{% extends "base_admin.html" %}
{% block title %}ユーザー別 購入履歴一覧{% endblock %}

{% block content %}
<div class="p-8">

  <h1 class="text-3xl font-extrabold mb-8 text-gray-800">📄 ユーザー別 購入履歴一覧</h1>

  <!-- 📅 月別フィルター -->
  <form method="get" class="mb-6">
    <label for="month" class="font-semibold text-gray-700 mr-2">📅 表示月：</label>
    <select name="month" id="month" onchange="this.form.submit()" class="border border-gray-300 rounded px-3 py-2 text-sm">
      <option value="all" {% if selected_month == 'all' %}selected{% endif %}>全期間</option>
      {% for month in all_months %}
        <option value="{{ month }}" {% if selected_month == month %}selected{% endif %}>{{ month }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- ✅ ユーザー別 購入履歴表示（折りたたみ） -->
  {% for user_id, logs in grouped_logs.items() %}
    <details class="mb-4 bg-white border rounded shadow-sm">
      <summary class="px-4 py-3 cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-800 font-semibold text-lg border-b">
        👤 {{ user_info_dict[user_id].name }}
        {% if user_info_dict[user_id].company %}
          <span class="text-sm text-gray-600 ml-2">（{{ user_info_dict[user_id].company }}）</span>
        {% endif %}
      </summary>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-center">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="py-2 px-4 border-b">購入日</th>
              <th class="py-2 px-4 border-b">サイト数</th>
              <th class="py-2 px-4 border-b text-green-700">龍之介（@1000）</th>
              <th class="py-2 px-4 border-b text-purple-700">毅（@2000）</th>
            </tr>
          </thead>
          <tbody class="text-gray-800">
            {% for log in logs %}
            <tr class="hover:bg-gray-50">
              <td class="py-2 px-4 border-b">{{ log.created_at.strftime('%Y-%m-%d') }}</td>
              <td class="py-2 px-4 border-b">{{ log.site_count }}</td>
              <td class="py-2 px-4 border-b text-green-700">{{ (log.site_count * 1000) | comma }}</td>
              <td class="py-2 px-4 border-b text-purple-700">{{ (log.site_count * 2000) | comma }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
  {% else %}
    <p class="text-gray-500 italic text-center mt-10">表示可能な購入履歴がありません。</p>
  {% endfor %}

</div>
{% endblock %}
