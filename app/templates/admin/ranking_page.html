{% extends "base_admin.html" %}
{% block title %}ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ | ç®¡ç†è€…ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<div class="px-6 py-6">
  <div class="bg-white shadow-md rounded-lg p-6">

    <h1 class="text-2xl font-bold mb-6">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ</h1>

    <!-- âœ… ã‚¿ãƒ– -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button class="tab-btn px-3 py-1.5 rounded border bg-blue-600 text-white font-semibold" data-type="site">ã‚µã‚¤ãƒˆæ•°</button>
      <button class="tab-btn px-3 py-1.5 rounded border bg-gray-100 text-gray-800" data-type="impressions">è¡¨ç¤ºå›æ•°</button>
      <button class="tab-btn px-3 py-1.5 rounded border bg-gray-100 text-gray-800" data-type="clicks">ã‚¯ãƒªãƒƒã‚¯æ•°</button>
      <button class="tab-btn px-3 py-1.5 rounded border bg-gray-100 text-gray-800" data-type="posted_articles">æŠ•ç¨¿å®Œäº†è¨˜äº‹æ•°</button>
    </div>

    <!-- âœ… æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div id="period-bar" class="flex gap-2 mb-4 flex-wrap">
      <!-- ãƒœã‚¿ãƒ³ã¯JSã§å‡ºã—åˆ†ã‘ -->
      <button class="period-btn px-2.5 py-1 rounded border" data-period="1d">24æ™‚é–“</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="7d">7æ—¥é–“</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="28d">28æ—¥é–“</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="3m">3ã‹æœˆ</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="6m">6ã‹æœˆ</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="12m">12ã‹æœˆ</button>
      <button class="period-btn px-2.5 py-1 rounded border" data-period="16m">16ã‹æœˆ</button>
      <button id="custom-open" onclick="toggleCustomDate()" class="px-2.5 py-1 rounded border bg-gray-100">ğŸ“… ã‚«ã‚¹ã‚¿ãƒ </button>
    </div>

    <!-- âœ… ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ -->
    <div id="custom-date-box" class="mb-4 hidden space-x-2">
      <label>é–‹å§‹æ—¥: <input type="date" id="start_date" class="border rounded p-1 text-sm"></label>
      <label>çµ‚äº†æ—¥: <input type="date" id="end_date" class="border rounded p-1 text-sm"></label>
      <button onclick="reloadRanking()" class="px-3 py-1 bg-blue-600 text-white rounded">é©ç”¨</button>
    </div>

    <!-- âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ -->
    <div class="border rounded shadow bg-white overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-100 text-gray-800 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>

    <!-- âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading" class="text-center mt-6 text-blue-600 font-semibold hidden">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<script>
let currentType = "site";
let currentOrder = "desc";
let currentPeriod = "3m";

// ã‚¯ãƒªãƒƒã‚¯/è¡¨ç¤ºå›æ•°ã§è¨±å¯ã™ã‚‹æœŸé–“ï¼ˆ24hã¯å‡ºã•ãªã„ï¼‰
const periodsForGSC = new Set(["7d","28d","3m","6m","12m","16m","custom"]);
// ã‚µã‚¤ãƒˆæ•°/æŠ•ç¨¿å®Œäº†ã§ã¯å…¨è¡¨ç¤º
const periodsAll = new Set(["1d","7d","28d","3m","6m","12m","16m","custom"]);

function setActiveTab(btn) {
  document.querySelectorAll(".tab-btn").forEach(b => {
    b.classList.remove("bg-blue-600","text-white");
    b.classList.add("bg-gray-100","text-gray-800");
  });
  btn.classList.remove("bg-gray-100","text-gray-800");
  btn.classList.add("bg-blue-600","text-white");
}

function setActivePeriod(btn) {
  document.querySelectorAll(".period-btn").forEach(b => {
    b.classList.remove("bg-blue-600","text-white","font-bold");
  });
  btn.classList.add("bg-blue-600","text-white","font-bold");
}

function filterPeriodButtons() {
  const allowed = (currentType === "impressions" || currentType === "clicks") ? periodsForGSC : periodsAll;
  document.querySelectorAll("#period-bar .period-btn, #custom-open").forEach(btn => {
    const p = btn.dataset.period || "custom";
    btn.classList.toggle("hidden", !allowed.has(p));
  });
  // ç¾åœ¨é¸æŠä¸­ãŒéè¡¨ç¤ºã«ãªã£ãŸã‚‰ãƒ‡ãƒ•ã‚©ã‚’é¸ã³ç›´ã™
  if ((currentType === "impressions" || currentType === "clicks") && currentPeriod === "1d") {
    currentPeriod = "28d";
  }
  // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ä¸­ã§ active ä»˜ã‘ç›´ã—
  const curBtn = [...document.querySelectorAll(".period-btn")].find(b => !b.classList.contains("hidden") && b.dataset.period === currentPeriod);
  if (curBtn) setActivePeriod(curBtn);
}

window.addEventListener("DOMContentLoaded", () => {
  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  filterPeriodButtons();
  // ãƒ‡ãƒ•ã‚© period ãƒœã‚¿ãƒ³ã®å¼·èª¿
  const defaultBtn = document.querySelector(`.period-btn[data-period="${currentPeriod}"]`);
  if (defaultBtn && !defaultBtn.classList.contains("hidden")) setActivePeriod(defaultBtn);
  loadRanking();

  // ã‚¿ãƒ–åˆ‡æ›¿
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      setActiveTab(btn);
      currentType = btn.dataset.type;
      filterPeriodButtons();
      loadRanking();
    });
  });

  // æœŸé–“åˆ‡æ›¿
  document.querySelectorAll(".period-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.classList.contains("hidden")) return;
      setActivePeriod(btn);
      currentPeriod = btn.dataset.period;
      loadRanking();
    });
  });
});

function toggleCustomDate() {
  document.getElementById("custom-date-box").classList.toggle("hidden");
}

function reloadRanking() {
  currentPeriod = "custom";
  loadRanking();
}

function toggleSort() {
  currentOrder = currentOrder === "desc" ? "asc" : "desc";
  loadRanking();
}

function setLoading(on) {
  document.getElementById("loading").classList[on ? "remove" : "add"]("hidden");
}

async function loadRanking() {
  const thead = document.getElementById("ranking-thead");
  const tbody = document.getElementById("ranking-body");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  setLoading(true);

  try {
    const start = document.getElementById("start_date")?.value;
    const end = document.getElementById("end_date")?.value;

    const params = new URLSearchParams({
      type: currentType,
      order: currentOrder,
      period: currentPeriod
    });
    if (currentPeriod === "custom") {
      if (start) params.set("start_date", start);
      if (end)   params.set("end_date",   end);
    }

    const res = await fetch(`/api/admin/rankings?${params.toString()}`, {
      credentials: "same-origin",
      headers: { "Accept": "application/json", "X-Requested-With": "XMLHttpRequest" }
    });

    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) throw new Error(`Unexpected response (status ${res.status})`);
    const json = await res.json();
    if (!res.ok) throw new Error(json.error || `HTTP ${res.status}`);

    const data = Array.isArray(json) ? json : (json.data || []);

    if (currentType === "site") {
      thead.innerHTML = `
        <tr>
          <th class="p-2 w-[56px]">é †ä½</th>
          <th class="p-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th class="p-2 w-[120px] text-center cursor-pointer" onclick="toggleSort()">ã‚µã‚¤ãƒˆæ•° ${currentOrder === "desc" ? "â†“" : "â†‘"}</th>
        </tr>`;
      tbody.innerHTML = data.length
        ? data.map((row, i) => `
          <tr class="border-b">
            <td class="p-2">${i < 3 ? ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i] : `#${i+1}`}</td>
            <td class="p-2">${row.last_name} ${row.first_name}</td>
            <td class="p-2 text-center font-semibold">${row.site_count ?? 0}</td>
          </tr>`).join("")
        : `<tr><td colspan="3" class="p-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
    } else {
      thead.innerHTML = `
        <tr>
          <th class="p-2 w-[56px]">é †ä½</th>
          <th class="p-2">ã‚µã‚¤ãƒˆå</th>
          <th class="p-2 w-[180px]">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th class="p-2 w-[120px] text-center cursor-pointer" onclick="toggleSort()">å€¤ ${currentOrder === "desc" ? "â†“" : "â†‘"}</th>
        </tr>`;
      tbody.innerHTML = data.length
        ? data.map((row, i) => `
          <tr class="border-b">
            <td class="p-2">${i < 3 ? ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i] : `#${i+1}`}</td>
            <td class="p-2 text-blue-600 underline"><a href="${row.site_url}" target="_blank" rel="noopener">${row.site_name}</a></td>
            <td class="p-2">${row.user_name}</td>
            <td class="p-2 text-center font-semibold">${row.value ?? 0}</td>
          </tr>`).join("")
        : `<tr><td colspan="4" class="p-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("ranking-body").innerHTML =
      `<tr><td colspan="4" class="p-4 text-center text-red-600">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${err.message}</td></tr>`;
  } finally {
    setLoading(false);
  }
}
</script>
{% endblock %}
