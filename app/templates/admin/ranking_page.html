{% extends "base_admin.html" %}
{% block title %}ランキング分析 | 管理者ページ{% endblock %}

{% block content %}
<div class="px-6 py-6">
  <div class="bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-6">📊 ランキング分析</h1>

    <!-- 🔹 タブ -->
    <div class="flex gap-4 mb-4 flex-wrap">
      <button class="tab-btn px-4 py-2 rounded bg-blue-100 text-blue-800 font-semibold" data-type="site">サイト登録数</button>
      <button class="tab-btn px-4 py-2 rounded bg-gray-100 text-gray-800" data-type="access">アクセスランキング</button>
    </div>

    <!-- 🔹 期間選択 -->
    <div class="flex gap-2 mb-4 flex-wrap items-center">
      <button class="period-btn px-3 py-1 rounded border" data-period="1d">24時間</button>
      <button class="period-btn px-3 py-1 rounded border" data-period="7d">7日間</button>
      <button class="period-btn px-3 py-1 rounded border" data-period="28d">28日間</button>
      <button class="period-btn px-3 py-1 rounded border bg-blue-200 font-bold" data-period="3m">3か月</button>
      <div class="relative">
        <button id="detailBtn" class="px-3 py-1 rounded border">詳細 ▾</button>
        <div id="datePopup" class="hidden absolute bg-white border shadow-lg p-4 mt-1 z-50 rounded">
          <label class="block text-sm">開始日</label>
          <input type="date" id="startDate" class="border rounded p-1 mb-2 w-full">
          <label class="block text-sm">終了日</label>
          <input type="date" id="endDate" class="border rounded p-1 w-full">
          <button id="applyDate" class="mt-3 px-3 py-1 rounded bg-blue-500 text-white">適用</button>
        </div>
      </div>
    </div>

    <!-- 🔹 テーブル -->
    <div class="border rounded shadow bg-white overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-100 text-gray-800 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>

    <div id="loading" class="text-center mt-6 text-blue-600 font-semibold hidden">読み込み中...</div>
  </div>
</div>

<script>
let currentType = "site";
let currentMetric = "impressions";
let currentOrder = "asc";
let currentPeriod = "3m";
let customStart = null;
let customEnd = null;

document.addEventListener("DOMContentLoaded", () => {
  loadRanking();

  // タブ切替
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("bg-blue-100", "text-blue-800", "font-semibold"));
      btn.classList.add("bg-blue-100", "text-blue-800", "font-semibold");
      currentType = btn.dataset.type;
      currentOrder = "asc"; // 初期化
      loadRanking();
    });
  });

  // 期間ボタン切替
  document.querySelectorAll(".period-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".period-btn").forEach(b => b.classList.remove("bg-blue-200", "font-bold"));
      btn.classList.add("bg-blue-200", "font-bold");
      currentPeriod = btn.dataset.period;
      customStart = null;
      customEnd = null;
      loadRanking();
    });
  });

  // 詳細ポップアップ
  document.getElementById("detailBtn").addEventListener("click", () => {
    document.getElementById("datePopup").classList.toggle("hidden");
  });

  document.getElementById("applyDate").addEventListener("click", () => {
    customStart = document.getElementById("startDate").value;
    customEnd = document.getElementById("endDate").value;
    currentPeriod = null;
    document.getElementById("datePopup").classList.add("hidden");
    loadRanking();
  });
});

// ソート切替
function toggleSort(column) {
  if (currentMetric === column) {
    currentOrder = currentOrder === "asc" ? "desc" : "asc";
  } else {
    currentMetric = column;
    currentOrder = "asc";
  }
  loadRanking();
}

// ランキング読み込み
function loadRanking() {
  document.getElementById("ranking-body").innerHTML = "";
  document.getElementById("loading").classList.remove("hidden");

  let url = `/api/admin/rankings?type=${currentType === "access" ? currentMetric : "site"}&order=${currentOrder}`;
  if (currentPeriod) {
    url += `&period=${currentPeriod}`;
  } else if (customStart && customEnd) {
    url += `&start_date=${customStart}&end_date=${customEnd}`;
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const thead = document.getElementById("ranking-thead");
      const tbody = document.getElementById("ranking-body");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      document.getElementById("loading").classList.add("hidden");

      if (currentType === "site") {
        thead.innerHTML = `
          <tr>
            <th class="p-2 w-[60px]">順位</th>
            <th class="p-2 w-[120px]">ユーザー名</th>
            <th class="p-2 w-[90px] text-center">サイト数</th>
          </tr>`;
        data.forEach((row, i) => {
          tbody.innerHTML += `
            <tr class="border-b">
              <td class="p-2">${i < 3 ? ["🥇","🥈","🥉"][i] : `#${i + 1}`}</td>
              <td class="p-2">${row.last_name} ${row.first_name}</td>
              <td class="p-2 text-center">${row.site_count}</td>
            </tr>`;
        });
      } else {
        thead.innerHTML = `
          <tr>
            <th class="p-2 w-[60px]">順位</th>
            <th class="p-2">サイト名</th>
            <th class="p-2">ユーザー名</th>
            <th class="p-2 cursor-pointer" onclick="toggleSort('impressions')">表示回数 ${currentMetric === 'impressions' ? (currentOrder === 'asc' ? "↑" : "↓") : ''}</th>
            <th class="p-2 cursor-pointer" onclick="toggleSort('clicks')">クリック数 ${currentMetric === 'clicks' ? (currentOrder === 'asc' ? "↑" : "↓") : ''}</th>
            <th class="p-2 cursor-pointer" onclick="toggleSort('posted_articles')">投稿完了 ${currentMetric === 'posted_articles' ? (currentOrder === 'asc' ? "↑" : "↓") : ''}</th>
          </tr>`;

        data.forEach((row, i) => {
          tbody.innerHTML += `
            <tr class="border-b ${i % 2 === 0 ? 'bg-blue-50' : ''}">
              <td class="p-2">${i < 3 ? ["🥇","🥈","🥉"][i] : `#${i + 1}`}</td>
              <td class="p-2 text-blue-600 underline"><a href="${row.site_url}" target="_blank">${row.site_name}</a></td>
              <td class="p-2">${row.user_name}</td>
              <td class="p-2 text-purple-600 text-center">${row.impressions}</td>
              <td class="p-2 text-red-500 text-center">${row.clicks}</td>
              <td class="p-2 text-blue-600 text-center">${row.posted_articles}</td>
            </tr>`;
        });
      }
    })
    .catch(err => {
      console.error(err);
      document.getElementById("ranking-body").innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">読み込みに失敗しました</td></tr>`;
    });
}
</script>
{% endblock %}
