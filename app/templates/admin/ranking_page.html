{% extends "base_admin.html" %}
{% block title %}ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ | ç®¡ç†è€…ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<div class="px-6 py-6">
  <div class="bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-6">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ</h1>

    <!-- ğŸ”¹ 2ã¤ã®ã‚¿ãƒ– -->
    <div class="flex gap-4 mb-4 flex-wrap">
      <button class="tab-btn px-4 py-2 rounded bg-blue-100 text-blue-800 font-semibold" data-type="site">ã‚µã‚¤ãƒˆç™»éŒ²æ•°</button>
      <button class="tab-btn px-4 py-2 rounded bg-gray-100 text-gray-800" data-type="access">ã‚¢ã‚¯ã‚»ã‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>

    <!-- ğŸ”¹ ä¸¦ã³æ›¿ãˆé …ç›®ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ç³»ã®ã¿æœ‰åŠ¹ï¼‰ -->
    <div id="access-sort-options" class="flex gap-4 mb-4 flex-wrap hidden">
      <button class="metric-btn px-3 py-1 rounded border bg-purple-200 font-bold" data-metric="impressions">è¡¨ç¤ºå›æ•°</button>
      <button class="metric-btn px-3 py-1 rounded border" data-metric="clicks">ã‚¯ãƒªãƒƒã‚¯æ•°</button>
      <button class="metric-btn px-3 py-1 rounded border" data-metric="posted_articles">æŠ•ç¨¿å®Œäº†</button>
    </div>

    <!-- ğŸ”¹ æœŸé–“é¸æŠ -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button class="period-btn px-3 py-1 rounded border" data-period="1d">24æ™‚é–“</button>
      <button class="period-btn px-3 py-1 rounded border" data-period="7d">7æ—¥é–“</button>
      <button class="period-btn px-3 py-1 rounded border" data-period="28d">28æ—¥é–“</button>
      <button class="period-btn px-3 py-1 rounded border bg-blue-200 font-bold" data-period="3m">3ã‹æœˆ</button>
    </div>

    <!-- ğŸ”¹ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="border rounded shadow bg-white overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-100 text-gray-800 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>

    <div id="loading" class="text-center mt-6 text-blue-600 font-semibold hidden">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<script>
let currentType = "site";
let currentMetric = "impressions"; // ã‚¢ã‚¯ã‚»ã‚¹ç³»ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
let currentOrder = "asc";
let currentPeriod = "3m";

document.addEventListener("DOMContentLoaded", () => {
  loadRanking();

  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("bg-blue-100", "text-blue-800", "font-semibold"));
      btn.classList.add("bg-blue-100", "text-blue-800", "font-semibold");
      currentType = btn.dataset.type;
      currentOrder = "desc";

      // ã‚¢ã‚¯ã‚»ã‚¹ç³»è¡¨ç¤ºæ™‚ã®UIåˆ‡æ›¿
      document.getElementById("access-sort-options").classList.toggle("hidden", currentType !== "access");
      loadRanking();
    });
  });

  document.querySelectorAll(".period-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".period-btn").forEach(b => b.classList.remove("bg-blue-200", "font-bold"));
      btn.classList.add("bg-blue-200", "font-bold");
      currentPeriod = btn.dataset.period;
      loadRanking();
    });
  });

  document.querySelectorAll(".metric-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".metric-btn").forEach(b => b.classList.remove("bg-purple-200", "font-bold"));
      btn.classList.add("bg-purple-200", "font-bold");
      currentMetric = btn.dataset.metric;
      currentOrder = "desc";
      loadRanking();
    });
  });
});

function toggleSort() {
  currentOrder = currentOrder === "desc" ? "asc" : "desc";
  loadRanking();
}

function loadRanking() {
  document.getElementById("ranking-body").innerHTML = "";
  document.getElementById("loading").classList.remove("hidden");

  let typeParam = currentType === "access" ? currentMetric : "site";
  let url = `/api/admin/rankings?type=${typeParam}&order=${currentOrder}&period=${currentPeriod}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const thead = document.getElementById("ranking-thead");
      const tbody = document.getElementById("ranking-body");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      document.getElementById("loading").classList.add("hidden");

      if (currentType === "site") {
        thead.innerHTML = `
          <tr>
            <th class="p-2 w-[60px]">é †ä½</th>
            <th class="p-2 w-[150px]">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
            <th class="p-2 cursor-pointer" onclick="toggleSort()">ã‚µã‚¤ãƒˆæ•° ${currentOrder === "desc" ? "â†“" : "â†‘"}</th>
          </tr>`;
        data.forEach((row, i) => {
          tbody.innerHTML += `
            <tr class="border-b">
              <td class="p-2">${i < 3 ? ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][i] : `#${i + 1}`}</td>
              <td class="p-2">${row.last_name} ${row.first_name}</td>
              <td class="p-2 text-center">${row.site_count}</td>
            </tr>`;
        });
      } else {
        // ã‚¢ã‚¯ã‚»ã‚¹ç³»ï¼šæ¨ªä¸¦ã³å½¢å¼ã§è¡¨ç¤º
        thead.innerHTML = `
          <tr>
            <th class="p-2 w-[60px]">é †ä½</th>
            <th class="p-2">ã‚µã‚¤ãƒˆå</th>
            <th class="p-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
            <th class="p-2 cursor-pointer" onclick="setMetric('posted_articles')">æŠ•ç¨¿å®Œäº†</th>
            <th class="p-2 cursor-pointer" onclick="setMetric('clicks')">ã‚¯ãƒªãƒƒã‚¯æ•°</th>
            <th class="p-2 cursor-pointer" onclick="setMetric('impressions')">è¡¨ç¤ºå›æ•° ${currentOrder === "desc" ? "â†“" : "â†‘"}</th>
          </tr>`;

        const grouped = {};
        data.forEach(row => {
          const key = row.site_url;
          if (!grouped[key]) {
            grouped[key] = {
              site_name: row.site_name,
              site_url: row.site_url,
              user_name: row.user_name,
              posted_articles: 0,
              clicks: 0,
              impressions: 0,
            };
          }
          grouped[key][currentMetric] = row.value;
        });

        Object.values(grouped).forEach((row, i) => {
          tbody.innerHTML += `
            <tr class="border-b ${i % 2 === 0 ? 'bg-blue-50' : ''}">
              <td class="p-2">${i < 3 ? ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][i] : `#${i + 1}`}</td>
              <td class="p-2 text-blue-600 underline"><a href="${row.site_url}" target="_blank">${row.site_name}</a></td>
              <td class="p-2">${row.user_name}</td>
              <td class="p-2 text-blue-600 text-center">${row.posted_articles}</td>
              <td class="p-2 text-red-500 text-center">${row.clicks}</td>
              <td class="p-2 text-purple-600 text-center">${row.impressions}</td>
            </tr>`;
        });
      }
    })
    .catch(err => {
      console.error(err);
      document.getElementById("ranking-body").innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-600">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>`;
    });
}

function setMetric(metric) {
  currentMetric = metric;
  currentOrder = "desc";
  document.querySelectorAll(".metric-btn").forEach(btn => {
    btn.classList.remove("bg-purple-200", "font-bold");
    if (btn.dataset.metric === metric) {
      btn.classList.add("bg-purple-200", "font-bold");
    }
  });
  loadRanking();
}
</script>
{% endblock %}
