{% extends "base_admin.html" %}
{% block title %}ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ | ç®¡ç†è€…ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<div class="px-6 py-6">
  <div class="bg-white shadow-md rounded-lg p-6">

    <h1 class="text-2xl font-bold mb-6">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ</h1>

    <!-- ã‚¿ãƒ– -->
    <div id="tab-bar" class="flex gap-2 mb-3 flex-wrap">
      <button class="tab-btn px-3 py-1 rounded border transition" data-type="site">ã‚µã‚¤ãƒˆæ•°</button>
      <button class="tab-btn px-3 py-1 rounded border transition" data-type="impressions">è¡¨ç¤ºå›æ•°</button>
      <button class="tab-btn px-3 py-1 rounded border transition" data-type="clicks">ã‚¯ãƒªãƒƒã‚¯æ•°</button>
      <button class="tab-btn px-3 py-1 rounded border transition" data-type="posted_articles">æŠ•ç¨¿å®Œäº†è¨˜äº‹æ•°</button>
    </div>

    <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ç”Ÿæˆï¼‰ -->
    <div class="flex items-center gap-2 mb-3 flex-wrap">
      <div id="period-bar" class="flex gap-2 flex-wrap"></div>
      <button id="custom-toggle" onclick="toggleCustomDate()" class="px-3 py-1 rounded border bg-gray-100 hover:bg-gray-200">
        ğŸ“… ã‚«ã‚¹ã‚¿ãƒ 
      </button>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ -->
    <div id="custom-date-box" class="mb-4 hidden space-x-2">
      <label class="text-sm">é–‹å§‹æ—¥:
        <input type="date" id="start_date" class="border rounded p-1 text-sm">
      </label>
      <label class="text-sm">çµ‚äº†æ—¥:
        <input type="date" id="end_date" class="border rounded p-1 text-sm">
      </label>
      <button onclick="reloadRanking()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">é©ç”¨</button>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ -->
    <div class="border rounded shadow bg-white overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-50 text-gray-800 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="text-center mt-4 text-blue-600 font-semibold hidden">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<style>
  /* åˆ—å¹…ãƒ»çœç•¥è¡¨ç¤ºï¼ˆTailwindã® @apply ã¯ä½¿ã‚ãªã„ï¼‰ */
  #ranking-thead th, #ranking-body td { padding: 0.25rem 0.5rem; vertical-align: middle; }
  .col-rank  { width: 56px;  white-space: nowrap; }
  .col-user  { width: 160px; white-space: nowrap; }
  .col-value { width: 96px;  text-align: right; }
  .site-cell { max-width: 520px; }
  .site-link { color: #2563eb; text-decoration: none; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .site-link:hover { text-decoration: underline; }
  tbody tr:nth-child(odd){ background-color:#ffffff; }
  tbody tr:nth-child(even){ background-color:#f9fafb; }
  tbody tr:hover{ background-color:#eff6ff; }
</style>

<script>
let currentType   = "site";
let currentOrder  = "desc";
let currentPeriod = "28d";   // åˆæœŸã¯28æ—¥ã‚’åŸºæº–ã«
const periodBar   = document.getElementById("period-bar");
const tabBar      = document.getElementById("tab-bar");

/** ã‚¿ã‚¤ãƒ—æ¯ã«è¡¨ç¤ºã™ã‚‹æœŸé–“ */
const PERIODS_BY_TYPE = {
  site:            ["1d","7d","28d","3m","6m","12m","16m"],
  posted_articles: ["1d","7d","28d","3m","6m","12m","16m"],
  impressions:     ["7d","28d","3m","6m","12m","16m"], // 24hã¯éè¡¨ç¤ºï¼ˆGSCã¯æ—¥æ¬¡é›†è¨ˆã®ãŸã‚ï¼‰
  clicks:          ["7d","28d","3m","6m","12m","16m"],
};
/** ãƒ©ãƒ™ãƒ«è¡¨è¨˜ */
const PERIOD_LABEL = {
  "1d":"24æ™‚é–“","7d":"7æ—¥é–“","28d":"28æ—¥é–“","3m":"3ã‹æœˆ","6m":"6ã‹æœˆ","12m":"12ã‹æœˆ","16m":"16ã‹æœˆ"
};

/** ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹ï¼ˆTailwindã‚’ç›´æ¥ä»˜ã‘æ›¿ãˆã‚‹ï¼‰ */
const BASE_BTN    = "px-3 py-1 rounded border transition";
const ACTIVE_BTN  = "bg-blue-600 text-white font-semibold border-blue-600";
const INACTIVE_BTN= "bg-gray-100 text-gray-800 hover:bg-gray-200";

window.addEventListener("DOMContentLoaded", () => {
  renderTabs();
  renderPeriods();
  loadRanking();
});

/** ã‚¿ãƒ–æç”»ï¼‹ã‚¤ãƒ™ãƒ³ãƒˆ */
function renderTabs(){
  tabBar.querySelectorAll(".tab-btn").forEach(btn => {
    const type = btn.dataset.type;
    btn.className = `tab-btn ${BASE_BTN} ${type === currentType ? ACTIVE_BTN : INACTIVE_BTN}`;
    btn.onclick = () => {
      currentType = type;
      // è¨±å¯å¤–ã®æœŸé–“ã‚’é¸ã‚“ã§ã„ãŸã‚‰ 28æ—¥é–“ã¸
      const allowed = PERIODS_BY_TYPE[currentType];
      if (!allowed.includes(currentPeriod)) currentPeriod = "28d";
      renderTabs();
      renderPeriods();
      loadRanking();
    };
  });
}

/** æœŸé–“ãƒœã‚¿ãƒ³æç”»ï¼ˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‡ºã—åˆ†ã‘ï¼‰ */
function renderPeriods(){
  const allowed = PERIODS_BY_TYPE[currentType];
  periodBar.innerHTML = "";
  allowed.forEach(code => {
    const b = document.createElement("button");
    b.className = `period-btn ${BASE_BTN} ${currentPeriod === code ? ACTIVE_BTN : INACTIVE_BTN}`;
    b.dataset.period = code;
    b.textContent = PERIOD_LABEL[code];
    b.onclick = () => {
      currentPeriod = code;
      renderPeriods();
      loadRanking();
    };
    periodBar.appendChild(b);
  });
}

/** ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºåˆ‡æ›¿ */
function toggleCustomDate() {
  document.getElementById("custom-date-box").classList.toggle("hidden");
}

/** ã‚«ã‚¹ã‚¿ãƒ é©ç”¨ */
function reloadRanking() {
  currentPeriod = "custom";
  loadRanking();
}

/** æ˜‡é™é †åˆ‡æ›¿ */
function toggleSort() {
  currentOrder = currentOrder === "desc" ? "asc" : "desc";
  loadRanking();
}

function setLoading(on) {
  document.getElementById("loading").classList[on ? "remove" : "add"]("hidden");
}

/** ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†ãƒ†ãƒ¼ãƒ–ãƒ«æç”» */
async function loadRanking() {
  const thead = document.getElementById("ranking-thead");
  const tbody = document.getElementById("ranking-body");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  setLoading(true);

  try {
    const start = document.getElementById("start_date")?.value;
    const end   = document.getElementById("end_date")?.value;

    const params = new URLSearchParams({
      type: currentType,
      order: currentOrder,
      period: currentPeriod
    });
    if (currentPeriod === "custom") {
      if (start) params.set("start_date", start);
      if (end)   params.set("end_date", end);
    }

    const res = await fetch(`/api/admin/rankings?${params.toString()}`, {
      credentials: "same-origin",
      headers: { "Accept": "application/json", "X-Requested-With": "XMLHttpRequest" }
    });

    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) throw new Error(`Unexpected response (status ${res.status})`);

    const json = await res.json();
    if (!res.ok) throw new Error(json.error || `HTTP ${res.status}`);

    const data = Array.isArray(json) ? json : (json.data || []);

    if (currentType === "site") {
      thead.innerHTML = `
        <tr>
          <th class="col-rank p-2">é †ä½</th>
          <th class="col-user p-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th class="col-value p-2 cursor-pointer text-right" onclick="toggleSort()">
            ã‚µã‚¤ãƒˆæ•° ${currentOrder === "desc" ? "â†“" : "â†‘"}
          </th>
        </tr>`;
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
      } else {
        tbody.innerHTML = data.map((row, i) => `
          <tr class="border-b">
            <td class="col-rank p-2">${i < 3 ? ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i] : `#${i+1}`}</td>
            <td class="col-user p-2">${row.last_name} ${row.first_name}</td>
            <td class="col-value p-2">${row.site_count ?? 0}</td>
          </tr>`).join("");
      }
    } else {
      thead.innerHTML = `
        <tr>
          <th class="col-rank p-2">é †ä½</th>
          <th class="p-2 site-cell">ã‚µã‚¤ãƒˆå</th>
          <th class="col-user p-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
          <th class="col-value p-2 cursor-pointer" onclick="toggleSort()">
            å€¤ ${currentOrder === "desc" ? "â†“" : "â†‘"}
          </th>
        </tr>`;
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>`;
      } else {
        tbody.innerHTML = data.map((row, i) => `
          <tr class="border-b">
            <td class="col-rank p-2">${i < 3 ? ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i] : `#${i+1}`}</td>
            <td class="p-2 site-cell">
              <a class="site-link" href="${row.site_url}" target="_blank" rel="noopener">${row.site_name}</a>
            </td>
            <td class="col-user p-2">${row.user_name}</td>
            <td class="col-value p-2">${row.value ?? 0}</td>
          </tr>`).join("");
      }
    }
  } catch (err) {
    console.error(err);
    document.getElementById("ranking-body").innerHTML =
      `<tr><td colspan="4" class="p-4 text-center text-red-600">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${err.message}</td></tr>`;
  } finally {
    setLoading(false);
  }
}
</script>
{% endblock %}
