{% extends "base_admin.html" %}
{% block title %}çµŒç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="p-8">
  <h1 class="text-3xl font-extrabold mb-8 text-gray-800">
    ğŸ’¼ çµŒç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    <span class="text-sm font-normal text-gray-500">(å„ã‚µã‚¤ãƒˆãƒ—ãƒ©ãƒ³ã®é›†è¨ˆ)</span>
  </h1>

  <!-- ğŸ“… æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <form method="get" class="mb-6">
    <label for="month" class="font-semibold text-gray-700 mr-2">ğŸ“… è¡¨ç¤ºæœˆï¼š</label>
    <select name="month" id="month" onchange="this.form.submit()" class="border border-gray-300 rounded px-3 py-2 text-sm">
      <option value="all" {% if selected_month == 'all' %}selected{% endif %}>å…¨æœŸé–“</option>
      {% for month in all_months %}
        <option value="{{ month }}" {% if selected_month == month %}selected{% endif %}>{{ month }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- âœ… ã‚µã‚¤ãƒˆæ è³¼å…¥ã®å†…è¨³ -->
  <div class="bg-white border border-gray-300 rounded-lg shadow-md mb-10">
    <div class="p-4 border-b bg-gray-50 rounded-t">
      <h2 class="text-xl font-bold text-gray-800">ğŸ“Š ã‚µã‚¤ãƒˆæ è³¼å…¥ã®å†…è¨³</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-center">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-3 px-4 text-base">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥</th>
            <th class="py-3 px-4 text-base">è³¼å…¥ã‚µã‚¤ãƒˆæ•°</th>
            <th class="py-3 px-4 text-base text-green-700">é¾ä¹‹ä»‹å–ã‚Šåˆ†</th>
            <th class="py-3 px-4 text-base text-purple-700">æ¯…å–ã‚Šåˆ†</th>
          </tr>
        </thead>
        <tbody class="text-gray-800 text-lg">
          <!-- â–¼ TCCç ”ç©¶ç”Ÿ -->
          <tr class="hover:bg-gray-50">
            <td class="py-3 px-4 font-semibold">TCCç ”ç©¶ç”Ÿï¼ˆ@3,000ï¼‰</td>
            <td class="py-3 px-4 text-blue-700 font-bold" id="cnt-student">
              <button class="px-2 bg-gray-200 rounded mr-1" onclick="adjustQuota('student', -1)">ï¼</button>
              <span>{{ breakdown.unpurchased.count }}</span> ä»¶
              <button class="px-2 bg-gray-200 rounded ml-1" onclick="adjustQuota('student', 1)">ï¼‹</button>
            </td>
            <td class="py-3 px-4 text-green-700 font-bold"  id="ryu-student">Â¥{{ breakdown.unpurchased.ryu | comma }}</td>
            <td class="py-3 px-4 text-purple-700 font-bold" id="take-student">Â¥{{ breakdown.unpurchased.take | comma }}</td>
          </tr>

          <!-- â–¼ TCCãƒ¡ãƒ³ãƒãƒ¼ -->
          <tr class="hover:bg-gray-50">
            <td class="py-3 px-4 font-semibold">TCCãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ@1,000ï¼‰</td>
            <td class="py-3 px-4 text-blue-700 font-bold" id="cnt-member">
              <button class="px-2 bg-gray-200 rounded mr-1" onclick="adjustQuota('member', -1)">ï¼</button>
              <span>{{ breakdown.purchased.count }}</span> ä»¶
              <button class="px-2 bg-gray-200 rounded ml-1" onclick="adjustQuota('member', 1)">ï¼‹</button>
            </td>
            <td class="py-3 px-4 text-green-700 font-bold"  id="ryu-member">Â¥{{ breakdown.purchased.ryu | comma }}</td>
            <td class="py-3 px-4 text-purple-700 font-bold" id="take-member">Â¥{{ breakdown.purchased.take | comma }}</td>
          </tr>

          <!-- â–¼ äº‹æ¥­ãƒ—ãƒ©ãƒ³ -->
          <tr class="hover:bg-gray-50">
            <td class="py-3 px-4 font-semibold">äº‹æ¥­ç”¨ãƒ—ãƒ©ãƒ³ï¼ˆ@20,000/æœˆï¼‰</td>
            <td class="py-3 px-4 text-blue-700 font-bold" id="cnt-business">
              <button class="px-2 bg-gray-200 rounded mr-1" onclick="adjustQuota('business', -1)">ï¼</button>
              <span>{{ breakdown.business.count }}</span> ä»¶
              <button class="px-2 bg-gray-200 rounded ml-1" onclick="adjustQuota('business', 1)">ï¼‹</button>
            </td>
            <td class="py-3 px-4 text-green-700 font-bold"  id="ryu-business">Â¥{{ breakdown.business.ryu | comma }}</td>
            <td class="py-3 px-4 text-purple-700 font-bold" id="take-business">Â¥{{ breakdown.business.take | comma }}</td>
          </tr>

          <!-- â–¼ åˆè¨ˆ -->
          <tr class="bg-gray-50 border-t font-bold">
            <td class="py-3 px-4">åˆè¨ˆ</td>
            <td class="py-3 px-4 text-blue-700"   id="cnt-total">{{ breakdown.total.count }} ä»¶</td>
            <td class="py-3 px-4 text-green-800"  id="ryu-total">Â¥{{ breakdown.total.ryu | comma }}</td>
            <td class="py-3 px-4 text-purple-800" id="take-total">Â¥{{ breakdown.total.take | comma }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ğŸ¦ å…¥é‡‘çŠ¶æ³ãªã©ï¼ˆä»¥ä¸‹å…ƒã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ï¼‰ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
    <div class="bg-white border rounded-lg shadow-md p-6">
      <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ’° é¾ä¹‹ä»‹ã®å…¥é‡‘çŠ¶æ³</h3>
      <p class="mb-2 text-gray-600">âœ… å…¥é‡‘æ¸ˆã¿é‡‘é¡ï¼š<span class="font-bold text-green-700">{{ paid_total | comma }} å††</span></p>
      <p class="mb-2 text-gray-600">ğŸ’¸ æ®‹ã‚Šå—å–é¡ï¼š<span class="font-bold text-red-600">{{ remaining | comma }} å††</span></p>
    </div>

    <div class="bg-white border rounded-lg shadow-md p-6">
      <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“ é¾ä¹‹ä»‹ã®å…¥é‡‘ã‚’è¨˜éŒ²</h3>
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mb-4">
          {{ form.deposit_date.label(class="block text-sm font-semibold text-gray-600 mb-1") }}
          {{ form.deposit_date(class="w-full border px-3 py-2 rounded text-sm") }}
        </div>
        <div class="mb-4">
          {{ form.amount.label(class="block text-sm font-semibold text-gray-600 mb-1") }}
          {{ form.amount(class="w-full border px-3 py-2 rounded text-sm") }}
        </div>
        <div class="mb-4">
          {{ form.memo.label(class="block text-sm font-semibold text-gray-600 mb-1") }}
          {{ form.memo(class="w-full border px-3 py-2 rounded text-sm") }}
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm shadow">
          ğŸ’¾ å…¥é‡‘ã‚’ç™»éŒ²ã™ã‚‹
        </button>
      </form>
    </div>
  </div>

  <!-- ğŸ”— ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥è³¼å…¥å±¥æ­´ãƒªãƒ³ã‚¯ -->
  <div class="mb-10 text-right">
    <a href="{{ url_for('admin.accounting_details') }}"
       class="inline-block bg-blue-600 text-white text-sm font-semibold px-4 py-2 rounded hover:bg-blue-700 shadow">
      ğŸ§¾ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®è³¼å…¥å±¥æ­´ã‚’è¦‹ã‚‹
    </a>
  </div>

  <!-- ğŸ“œ å…¥é‡‘å±¥æ­´ä¸€è¦§ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰é€šã‚Šï¼‰ -->
  <div class="bg-white border rounded-lg shadow-md">
    <div class="p-4 border-b bg-gray-50 rounded-t">
      <h3 class="text-lg font-bold text-gray-700">ğŸ“œ é¾ä¹‹ä»‹ã®å…¥é‡‘å±¥æ­´</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="py-2 px-4 border-b">å…¥é‡‘æ—¥</th>
            <th class="py-2 px-4 border-b">é‡‘é¡</th>
            <th class="py-2 px-4 border-b">å‚™è€ƒ</th>
          </tr>
        </thead>
        <tbody class="text-gray-800">
          {% for log in deposit_logs %}
          <tr class="hover:bg-gray-50">
            <td class="py-2 px-4 border-b">{{ log.deposit_date.strftime("%Y-%m-%d") }}</td>
            <td class="py-2 px-4 border-b text-green-700">{{ log.amount | comma }} å††</td>
            <td class="py-2 px-4 border-b">{{ log.memo or '-' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="3" class="py-4 text-gray-500 italic text-center">ã¾ã å…¥é‡‘è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ğŸ”§ JS éƒ¨åˆ†ï¼šä»¶æ•°ãƒ»é‡‘é¡ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° -->
<script>
/* ä¾¡æ ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
const PRICE = {
  student:  { ryu: 1000,  take: 2000 },
  member:   { ryu: 0,     take: 1000 },
  business: { ryu: 16000, take: 4000 }
};

/* 3 æ¡ã‚«ãƒ³ãƒ */
const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

/* ãƒœã‚¿ãƒ³æŠ¼ä¸‹ â†’ API â†’ è¡¨æ›´æ–° */
function adjustQuota(category, delta) {
  fetch("/admin/accounting/adjust", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ category, delta })
  })
  .then(r => r.ok ? r.json() : Promise.reject(r))
  .then(data => {
    // â‘  ä»¶æ•°ã‚»ãƒ«ã‚’æ›´æ–°
    document.querySelector("#cnt-student span").innerText  = data.student;
    document.querySelector("#cnt-member span").innerText   = data.member;
    document.querySelector("#cnt-business span").innerText = data.business;
    document.getElementById("cnt-total").innerText         = data.total + " ä»¶";

    // â‘¡ é‡‘é¡ã‚»ãƒ«ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
    updateAmounts("student",  data.student);
    updateAmounts("member",   data.member);
    updateAmounts("business", data.business);

    const totalRyu  = PRICE.student.ryu  * data.student  + PRICE.member.ryu  * data.member  + PRICE.business.ryu  * data.business;
    const totalTake = PRICE.student.take * data.student  + PRICE.member.take * data.member  + PRICE.business.take * data.business;

    document.getElementById("ryu-total").innerText  = "Â¥" + fmt(totalRyu);
    document.getElementById("take-total").innerText = "Â¥" + fmt(totalTake);
  })
  .catch(err => alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"));
}

/* å€‹åˆ¥ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å–ã‚Šåˆ†æ›´æ–° */
function updateAmounts(cat, cnt) {
  const ryu  = PRICE[cat].ryu  * cnt;
  const take = PRICE[cat].take * cnt;
  document.getElementById(`ryu-${cat}`).innerText  = "Â¥" + fmt(ryu);
  document.getElementById(`take-${cat}`).innerText = "Â¥" + fmt(take);
}
</script>
{% endblock %}
