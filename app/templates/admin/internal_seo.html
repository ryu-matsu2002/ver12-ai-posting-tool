{% extends "base_admin.html" %}
{% block title %}å†…éƒ¨SEO ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid py-4 internal-seo">

  <!-- CSRFï¼ˆPOSTã§ä½¿ç”¨ï¼‰ -->
  <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined }}">

  <!-- è»½ã„UIç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆGSCé¢¨ï¼‰ -->
  <style>
    .internal-seo .guide{background:#f7fbff;border:1px solid #e3f0ff;border-left:4px solid #0d6efd;border-radius:.5rem;padding:.75rem .9rem;color:#0b3d91;font-size:.95rem}
    .internal-seo .gsc-card{border:1px solid #e8eef5;background:#fff;border-radius:.75rem;box-shadow:0 2px 8px rgba(16,24,40,.06);transition:box-shadow .15s ease,transform .12s ease}
    .internal-seo .gsc-card:hover{box-shadow:0 8px 20px rgba(13,110,253,.12);transform:translateY(-1px)}
    .internal-seo .section-title{font-weight:600;color:#0d6efd}
    .internal-seo .mini-label{font-size:.8rem;color:#6c757d}
    .internal-seo .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem}
    .internal-seo .pill-blue{background:#e7f1ff;color:#0d6efd}
    .internal-seo .pill-green{background:#eaf7ea;color:#198754}
    .internal-seo .btn-ghost{border:1px solid #dee2e6;background:#fff}
    .internal-seo .kbd{background:#f1f3f5;border:1px solid #dee2e6;border-bottom-width:2px;padding:.05rem .35rem;border-radius:.35rem;font-size:.75rem}
    .internal-seo .owner-header{background:#f8fafc;border:1px solid #e8eef5;border-radius:.5rem;padding:.6rem .8rem}
    .internal-seo .metric{font-weight:600}
    .internal-seo .muted{color:#6c757d}
    .internal-seo .progress{height:12px}
  </style>

  <!-- è¦‹å‡ºã— + ã‚¬ã‚¤ãƒ‰ -->
  <div class="d-flex align-items-center mb-3">
    <h2 class="h4 mb-0">ğŸ”§ å†…éƒ¨SEO ç®¡ç†</h2>
    <div class="ms-auto d-flex align-items-center gap-2">
      <!-- âœ… è¿½åŠ ï¼šå…¨ã‚µã‚¤ãƒˆä¸€æ‹¬ enqueue ãƒœã‚¿ãƒ³ -->
      <button id="enqueueAllBtn" class="btn btn-sm btn-primary">å…¨ã‚µã‚¤ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²</button>
      <span id="enqueueAllOut" class="mini-label text-muted"></span>
      <button id="capacityRefresh" class="btn btn-sm btn-ghost">å†è¨ˆæ¸¬</button>
    </div>
  </div>

  <div class="guide mb-3">
    <strong class="me-2">ã‚¬ã‚¤ãƒ‰</strong>
    å·¦å´ã®<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰</strong>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã â†’ è¡¨ç¤ºã•ã‚ŒãŸ<strong>ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰ã®ã€Œå†…éƒ¨SEOé–‹å§‹ã€</strong>ã‚’æŠ¼ã™ã ã‘ã€‚<br>
    è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸‹ã®<strong>ã€Œé«˜åº¦ãªè¨­å®šã€</strong>ã§å¿…è¦ãªæ™‚ã ã‘é–‹ã„ã¦ç·¨é›†ã§ãã¾ã™ã€‚
  </div>

  <!-- å‡¦ç†ä½™åŠ›ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <div class="section-title mb-0">âš¡ ç¾åœ¨ã®å‡¦ç†ä½™åŠ›</div>
        <span id="capacityText" class="pill pill-blue ms-2">è¨ˆæ¸¬ä¸­â€¦</span>
      </div>
      <div class="progress">
        <div id="capacityBar" class="progress-bar bg-secondary" role="progressbar" style="width:0%">0%</div>
      </div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center">
        <div class="section-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚µã‚¤ãƒˆ</div>
        <div class="ms-auto mini-label">æ¤œç´¢ã¯å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¥åŠ›ã‚’ä½¿ç”¨</div>
      </div>
      <div id="ownersAccordion" class="accordion mt-3">
        <!-- ã“ã“ã«ã‚ªãƒ¼ãƒŠãƒ¼æ¯ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’JSã§æŒ¿å…¥ -->
        <div class="text-muted" id="ownersEmpty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
    </div>
  </div>

  <!-- é«˜åº¦ãªè¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <button class="btn btn-sm btn-ghost" type="button" data-bs-toggle="collapse" data-bs-target="#advSettings" aria-expanded="false">
        âš™ï¸ é«˜åº¦ãªè¨­å®šï¼ˆé–‹ãã¨ç·¨é›†ã§ãã¾ã™ï¼‰
      </button>
      <div class="collapse mt-3" id="advSettings">
        <div class="row g-2">
          <div class="col-6 col-md-2"><div class="mini-label">pages</div>
            <input type="number" id="batchPages" class="form-control form-control-sm" value="{{ request.args.get('pages', 10) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">per_page</div>
            <input type="number" id="batchPerPage" class="form-control form-control-sm" value="{{ request.args.get('per_page', 100) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">min_score</div>
            <input type="number" step="0.01" id="batchMinScore" class="form-control form-control-sm" value="{{ request.args.get('min_score', 0.05) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">max_k</div>
            <input type="number" id="batchMaxK" class="form-control form-control-sm" value="{{ request.args.get('max_k', 80) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">limit_sources</div>
            <input type="number" id="batchLimitSources" class="form-control form-control-sm" value="{{ request.args.get('limit_sources', 200) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">limit_posts</div>
            <input type="number" id="batchLimitPosts" class="form-control form-control-sm" value="{{ request.args.get('limit_posts', 50) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">incremental</div>
            <select id="batchIncremental" class="form-select form-select-sm">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
        <div class="mini-label mt-2">
          â€» ã“ã“ã§è¨­å®šã—ãŸå€¤ã¯ã€ä»¥å¾Œã®ã€Œå†…éƒ¨SEOé–‹å§‹ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®é€ä¿¡å€¤ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- å®Ÿè¡Œå±¥æ­´ï¼ˆç°¡æ½”ç‰ˆï¼‰ -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <div class="section-title">ğŸ“œ å®Ÿè¡Œå±¥æ­´</div>
        <div class="ms-auto d-flex align-items-end gap-2">
          <div>
            <div class="mini-label">Site ID</div>
            <input type="number" id="siteIdInput" class="form-control form-control-sm" style="width:120px" placeholder="Site ID">
          </div>
          <div>
            <div class="mini-label">ä»¶æ•°</div>
            {% set pp = per_page or 50 %}
            <select id="perPageSelect" class="form-select form-select-sm" style="width:110px">
              {% for n in [25,50,100,200] %}
                <option value="{{ n }}" {% if pp==n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>
          <button id="applyFilterBtn" class="btn btn-sm btn-primary">å†é©ç”¨</button>
          <button id="clearFilterBtn" class="btn btn-sm btn-ghost">ã‚¯ãƒªã‚¢</button>
          <a class="btn btn-sm btn-ghost" href="/admin/internal-seo/detail" target="_blank">è©³ç´°ãƒ­ã‚°ã‚’é–‹ã</a>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:72px">ID</th>
              <th style="width:72px">Site</th>
              <th style="width:110px">Status</th>
              <th style="width:120px">Kind</th>
              <th>Started</th>
              <th>Ended</th>
              <th style="width:120px">Duration(ms)</th>
              <th style="width:140px">è©³ç´°</th>
            </tr>
          </thead>
          <tbody id="runsBody">
            <tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex mt-2">
        <button id="loadMoreBtn" class="btn btn-sm btn-ghost ms-auto d-none" type="button">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å®Ÿè¡Œè©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <div id="statsBody" class="small font-monospace"><div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div></div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-ghost" id="goDetailLink" href="#" target="_blank">è©³ç´°ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ====================== Utils ======================
function esc(v){ if(v===null||v===undefined) return ''; return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
function fmtLocal(iso){ if(!iso) return '-'; try{const d=new Date(iso);const p=x=>String(x).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`}catch(e){return iso}}
function getCsrf(){ return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' }
function badge(st){ if(st==='success') return '<span class="badge bg-success">success</span>'; if(st==='running') return '<span class="badge bg-info text-dark">running</span>'; if(st==='error') return '<span class="badge bg-danger">error</span>'; return `<span class="badge bg-secondary">${esc(st||'-')}</span>` }

// ====================== Capacity ======================
async function refreshCapacity(){
  try{
    const r = await fetch('/admin/internal-seo/capacity',{headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const c = await r.json();
    const run=c.running??0, max=c.max_parallel??1, q=c.queued??0, avail=c.available??Math.max(0,max-run);
    const pct = Math.round(100*(run/Math.max(1,max)));
    const bar = document.getElementById('capacityBar');
    bar.style.width=pct+'%'; bar.textContent=`${pct}%`;
    bar.classList.remove('bg-success','bg-warning','bg-danger','bg-secondary');
    if(pct<=50) bar.classList.add('bg-success'); else if(pct<=80) bar.classList.add('bg-warning'); else bar.classList.add('bg-danger');
    document.getElementById('capacityText').textContent=`max:${max} / running:${run} / queued:${q} / available:${avail} / suggest:${c.suggest_batch_size}`;
  }catch(e){
    const bar=document.getElementById('capacityBar'); bar.style.width='0%'; bar.textContent='N/A'; bar.classList.remove('bg-success','bg-warning','bg-danger'); bar.classList.add('bg-secondary');
    document.getElementById('capacityText').textContent='å–å¾—å¤±æ•—: '+e.message;
  }
}
setInterval(refreshCapacity,15000);

// ====================== å…¨ã‚µã‚¤ãƒˆä¸€æ‹¬ enqueue ======================
async function enqueueAll(){
  const btn = document.getElementById('enqueueAllBtn');
  const out = document.getElementById('enqueueAllOut');

  // é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé«˜åº¦ãªè¨­å®šã‹ã‚‰æ‹¾ã†ï¼‰
  const payload = {
    pages:         Number(document.getElementById('batchPages')?.value || 10),
    per_page:      Number(document.getElementById('batchPerPage')?.value || 100),
    min_score:     Number(document.getElementById('batchMinScore')?.value || 0.05),
    max_k:         Number(document.getElementById('batchMaxK')?.value || 80),
    limit_sources: Number(document.getElementById('batchLimitSources')?.value || 200),
    limit_posts:   Number(document.getElementById('batchLimitPosts')?.value || 50),
    incremental:   String(document.getElementById('batchIncremental')?.value || 'true')
  };

  btn.disabled = true; out.textContent = 'æŠ•å…¥ä¸­â€¦';
  try{
    const res = await fetch('/admin/internal-seo/enqueue-all', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        // Flask-WTF äº’æ›ã®CSRFãƒ˜ãƒƒãƒ€ï¼ˆã‚ãªãŸã®å®Ÿè£…ã«åˆã‚ã›ã¦ç‰‡æ–¹/ä¸¡æ–¹ä½¿ç”¨ï¼‰
        'X-CSRFToken': getCsrf(),
        'X-CSRF-Token': getCsrf(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.ok){
      out.textContent = `ç™»éŒ²æ•°: ${json.inserted} ä»¶`;
      // ä½™åŠ›ã¨ã‚­ãƒ¥ãƒ¼è¡¨ç¤ºã®åˆ·æ–°ã«å‚™ãˆã¦å³æ™‚å†è¨ˆæ¸¬
      refreshCapacity();
    }else{
      out.textContent = `å¤±æ•—: ${json.error || 'unknown error'}`;
    }
  }catch(e){
    out.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
  }finally{
    btn.disabled = false;
  }
}

// ====================== Owners (accordion) ======================
/**  ownerã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ³ãƒ—ãƒ¬    */
function ownerSectionHTML(o){
  const oid = o.id===null ? 'all' : o.id;
  return `
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="head-${oid}">
        <button class="accordion-button collapsed owner-header" type="button" data-bs-toggle="collapse" data-bs-target="#pane-${oid}" aria-expanded="false">
          <div class="w-100 d-flex align-items-center">
            <div class="fw-semibold">${esc(o.name)}</div>
            <div class="ms-3 mini-label">ã‚µã‚¤ãƒˆæ•° <span class="metric">${o.site_count}</span></div>
            <div class="ms-3 mini-label">ç¨¼åƒä¸­ <span class="metric">${o.running_count||0}</span></div>
            <div class="ms-auto d-flex align-items-center gap-2" style="max-width:360px">
              <input type="text" class="form-control form-control-sm" placeholder="ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å†…ã‚’æ¤œç´¢" data-owner-search="${oid}">
              <button class="btn btn-sm btn-ghost" data-owner-reload="${oid}">æ›´æ–°</button>
            </div>
          </div>
        </button>
      </h2>
      <div id="pane-${oid}" class="accordion-collapse collapse" data-owner-pane="${oid}">
        <div class="accordion-body">
          <div id="grid-${oid}" class="d-grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
            <div class="text-muted" data-owner-empty="${oid}">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
          </div>
          <div class="d-flex mt-2">
            <button class="btn btn-sm btn-ghost ms-auto d-none" type="button" data-owner-more="${oid}">ã‚‚ã£ã¨è¦‹ã‚‹</button>
          </div>
        </div>
      </div>
    </div>`;
}

/** ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰ */
function siteCardHTML(s){
  const m = s.metrics || {};
  const running = !!m.running;
  const last = m.last_run_status || '-';
  const progressDen = (m.applied||0) + (m.pending||0);
  const pct = progressDen ? Math.round(100 * (m.applied||0) / progressDen) : 0;
  return `
    <div class="gsc-card p-3 d-flex justify-content-between align-items-start">
      <div class="me-3">
        <div class="fw-semibold">${esc(s.name)} <span class="muted">#${s.id}</span></div>
        <div class="mini-label mt-1">
          åæ˜ æ¸ˆã¿: <span class="metric">${m.applied||0}</span>
          / ä¿ç•™: <span class="metric">${m.pending||0}</span>
          / ã‚¹ã‚­ãƒƒãƒ—: <span class="metric">${m.skipped||0}</span>
        </div>
        <div class="mini-label mt-1">
          æœ€çµ‚: ${badge(last)} / é–‹å§‹: ${esc(m.last_run_started_at? fmtLocal(m.last_run_started_at):'-')}
        </div>
        <div class="mt-2">
          <div class="progress" title="é€²æ—ï¼ˆåæ˜ æ¸ˆ/åæ˜ +ä¿ç•™ï¼‰">
            <div class="progress-bar" role="progressbar" style="width:${pct}%">${pct}%</div>
          </div>
        </div>
      </div>
      <div class="text-end">
        <form method="post" action="/admin/internal-seo/run" class="d-inline">
          <input type="hidden" name="csrf_token" value="${esc(getCsrf())}">
          <input type="hidden" name="site_id" value="${s.id}">
          <input type="hidden" name="pages" value="${document.getElementById('batchPages')?.value || 10}">
          <input type="hidden" name="per_page" value="${document.getElementById('batchPerPage')?.value || 100}">
          <input type="hidden" name="min_score" value="${document.getElementById('batchMinScore')?.value || 0.05}">
          <input type="hidden" name="max_k" value="${document.getElementById('batchMaxK')?.value || 80}">
          <input type="hidden" name="limit_sources" value="${document.getElementById('batchLimitSources')?.value || 200}">
          <input type="hidden" name="limit_posts" value="${document.getElementById('batchLimitPosts')?.value || 50}">
          <input type="hidden" name="incremental" value="${document.getElementById('batchIncremental')?.value || 'true'}">
          <button class="btn btn-sm ${running? 'btn-secondary disabled':'btn-outline-primary'}" type="submit" ${running? 'disabled':''}>
            ${running? 'å®Ÿè¡Œä¸­â€¦':'â–¶ å†…éƒ¨SEOé–‹å§‹'}
          </button>
        </form>
        <div class="mt-2">
          <a class="btn btn-sm btn-ghost" href="/admin/internal-seo/detail?site_id=${encodeURIComponent(s.id)}" target="_blank">è©³ç´°ãƒ­ã‚°</a>
        </div>
      </div>
    </div>`;
}

/** owneré…ä¸‹ã®ã‚µã‚¤ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¤œç´¢ãƒ»è¿½åŠ ãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰ */
async function loadSitesForOwner(ownerId, opts){
  const state = loadSitesForOwner.state || (loadSitesForOwner.state = {});
  const key = String(ownerId);
  const st = state[key] || (state[key] = {cursor: null, q:'', hasMore:true, loading:false});

  if(opts?.reset){ st.cursor=null; st.hasMore=true; document.querySelector(`#grid-${ownerId}`).innerHTML=''; }
  if(typeof opts?.q === 'string'){ st.q = opts.q.trim(); st.cursor=null; st.hasMore=true; document.querySelector(`#grid-${ownerId}`).innerHTML=''; }
  if(st.loading || !st.hasMore) return;

  st.loading = true;
  const params = new URLSearchParams();
  params.set('owner_id', ownerId==='all' ? '' : ownerId);
  params.set('limit','24');
  if(st.q) params.set('q', st.q);
  if(st.cursor) params.set('cursor_id', st.cursor);

  try{
    const res = await fetch(`/admin/internal-seo/sites?${params.toString()}`, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const list = data.rows || [];

    const grid = document.querySelector(`#grid-${ownerId}`);
    const empty = document.querySelector(`[data-owner-empty="${ownerId}"]`);
    if(empty) empty.remove();
    const tmp = document.createElement('div');
    const frag = document.createDocumentFragment();
    for(const s of list){ tmp.innerHTML = siteCardHTML(s); frag.appendChild(tmp.firstElementChild); }
    grid.appendChild(frag);

    st.cursor = data.next_cursor_id || null;
    st.hasMore = !!data.has_more;

    const moreBtn = document.querySelector(`[data-owner-more="${ownerId}"]`);
    moreBtn.classList.toggle('d-none', !st.hasMore);
  }catch(e){
    const grid = document.querySelector(`#grid-${ownerId}`);
    const err = document.createElement('div'); err.className='text-danger'; err.textContent='ã‚µã‚¤ãƒˆå–å¾—å¤±æ•—: '+e.message;
    grid.appendChild(err);
    st.hasMore=false;
  }finally{ st.loading=false; }
}

/** ã‚ªãƒ¼ãƒŠãƒ¼ä¸€è¦§ãƒ­ãƒ¼ãƒ‰ï¼†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åˆæœŸåŒ– */
async function loadOwners(){
  const cont = document.getElementById('ownersAccordion');
  const empty = document.getElementById('ownersEmpty');
  if(empty) empty.textContent='èª­ã¿è¾¼ã¿ä¸­â€¦';

  try{
    const r = await fetch('/admin/internal-seo/owners',{headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    const owners = data.rows || [];

    if(empty) empty.remove();
    const tmp = document.createElement('div');
    const frag = document.createDocumentFragment();
    for(const o of owners){
      tmp.innerHTML = ownerSectionHTML(o);
      const el = tmp.firstElementChild;
      frag.appendChild(el);

      // å±•é–‹æ™‚ã«åˆå›ãƒ­ãƒ¼ãƒ‰
      const pane = el.querySelector('[data-owner-pane]');
      pane.addEventListener('shown.bs.collapse', () => {
        const oid = pane.getAttribute('data-owner-pane');
        loadSitesForOwner(oid, {reset:true});
      });

      // æ¤œç´¢
      el.querySelector('[data-owner-search]').addEventListener('keydown', (ev)=>{
        if(ev.key==='Enter'){ ev.preventDefault(); loadSitesForOwner(pane.getAttribute('data-owner-pane'), {q: ev.target.value}); }
      });
      // æ›´æ–°
      el.querySelector('[data-owner-reload]').addEventListener('click', ()=>{
        const q = el.querySelector('[data-owner-search]').value;
        loadSitesForOwner(pane.getAttribute('data-owner-pane'), {q, reset:true});
      });
      // ã‚‚ã£ã¨è¦‹ã‚‹
      el.querySelector('[data-owner-more]').addEventListener('click', ()=>{
        loadSitesForOwner(pane.getAttribute('data-owner-pane'));
      });
    }
    cont.appendChild(frag);
  }catch(e){
    if(empty) empty.textContent = 'ã‚ªãƒ¼ãƒŠãƒ¼å–å¾—å¤±æ•—: '+e.message;
  }
}

// ====================== Runs (history) ======================
let nextCursorTs=null, nextCursorId=null, runsLoading=false, runsReachedEnd=false;
async function loadRuns(initial=false){
  if(runsLoading||runsReachedEnd) return; runsLoading=true;
  const tbody=document.getElementById('runsBody'); const ph=document.getElementById('placeholderRow'); if(ph) ph.remove();
  const params=new URLSearchParams();
  const siteId=document.getElementById('siteIdInput')?.value||''; const perPage=document.getElementById('perPageSelect')?.value||'50';
  if(siteId) params.set('site_id', siteId); params.set('limit', perPage);
  if(!initial && nextCursorTs && nextCursorId){ params.set('cursor_ts', nextCursorTs); params.set('cursor_id', nextCursorId); }
  try{
    const res=await fetch(`/admin/internal-seo/list?${params.toString()}`,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); const rows=data.rows||[]; const frag=document.createDocumentFragment();
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.id}</td>
        <td>${r.site_id}</td>
        <td>${badge(r.status)}</td>
        <td class="text-muted">${esc(r.job_kind||'')}</td>
        <td>${fmtLocal(r.started_at)}</td>
        <td>${fmtLocal(r.ended_at)}</td>
        <td>${r.duration_ms??'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-run-id="${r.id}" data-site-id="${r.site_id}" onclick="openStatsModal(this)">è©³ç´°</button>
          <a class="btn btn-sm btn-ghost" href="/admin/internal-seo/detail?site_id=${encodeURIComponent(r.site_id)}" target="_blank">ãƒ­ã‚°ä¸€è¦§</a>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    nextCursorTs=data.next_cursor_ts||null; nextCursorId=data.next_cursor_id||null; runsReachedEnd=!data.has_more;
    document.getElementById('loadMoreBtn').classList.toggle('d-none', runsReachedEnd);
  }catch(e){
    const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="8" class="text-danger">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</td>`; tbody.appendChild(tr); runsReachedEnd=true;
  }finally{ runsLoading=false; }
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
async function openStatsModal(btn){
  const runId=btn.getAttribute('data-run-id'); const siteId=btn.getAttribute('data-site-id');
  const body=document.getElementById('statsBody'); body.innerHTML='<div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try{
    const res=await fetch(`/admin/internal-seo/run/${runId}/stats`,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); const s=(data&&data.stats)||{}; const rows=[];
    const row = (t,o)=>{ const kv=Object.entries(o||{}).map(([k,v])=>`<tr><th class="w-25">${esc(k)}</th><td>${esc(typeof v==='object'?JSON.stringify(v):v)}</td></tr>`).join(''); return `<tr class="table-active"><th colspan="2">${esc(t)}</th></tr>${kv}` }
    if(s.indexer) rows.push(row('Indexer',s.indexer));
    if(s.link_graph) rows.push(row('LinkGraph',s.link_graph));
    if(s.planner) rows.push(row('Planner',s.planner));
    if(s.applier) rows.push(row('Applier',s.applier));
    if(s.params) rows.push(row('Params',s.params));
    body.innerHTML = rows.length ? `<table class="table table-sm mb-0"><tbody>${rows.join('')}</tbody></table>` : '<div class="text-muted">è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    document.getElementById('goDetailLink').href=`/admin/internal-seo/detail?site_id=${encodeURIComponent(siteId)}&run_id=${encodeURIComponent(runId)}`;
  }catch(e){ body.innerHTML=`<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`; }
  new bootstrap.Modal(document.getElementById('statsModal')).show();
}

// ====================== Init ======================
document.addEventListener('DOMContentLoaded', ()=>{
  // capacity
  refreshCapacity();
  document.getElementById('capacityRefresh').addEventListener('click', refreshCapacity);

  // âœ… å…¨ã‚µã‚¤ãƒˆä¸€æ‹¬ enqueue
  document.getElementById('enqueueAllBtn').addEventListener('click', enqueueAll);

  // owners & sites
  loadOwners();

  // runs
  loadRuns(true);
  document.getElementById('loadMoreBtn').addEventListener('click', ()=>loadRuns(false));
  document.getElementById('applyFilterBtn').addEventListener('click', ()=>{
    nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });
  document.getElementById('clearFilterBtn').addEventListener('click', ()=>{
    document.getElementById('siteIdInput').value='';
    nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });
});
</script>
{% endblock %}
