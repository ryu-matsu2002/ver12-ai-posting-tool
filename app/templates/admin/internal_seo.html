{% extends "admin/base.html" %}
{% block title %}内部SEO 管理{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <h3 class="mb-3">内部SEO 管理</h3>

  <!-- 絞り込み -->
  <form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="{{ url_for('admin.admin_internal_seo_index') }}">
    <div class="col-auto">
      <label class="form-label">Site</label>
      <select name="site_id" class="form-select">
        <option value="">すべて</option>
        {% for s in sites %}
          <option value="{{ s.id }}" {% if selected_site_id==s.id %}selected{% endif %}>
            {{ s.id }}: {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">絞り込み</button>
      {% if selected_site_id %}
        <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_internal_seo_index') }}">解除</a>
      {% endif %}
    </div>
  </form>

  <!-- 手動実行 -->
  <form class="row gy-2 gx-2 align-items-end mb-4" method="post" action="{{ url_for('admin.admin_internal_seo_run') }}">
    {{ csrf_token() if csrf_token is defined }}
    <div class="col-auto">
      <label class="form-label">実行 Site</label>
      <select name="site_id" class="form-select" required>
        {% for s in sites %}
          <option value="{{ s.id }}" {% if selected_site_id==s.id %}selected{% endif %}>
            {{ s.id }}: {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">pages</label>
      <input type="number" name="pages" class="form-control" value="{{ request.args.get('pages', 10) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">per_page</label>
      <input type="number" name="per_page" class="form-control" value="{{ request.args.get('per_page', 100) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">min_score</label>
      <input type="number" step="0.01" name="min_score" class="form-control" value="{{ request.args.get('min_score', 0.05) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">max_k</label>
      <input type="number" name="max_k" class="form-control" value="{{ request.args.get('max_k', 80) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">limit_sources</label>
      <input type="number" name="limit_sources" class="form-control" value="{{ request.args.get('limit_sources', 200) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">limit_posts</label>
      <input type="number" name="limit_posts" class="form-control" value="{{ request.args.get('limit_posts', 50) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">incremental</label>
      <select name="incremental" class="form-select">
        <option value="true" selected>true</option>
        <option value="false">false</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-success">手動実行（非同期）</button>
    </div>
  </form>

  <!-- 実行履歴 -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Site</th>
          <th>Status</th>
          <th>Kind</th>
          <th>Started</th>
          <th>Ended</th>
          <th>Duration(ms)</th>
          <th>Index</th>
          <th>Graph</th>
          <th>Plan</th>
          <th>Apply</th>
        </tr>
      </thead>
      <tbody>
        {% for r in runs %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.site_id }}</td>
          <td>
            {% if r.status == 'success' %}
              <span class="badge bg-success">success</span>
            {% elif r.status == 'running' %}
              <span class="badge bg-info text-dark">running</span>
            {% elif r.status == 'error' %}
              <span class="badge bg-danger">error</span>
            {% else %}
              <span class="badge bg-secondary">{{ r.status }}</span>
            {% endif %}
          </td>
          <td>{{ r.job_kind }}</td>
          <td>{{ r.started_at }}</td>
          <td>{{ r.ended_at or '-' }}</td>
          <td>{{ r.duration_ms or '-' }}</td>
          <td>
            {% set s = (r.stats or {}).get('indexer') %}
            {% if s %} p={{ s.get('processed') }} / u={{ s.get('created_or_updated') }} {% else %}-{% endif %}
          </td>
          <td>
            {% set s = (r.stats or {}).get('link_graph') %}
            {% if s %} src={{ s.get('sources') }} / e={{ s.get('edges_upserted') }} {% else %}-{% endif %}
          </td>
          <td>
            {% set s = (r.stats or {}).get('planner') %}
            {% if s %} plan={{ s.get('planned') }} / proc={{ s.get('processed') }} {% else %}-{% endif %}
          </td>
          <td>
            {% set s = (r.stats or {}).get('applier') %}
            {% if s %} ok={{ s.get('applied') }} / posts={{ s.get('processed_posts') }} {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
