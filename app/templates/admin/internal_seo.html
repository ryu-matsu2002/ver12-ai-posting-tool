{% extends "base_admin.html" %}
{% block title %}å†…éƒ¨SEO ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- CSRFï¼ˆJSç”¨ï¼‰ -->
  <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined }}">

  <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼æ¡ˆå†… ===== -->
  <div class="d-flex align-items-center mb-3">
    <h1 class="h5 mb-0">ğŸ”§ å†…éƒ¨SEO ç®¡ç†</h1>
    <button id="capacityRefresh" class="btn btn-sm btn-outline-primary ms-auto">å†è¨ˆæ¸¬</button>
  </div>

  <div class="alert alert-light border d-flex align-items-center py-2 small mb-3" role="alert">
    <span class="me-2">ğŸ“˜</span>
    <div>ä¸‹ã®<strong>ã‚µã‚¤ãƒˆæ¤œç´¢</strong>ã§ã‚«ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã¿ã€ãƒã‚§ãƒƒã‚¯ã§é¸æŠ â†’ å³ä¸Šã®<strong>é¸æŠã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œ</strong>ã€‚è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€Œé«˜åº¦ãªè¨­å®šã€ã‚’é–‹ãã¨ç·¨é›†ã§ãã¾ã™ã€‚</div>
  </div>

  <!-- ===== ä¸Šéƒ¨ï¼šæ¤œç´¢ãƒ»å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒ»å®¹é‡ ===== -->
  <div class="row g-3 align-items-stretch mb-4">
    <!-- æ¤œç´¢ï¼†å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="col-12 col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label mb-1 small">ğŸ” ã‚µã‚¤ãƒˆæ¤œç´¢ï¼ˆã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’å³æ™‚ãƒ•ã‚£ãƒ«ã‚¿ï¼‰</label>
              <div class="d-flex gap-2">
                <input id="siteSearchInput" type="text" class="form-control form-control-sm" placeholder="ã‚µã‚¤ãƒˆå ã¾ãŸã¯ IDï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰">
                <button id="siteSearchBtn" class="btn btn-sm btn-primary">æ¤œç´¢</button>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label mb-1 small">ğŸ“Œ å±¥æ­´ã®çµã‚Šè¾¼ã¿ Site ID</label>
              <input type="number" id="siteIdInput" class="form-control form-control-sm" placeholder="ä¾‹: 12" value="{{ selected_site_id or '' }}">
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label mb-1 small">ğŸ“„ å±¥æ­´ã®è¡¨ç¤ºä»¶æ•°</label>
              {% set pp = per_page or 50 %}
              <select id="perPageSelect" class="form-select form-select-sm">
                {% for n in [25,50,100,200] %}
                  <option value="{{ n }}" {% if pp==n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end gap-2">
              <button id="applyFilterBtn" class="btn btn-sm btn-outline-primary w-100">å±¥æ­´ã«é©ç”¨</button>
              <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary w-100">ã‚¯ãƒªã‚¢</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å®¹é‡ã‚²ãƒ¼ã‚¸ -->
    <div class="col-12 col-lg-5">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <h6 class="mb-0">âš¡ ç¾åœ¨ã®å‡¦ç†ä½™åŠ›</h6>
            <span id="capacityText" class="badge bg-light text-muted ms-2">è¨ˆæ¸¬ä¸­â€¦</span>
          </div>
          <div class="progress" style="height:14px">
            <div id="capacityBar" class="progress-bar bg-secondary" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ã¾ã¨ã‚å®Ÿè¡Œï¼ˆGSCã‚«ãƒ¼ãƒ‰é¢¨ï¼‰ ===== -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆstickyï¼‰ -->
      <div class="d-flex align-items-center mb-2 position-sticky top-0" style="z-index:1">
        <div class="fw-semibold">âœ… é¸æŠã‚µã‚¤ãƒˆã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œ</div>
        <small class="text-muted ms-2">ï¼ˆææ¡ˆãƒãƒƒãƒã‚µã‚¤ã‚ºã¯å®¹é‡ã‚²ãƒ¼ã‚¸ã‚’åæ˜ ï¼‰</small>
        <button id="runBatchBtn" class="btn btn-success btn-sm ms-auto">é¸æŠã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œ</button>
      </div>

      <!-- é«˜åº¦ãªè¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
      <details class="mb-3">
        <summary class="small text-muted" style="cursor:pointer">âš™ï¸ é«˜åº¦ãªè¨­å®šï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>
        <div class="row g-2 align-items-end mt-2">
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">pages</label>
            <input type="number" id="batchPages" class="form-control form-control-sm" value="{{ request.args.get('pages', 10) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">per_page</label>
            <input type="number" id="batchPerPage" class="form-control form-control-sm" value="{{ request.args.get('per_page', 100) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">min_score</label>
            <input type="number" step="0.01" id="batchMinScore" class="form-control form-control-sm" value="{{ request.args.get('min_score', 0.05) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">max_k</label>
            <input type="number" id="batchMaxK" class="form-control form-control-sm" value="{{ request.args.get('max_k', 80) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">limit_sources</label>
            <input type="number" id="batchLimitSources" class="form-control form-control-sm" value="{{ request.args.get('limit_sources', 200) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">limit_posts</label>
            <input type="number" id="batchLimitPosts" class="form-control form-control-sm" value="{{ request.args.get('limit_posts', 50) }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1 small">incremental</label>
            <select id="batchIncremental" class="form-select form-select-sm">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
      </details>

      <!-- ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒƒãƒ€ -->
      <div class="d-flex align-items-center mb-2">
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="checkAllSites">
          <label for="checkAllSites" class="form-check-label small">ã™ã¹ã¦é¸æŠï¼è§£é™¤</label>
        </div>
        <div class="small text-muted ms-auto">
          <span id="visibleCount">0</span> ä»¶è¡¨ç¤ºï¼ˆå…¨ <span id="totalCount">{{ sites|length }}</span> ä»¶ï¼‰
        </div>
      </div>

      <!-- ã‚µã‚¤ãƒˆä¸€è¦§ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ -->
      <div id="sitesBody" class="d-grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));">
        {% for s in sites %}
          <div class="site-card p-3 bg-white rounded border shadow-sm d-flex justify-content-between align-items-start"
               data-id="{{ s.id }}" data-name="{{ (s.name or '')|lower }}">
            <div class="me-3">
              <div class="d-flex align-items-center gap-2 mb-1">
                <input class="form-check-input site-check" type="checkbox" value="{{ s.id }}" id="site-{{ s.id }}">
                <label class="form-check-label fw-semibold" for="site-{{ s.id }}" style="cursor:pointer;">
                  {{ s.name }}
                </label>
              </div>
              <div class="text-muted small">ID: <span class="fw-semibold">{{ s.id }}</span></div>
            </div>
            <div class="text-end">
              <form method="post" action="{{ url_for('admin.admin_internal_seo_run') }}" class="d-inline">
                {{ csrf_token() if csrf_token is defined }}
                <input type="hidden" name="site_id" value="{{ s.id }}">
                <input type="hidden" name="pages" value="{{ request.args.get('pages', 10) }}">
                <input type="hidden" name="per_page" value="{{ request.args.get('per_page', 100) }}">
                <input type="hidden" name="min_score" value="{{ request.args.get('min_score', 0.05) }}">
                <input type="hidden" name="max_k" value="{{ request.args.get('max_k', 80) }}">
                <input type="hidden" name="limit_sources" value="{{ request.args.get('limit_sources', 200) }}">
                <input type="hidden" name="limit_posts" value="{{ request.args.get('limit_posts', 50) }}">
                <input type="hidden" name="incremental" value="true">
                <button class="btn btn-outline-primary btn-sm" type="submit">â–¶ ã“ã®ã‚µã‚¤ãƒˆã ã‘å®Ÿè¡Œ</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <div id="batchResult" class="small text-muted mt-2"></div>
    </div>
  </div>

  <!-- ===== å®Ÿè¡Œå±¥æ­´ ===== -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <h6 class="mb-0">ğŸ“œ å®Ÿè¡Œå±¥æ­´</h6>
        <a class="btn btn-sm btn-outline-secondary ms-auto" href="/admin/internal-seo/detail" target="_blank">è©³ç´°ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:72px">ID</th>
              <th style="width:72px">Site</th>
              <th style="width:110px">Status</th>
              <th style="width:120px">Kind</th>
              <th>Started</th>
              <th>Ended</th>
              <th style="width:120px">Duration(ms)</th>
              <th style="width:140px">è©³ç´°</th>
            </tr>
          </thead>
          <tbody id="runsBody">
            <tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex mt-2">
        <button id="loadMoreBtn" class="btn btn-sm btn-outline-secondary ms-auto d-none" type="button">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- å®Ÿè¡Œè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å®Ÿè¡Œè©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <div id="statsBody" class="small text-monospace">
          <div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary" id="goDetailLink" href="#" target="_blank">è©³ç´°ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ===== ã¡ã‚‡ã„CSSï¼ˆã‚«ãƒ¼ãƒ‰ã®é›°å›²æ°—ã‚’GSCå¯„ã‚Šã«ï¼‰ =====
document.head.insertAdjacentHTML('beforeend', `
  <style>
    .site-card { border-left: 4px solid #e5e7eb; transition: box-shadow .15s, border-color .15s, transform .05s;}
    .site-card:hover { border-left-color:#3b82f6; box-shadow: 0 6px 18px rgba(59,130,246,.14); }
    .badge.bg-light { border: 1px solid #e5e7eb; }
  </style>
`);

// ===== Util =====
function fmtLocal(iso){ if(!iso) return '-'; try{const d=new Date(iso);const p=x=>String(x).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}catch(e){return iso;}}
function esc(v){ if(v===null||v===undefined) return ''; return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function statusBadge(st){ if(st==='success')return'<span class="badge bg-success">success</span>'; if(st==='running')return'<span class="badge bg-info text-dark">running</span>'; if(st==='error')return'<span class="badge bg-danger">error</span>'; return `<span class="badge bg-secondary">${esc(st||'-')}</span>`;}

// ===== å®¹é‡ =====
async function refreshCapacity(){
  try{
    const r=await fetch('/admin/internal-seo/capacity',{headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const c=await r.json();
    const run=c.running??0, max=c.max_parallel??1, q=c.queued??0;
    const pct=Math.round(100*(run/Math.max(1,max)));
    const bar=document.getElementById('capacityBar');
    bar.style.width=pct+'%'; bar.textContent=`${pct}%`; bar.className='progress-bar';
    if(pct<=50) bar.classList.add('bg-success'); else if(pct<=80) bar.classList.add('bg-warning'); else bar.classList.add('bg-danger');
    document.getElementById('capacityText').textContent=`max:${max} / running:${run} / queued:${q} / available:${Math.max(0,max-run)} / suggest:${c.suggest_batch_size}`;
    document.getElementById('runBatchBtn').dataset.suggest=c.suggest_batch_size??1;
  }catch(e){
    const bar=document.getElementById('capacityBar'); bar.style.width='0%'; bar.textContent='N/A'; bar.className='progress-bar bg-secondary';
    document.getElementById('capacityText').textContent='å–å¾—å¤±æ•—: '+e.message;
  }
}
setInterval(refreshCapacity,15000);

// ===== ã‚µã‚¤ãƒˆæ¤œç´¢ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ï¼‰ =====
function updateVisibleCount(){
  const cards=[...document.querySelectorAll('#sitesBody .site-card')];
  const visible=cards.filter(c=>c.style.display!=='none').length;
  document.getElementById('visibleCount').textContent=visible;
}
function applySiteFilter(){
  const q=(document.getElementById('siteSearchInput').value||'').toLowerCase().trim();
  document.querySelectorAll('#sitesBody .site-card').forEach(card=>{
    const name=(card.dataset.name||'').toLowerCase();
    const idStr=String(card.dataset.id||'');
    const ok=!q || name.includes(q) || idStr.includes(q);
    card.style.display= ok ? '' : 'none';
  });
  document.getElementById('checkAllSites').checked=false;
  updateVisibleCount();
}
// ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚§ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ æ“ä½œã¯é™¤å¤–ï¼‰
document.addEventListener('click', (ev)=>{
  const card=ev.target.closest('.site-card'); if(!card) return;
  if(ev.target.closest('form')||['BUTTON','A','INPUT','LABEL','SELECT'].includes(ev.target.tagName)) return;
  const cb=card.querySelector('.site-check'); cb.checked=!cb.checked;
});

// å…¨é¸æŠï¼ˆè¡¨ç¤ºä¸­ã®ã¿ï¼‰
document.getElementById('checkAllSites').addEventListener('change', (e)=>{
  const checked=e.target.checked;
  document.querySelectorAll('#sitesBody .site-card').forEach(card=>{
    if(card.style.display==='none') return;
    const cb=card.querySelector('.site-check'); cb.checked=checked;
  });
});

// ===== ä¸€æ‹¬å®Ÿè¡Œ =====
async function runBatch(){
  const ids=[...document.querySelectorAll('#sitesBody .site-card')]
    .filter(c=>c.style.display!=='none')
    .map(c=>c.querySelector('.site-check'))
    .filter(cb=>cb && cb.checked)
    .map(cb=>parseInt(cb.value,10))
    .filter(Boolean);
  if(!ids.length){ document.getElementById('batchResult').textContent='ã‚µã‚¤ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; return; }

  const suggest=parseInt(document.getElementById('runBatchBtn').dataset.suggest||'5',10);
  const picked=ids.slice(0,Math.max(1,suggest));
  const payload={
    site_ids:picked,
    pages:parseInt(document.getElementById('batchPages').value||'10',10),
    per_page:parseInt(document.getElementById('batchPerPage').value||'100',10),
    min_score:parseFloat(document.getElementById('batchMinScore').value||'0.05'),
    max_k:parseInt(document.getElementById('batchMaxK').value||'80',10),
    limit_sources:parseInt(document.getElementById('batchLimitSources').value||'200',10),
    limit_posts:parseInt(document.getElementById('batchLimitPosts').value||'50',10),
    incremental:String(document.getElementById('batchIncremental').value||'true')!=='false',
  };

  const btn=document.getElementById('runBatchBtn');
  btn.disabled=true; btn.textContent='ç™»éŒ²ä¸­â€¦';
  try{
    const res=await fetch('/admin/internal-seo/run-batch',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(!res.ok || !data.ok) throw new Error(data.error||`HTTP ${res.status}`);
    document.getElementById('batchResult').textContent=`ç™»éŒ²: ${data.enqueued} ä»¶ / ã‚¹ã‚­ãƒƒãƒ—: ${data.skipped?.length||0} / ã‚¨ãƒ©ãƒ¼: ${data.errors?.length||0}`;
    refreshCapacity();
  }catch(e){
    document.getElementById('batchResult').textContent='å¤±æ•—: '+e.message;
  }finally{
    btn.disabled=false; btn.textContent='é¸æŠã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œ';
  }
}

// ===== å®Ÿè¡Œå±¥æ­´ï¼ˆAJAXï¼‰ =====
let nextCursorTs=null, nextCursorId=null, runsLoading=false, runsReachedEnd=false;
function escHtml(s){return s==null?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
async function loadRuns(initial=false){
  if(runsLoading||runsReachedEnd) return; runsLoading=true;
  const tbody=document.getElementById('runsBody'); document.getElementById('placeholderRow')?.remove();

  const p=new URLSearchParams();
  const siteId=document.getElementById('siteIdInput')?.value||''; const perPage=document.getElementById('perPageSelect')?.value||'50';
  if(siteId) p.set('site_id',siteId); p.set('limit',perPage);
  if(!initial && nextCursorTs && nextCursorId){ p.set('cursor_ts',nextCursorTs); p.set('cursor_id',nextCursorId); }

  try{
    const r=await fetch(`/admin/internal-seo/list?${p.toString()}`,{headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`HTTP ${r.status}`); const data=await r.json();
    const frag=document.createDocumentFragment();
    (data.rows||[]).forEach(row=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${row.id}</td>
        <td>${row.site_id}</td>
        <td>${statusBadge(row.status)}</td>
        <td class="text-muted">${escHtml(row.job_kind||'')}</td>
        <td>${fmtLocal(row.started_at)}</td>
        <td>${fmtLocal(row.ended_at)}</td>
        <td>${row.duration_ms ?? '-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-run-id="${row.id}" data-site-id="${row.site_id}" onclick="openStatsModal(this)">è©³ç´°</button>
          <a class="btn btn-sm btn-outline-secondary" href="/admin/internal-seo/detail?site_id=${encodeURIComponent(row.site_id)}" target="_blank">ãƒ­ã‚°ä¸€è¦§</a>
        </td>`;
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
    nextCursorTs=data.next_cursor_ts||null; nextCursorId=data.next_cursor_id||null; runsReachedEnd=!data.has_more;
    document.getElementById('loadMoreBtn').classList.toggle('d-none',runsReachedEnd);
  }catch(e){
    const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="8" class="text-danger">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</td>`; tbody.appendChild(tr); runsReachedEnd=true;
  }finally{ runsLoading=false; }
}

// è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
async function openStatsModal(btn){
  const runId=btn.getAttribute('data-run-id'); const siteId=btn.getAttribute('data-site-id');
  const body=document.getElementById('statsBody'); body.innerHTML='<div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try{
    const r=await fetch(`/admin/internal-seo/run/${runId}/stats`,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data=await r.json(); const s=(data&&data.stats)||{}; const seg=[];
    function segRows(title,obj){ if(!obj) return ''; const kv=Object.entries(obj).map(([k,v])=>`<tr><th class="w-25">${escHtml(k)}</th><td>${escHtml(typeof v==='object'?JSON.stringify(v):v)}</td></tr>`).join(''); return `<tr class="table-active"><th colspan="2">${escHtml(title)}</th></tr>${kv}`;}
    if(s.indexer) seg.push(segRows('Indexer',s.indexer)); if(s.link_graph) seg.push(segRows('LinkGraph',s.link_graph)); if(s.planner) seg.push(segRows('Planner',s.planner)); if(s.applier) seg.push(segRows('Applier',s.applier)); if(s.params) seg.push(segRows('Params',s.params));
    body.innerHTML= seg.length ? `<table class="table table-sm"><tbody>${seg.join('')}</tbody></table>` : '<div class="text-muted">è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    document.getElementById('goDetailLink').href=`/admin/internal-seo/detail?site_id=${encodeURIComponent(siteId)}&run_id=${encodeURIComponent(runId)}`;
  }catch(e){ body.innerHTML=`<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`; }
  new bootstrap.Modal(document.getElementById('statsModal')).show();
}

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', ()=>{
  refreshCapacity();
  document.getElementById('capacityRefresh').addEventListener('click', refreshCapacity);

  // æ¤œç´¢
  const apply=()=>applySiteFilter();
  document.getElementById('siteSearchBtn').addEventListener('click', apply);
  document.getElementById('siteSearchInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); apply(); } });
  applySiteFilter(); // åˆå›

  // å±¥æ­´
  loadRuns(true);
  document.getElementById('loadMoreBtn').addEventListener('click', ()=>loadRuns(false));
  document.getElementById('applyFilterBtn').addEventListener('click', ()=>{
    nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });
  document.getElementById('clearFilterBtn').addEventListener('click', ()=>{
    document.getElementById('siteIdInput').value=''; nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });

  // ä¸€æ‹¬å®Ÿè¡Œ
  document.getElementById('runBatchBtn').addEventListener('click', e=>{ e.preventDefault(); runBatch(); });

  // ä»¶æ•°è¡¨ç¤º
  updateVisibleCount();
});
</script>
{% endblock %}
