{% extends "admin/base.html" %}
{% block title %}内部SEO 管理{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <h3 class="mb-3">内部SEO 管理</h3>

  <!-- 絞り込み -->
  <form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="{{ url_for('admin.admin_internal_seo_index') }}">
    <div class="col-auto">
      <label class="form-label">Site</label>
      <select name="site_id" class="form-select">
        <option value="">すべて</option>
        {% for s in sites %}
          <option value="{{ s.id }}" {% if selected_site_id==s.id %}selected{% endif %}>
            {{ s.id }}: {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label">表示件数</label>
      {% set pp = per_page or 50 %}
      <select name="per_page" class="form-select">
        {% for n in [25,50,100,200] %}
          <option value="{{ n }}" {% if pp==n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <button class="btn btn-primary">絞り込み</button>
      {% if selected_site_id or (pagination and pagination.page>1) %}
        <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_internal_seo_index') }}">解除</a>
      {% endif %}
    </div>
  </form>

  <!-- 手動実行 -->
  <form class="row gy-2 gx-2 align-items-end mb-4" method="post" action="{{ url_for('admin.admin_internal_seo_run') }}">
    {{ csrf_token() if csrf_token is defined }}
    <div class="col-auto">
      <label class="form-label">実行 Site</label>
      <select name="site_id" class="form-select" required>
        {% for s in sites %}
          <option value="{{ s.id }}" {% if selected_site_id==s.id %}selected{% endif %}>
            {{ s.id }}: {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">pages</label>
      <input type="number" name="pages" class="form-control" value="{{ request.args.get('pages', 10) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">per_page</label>
      <input type="number" name="per_page" class="form-control" value="{{ request.args.get('per_page', 100) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">min_score</label>
      <input type="number" step="0.01" name="min_score" class="form-control" value="{{ request.args.get('min_score', 0.05) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">max_k</label>
      <input type="number" name="max_k" class="form-control" value="{{ request.args.get('max_k', 80) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">limit_sources</label>
      <input type="number" name="limit_sources" class="form-control" value="{{ request.args.get('limit_sources', 200) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">limit_posts</label>
      <input type="number" name="limit_posts" class="form-control" value="{{ request.args.get('limit_posts', 50) }}">
    </div>
    <div class="col-auto">
      <label class="form-label">incremental</label>
      <select name="incremental" class="form-select">
        <option value="true" selected>true</option>
        <option value="false">false</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-success">手動実行（非同期）</button>
    </div>
  </form>

  <!-- 実行履歴（軽量） -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th style="width:72px">ID</th>
          <th style="width:72px">Site</th>
          <th style="width:110px">Status</th>
          <th style="width:120px">Kind</th>
          <th>Started</th>
          <th>Ended</th>
          <th style="width:120px">Duration(ms)</th>
          <th style="width:90px">詳細</th>
        </tr>
      </thead>
      <tbody>
        {% for r in runs %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.site_id }}</td>
          <td>
            {% if r.status == 'success' %}
              <span class="badge bg-success">success</span>
            {% elif r.status == 'running' %}
              <span class="badge bg-info text-dark">running</span>
            {% elif r.status == 'error' %}
              <span class="badge bg-danger">error</span>
            {% else %}
              <span class="badge bg-secondary">{{ r.status }}</span>
            {% endif %}
          </td>
          <td class="text-muted">{{ r.job_kind }}</td>
          <td>
            <time class="dt" data-iso="{{ r.started_at.isoformat() if r.started_at }}">{{ r.started_at or '-' }}</time>
          </td>
          <td>
            <time class="dt" data-iso="{{ r.ended_at.isoformat() if r.ended_at }}">{{ r.ended_at or '-' }}</time>
          </td>
          <td>{{ r.duration_ms or '-' }}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary"
                    data-run-id="{{ r.id }}"
                    onclick="openStatsModal(this)">
              詳細
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ページング -->
  {% if pagination %}
  <nav class="mt-3 d-flex align-items-center gap-2">
    {% if pagination.has_prev %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('admin.admin_internal_seo_index', site_id=selected_site_id, page=pagination.prev_num, per_page=per_page) }}">← Prev</a>
    {% else %}
      <span class="btn btn-sm btn-outline-secondary disabled">← Prev</span>
    {% endif %}

    <span>Page {{ pagination.page }} / {{ pagination.pages or 1 }}</span>

    {% if pagination.has_next %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('admin.admin_internal_seo_index', site_id=selected_site_id, page=pagination.next_num, per_page=per_page) }}">Next →</a>
    {% else %}
      <span class="btn btn-sm btn-outline-secondary disabled">Next →</span>
    {% endif %}
  </nav>
  {% endif %}
</div>

<!-- 詳細モーダル -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">実行詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body">
        <div id="statsBody" class="small text-monospace">
          <div class="text-muted">読み込み中…</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// 軽量なローカル時刻表示
(() => {
  const nodes = document.querySelectorAll('time.dt[data-iso]');
  for (const n of nodes) {
    const iso = n.getAttribute('data-iso');
    if (!iso) continue;
    try {
      const d = new Date(iso);
      // YYYY-MM-DD HH:mm:ss (local)
      const pad = (x)=> String(x).padStart(2,'0');
      const s = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} `
              + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      n.textContent = s;
      n.title = iso;
    } catch(e) {}
  }
})();

// 詳細モーダル（必要時のみ stats を取得）
async function openStatsModal(btn) {
  const runId = btn.getAttribute('data-run-id');
  const body = document.getElementById('statsBody');
  body.innerHTML = '<div class="text-muted">読み込み中…</div>';

  // 推奨エンドポイント: GET /admin/internal-seo/run/<run_id>/stats → JSON
  // 例）{ ok:true, stats:{ indexer:{...}, link_graph:{...}, planner:{...}, applier:{...}, params:{...} } }
  const url = `/admin/internal-seo/run/${runId}/stats`;
  try {
    const res = await fetch(url, {headers: {'Accept': 'application/json'}});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data || !data.ok) {
      body.innerHTML = `<div class="text-danger">読み込み失敗: ${data && data.error || 'unknown'}</div>`;
    } else {
      const s = data.stats || {};
      // 表示最適化：存在するブロックだけを出す
      const rows = [];
      if (s.indexer) rows.push(renderRow('Indexer', s.indexer));
      if (s.link_graph) rows.push(renderRow('LinkGraph', s.link_graph));
      if (s.planner) rows.push(renderRow('Planner', s.planner));
      if (s.applier) rows.push(renderRow('Applier', s.applier));
      if (s.params) rows.push(renderRow('Params', s.params));

      body.innerHTML = rows.length
        ? `<table class="table table-sm">
             <tbody>${rows.join('')}</tbody>
           </table>`
        : '<div class="text-muted">詳細データなし</div>';
    }
  } catch (e) {
    body.innerHTML = `<div class="text-danger">エラー: ${e.message}</div>`;
  }

  // Bootstrap モーダルを開く
  const modal = new bootstrap.Modal(document.getElementById('statsModal'));
  modal.show();
}

function renderRow(title, obj) {
  // キー=値の簡易テーブル化
  const esc = (v) => {
    if (v === null || v === undefined) return '';
    return String(v)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  };
  const kv = Object.entries(obj).map(([k,v]) => {
    if (typeof v === 'object' && v !== null) v = JSON.stringify(v);
    return `<tr><th class="w-25">${esc(k)}</th><td>${esc(v)}</td></tr>`;
  }).join('');
  return `<tr class="table-active"><th colspan="2">${esc(title)}</th></tr>${kv}`;
}
</script>
{% endblock %}
