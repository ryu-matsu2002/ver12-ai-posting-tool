{% extends "base_admin.html" %}
{% block title %}å†…éƒ¨SEO ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid py-4 internal-seo">

  <!-- CSRFï¼ˆãƒãƒƒãƒ/å˜ç™ºã§ä½¿ç”¨ï¼‰ -->
  <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined }}">

  <!-- è»½é‡ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆGSCé¢¨ï¼‰ -->
  <style>
    .internal-seo .guide {
      background: #f7fbff; border: 1px solid #e3f0ff; border-left: 4px solid #0d6efd;
      border-radius: .5rem; padding: .75rem .9rem; color:#0b3d91; font-size: .95rem;
    }
    .internal-seo .gsc-card {
      border: 1px solid #e8eef5; background: #fff; border-radius: .75rem;
      box-shadow: 0 2px 8px rgba(16,24,40,.06); transition: box-shadow .15s ease, transform .12s ease;
    }
    .internal-seo .gsc-card:hover { box-shadow: 0 8px 20px rgba(13,110,253,.12); transform: translateY(-1px); }
    .internal-seo .section-title { font-weight: 600; color:#0d6efd; }
    .internal-seo .mini-label { font-size: .8rem; color:#6c757d; }
    .internal-seo .pill { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; }
    .internal-seo .pill-blue { background:#e7f1ff; color:#0d6efd; }
    .internal-seo .pill-green{ background:#eaf7ea; color:#198754; }
    .internal-seo .btn-ghost { border:1px solid #dee2e6; background:#fff; }
    .internal-seo .kbd { background:#f1f3f5; border:1px solid #dee2e6; border-bottom-width:2px; padding:.05rem .35rem; border-radius:.35rem; font-size:.75rem;}
    .internal-seo .owner-header { font-weight:600; }
    .internal-seo .metric { font-size:.8rem; color:#6b7280; }
    .internal-seo .metric b { color:#111827; }
    .internal-seo .progress { height: 10px; }
    .internal-seo .site-actions .badge { font-weight: 600; }
    .internal-seo .owner-toolbar { gap:.5rem; }
    .internal-seo .owner-toolbar .form-control, .owner-toolbar .form-select { height:32px; padding:.25rem .5rem; font-size:.875rem; }
    .internal-seo .owner-toolbar .btn { padding:.25rem .5rem; font-size:.875rem; }
    .internal-seo .owner-empty { color:#6c757d; }
  </style>

  <!-- è¦‹å‡ºã— -->
  <div class="d-flex align-items-center mb-3">
    <h2 class="h4 mb-0">ğŸ”§ å†…éƒ¨SEO ç®¡ç†</h2>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button id="capacityRefresh" class="btn btn-sm btn-ghost">å†è¨ˆæ¸¬</button>
    </div>
  </div>

  <!-- ã‚¬ã‚¤ãƒ‰ -->
  <div class="guide mb-3">
    <strong class="me-2">ã‚¬ã‚¤ãƒ‰</strong>
    å·¦å´ã®<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰</strong>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã â†’ è¡¨ç¤ºã•ã‚ŒãŸ<strong>ã‚µã‚¤ãƒˆã‚«ãƒ¼ãƒ‰ã®ã€Œå†…éƒ¨SEOé–‹å§‹ã€</strong>ã‚’æŠ¼ã™ã ã‘ã€‚<br>
    è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸‹ã®<strong>ã€Œé«˜åº¦ãªè¨­å®šã€</strong>ã‚’é–‹ãã¨ç·¨é›†ã§ãã¾ã™ã€‚
  </div>

  <!-- ç¾åœ¨ã®å‡¦ç†ä½™åŠ› -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <div class="section-title mb-0">âš¡ ç¾åœ¨ã®å‡¦ç†ä½™åŠ›</div>
        <span id="capacityText" class="pill pill-blue ms-2">è¨ˆæ¸¬ä¸­â€¦</span>
      </div>
      <div class="progress"><div id="capacityBar" class="progress-bar bg-secondary" role="progressbar" style="width:0%">0%</div></div>
    </div>
  </div>

  <!-- é«˜åº¦ãªè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‰ã˜ã‚‹ï¼‰ -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <a class="text-decoration-none d-inline-flex align-items-center" data-bs-toggle="collapse" href="#advancedPanel" role="button" aria-expanded="false" aria-controls="advancedPanel">
        <span class="me-2">ğŸ›  é«˜åº¦ãªè¨­å®š</span><span class="mini-label">(é–‹ãã¨ç·¨é›†ã§ãã¾ã™)</span>
      </a>

      <div class="collapse mt-3" id="advancedPanel">
        <div class="row g-2">
          <div class="col-6 col-md-2"><div class="mini-label">pages</div>
            <input type="number" id="batchPages" class="form-control form-control-sm" value="{{ request.args.get('pages', 10) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">per_page</div>
            <input type="number" id="batchPerPage" class="form-control form-control-sm" value="{{ request.args.get('per_page', 100) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">min_score</div>
            <input type="number" step="0.01" id="batchMinScore" class="form-control form-control-sm" value="{{ request.args.get('min_score', 0.05) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">max_k</div>
            <input type="number" id="batchMaxK" class="form-control form-control-sm" value="{{ request.args.get('max_k', 80) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">limit_sources</div>
            <input type="number" id="batchLimitSources" class="form-control form-control-sm" value="{{ request.args.get('limit_sources', 200) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">limit_posts</div>
            <input type="number" id="batchLimitPosts" class="form-control form-control-sm" value="{{ request.args.get('limit_posts', 50) }}">
          </div>
          <div class="col-6 col-md-2"><div class="mini-label">incremental</div>
            <select id="batchIncremental" class="form-select form-select-sm">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
        <div class="mini-label mt-1">â€» ã“ã“ã§è¨­å®šã—ãŸå€¤ã¯ã€å€‹åˆ¥å®Ÿè¡Œãƒ»ä¸€æ‹¬å®Ÿè¡Œã®ä¸¡æ–¹ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <!-- ã¾ã¨ã‚å®Ÿè¡Œãƒãƒ¼ -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
      <div class="section-title me-1">âœ… é¸æŠã‚µã‚¤ãƒˆã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œ</div>
      <div class="mini-label">ï¼ˆææ¡ˆæ•°ã¯ä½™åŠ›ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’åæ˜ ï¼‰</div>
      <div class="ms-auto">
        <button id="runBatchBtn" class="btn btn-success btn-sm">é¸æŠã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œ</button>
      </div>
      <div id="batchResult" class="mini-label ms-2"></div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
  <div class="accordion mb-4" id="ownersAccordion">
    <div class="text-muted small px-2 py-1">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <!-- å®Ÿè¡Œå±¥æ­´ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰ -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <div class="section-title">ğŸ“œ å®Ÿè¡Œå±¥æ­´</div>
        <div class="ms-auto d-flex align-items-center owner-toolbar">
          <input type="number" id="siteIdInput" class="form-control" placeholder="Site ID" style="width:120px">
          {% set pp = per_page or 50 %}
          <select id="perPageSelect" class="form-select" style="width:110px">
            {% for n in [25,50,100,200] %}<option value="{{ n }}" {% if pp==n %}selected{% endif %}>{{ n }}</option>{% endfor %}
          </select>
          <button id="applyFilterBtn" class="btn btn-primary">é©ç”¨</button>
          <button id="clearFilterBtn" class="btn btn-ghost">ã‚¯ãƒªã‚¢</button>
          <a class="btn btn-ghost" href="/admin/internal-seo/detail" target="_blank">è©³ç´°ãƒ­ã‚°ã‚’é–‹ã</a>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:72px">ID</th>
              <th style="width:72px">Site</th>
              <th style="width:110px">Status</th>
              <th style="width:120px">Kind</th>
              <th>Started</th>
              <th>Ended</th>
              <th style="width:120px">Duration(ms)</th>
              <th style="width:140px">è©³ç´°</th>
            </tr>
          </thead>
          <tbody id="runsBody">
            <tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex mt-2">
        <button id="loadMoreBtn" class="btn btn-sm btn-ghost ms-auto d-none" type="button">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å®Ÿè¡Œè©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <div id="statsBody" class="small text-monospace"><div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div></div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-ghost" id="goDetailLink" href="#" target="_blank">è©³ç´°ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
/* ========= Utils ========= */
function fmtLocal(iso){ if(!iso) return '-'; try{const d=new Date(iso); const p=x=>String(x).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`}catch(e){return iso}}
function esc(v){ if(v===null||v===undefined) return ''; return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
function statusBadge(st){ if(st==='success') return '<span class="badge bg-success">success</span>'; if(st==='running') return '<span class="badge bg-info text-dark">running</span>'; if(st==='error') return '<span class="badge bg-danger">error</span>'; return `<span class="badge bg-secondary">${esc(st||'-')}</span>` }
function getCsrfToken(){ return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '' }
function pct(a,b){ const t=Math.max(0,(a||0)+(b||0)); if(!t) return 0; return Math.round(100*(a||0)/t); }

/* ========= å®¹é‡ ========= */
let lastCapacity=null;
async function refreshCapacity(){
  try{
    const res=await fetch('/admin/internal-seo/capacity',{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const c=await res.json(); lastCapacity=c;
    const run=c.running??0, max=c.max_parallel??1, q=c.queued??0, avail=c.available??Math.max(0,max-run);
    const per=Math.round(100*(run/Math.max(1,max)));
    const bar=document.getElementById('capacityBar');
    bar.style.width=per+'%'; bar.textContent=`${per}%`;
    bar.classList.remove('bg-success','bg-warning','bg-danger','bg-secondary');
    if(per<=50) bar.classList.add('bg-success'); else if(per<=80) bar.classList.add('bg-warning'); else bar.classList.add('bg-danger');
    document.getElementById('capacityText').textContent=`max:${max} / running:${run} / queued:${q} / available:${avail} / suggest:${c.suggest_batch_size}`;
    document.getElementById('runBatchBtn').dataset.suggest=(c.suggest_batch_size??1);
  }catch(e){
    const bar=document.getElementById('capacityBar');
    bar.style.width='0%'; bar.textContent='N/A';
    bar.classList.remove('bg-success','bg-warning','bg-danger'); bar.classList.add('bg-secondary');
    document.getElementById('capacityText').textContent='å–å¾—å¤±æ•—: '+e.message;
  }
}
setInterval(refreshCapacity, 15000);

/* ========= ã‚ªãƒ¼ãƒŠãƒ¼ & ã‚µã‚¤ãƒˆï¼ˆæ–°è¦ï¼‰ ========= */
const ownersState = new Map(); // ownerId => {q:'', cursorId:null, loading:false, hasMore:true}

function ownerSkeleton(owner){
  const oid = owner.id===null ? 'all' : String(owner.id);
  return `
  <div class="accordion-item" id="owner-${oid}">
    <h2 class="accordion-header" id="heading-${oid}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${oid}" aria-expanded="false" aria-controls="collapse-${oid}">
        <span class="owner-header">ğŸ‘¤ ${esc(owner.name)}</span>
        <span class="ms-3 metric">ã‚µã‚¤ãƒˆæ•°: <b>${owner.site_count ?? '-'}</b></span>
        <span class="ms-3 metric">å®Ÿè¡Œä¸­: <b>${owner.running_count ?? 0}</b></span>
      </button>
    </h2>
    <div id="collapse-${oid}" class="accordion-collapse collapse" aria-labelledby="heading-${oid}" data-bs-parent="#ownersAccordion">
      <div class="accordion-body">
        <div class="d-flex align-items-center owner-toolbar mb-2">
          <div class="form-check me-2">
            <input class="form-check-input owner-checkall" type="checkbox" data-owner="${oid}" id="checkall-${oid}">
            <label class="form-check-label mini-label" for="checkall-${oid}">ã™ã¹ã¦é¸æŠ</label>
          </div>
          <input type="text" class="form-control owner-search" placeholder="ã‚µã‚¤ãƒˆå / ID" data-owner="${oid}" style="width:220px">
          <button class="btn btn-ghost owner-search-btn" data-owner="${oid}">æ¤œç´¢</button>
          <div class="ms-auto">
            <button class="btn btn-ghost btn-sm owner-loadmore d-none" data-owner="${oid}">ã‚‚ã£ã¨è¦‹ã‚‹</button>
          </div>
        </div>
        <div class="d-grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));" id="sites-${oid}">
          <div class="text-muted owner-empty">èª­ã¿è¾¼ã¿å¾…ã¡â€¦</div>
        </div>
      </div>
    </div>
  </div>`;
}

function siteCardHTML(s){
  const m = s.metrics || {};
  const csrf=getCsrfToken();
  const progress = pct(m.applied, m.pending);
  const running = m.running ? `<span class="badge bg-info text-dark ms-2">running</span>` : '';
  const last = m.last_run_status ? `${esc(m.last_run_status)} / ${fmtLocal(m.last_run_started_at)}` : '-';

  return `
  <div class="gsc-card p-3 d-flex flex-column justify-content-between">
    <div class="d-flex align-items-start justify-content-between">
      <div class="form-check">
        <input class="form-check-input site-check" type="checkbox" value="${s.id}" id="site-${s.id}">
        <label class="form-check-label fw-semibold" for="site-${s.id}">${esc(s.name)}</label>
      </div>
      ${running}
    </div>

    <div class="mt-2">
      <div class="mini-label">é€²æ—ï¼ˆapplied / pendingï¼‰</div>
      <div class="progress"><div class="progress-bar" role="progressbar" style="width:${progress}%">${progress}%</div></div>
      <div class="d-flex gap-3 mt-1 mini-label">
        <div>applied <b>${m.applied ?? 0}</b></div>
        <div>pending <b>${m.pending ?? 0}</b></div>
        <div>skipped <b>${m.skipped ?? 0}</b></div>
      </div>
      <div class="mini-label mt-1">æœ€çµ‚å®Ÿè¡Œ: ${last}</div>
    </div>

    <div class="d-flex justify-content-between mt-2 site-actions">
      <form method="post" action="/admin/internal-seo/run" class="d-inline">
        <input type="hidden" name="csrf_token" value="${esc(csrf)}">
        <input type="hidden" name="site_id" value="${s.id}">
        <input type="hidden" name="pages" value="${document.getElementById('batchPages')?.value || 10}">
        <input type="hidden" name="per_page" value="${document.getElementById('batchPerPage')?.value || 100}">
        <input type="hidden" name="min_score" value="${document.getElementById('batchMinScore')?.value || 0.05}">
        <input type="hidden" name="max_k" value="${document.getElementById('batchMaxK')?.value || 80}">
        <input type="hidden" name="limit_sources" value="${document.getElementById('batchLimitSources')?.value || 200}">
        <input type="hidden" name="limit_posts" value="${document.getElementById('batchLimitPosts')?.value || 50}">
        <input type="hidden" name="incremental" value="${document.getElementById('batchIncremental')?.value || 'true'}">
        <button class="btn btn-outline-primary btn-sm" type="submit">â–¶ å†…éƒ¨SEOé–‹å§‹</button>
      </form>
      <a class="btn btn-ghost btn-sm" href="/admin/internal-seo/detail?site_id=${encodeURIComponent(s.id)}" target="_blank">ãƒ­ã‚°</a>
    </div>
  </div>`;
}

async function fetchOwners(){
  const wrap = document.getElementById('ownersAccordion');
  wrap.innerHTML = '<div class="text-muted small px-2 py-1">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  let rows = [];
  try{
    const res = await fetch('/admin/internal-seo/owners', {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    rows = data.rows || [];
  }catch(e){
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ€ä½é™1ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    rows = [{id:null, name:'å…¨ã‚µã‚¤ãƒˆ', site_count:null, running_count:0}];
  }

  if(!rows.length){ wrap.innerHTML = '<div class="text-muted small px-2 py-1">å¯¾è±¡ãªã—</div>'; return; }

  const frag = document.createDocumentFragment();
  for(const owner of rows){
    const tmp = document.createElement('div');
    tmp.innerHTML = ownerSkeleton(owner);
    frag.appendChild(tmp.firstElementChild);
    ownersState.set(owner.id ?? 'all', { q:'', cursorId:null, loading:false, hasMore:true });
  }
  wrap.innerHTML = '';
  wrap.appendChild(frag);

  // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¤œç´¢/ã‚‚ã£ã¨è¦‹ã‚‹/å…¨é¸æŠï¼‰
  wrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.owner-search-btn');
    const more = e.target.closest('.owner-loadmore');
    const check = e.target.closest('.owner-checkall');
    if(btn){
      const oid = btn.dataset.owner;
      const input = wrap.querySelector(`.owner-search[data-owner="${oid}"]`);
      ownersState.get(oid).q = (input?.value || '').trim();
      fetchSitesForOwner(oid, true);
    }else if(more){
      const oid = more.dataset.owner;
      fetchSitesForOwner(oid, false);
    }else if(check){
      const oid = e.target.dataset.owner;
      const cont = wrap.querySelector(`#sites-${oid}`);
      cont?.querySelectorAll('.site-check').forEach(cb => cb.checked = e.target.checked);
    }
  });

  // æŠ˜ã‚ŠãŸãŸã¿ãŒé–‹ã„ãŸæ™‚ã«åˆå›èª­ã¿è¾¼ã¿
  rows.forEach(owner=>{
    const oid = owner.id ?? 'all';
    const el = document.getElementById(`collapse-${oid}`);
    el.addEventListener('shown.bs.collapse', ()=> fetchSitesForOwner(oid, true), {once:true});
  });
}

async function fetchSitesForOwner(ownerKey, reset){
  const state = ownersState.get(ownerKey);
  if(!state || state.loading) return;
  const cont = document.getElementById(`sites-${ownerKey}`);
  const moreBtn = document.querySelector(`.owner-loadmore[data-owner="${ownerKey}"]`);

  if(reset){
    state.cursorId = null; state.hasMore = true;
    cont.innerHTML = '<div class="text-muted owner-empty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  }
  if(!state.hasMore) return;

  state.loading = true;
  const params = new URLSearchParams();
  if(state.q) params.set('q', state.q);
  if(ownerKey !== 'all') params.set('owner_id', ownerKey);
  params.set('limit', '24');
  if(state.cursorId) params.set('cursor_id', state.cursorId);

  try{
    const res = await fetch(`/admin/internal-seo/sites?${params.toString()}`, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const list = data.rows || [];
    const frag = document.createDocumentFragment();
    const tmp = document.createElement('div');
    cont.querySelector('.owner-empty')?.remove();
    if(!list.length && !state.cursorId){
      cont.innerHTML = '<div class="owner-empty">ã‚µã‚¤ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
    }
    for(const s of list){ tmp.innerHTML = siteCardHTML(s); frag.appendChild(tmp.firstElementChild); }
    cont.appendChild(frag);
    state.cursorId = data.next_cursor_id || null;
    state.hasMore = !!data.has_more;
    moreBtn?.classList.toggle('d-none', !state.hasMore);
  }catch(e){
    cont.innerHTML = `<div class="text-danger">ã‚µã‚¤ãƒˆå–å¾—å¤±æ•—: ${esc(e.message)}</div>`;
    state.hasMore = false;
    moreBtn?.classList.add('d-none');
  }finally{
    state.loading = false;
  }
}

/* ========= ã¾ã¨ã‚å®Ÿè¡Œ ========= */
async function runBatch(){
  const ids = Array.from(document.querySelectorAll('.site-check:checked'))
    .map(cb => parseInt(cb.value,10)).filter(Boolean);
  if(!ids.length){ document.getElementById('batchResult').textContent = 'ã‚µã‚¤ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; return; }
  const suggest=parseInt(document.getElementById('runBatchBtn').dataset.suggest||'5',10);
  const picked=ids.slice(0, Math.max(1, suggest));
  const payload={
    site_ids:picked,
    pages:parseInt(document.getElementById('batchPages')?.value||'10',10),
    per_page:parseInt(document.getElementById('batchPerPage')?.value||'100',10),
    min_score:parseFloat(document.getElementById('batchMinScore')?.value||'0.05'),
    max_k:parseInt(document.getElementById('batchMaxK')?.value||'80',10),
    limit_sources:parseInt(document.getElementById('batchLimitSources')?.value||'200',10),
    limit_posts:parseInt(document.getElementById('batchLimitPosts')?.value||'50',10),
    incremental:String(document.getElementById('batchIncremental')?.value||'true')!=='false',
  };
  const btn=document.getElementById('runBatchBtn'); btn.disabled=true; btn.textContent='ç™»éŒ²ä¸­â€¦';
  try{
    const res=await fetch('/admin/internal-seo/run-batch',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json(); if(!res.ok||!data.ok) throw new Error(data.error||`HTTP ${res.status}`);
    document.getElementById('batchResult').textContent=`ç™»éŒ²: ${data.enqueued} / ã‚¹ã‚­ãƒƒãƒ—: ${data.skipped?.length||0} / ã‚¨ãƒ©ãƒ¼: ${data.errors?.length||0}`;
    refreshCapacity();
  }catch(e){
    document.getElementById('batchResult').textContent='å¤±æ•—: '+e.message;
  }finally{
    btn.disabled=false; btn.textContent='é¸æŠã‚µã‚¤ãƒˆã‚’å®Ÿè¡Œ';
  }
}

/* ========= å±¥æ­´ ========= */
let nextCursorTs=null, nextCursorId=null, runsLoading=false, runsReachedEnd=false;
async function loadRuns(initial=false){
  if(runsLoading||runsReachedEnd) return; runsLoading=true;
  const tbody=document.getElementById('runsBody'); const ph=document.getElementById('placeholderRow'); if(ph) ph.remove();
  const params=new URLSearchParams(); const siteId=document.getElementById('siteIdInput')?.value||''; const perPage=document.getElementById('perPageSelect')?.value||'50';
  if(siteId) params.set('site_id', siteId); params.set('limit', perPage);
  if(!initial && nextCursorTs && nextCursorId){ params.set('cursor_ts', nextCursorTs); params.set('cursor_id', nextCursorId); }
  try{
    const res=await fetch(`/admin/internal-seo/list?${params.toString()}`,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); const rows=data.rows||[]; const frag=document.createDocumentFragment();
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.id}</td>
        <td>${r.site_id}</td>
        <td>${statusBadge(r.status)}</td>
        <td class="text-muted">${esc(r.job_kind||'')}</td>
        <td>${fmtLocal(r.started_at)}</td>
        <td>${fmtLocal(r.ended_at)}</td>
        <td>${r.duration_ms??'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-run-id="${r.id}" data-site-id="${r.site_id}" onclick="openStatsModal(this)">è©³ç´°</button>
          <a class="btn btn-sm btn-ghost" href="/admin/internal-seo/detail?site_id=${encodeURIComponent(r.site_id)}" target="_blank">ãƒ­ã‚°ä¸€è¦§</a>
        </td>`;
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    nextCursorTs=data.next_cursor_ts||null; nextCursorId=data.next_cursor_id||null; runsReachedEnd=!data.has_more;
    document.getElementById('loadMoreBtn').classList.toggle('d-none', runsReachedEnd);
  }catch(e){
    const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="8" class="text-danger">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</td>`; tbody.appendChild(tr); runsReachedEnd=true;
  }finally{ runsLoading=false; }
}

async function openStatsModal(btn){
  const runId=btn.getAttribute('data-run-id'); const siteId=btn.getAttribute('data-site-id');
  const body=document.getElementById('statsBody'); body.innerHTML='<div class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try{
    const res=await fetch(`/admin/internal-seo/run/${runId}/stats`,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); const s=(data&&data.stats)||{}; const rows=[];
    const render=(t,o)=>{ const kv=Object.entries(o||{}).map(([k,v])=>`<tr><th class="w-25">${esc(k)}</th><td>${esc(typeof v==='object'?JSON.stringify(v):v)}</td></tr>`).join(''); return `<tr class="table-active"><th colspan="2">${esc(t)}</th></tr>${kv}`; }
    if(s.indexer) rows.push(render('Indexer',s.indexer));
    if(s.link_graph) rows.push(render('LinkGraph',s.link_graph));
    if(s.planner) rows.push(render('Planner',s.planner));
    if(s.applier) rows.push(render('Applier',s.applier));
    if(s.params) rows.push(render('Params',s.params));
    body.innerHTML = rows.length ? `<table class="table table-sm mb-0"><tbody>${rows.join('')}</tbody></table>` : '<div class="text-muted">è©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    document.getElementById('goDetailLink').href=`/admin/internal-seo/detail?site_id=${encodeURIComponent(siteId)}&run_id=${encodeURIComponent(runId)}`;
  }catch(e){ body.innerHTML=`<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`; }
  new bootstrap.Modal(document.getElementById('statsModal')).show();
}

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  refreshCapacity();
  document.getElementById('capacityRefresh').addEventListener('click', refreshCapacity);

  fetchOwners(); // â† ã“ã‚ŒãŒæ–°UIã®å¿ƒè‡“

  // å±¥æ­´
  loadRuns(true);
  document.getElementById('loadMoreBtn').addEventListener('click', ()=>loadRuns(false));
  document.getElementById('applyFilterBtn').addEventListener('click', ()=>{
    nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });
  document.getElementById('clearFilterBtn').addEventListener('click', ()=>{
    document.getElementById('siteIdInput').value=''; nextCursorTs=null; nextCursorId=null; runsReachedEnd=false;
    document.getElementById('runsBody').innerHTML='<tr id="placeholderRow"><td colspan="8" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    loadRuns(true);
  });

  document.getElementById('runBatchBtn').addEventListener('click', (e)=>{ e.preventDefault(); runBatch(); });
});
</script>
{% endblock %}
