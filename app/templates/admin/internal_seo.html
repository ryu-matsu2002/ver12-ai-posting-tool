{% extends "base_admin.html" %}
{% block title %}内部SEO ダッシュボード{% endblock %}

{% block content %}
<div class="container-fluid py-4 internal-seo">
  <style>
    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    .kpi{background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(20,20,40,.05)}
    .kpi h4{font-size:13px;margin:0;color:#6b7280;letter-spacing:.2px}
    .kpi .v{font-size:28px;font-weight:800;margin-top:6px;color:#111827}
    .section{margin-top:24px}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(20,20,40,.05)}
    .muted{color:#6b7280}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid #eef1f6;font-size:14px;vertical-align:middle}
    .tag{display:inline-block;font-size:12px;border-radius:999px;padding:2px 10px;border:1px solid #e5e7eb}
    .tag.idle{background:#fafafa}
    .tag.queued{background:#fff7ed;border-color:#fed7aa}
    .tag.running{background:#ecfeff;border-color:#a5f3fc}
    .logs{max-height:520px;overflow:auto}
    .log-item{display:grid;grid-template-columns:140px 140px 1fr 110px 110px 110px;gap:10px;padding:10px 0;border-bottom:1px solid #f1f5f9}
    .log-item .ts{font-variant-numeric:tabular-nums}
    .toolbar{gap:8px}
    @media (max-width: 1200px){
      .kpi-grid{grid-template-columns:repeat(2,1fr)}
      .log-item{grid-template-columns:140px 120px 1fr 90px 90px 90px}
    }
    @media (max-width: 700px){
      .kpi-grid{grid-template-columns:1fr}
      .log-item{grid-template-columns:1fr;row-gap:4px}
    }
  </style>

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">内部SEO ダッシュボード</h2>
    <div class="d-flex align-items-center toolbar">
      <label class="me-2 muted">期間:</label>
      <select id="days" class="form-select d-inline-block" style="width:auto">
        <option value="7"  {% if days==7  %}selected{% endif %}>過去7日</option>
        <option value="14" {% if days==14 %}selected{% endif %}>過去14日</option>
        <option value="30" {% if days==30 %}selected{% endif %}>過去30日</option>
      </select>
      <button id="reloadAll" class="btn btn-outline-primary btn-sm">再読み込み</button>
    </div>
  </div>

  <!-- KPI -->
  <div class="kpi-grid">
    <div class="kpi"><h4>登録サイト数</h4><div class="v" id="k_total">-</div></div>
    <div class="kpi"><h4>キュー中</h4><div class="v" id="k_queued">-</div></div>
    <div class="kpi"><h4>実行中</h4><div class="v" id="k_running">-</div></div>
    <div class="kpi"><h4>本日の適用リンク数</h4><div class="v" id="k_applied_today">-</div></div>
  </div>

  <!-- 期間合計（H内除去/旧仕様削除） -->
  <div class="section card">
    <div class="row">
      <div class="col-md-6">
        <div class="muted">Hタグ内リンク除去（期間合計）</div>
        <div class="v" id="k_removed_h">-</div>
      </div>
      <div class="col-md-6">
        <div class="muted">旧仕様リンク削除（期間合計）</div>
        <div class="v" id="k_legacy_removed">-</div>
      </div>
    </div>
    <div class="muted mt-2">※ 期間は上部セレクタで切替（デフォルト7日）</div>
  </div>

  <!-- 各ユーザー × 各サイトの進捗 -->
  <div class="section card">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h4 class="mb-0">ユーザー別 × サイト別 進捗</h4>
      <input id="progressSearch" type="search" class="form-control" placeholder="ユーザー/サイトで絞り込み" style="max-width:280px">
    </div>
    <div class="table-responsive">
      <table class="table" id="progressTable">
        <thead>
          <tr>
            <th style="width:180px">ユーザー</th>
            <th style="width:260px">サイト</th>
            <th style="width:160px">直近実行</th>
            <th style="width:130px;text-align:right">適用リンク</th>
            <th style="width:130px;text-align:right">スキップ</th>
            <th style="width:160px;text-align:right">H内除去</th>
            <th style="width:160px;text-align:right">旧仕様削除</th>
            <th style="width:110px">状態</th>
          </tr>
        </thead>
        <tbody id="progressTbody">
          <tr><td class="muted" colspan="8">読み込み中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- リアルタイムログ（ポーリング更新） -->
  <div class="section card">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h4 class="mb-0">リアルタイムログ</h4>
      <div class="d-flex align-items-center" style="gap:8px">
        <label class="muted">自動更新:</label>
        <select id="autoInterval" class="form-select" style="width:auto">
          <option value="0">停止</option>
          <option value="3000" selected>3秒</option>
          <option value="5000">5秒</option>
          <option value="10000">10秒</option>
        </select>
        <button id="refreshLogs" class="btn btn-outline-secondary btn-sm">今すぐ更新</button>
      </div>
    </div>
    <div class="logs" id="logs"></div>
  </div>
</div>

<script>
(function(){
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const daysSel = $("#days");
  const reloadAllBtn = $("#reloadAll");
  const progressSearch = $("#progressSearch");
  const logsBox = $("#logs");
  const refreshLogsBtn = $("#refreshLogs");
  const autoSel = $("#autoInterval");

  let logsLatestISO = null; // 直近ログの created_at ISO を保持（増分取得用）
  let autoTimer = null;
  let progressCache = [];   // クライアント側フィルタ用

  daysSel.addEventListener("change", ()=> location.href = `?days=${daysSel.value}`);
  reloadAllBtn.addEventListener("click", ()=> loadAll(true));
  refreshLogsBtn.addEventListener("click", ()=> loadLogs(true));
  autoSel.addEventListener("change", ()=>{
    if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
    const ms = parseInt(autoSel.value, 10);
    if(ms>0){
      autoTimer = setInterval(()=> loadLogs(false), ms);
    }
  });

  progressSearch.addEventListener("input", ()=>{
    renderProgress(progressCache, progressSearch.value.trim().toLowerCase());
  });

  async function loadKpis(){
    const r = await fetch(`/admin/internal-seo/kpis?days={{days}}`);
    const j = await r.json();
    $("#k_total").textContent = (j.total_sites||0).toLocaleString();
    $("#k_queued").textContent = (j.queued_sites||0).toLocaleString();
    $("#k_running").textContent = (j.running_sites||0).toLocaleString();
    $("#k_applied_today").textContent = (j.applied_today||0).toLocaleString();
    $("#k_removed_h").textContent = (j.removed_in_h_total||0).toLocaleString();
    $("#k_legacy_removed").textContent = (j.legacy_removed_total||0).toLocaleString();
  }

  async function loadProgress(){
    const r = await fetch(`/admin/internal-seo/progress?days={{days}}`);
    const j = await r.json();
    progressCache = j.rows || [];
    renderProgress(progressCache, progressSearch.value.trim().toLowerCase());
  }

  function renderProgress(rows, q){
    const tb = $("#progressTbody");
    tb.innerHTML = "";
    let filtered = rows;
    if(q){
      filtered = rows.filter(r =>
        (r.username||"").toLowerCase().includes(q) ||
        (r.site_name||"").toLowerCase().includes(q)
      );
    }
    if(filtered.length===0){
      tb.innerHTML = `<tr><td class="muted" colspan="8">該当データがありません</td></tr>`;
      return;
    }
    for(const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.username||"-")}</td>
        <td>${escapeHtml(r.site_name||"-")}</td>
        <td>${r.last_run_at ? `<span class="ts">${escapeHtml(r.last_run_at)}</span>` : '<span class="muted">-</span>'}</td>
        <td style="text-align:right">${(r.applied_links||0).toLocaleString()}</td>
        <td style="text-align:right">${(r.skipped_count||0).toLocaleString()}</td>
        <td style="text-align:right">${(r.removed_in_headings||0).toLocaleString()}</td>
        <td style="text-align:right">${(r.legacy_removed||0).toLocaleString()}</td>
        <td>${renderStatusTag(r.queue_status)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderStatusTag(st){
    const s = (st||"idle").toLowerCase();
    return `<span class="tag ${s}">${s}</span>`;
  }

  async function loadLogs(forceFull){
    const params = new URLSearchParams();
    params.set("limit", forceFull || !logsLatestISO ? "80" : "80");
    if(!forceFull && logsLatestISO){
      params.set("since", logsLatestISO);
    }
    const r = await fetch(`/admin/internal-seo/logs?${params.toString()}`);
    const j = await r.json();
    const logs = j.logs || [];
    if(logs.length===0) return;

    // 新しいものから返ってくる想定（id DESC）
    // 画面には上から新しい順で表示
    const frag = document.createDocumentFragment();
    for(const it of logs){
      const div = document.createElement("div");
      div.className = "log-item";
      div.innerHTML = `
        <div class="ts">${escapeHtml(it.created_at)}</div>
        <div>${escapeHtml(it.username||"-")}</div>
        <div><strong>${escapeHtml(it.site_name||"-")}</strong><br><span class="muted">${escapeHtml(it.status||"")}${it.reason?`：${escapeHtml(it.reason)}`:""}</span></div>
        <div>適用 ${Number(it.applied_links||0).toLocaleString()}</div>
        <div>H除去 ${Number(it.removed_in_headings||0).toLocaleString()}</div>
        <div>旧削除 ${Number(it.legacy_removed||0).toLocaleString()}</div>
      `;
      frag.appendChild(div);
    }
    // 先頭に挿入
    logsBox.prepend(frag);

    // 最新時刻を記録（次回は増分取得）
    logsLatestISO = logs[0].created_at;
    // 古すぎる表示は切る（視認性のため 2,000件程度で刈り込み）
    const MAX_NODES = 2000;
    const nodes = logsBox.children;
    if(nodes.length > MAX_NODES){
      for(let i=MAX_NODES;i<nodes.length;i++){
        nodes[i].remove();
      }
    }
  }

  function escapeHtml(s){
    if(s==null) return "";
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  async function loadAll(forceFull){
    await Promise.all([
      loadKpis(),
      loadProgress(),
      loadLogs(forceFull)
    ]);
  }

  // 初期ロード
  loadAll(true).then(()=>{
    // 自動更新（ログのみ）
    const ms = parseInt(autoSel.value,10);
    if(ms>0){
      autoTimer = setInterval(()=> loadLogs(false), ms);
    }
  });
})();
</script>
{% endblock %}
