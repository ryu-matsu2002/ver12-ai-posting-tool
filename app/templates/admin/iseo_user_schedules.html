{% extends "base_admin.html" %}
{% block title %}内部SEO ダッシュボード{% endblock %}

{% block content %}
<!-- templates/admin/iseo_user_schedules.html -->
<div class="container-fluid py-4">
  <h1 style="font-size:22px;margin:0 0 12px;">内部SEOスケジュール（ユーザー別）</h1>

  <style>
    :root{
      --bd:#e5e7eb; --muted:#6b7280; --bg:#f8fafc; --chip:#eef2ff;
      --ok:#137333; --okbg:#e6f4ea; --info:#1967d2; --infobg:#e8f0fe;
      --warn:#7a5d00; --warnbg:#fff4ce; --idle:#444; --idleb:#f1f3f4;
      --err:#c5221f; --errbg:#fde7e9; --txt:#111827; --primary:#2563eb;
      --primary-ghost:#eff6ff; --accent:#10b981;
    }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:14px 0; }
    .toolbar .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .search { padding:8px 12px; border:1px solid var(--bd); border-radius:8px; width:280px; background:#fff; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--bd); background:#fff; color:var(--txt); cursor:pointer; }
    .btn:hover { background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.04); }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .btn-primary { background:var(--primary); color:#fff; border-color:var(--primary); }

    table { width:100%; border-collapse:separate; border-spacing:0; margin-top:8px; background:#fff; border:1px solid var(--bd); border-radius:12px; overflow:hidden; }
    th, td { border-bottom:1px solid #f1f5f9; padding:10px 8px; text-align:left; font-size:14px; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; white-space:nowrap; } /* ヘッダーは常に1行 */
    tr:last-child td { border-bottom:0; }

    .badge { display:inline-block; padding:2px 10px; border-radius:9999px; font-size:12px; font-weight:600; }
    .s-running { background: var(--okbg); color: var(--ok); }
    .s-queued  { background: var(--infobg); color: var(--info); }
    .s-paused  { background: var(--warnbg); color: var(--warn); }
    .s-idle    { background: var(--idleb); color: var(--idle); }
    .s-error   { background: var(--errbg); color: var(--err); }

    .muted { color: var(--muted); font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .nowrap { white-space: nowrap; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .row-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { display:inline-block; padding:3px 10px; border-radius:9999px; background:var(--chip); font-size:12px; }

    /* 1行だけ省略表示 */
    .truncate-1 {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      overflow: hidden;
      max-width: 420px;
    }

    .kpis { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:10px; margin: 8px 0; }
    .kpi { border:1px solid var(--bd); border-radius:12px; padding:12px; background:#fff;}
    .kpi h3{margin:0; font-size:12px; color:var(--muted);}
    .kpi .v{margin-top:6px; font-weight:800; font-size:20px;}
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 640px){ .kpis{grid-template-columns: 1fr;} .truncate-1{max-width:220px;} }

    .btn-mini { padding:6px 10px; border-radius:8px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
    .btn-mini.primary { background:var(--primary); color:#fff; border-color:var(--primary); }
  </style>

  <!-- KPI -->
  <div class="kpis" id="kpis">
    <div class="kpi"><h3>内部SEO対象ユーザー数</h3><div class="v" id="k_users">-</div></div>
    <div class="kpi"><h3>内部リンク待ちの記事数</h3><div class="v" id="k_pending">-</div></div>
    <div class="kpi"><h3>これまでに追加された内部リンク数</h3><div class="v" id="k_applied24">-</div></div>
    <div class="kpi"><h3>これまでにSEO処理した記事数</h3><div class="v" id="k_processed24">-</div></div>
  </div>

  <!-- 上部の操作ボタン群は削除：検索と更新のみ -->
  <div class="toolbar">
    <div class="right">
      <input id="search" class="search" type="search" placeholder="名前で絞り込み…"/>
      <label class="muted"><input type="checkbox" id="auto-refresh" checked> 自動更新（10秒）</label>
      <button id="btn-refresh" class="btn btn-primary">最新表示に更新</button>
    </div>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th style="width:32px;"><input type="checkbox" id="check-all"></th>
        <th>ユーザー</th>
        <th>状態</th>
        <th class="num">保留記事数</th>
        <th class="num">予測消化日数</th>
        <th>最終実行</th>
        <th>次回予定</th>
        <th>直近実行の結果</th>
        <th>累計実績</th>
        <th>直近のエラー</th>
        <th>Preview</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- 初期表示：列数12に合わせたプレースホルダを1行だけ表示 -->
      <tr><td colspan="12" class="muted">読み込み中…</td></tr>
    </tbody>
  </table>

  <script>
    // ---- CSRF ----
    function getMetaCsrf() {
      const m = document.querySelector('meta[name="csrf-token"]');
      return m ? m.getAttribute('content') : null;
    }
    function getCookie(name) {
      return document.cookie.split('; ').reduce((prev, c) => {
        const [k, v] = c.split('=');
        return k === name ? decodeURIComponent(v) : prev;
      }, null);
    }
    function csrfToken() {
      return getMetaCsrf() || getCookie('csrf_token') || getCookie('csrf-token') || null;
    }
    function fetchJSON(url, opts = {}) {
      const headers = Object.assign({'Content-Type': 'application/json'}, opts.headers || {});
      const token = csrfToken();
      if (token) headers['X-CSRFToken'] = token;
      return fetch(url, Object.assign({}, opts, { headers }));
    }

    // ---- 状態 ----
    let items = [];
    let filtered = [];
    let timer = null;

    const tbody = document.getElementById('tbody');
    const search = document.getElementById('search');
    const btnRefresh = document.getElementById('btn-refresh');
    const autoRefresh = document.getElementById('auto-refresh');
    const checkAll = document.getElementById('check-all');

    // KPI要素
    const kUsers = document.getElementById('k_users');
    const kPending = document.getElementById('k_pending');
    const kApplied24 = document.getElementById('k_applied24');
    const kProcessed24 = document.getElementById('k_processed24');

    // ---- レンダリング ----
    function fmtTime(s) {
      if (!s) return '<span class="muted">-</span>';
      try {
        const d = new Date(s);
        const z = d.toLocaleString('ja-JP', { hour12: false });
        return `<span class="nowrap">${z}</span>`;
      } catch { return s; }
    }
    function badgeJa(status) {
      const map = { running:'実行中', queued:'待機中', paused:'一時停止', idle:'待機', error:'エラー' };
      const cls = {
        running:'s-running', queued:'s-queued', paused:'s-paused', idle:'s-idle', error:'s-error'
      }[status] || 's-idle';
      return `<span class="badge ${cls}">${map[status] || '待機'}</span>`;
    }
    function startedChip(isStarted){
      return isStarted
        ? '<span class="badge s-running" style="margin-left:6px;">開始済み</span>'
        : '<span class="badge s-idle" style="margin-left:6px;">未開始</span>';
    }
    function fmtPredDays(x){
      if (x == null || isNaN(x)) return '<span class="muted">-</span>';
      const v = Number(x);
      const s = v.toFixed(1) + ' 日';
      // しきい値で色づけ（30日超で注意色）
      if (v > 30) return `<span class="badge s-warn">${s}</span>`;
      return s;
    }
    function esc(s){return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
    function badgeLabel(s){ return ({running:'実行中', queued:'待機中', paused:'一時停止', idle:'待機', error:'エラー'})[s] || s || '-'; }

    function renderKPIs(list){
      const totalUsers = list.length;
      const sumPending = list.reduce((a,b)=>a + (Number(b.pending||0)||0), 0);
      // 累計（バックエンドの applied_total / processed_total を合算）
      const sumApplied = list.reduce((a,b)=>a + (Number(b.applied_total||0)||0), 0);
      const sumProcessed = list.reduce((a,b)=>a + (Number(b.processed_total||0)||0), 0);
      kUsers.textContent = totalUsers.toLocaleString();
      kPending.textContent = sumPending.toLocaleString();
      kApplied24.textContent = sumApplied.toLocaleString();
      kProcessed24.textContent = sumProcessed.toLocaleString();
    }

    function render() {
      const q = (search.value || '').toLowerCase();

      // 名前でフィルタ → ユーザーID昇順
      filtered = items
        .filter(x => !q || (x.username || '').toLowerCase().includes(q))
        .sort((a,b) => (a.user_id||0) - (b.user_id||0));

      renderKPIs(filtered);

      const rows = filtered.map(x => {
        const last = x.last_result || {};
        // 累計実績（リンク/記事/平均）
        const avgLP = (typeof x.avg_links_per_post === 'number') ? x.avg_links_per_post.toFixed(1) : '0.0';
        const totalSummary = `リンク:${x.applied_total ?? 0} / 記事:${x.processed_total ?? 0} / 平均:${avgLP}`;
        // 直近実行の結果（所要: 分）
        const dur = (typeof last.duration_min === 'number') ? `${last.duration_min}分` : '-';
        const lastSummary =
          `${last.status ? ('[' + esc(badgeLabel(last.status)) + '] ') : ''}` +
          `適用:${last.applied ?? '-'} / 記事:${last.processed_posts ?? '-'} / 所要:${dur}`;
        const err = x.last_error ? `<div class="truncate-1 mono" title="${esc(x.last_error)}">${esc(x.last_error)}</div>` : '<span class="muted">-</span>';

        // 操作ボタン：開始のみ。実行中はdisabledで「実行中」表示
        const running = (x.status === 'running');
        const buttonHtml = running
          ? `<button class="btn-mini primary act-start" data-running="1" disabled>実行中</button>`
          : `<button class="btn-mini primary act-start" data-running="0">開始</button>`;

          /* 追加: 適用済み記事一覧への遷移ボタン（ユーザー固定表示） */
        const previewBtn =
          `<a class="btn-mini" href="${"{{ url_for('admin.admin_iseo_applied_all_page') }}"}?user_id=${x.user_id}" target="_blank" rel="noopener">Preview</a>`;

        return `
          <tr data-id="${x.user_id}">
            <td><input type="checkbox" class="row-check"></td>
            <td class="nowrap">
              <div><strong>名前：</strong>${esc(x.username || '')} <span class="muted mono">（ID #${x.user_id}）</span></div>
            </td>
            <td>${badgeJa(x.status)}${startedChip(!!x.is_started)}</td>
            <td class="num">${(x.pending ?? 0).toLocaleString()}</td>
            <td class="num">${fmtPredDays(x.pred_days)}</td>
            <td>${fmtTime(x.last_run_at)}</td>
            <td>${fmtTime(x.next_run_at)}</td>
            <td class="mono">${lastSummary}</td>
            <td class="mono">${totalSummary}</td>
            <td>${err}</td>
            <!-- 追加: Preview 列 -->
            <td class="row-actions">
              ${previewBtn}
            </td>
            <!-- ここまで -->
            <td class="row-actions">
              ${buttonHtml}
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="12" class="muted">対象ユーザーがいません</td></tr>`;
      wireRowActions();
    }

    // ---- データ取得 ----
    async function load() {
      const res = await fetchJSON('/admin/iseo/schedules/status');
      if (!res.ok) throw new Error('fetch failed');
      const data = await res.json();
      items = (data.items || []);
      render();
    }

    // ---- 行操作（開始のみ） ----
    function wireRowActions() {
      tbody.querySelectorAll('.act-start').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const b = e.currentTarget;
          if (b.dataset.running === '1' || b.disabled) return; // すでに実行中
          const tr = b.closest('tr');
          const uid = parseInt(tr.dataset.id, 10);
          // 楽観更新：すぐに実行中表示にして押せないように
          const oldText = b.textContent;
          b.textContent = '実行中';
          b.disabled = true;
          b.dataset.running = '1';
          try {
            const res = await fetchJSON('/admin/iseo/schedules/bulk_enable', {
              method: 'POST',
              body: JSON.stringify({ user_ids: [uid] })
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok || data.ok === false) throw new Error(data.error || res.statusText);
            // 成功 → 状態を再取得
            await load();
          } catch (err) {
            // 失敗 → 元に戻す
            alert(`開始に失敗しました: ${err}`);
            b.textContent = oldText;
            b.disabled = false;
            b.dataset.running = '0';
          }
        });
      });
    }

    // ---- その他UI ----
    btnRefresh.addEventListener('click', load);
    search.addEventListener('input', render);
    autoRefresh.addEventListener('change', () => {
      if (autoRefresh.checked) {
        if (!timer) timer = setInterval(load, 10000);
      } else if (timer) {
        clearInterval(timer); timer = null;
      }
    });
    checkAll.addEventListener('change', () => {
      document.querySelectorAll('tbody .row-check').forEach(cb => cb.checked = checkAll.checked);
    });

    // ---- 初期化 ----
    (async function init(){
      await load();
      timer = setInterval(load, 10000);
    })();
  </script>
</div>
{% endblock %}
