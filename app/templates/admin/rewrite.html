<!-- templates/admin/rewrite.html -->
{% extends "base_admin.html" %}
{% block title %}全記事リライト（管理）{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-3">全記事リライト（管理）</h2>
  <p class="text-muted">
    ユーザーごとのリライト計画を一覧表示します。各行から全記事投入・進捗確認・再試行・SERP温めを操作できます。
  </p>

  <!-- 検索と更新 -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div class="input-group" style="max-width: 320px;">
      <input type="text" id="search-box" class="form-control" placeholder="ユーザー名・メールで検索">
      <button class="btn btn-outline-secondary" id="search-btn">検索</button>
    </div>
    <div>
      <button class="btn btn-outline-primary btn-sm" id="refresh-all">一覧更新</button>
      <button class="btn btn-outline-success btn-sm" id="auto-refresh-toggle" data-active="0">自動更新:OFF</button>
    </div>
  </div>

  <!-- 全体統計 -->
  <div class="row text-center mb-4">
    <div class="col-md-3 mb-2"><div class="card"><div class="card-body p-2"><strong>queued</strong><br><span id="sum-queued">0</span></div></div></div>
    <div class="col-md-3 mb-2"><div class="card"><div class="card-body p-2"><strong>running</strong><br><span id="sum-running">0</span></div></div></div>
    <div class="col-md-3 mb-2"><div class="card"><div class="card-body p-2"><strong>success</strong><br><span id="sum-success">0</span></div></div></div>
    <div class="col-md-3 mb-2"><div class="card"><div class="card-body p-2"><strong>error</strong><br><span id="sum-error">0</span></div></div></div>
  </div>

  <!-- ユーザー別テーブル -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>ユーザー別リライト進捗</span>
      <small class="text-muted" id="last-updated">更新: -</small>
    </div>
    <div class="table-responsive">
      <table class="table table-striped align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:60px;">ID</th>
            <th>ユーザー</th>
            <th style="width:80px;">サイト</th>
            <th style="width:100px;">Queued</th>
            <th style="width:100px;">Running</th>
            <th style="width:100px;">Success</th>
            <th style="width:100px;">Error</th>
            <th style="width:160px;">最終更新</th>
            <th style="width:220px;">操作</th>
          </tr>
        </thead>
        <tbody id="user-tbody">
          <tr><td colspan="9" class="text-center text-muted py-3">読込中…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 詳細モーダル -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">リライト詳細: <span id="modal-user-name"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modal-summary" class="mb-3 text-muted small">読込中…</div>
        <table class="table table-sm table-striped">
          <thead><tr><th>ID</th><th>Article</th><th>Status</th><th>Attempts</th><th>Updated</th><th>WP URL</th></tr></thead>
          <tbody id="modal-tbody"><tr><td colspan="6" class="text-center text-muted py-3">読込中…</td></tr></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-primary btn-sm" id="modal-refresh">更新</button>
        <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const tbody = $("#user-tbody");
  const modalEl = $("#userModal");
  const modal = new bootstrap.Modal(modalEl);
  const mUser = $("#modal-user-name");
  const mSum = $("#modal-summary");
  const mTbody = $("#modal-tbody");
  let autoRefresh = false, timer = null;

  function badge(val, cls){ return `<span class="badge bg-${cls}">${val}</span>`; }
  function formatDate(str){ return str ? new Date(str).toLocaleString() : "-"; }

  async function fetchJSON(url, opts){
    // フルパス or 相対パスの両対応（オリジンを自動補完）
    const fullUrl = url.startsWith("http") ? url : `${window.location.origin}${url}`;
    const r = await fetch(fullUrl, opts||{});
    const j = await r.json();
    if(!r.ok || j.ok===false) throw new Error(j.error||("HTTP "+r.status));
    return j;
  }

  async function loadUsers(){
    try{
      const q = $("#search-box").value.trim();
      const url = q ? `/admin/rewrite/users?q=${encodeURIComponent(q)}` : `/admin/rewrite/users`;
      const data = await fetchJSON(url);
      tbody.innerHTML = "";
      let sumQ=0,sumR=0,sumS=0,sumE=0;
      data.items.forEach(u=>{
        sumQ += u.queued; sumR += u.running; sumS += u.success; sumE += u.error;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.user_id}</td>
          <td><strong>${u.name}</strong></td>
          <td>${u.site_count}</td>
          <td>${badge(u.queued,"secondary")}</td>
          <td>${badge(u.running,"warning")}</td>
          <td>${badge(u.success,"success")}</td>
          <td>${badge(u.error,"danger")}</td>
          <td class="small text-muted">${formatDate(u.last_activity_at)}</td>
          <td>
            <button class="btn btn-sm btn-primary me-1" data-action="enqueue" data-id="${u.user_id}">開始</button>
            <button class="btn btn-sm btn-outline-warning me-1" data-action="retry" data-id="${u.user_id}">再試行</button>
            <button class="btn btn-sm btn-outline-info me-1" data-action="warmup" data-id="${u.user_id}">温め</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="detail" data-id="${u.user_id}" data-name="${u.name}">詳細</button>
          </td>`;
        tbody.appendChild(tr);
      });
      $("#sum-queued").textContent = sumQ;
      $("#sum-running").textContent = sumR;
      $("#sum-success").textContent = sumS;
      $("#sum-error").textContent = sumE;
      $("#last-updated").textContent = "更新: "+new Date().toLocaleString();
    }catch(err){
      tbody.innerHTML = `<tr><td colspan="9" class="text-danger text-center py-3">読み込み失敗: ${err.message}</td></tr>`;
    }
  }

  async function openDetail(uid, name){
    mUser.textContent = `#${uid} ${name}`;
    mSum.textContent = "読込中…";
    mTbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">読込中…</td></tr>`;
    modal.show();
    try{
      const prog = await fetchJSON(`/admin/rewrite/progress?user_id=${encodeURIComponent(uid)}`);
      mSum.textContent = `queued:${prog.totals.queued}, running:${prog.totals.running}, success:${prog.totals.success}, error:${prog.totals.error}`;
      mTbody.innerHTML = "";
      prog.recent.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td><td>${r.article_id}</td>
          <td><span class="badge bg-${r.status==="success"?"success":r.status==="error"?"danger":r.status==="running"?"warning":"secondary"}">${r.status}</span></td>
          <td>${r.attempts||""}</td>
          <td class="small text-muted">${formatDate(r.updated_at)}</td>
          <td>${r.posted_url?`<a href="${r.posted_url}" target="_blank">open</a>`:""}</td>`;
        mTbody.appendChild(tr);
      });
    }catch(err){
      mSum.textContent = "取得失敗: "+err.message;
    }
  }

  tbody.addEventListener("click", async e=>{
    const btn = e.target.closest("button[data-action]");
    if(!btn) return;
    const uid = btn.dataset.id;
    const act = btn.dataset.action;
    if(act==="detail") return openDetail(uid, btn.dataset.name);

    try{
      btn.disabled = true;
      if(act==="enqueue"){
        await fetchJSON("/admin/rewrite/enqueue",{
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({user_id:Number(uid),priority:0.0,site_ids:"",article_ids:""})
        });
        alert("全記事をキュー投入しました");
      }else if(act==="retry"){
        await fetchJSON("/admin/rewrite/retry_failed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(uid)})});
        alert("失敗の再試行をトリガしました");
      }else if(act==="warmup"){
        await fetchJSON("/admin/rewrite/serp_warmup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(uid)})});
        alert("SERP温めをトリガしました");
      }
      await loadUsers();
    }catch(err){ alert("操作失敗: "+err.message); }
    finally{ btn.disabled = false; }
  });

  $("#refresh-all").addEventListener("click", loadUsers);
  $("#search-btn").addEventListener("click", loadUsers);
  $("#modal-refresh").addEventListener("click", ()=>openDetail(mUser.textContent.split(" ")[0].replace("#",""),mUser.textContent));

  $("#auto-refresh-toggle").addEventListener("click",()=>{
    autoRefresh = !autoRefresh;
    const btn=$("#auto-refresh-toggle");
    btn.dataset.active = autoRefresh?1:0;
    btn.textContent = "自動更新:"+(autoRefresh?"ON":"OFF");
    if(autoRefresh){
      timer=setInterval(loadUsers,10000);
    }else{
      clearInterval(timer);
    }
  });

  // 初期ロード
  loadUsers();
})();
</script>
{% endblock %}
