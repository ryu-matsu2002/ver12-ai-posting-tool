{% extends "base_admin.html" %}
{% block title %}Title/Meta再生成 | 管理者{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">🧩 Title & Meta バッチ再生成</h1>
  <p class="text-sm text-gray-600 mb-6">
    指定ユーザーの<strong>全記事</strong>について、<code>&lt;title&gt;</code>（=記事タイトル）と
    メタディスクリプション（AI生成・既定180文字）を一括整備します。<br>
    実行ボタンは<strong>1つだけ</strong>。サーバ側が自動で最後まで（必要に応じて分割しながら）処理します。
  </p>

  <!-- 入力フォーム（簡略化） -->
  <div class="bg-white rounded-2xl shadow p-5 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="user_select" class="block text-sm font-medium mb-1">ユーザーを選択</label>
        <select id="user_select" class="w-full border rounded-lg px-3 py-2">
          <option value="">-- ユーザーを選んでください --</option>
          {% for u in users %}
            <option value="{{ u.id }}">#{{ u.id }} {{ u.username }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">一覧に出てこない場合は、ユーザー作成/権限をご確認ください。</p>
      </div>
      <div class="flex items-end">
        <button id="btnAutoAll"
                class="w-full md:w-auto px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition">
          🔁 このユーザーの全記事に適用（自動で最後まで）
        </button>
      </div>
    </div>
    <span id="busy" class="hidden text-sm text-gray-600">実行中…完了までお待ちください</span>
  </div>

  <!-- 進捗表示 -->
  <div id="progress" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-2xl shadow p-5">
      <h3 class="font-semibold mb-1">進捗（ユーザー）</h3>
      <div class="text-sm text-gray-600 mb-2">
        分母: <span id="p_total" class="font-semibold">-</span>　
        分子: <span id="p_applied" class="font-semibold">-</span>　
        率: <span id="p_pct" class="font-semibold">-</span>%
      </div>
      <label class="inline-flex items-center gap-2 text-xs">
        <input id="p_published_only" type="checkbox" class="h-4 w-4" checked>
        公開記事のみを対象
      </label>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 md:col-span-2">
      <h3 class="font-semibold mb-2">サイト別内訳（上位）</h3>
      <div id="p_by_site" class="text-sm text-gray-700 space-y-1 max-h-52 overflow-auto"></div>
    </div>
  </div>

  <!-- 結果表示 -->
  <div id="result" class="mt-6 space-y-4"></div>
</div>

<script>
  const endpoint   = "{{ url_for('admin.admin_title_meta_backfill') }}";
  const progressEp = "{{ url_for('admin.admin_title_meta_progress') }}";

  const el = (sel) => document.querySelector(sel);
  const userSelect  = el('#user_select');
  const btnAutoAll  = el('#btnAutoAll');
  const busy        = el('#busy');
  const resultBox   = el('#result');
  const pPublished  = el('#p_published_only');
  const pTotal      = el('#p_total');
  const pApplied    = el('#p_applied');
  const pPct        = el('#p_pct');
  const pBySite     = el('#p_by_site');

  function setBusy(v) {
    btnAutoAll.disabled = v;
    busy.classList.toggle('hidden', !v);
  }

  // 進捗描画
  async function refreshProgress() {
    const uid = (userSelect.value || '').trim();
    if (!uid) { pTotal.textContent='-'; pApplied.textContent='-'; pPct.textContent='-'; pBySite.innerHTML=''; return; }
    const po = pPublished.checked ? '1' : '0';
    const url = `${progressEp}?user_id=${encodeURIComponent(uid)}&published_only=${po}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'progress error');
      pTotal.textContent   = data.total;
      pApplied.textContent = data.applied;
      pPct.textContent     = data.percentage.toFixed(2);
      pBySite.innerHTML    = (data.by_site || []).map(r => {
        const pct = r.total ? Math.round((r.applied / r.total) * 100) : 0;
        return `<div>#${r.site_id} … ${r.applied}/${r.total} (${pct}%)</div>`;
      }).join('');
    } catch (e) {
      // 軽い失敗は無視
    }
  }
  pPublished.addEventListener('change', refreshProgress);
  userSelect.addEventListener('change', refreshProgress);
  setInterval(refreshProgress, 5000);

  // 結果描画（サマリー）
  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderSummaryAuto(res) {
    // ループ完走後サーバが返すサマリーに対応（routes の新実装に合わせる）
    const updatedTotal = res.updated_total ?? res.updated ?? 0;
    const iterations   = res.iterations ?? 1;
    const lastCursor   = (res.last_cursor ?? res.cursor ?? '');
    const lastChunk    = res.last_chunk || {};
    const lastUpdated  = lastChunk.updated ?? 0;
    const doneFlag     = (lastChunk.done === true) || (!lastCursor || lastCursor === 0);

    return `
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="font-semibold mb-2">実行結果（自動完走）</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-3 rounded-lg bg-gray-50">合計更新<br><span class="text-lg font-bold">${updatedTotal}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">反復回数<br><span class="text-lg font-bold">${iterations}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">最終チャンク更新<br><span class="text-lg font-bold">${lastUpdated}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">状態<br><span class="text-lg font-bold">${doneFlag ? '完了' : '未完'}</span></div>
        </div>
        <div class="mt-3 text-sm">last_cursor: <code class="px-2 py-1 bg-gray-100 rounded">${escapeHtml(lastCursor ?? '')}</code></div>
      </div>
    `;
  }

  // 実行
  btnAutoAll.addEventListener('click', async () => {
    const uid = (userSelect.value || '').trim();
    if (!uid) { alert('先にユーザーを選んでください'); return; }

    setBusy(true);
    resultBox.innerHTML = '';
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: Number(uid) })
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.ok === false) {
        resultBox.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
            <div class="font-semibold mb-1">エラー</div>
            <pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
          </div>`;
        return;
      }

      resultBox.innerHTML = renderSummaryAuto(data);
      await refreshProgress();
    } catch (e) {
      resultBox.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
          <div class="font-semibold mb-1">通信エラー</div>
          <pre class="text-xs whitespace-pre-wrap">${escapeHtml(String(e))}</pre>
        </div>`;
    } finally {
      setBusy(false);
    }
  });

  // 初期：ユーザー未選択なので空表示
</script>
{% endblock %}
