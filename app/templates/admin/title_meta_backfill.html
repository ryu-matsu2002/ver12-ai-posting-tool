{% extends "base_admin.html" %}
{% block title %}Title/Meta再生成 | 管理者{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">🧩 Title & Meta バッチ再生成</h1>
  <p class="text-sm text-gray-600 mb-6">
    指定ユーザーの<strong>全記事</strong>について、<code>&lt;title&gt;</code>（=記事タイトル）と
    メタディスクリプション（AI生成・既定180文字）を一括整備します。<br>
    実行ボタンは<strong>1つだけ</strong>。サーバ側が自動で最後まで（必要に応じて分割しながら）処理します。
  </p>

  <!-- 入力フォーム（簡略化） -->
  <div class="bg-white rounded-2xl shadow p-5 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="user_select" class="block text-sm font-medium mb-1">ユーザーを選択</label>

        <!-- 検索入力（デバウンスで候補を遅延取得） -->
        <input id="user_search" type="text" placeholder="ユーザー名/メールで検索（入力で候補を取得）"
               class="w-full border rounded-lg px-3 py-2 mb-2" autocomplete="off">

        <!-- 初回は空。フォーカス/検索で候補をAJAX注入 -->
        <select id="user_select" class="w-full border rounded-lg px-3 py-2" aria-describedby="user_help">
          <option value="">-- ユーザーを選んでください --</option>
        </select>

        <p id="user_help" class="text-xs text-gray-500 mt-1">
          ※ 初回表示時は高速化のためユーザー一覧を読み込みません。入力/フォーカス時に候補を取得します。
        </p>
      </div>

      <div class="flex items-end">
        <button id="btnAutoAll"
                class="w-full md:w-auto px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          🔁 このユーザーの全記事に適用（自動で最後まで）
        </button>
      </div>
    </div>
    <span id="busy" class="hidden text-sm text-gray-600" aria-live="polite">実行中…完了までお待ちください</span>
  </div>

  <!-- 進捗表示 -->
  <div id="progress" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-2xl shadow p-5">
      <h3 class="font-semibold mb-1">進捗（ユーザー）</h3>
      <div class="text-sm text-gray-600 mb-2">
        分母: <span id="p_total" class="font-semibold">-</span>　
        分子: <span id="p_applied" class="font-semibold">-</span>　
        率: <span id="p_pct" class="font-semibold">-</span>%
      </div>
      <label class="inline-flex items-center gap-2 text-xs">
        <input id="p_published_only" type="checkbox" class="h-4 w-4" checked>
        公開記事のみを対象
      </label>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 md:col-span-2">
      <h3 class="font-semibold mb-2">サイト別内訳（上位50）</h3>
      <div id="p_by_site" class="text-sm text-gray-700 space-y-1 max-h-52 overflow-auto" aria-live="polite"></div>
    </div>
  </div>

  <!-- 結果表示 -->
  <div id="result" class="mt-6 space-y-4"></div>
</div>

<script>
  const endpoint        = "{{ url_for('admin.admin_title_meta_backfill') }}";
  const progressEp      = "{{ url_for('admin.admin_title_meta_progress') }}";
  const usersSuggestEp  = "{{ url_for('admin.admin_tools_users_suggest') }}";

  const el = (sel) => document.querySelector(sel);
  const userSearch = el('#user_search');
  const userSelect = el('#user_select');
  const btnAutoAll = el('#btnAutoAll');
  const busy       = el('#busy');
  const resultBox  = el('#result');
  const pPublished = el('#p_published_only');
  const pTotal     = el('#p_total');
  const pApplied   = el('#p_applied');
  const pPct       = el('#p_pct');
  const pBySite    = el('#p_by_site');

  function setBusy(v) {
    btnAutoAll.disabled = v || !(userSelect.value && userSelect.value.trim());
    busy.classList.toggle('hidden', !v);
    document.body.toggleAttribute('aria-busy', v);
  }

  // ユーザー選択の有無でボタン活性/非活性
  function reflectButtonState() {
    btnAutoAll.disabled = !(userSelect.value && userSelect.value.trim());
  }

  // ---------------- ユーザー候補（遅延取得） ----------------
  let usersCtrl = null;   // AbortController
  let usersOnce = false;  // 初回フォーカス時、空検索で20件だけ取得

  function setUserOptions(items) {
    const current = userSelect.value || '';
    const opts = ['<option value="">-- ユーザーを選んでください --</option>']
      .concat((items || []).map(it => `<option value="${it.id}">${it.label}</option>`));
    userSelect.innerHTML = opts.join('');
    // 既存選択がリストにあれば維持
    if (current && Array.from(userSelect.options).some(o => o.value === current)) {
      userSelect.value = current;
    }
    reflectButtonState();
  }

  async function fetchUsers(q) {
    try {
      if (usersCtrl) usersCtrl.abort();
      usersCtrl = new AbortController();
      const params = new URLSearchParams();
      if (q && q.trim()) params.set('q', q.trim());
      const res = await fetch(`${usersSuggestEp}?${params.toString()}`, { signal: usersCtrl.signal });
      const data = await res.json().catch(() => ({items: []}));
      setUserOptions(data.items || []);
    } catch (e) {
      // 中断/失敗時は候補をクリアせず無視
    }
  }

  // 入力のデバウンス
  let userDebounce = null;
  userSearch.addEventListener('input', () => {
    clearTimeout(userDebounce);
    userDebounce = setTimeout(() => {
      const q = userSearch.value;
      fetchUsers(q);
    }, 200);
  });

  // セレクトに初回フォーカスしたら空検索で直近20件
  userSelect.addEventListener('focus', () => {
    if (usersOnce) return;
    usersOnce = true;
    fetchUsers('');
  });

  // 選択が変わったら進捗更新＆ボタン状態更新
  userSelect.addEventListener('change', () => {
    reflectButtonState();
    refreshProgress();
  });

  // ---------------- 進捗描画 ----------------
  let progressTimer = null;

  function safePercent(num) {
    const n = Number(num);
    return Number.isFinite(n) ? n : 0;
  }

  async function refreshProgress() {
    const uid = (userSelect.value || '').trim();
    if (!uid) {
      pTotal.textContent='-'; pApplied.textContent='-'; pPct.textContent='-'; pBySite.innerHTML='';
      return;
    }
    const po = pPublished.checked ? '1' : '0';
    const url = `${progressEp}?user_id=${encodeURIComponent(uid)}&published_only=${po}`;
    try {
      const res = await fetch(url);
      // 例外系(4xx/5xx)はJSONでない可能性→ガード
      if (!res.ok) {
        pBySite.innerHTML = `<div class="text-red-600">進捗取得エラー：HTTP ${res.status}</div>`;
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'progress error');

      pTotal.textContent   = data.total;
      pApplied.textContent = data.applied;

      const pctNum = safePercent(data.percentage);
      pPct.textContent     = safePercent(pctNum).toFixed(2);

      const list = (data.by_site || []).slice(0, 50).map(r => {
        const t = Number(r.total) || 0;
        const a = Number(r.applied) || 0;
        const pct = t ? Math.round((a / t) * 100) : 0;
        return `<div>#${r.site_id} … ${a}/${t} (${pct}%)</div>`;
      }).join('');
      pBySite.innerHTML = list || '<div class="text-gray-500">データなし</div>';
    } catch (e) {
      // 軽い失敗は無視（UI上は静かに）
    }
  }

  pPublished.addEventListener('change', refreshProgress);

  // ポーリングは1本に限定
  if (!progressTimer) {
    progressTimer = setInterval(refreshProgress, 5000);
  }

  // ---------------- 実行結果描画 ----------------
  function escapeHtml(s) {
    return String(s || '').replace(/[&<>\"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderSummaryAuto(res) {
    // ループ完走後サーバが返すサマリーに対応（routes の実装に合わせる）
    const updatedTotal = Number(res.updated_total ?? res.updated ?? 0);
    const iterations   = Number(res.iterations ?? 1);
    const lastCursor   = (res.last_cursor ?? res.cursor ?? '');
    const lastChunk    = res.last_chunk || {};
    const lastUpdated  = Number(lastChunk.updated ?? 0);
    const doneFlag     = (lastChunk.done === true) || (!lastCursor || lastCursor === 0);

    return `
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="font-semibold mb-2">実行結果（自動完走）</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-3 rounded-lg bg-gray-50">合計更新<br><span class="text-lg font-bold">${updatedTotal}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">反復回数<br><span class="text-lg font-bold">${iterations}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">最終チャンク更新<br><span class="text-lg font-bold">${lastUpdated}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">状態<br><span class="text-lg font-bold">${doneFlag ? '完了' : '未完'}</span></div>
        </div>
        <div class="mt-3 text-sm">last_cursor: <code class="px-2 py-1 bg-gray-100 rounded">${escapeHtml(String(lastCursor ?? ''))}</code></div>
      </div>
    `;
  }

  // ---------------- 実行 ----------------
  btnAutoAll.addEventListener('click', async () => {
    const uid = (userSelect.value || '').trim();
    if (!uid) { alert('先にユーザーを選んでください'); return; }

    setBusy(true);
    resultBox.innerHTML = '';
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: Number(uid) })
      });

      let data = {};
      try { data = await res.json(); } catch (_){ /* 非JSONでも落とさない */ }

      if (!res.ok || data.ok === false) {
        resultBox.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
            <div class="font-semibold mb-1">エラー</div>
            <pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(data || {status: res.status}, null, 2))}</pre>
          </div>`;
        return;
      }

      resultBox.innerHTML = renderSummaryAuto(data);
      await refreshProgress();
    } catch (e) {
      resultBox.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
          <div class="font-semibold mb-1">通信エラー</div>
          <pre class="text-xs whitespace-pre-wrap">${escapeHtml(String(e))}</pre>
        </div>`;
    } finally {
      setBusy(false);
    }
  });

  // Enter キーで実行（セレクトにフォーカス中）
  userSelect.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' && !btnAutoAll.disabled) {
      btnAutoAll.click();
    }
  });

  // 初期：高速化のためユーザー配列は描画しない
</script>
{% endblock %}
