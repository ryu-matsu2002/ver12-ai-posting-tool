{% extends "base_admin.html" %}
{% block title %}Title/Metaå†ç”Ÿæˆ | ç®¡ç†è€…{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-3">ğŸ§© Title & Meta ãƒãƒƒãƒå†ç”Ÿæˆ</h1>
  <p class="text-sm text-gray-600 mb-6">
    å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®<strong>æ—¢å­˜è¨˜äº‹</strong>ã«ã¤ã„ã¦ã€&lt;title&gt; ã¨ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆAI ç”Ÿæˆãƒ»æ—¢å®š180å­—ï¼‰ã‚’
    ä¸€æ‹¬æ•´å‚™ã—ã¾ã™ã€‚è¡Œå³ç«¯ã®<strong>ã€Œå®Ÿè¡Œã€</strong>ã‚’æŠ¼ã™ã ã‘ã§ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨å¯¾è±¡è¨˜äº‹ã‚’æœ€å¾Œã¾ã§è‡ªå‹•å‡¦ç†ã—ã¾ã™ã€‚
  </p>

  <!-- æ“ä½œãƒãƒ¼ï¼ˆæ¤œç´¢ãƒ»æ›´æ–°ï¼‰ -->
  <div class="bg-white rounded-2xl shadow p-4 mb-4 flex flex-col md:flex-row gap-3 md:items-center">
    <div class="flex-1 flex gap-2">
      <input id="q" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§çµã‚Šè¾¼ã¿ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ•ã‚£ãƒ«ã‚¿ï¼‰"
             class="w-full border rounded-lg px-3 py-2" autocomplete="off">
      <button id="btnReload"
              class="px-3 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100">
        å†èª­è¾¼
      </button>
    </div>
    <div class="text-xs text-gray-500">
      å¯¾è±¡å“è³ª: <code>empty, too_short, too_long, duplicate</code>ï¼ˆå¤‰æ›´ã¯ API å´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¯ï¼‰
    </div>
  </div>

  <!-- ä¸€è¦§ï¼ˆ1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ 1 è¡Œï¼‰ -->
  <div class="bg-white rounded-2xl shadow">
    <div class="px-4 py-3 border-b text-sm text-gray-600 flex justify-between">
      <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆéåŒæœŸå–å¾—ï¼‰</div>
      <div id="loadState" class="text-gray-500">èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­â€¦</div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-4 py-2 w-56">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
            <th class="text-left px-4 py-2 w-28">å¯¾è±¡ä»¶æ•°</th>
            <th class="text-left px-4 py-2">ã‚µã‚¤ãƒˆå†…è¨³</th>
            <th class="text-left px-4 py-2 w-40">ç›´è¿‘ã®çµæœ</th>
            <th class="text-right px-4 py-2 w-36">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="userRows">
          <!-- éåŒæœŸã«æŒ¿å…¥ -->
        </tbody>
      </table>
    </div>
  </div>

  <p class="text-xs text-gray-500 mt-3">
    åˆæœŸè¡¨ç¤ºã¯ DB ã‚’å©ã‹ãšã« 1 ç§’ä»¥å†…ã§é–‹ãã¾ã™ã€‚è¡Œãƒ‡ãƒ¼ã‚¿ã¯ AJAX ã§è»½é‡å–å¾—ã—ã¦ã„ã¾ã™ã€‚
  </p>
</div>

<script>
  // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  const listEp     = "{{ url_for('admin.admin_title_meta_users') }}";
  const runEp      = "{{ url_for('admin.admin_title_meta_backfill') }}";

  // DOM å‚ç…§
  const el = (s) => document.querySelector(s);
  const userRows = el('#userRows');
  const qInput   = el('#q');
  const loadState = el('#loadState');
  const btnReload = el('#btnReload');

  // çŠ¶æ…‹
  let rawUsers = [];   // API ã‹ã‚‰ã®ç”Ÿé…åˆ—
  let running  = new Set(); // å®Ÿè¡Œä¸­ user_id

  // HTML ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const esc = (s) => String(s ?? '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const fmtInt = (n) => Number(n||0).toLocaleString();

  function siteChip(s) {
    // s: {site_id, name, targets, posted, done}
    return `
      <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full border bg-gray-50 mr-2 mb-2">
        <span class="text-gray-700">${esc(s.name)}</span>
        <span class="text-gray-500">#${s.site_id}</span>
        <span class="text-gray-800 font-medium">${fmtInt(s.targets)}</span>
        <span class="text-xs text-gray-500">(posted:${fmtInt(s.posted)} / done:${fmtInt(s.done)})</span>
      </span>
    `;
  }

  function actionCell(user_id) {
    const busy = running.has(user_id);
    return `
      <button data-run="${user_id}"
              class="px-3 py-2 rounded-lg text-white ${busy?'bg-gray-400 cursor-not-allowed':'bg-purple-600 hover:bg-purple-700'}"
              ${busy?'disabled':''}>
        ${busy ? 'å®Ÿè¡Œä¸­â€¦' : 'å®Ÿè¡Œ'}
      </button>
    `;
  }

  function rowHTML(u) {
    // u: {user_id, name, targets, sites:[...] }
    const sites = (u.sites||[]).map(siteChip).join('');
    return `
      <tr class="border-t">
        <td class="px-4 py-3">
          <div class="font-medium">${esc(u.name)}</div>
          <div class="text-xs text-gray-500">#${u.user_id}</div>
        </td>
        <td class="px-4 py-3">
          <div class="font-bold">${fmtInt(u.targets)}</div>
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-wrap">${sites || '<span class="text-gray-400">å†…è¨³ãªã—</span>'}</div>
        </td>
        <td class="px-4 py-3">
          <div id="r-${u.user_id}" class="text-xs text-gray-600">-</div>
        </td>
        <td class="px-4 py-3 text-right">
          ${actionCell(u.user_id)}
        </td>
      </tr>
    `;
  }

  function renderList(filterText='') {
    const f = (filterText || '').trim().toLowerCase();
    const rows = rawUsers
      .filter(u => !f || String(u.name||'').toLowerCase().includes(f) || String(u.user_id).includes(f))
      .map(rowHTML)
      .join('');
    userRows.innerHTML = rows || `
      <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>`;
    // å†ã‚¢ã‚¿ãƒƒãƒï¼ˆå‹•çš„ç”Ÿæˆã®ãŸã‚ï¼‰
    attachRowHandlers();
  }

  function attachRowHandlers() {
    userRows.querySelectorAll('button[data-run]').forEach(btn => {
      btn.addEventListener('click', () => runForUser(Number(btn.dataset.run)));
    });
  }

  async function loadList() {
    try {
      loadState.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
      const res = await fetch(listEp, { cache: 'no-store' });
      const data = await res.json().catch(() => ({users:[]}));
      rawUsers = Array.isArray(data.users) ? data.users : [];
      renderList(qInput.value);
      loadState.textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ${rawUsers.length}ä»¶ï¼‰`;
    } catch(e) {
      loadState.textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
      userRows.innerHTML = `
        <tr><td colspan="5" class="px-4 py-6 text-center text-red-600">ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>`;
    }
  }

  async function runForUser(user_id) {
    if (running.has(user_id)) return;
    running.add(user_id);
    // ãƒœã‚¿ãƒ³å†æç”»
    const cell = userRows.querySelector(`button[data-run="${user_id}"]`);
    if (cell) {
      cell.outerHTML = actionCell(user_id);
      attachRowHandlers();
    }
    const resBox = el(`#r-${user_id}`);
    if (resBox) resBox.textContent = 'å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­â€¦';

    try {
      const res = await fetch(runEp, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || data.ok === false) {
        const msg = data.error ? `ã‚¨ãƒ©ãƒ¼: ${data.error}` : `HTTP ${res.status}`;
        if (resBox) resBox.textContent = msg;
      } else {
        // ã‚µãƒãƒªãƒ¼ã‚’è»½ãè¡¨ç¤º
        const total = Number(data.updated_total ?? data.updated ?? 0);
        const iters = Number(data.iterations ?? 1);
        const okWp  = (data.wp && data.wp.ok) ? ` / WP OK ${data.wp.ok}` : '';
        if (resBox) resBox.textContent = `å®Œäº†: æ›´æ–° ${total}ä»¶ / åå¾© ${iters}${okWp}`;
      }
    } catch(e) {
      if (resBox) resBox.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
    } finally {
      running.delete(user_id);
      // ãƒœã‚¿ãƒ³å†æç”»
      const cell2 = userRows.querySelector(`button[data-run="${user_id}"]`);
      if (cell2) {
        cell2.outerHTML = actionCell(user_id);
        attachRowHandlers();
      }
    }
  }

  // å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  let deb = null;
  qInput.addEventListener('input', () => {
    clearTimeout(deb);
    deb = setTimeout(() => renderList(qInput.value), 150);
  });

  btnReload.addEventListener('click', loadList);

  // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šã‚µãƒ¼ãƒãƒ¼ã¯HTMLã ã‘è¿”ã— DB ã¯è§¦ã‚‰ãªã„ â†’ JS ã§è»½é‡APIã‚’å©ã
  loadList();
</script>
{% endblock %}
