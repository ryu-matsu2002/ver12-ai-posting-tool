{% extends "base_admin.html" %}
{% block title %}Title/Metaå†ç”Ÿæˆ | ç®¡ç†è€…{% endblock %}

{% block content %}
<div class="px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">ğŸ§© Title & Meta ãƒãƒƒãƒå†ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰</h1>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ & å†èª­è¾¼ -->
  <div class="bg-white rounded-2xl shadow p-4 mb-4">
    <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
      <div class="flex-1 w-full">
        <input id="q" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§çµã‚Šè¾¼ã¿â€¦" />
      </div>
      <div class="flex items-center gap-2">
        <button id="btnReload" class="px-3 py-2 rounded-lg border hover:bg-gray-50">å†èª­è¾¼</button>
      </div>
    </div>
    <div class="text-xs text-gray-500 mt-2">
      åˆ†æ¯ï¼<strong>æŠ•ç¨¿è¨˜äº‹</strong>ï¼ˆæ—¢å®šï¼‰ï¼ åˆ†å­ï¼<code>meta_description</code> ãŒç©ºã§ãªã„è¨˜äº‹æ•°ï¼ˆ=é©ç”¨æ¸ˆã¿ï¼‰ï¼ æ‰‹å‹•ãƒ¡ã‚¿ã¯é™¤å¤–<br>
      â€» æŠ•ç¨¿åˆ¤å®šï¼š<code>posted_at</code> ã‚ã‚Š ã¾ãŸã¯ <code>posted_url</code> éç©º
    </div>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="bg-white rounded-2xl shadow overflow-hidden">
    <div class="border-b px-4 py-2 text-sm text-gray-600 flex items-center justify-between">
      <div>è¡¨ç¤ºã¯é…å»¶å–å¾—ï¼ˆåˆå›DBãªã—ã§é«˜é€Ÿè¡¨ç¤ºï¼‰</div>
      <div id="loading" class="hidden">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-4 py-2 w-64">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
            <th class="text-left px-4 py-2 w-36">çŠ¶æ…‹</th>
            <th class="text-left px-4 py-2 w-56">é€²æ—</th>
            <th class="text-left px-4 py-2">ã‚µã‚¤ãƒˆå†…è¨³</th>
            <th class="text-right px-4 py-2 w-28">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="rows">
          <!-- JSã§æ³¨å…¥ -->
        </tbody>
      </table>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒ£ -->
    <div class="border-t px-4 py-3 flex items-center justify-between text-sm">
      <div><span id="pagerInfo">0 / 0</span></div>
      <div class="space-x-2">
        <button id="prev" class="px-3 py-1 border rounded disabled:opacity-50" disabled>å‰ã¸</button>
        <button id="next" class="px-3 py-1 border rounded disabled:opacity-50" disabled>æ¬¡ã¸</button>
      </div>
    </div>
  </div>
</div>

<script>
  const listEp   = "{{ url_for('admin.admin_title_meta_rows') }}";
  const runEp    = "{{ url_for('admin.admin_title_meta_backfill') }}";

  const el = (s) => document.querySelector(s);
  const rowsEl = el('#rows');
  const qEl = el('#q');
  const loadingEl = el('#loading');
  const pagerInfo = el('#pagerInfo');
  const prevBtn = el('#prev');
  const nextBtn = el('#next');
  const reloadBtn = el('#btnReload');

  let page = 1, perPage = 20, total = 0, debounceTimer = null;

  function pill(text, hint='') {
    return `<span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-700 mr-2 mb-1" title="${hint}">${text}</span>`;
  }

  function statusBadgeFromProgress(applied, total, fallbackTarget=null) {
    let ok = false;
    if (typeof total === 'number' && total > 0) {
      ok = Number(applied) >= Number(total);
    } else if (fallbackTarget !== null) {
      ok = Number(fallbackTarget) === 0;
    }
    const cls = ok ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-800';
    const label = ok ? 'æ•´å‚™æ¸ˆã¿' : 'æ•´å‚™ä¸­';
    return `<span class="inline-flex px-2 py-1 rounded ${cls}">${label}</span>`;
  }

  function progressText(applied, total, percentage) {
    const a = Number(applied || 0);
    const t = Number(total || 0);
    const p = (typeof percentage === 'number') ? percentage : (t ? Math.round((a / t) * 10000) / 100 : 0);
    return `${a} / ${t}ï¼ˆ${p}%ï¼‰`;
  }

  function siteChips(sites) {
    if (!Array.isArray(sites) || sites.length === 0) {
      return '<span class="text-gray-400">ï¼ˆãªã—ï¼‰</span>';
    }
    return sites.map(s => {
      const txt = `${s.name} #${s.site_id} ${s.applied}/${s.total}ï¼ˆ${s.percentage}%ï¼‰`;
      return pill(txt, `site_id=${s.site_id}`);
    }).join('');
  }

  function rowHtml(item) {
    const user = `#${item.user_id} ${item.username} <span class="text-gray-500 text-xs">&lt;${item.email}&gt;</span>`;
    const total = Number(item.total_cnt || 0);
    const applied = Number(item.applied_cnt || 0);
    const percentage = typeof item.percentage === 'number' ? item.percentage : (total ? Math.round((applied / total) * 10000)/100 : 0);
    const targetFallback = Number(item.target_cnt || Math.max(total - applied, 0));
    const canRun = total > 0 && applied < total;

    return `
      <tr class="border-t">
        <td class="px-4 py-3 align-top">
          <div class="font-medium">${user}</div>
        </td>
        <td class="px-4 py-3 align-top">${statusBadgeFromProgress(applied, total, targetFallback)}</td>
        <td class="px-4 py-3 align-top">
          <div class="flex items-center gap-2">
            <span>${progressText(applied, total, percentage)}</span>
            ${renderMiniBar(percentage)}
          </div>
        </td>
        <td class="px-4 py-3 align-top">
          <div class="flex flex-wrap">${siteChips(item.sites)}</div>
        </td>
        <td class="px-4 py-3 align-top text-right">
          <button class="px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-50"
                  ${canRun ? '' : 'disabled'}
                  onclick="runUser(${item.user_id})">å®Ÿè¡Œ</button>
        </td>
      </tr>
    `;
  }

  function renderMiniBar(percentage) {
    const p = Math.max(0, Math.min(100, Number(percentage || 0)));
    return `
      <span class="inline-block w-28 h-2 bg-gray-200 rounded-full overflow-hidden align-middle" aria-hidden="true">
        <span class="block h-2" style="width:${p}%; background:#8b5cf6;"></span>
      </span>
    `;
  }

  async function fetchPage() {
    loadingEl.classList.remove('hidden');
    try {
      const params = new URLSearchParams({ page: String(page), per_page: String(perPage) });
      // æ—¢å®šã¯å…¬é–‹è¨˜äº‹ã®ã¿ã€‚å…¨ä»¶ã§è¦‹ãŸã„å ´åˆã¯ published_only=0 ã‚’ä»˜ä¸ï¼ˆå¿…è¦ã«å¿œã˜ã¦UIè¿½åŠ å¯ï¼‰
      params.set('published_only', '1');
      const q = (qEl.value || '').trim();
      if (q) params.set('q', q);
      const res = await fetch(`${listEp}?${params.toString()}`);
      const data = await res.json();
      total = Number(data.total || 0);
      rowsEl.innerHTML = (data.items || []).map(rowHtml).join('') || `
        <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>`;
      const lastPage = Math.max(1, Math.ceil(total / perPage));
      pagerInfo.textContent = `${page} / ${lastPage}ï¼ˆå…¨${total}äººï¼‰`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= lastPage;
    } catch(e) {
      rowsEl.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-600">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>`;
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  async function runUser(userId) {
    const btn = document.activeElement;
    btn?.setAttribute('disabled', 'disabled');
    try {
      const res = await fetch(runEp, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || data.ok===false) {
        alert('å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
      } else {
        // å®Ÿè¡Œå¾Œã«å½“è©²è¡Œã®é€²æ—ãŒé€²ã‚€å¯èƒ½æ€§ãŒé«˜ã„ã®ã§ãƒªãƒ­ãƒ¼ãƒ‰
        fetchPage();
      }
    } catch(e) {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼');
    } finally {
      btn?.removeAttribute('disabled');
    }
  }
  window.runUser = runUser;

  // æ¤œç´¢ãƒ‡ãƒã‚¦ãƒ³ã‚¹
  qEl.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => { page = 1; fetchPage(); }, 250);
  });
  reloadBtn.addEventListener('click', () => fetchPage());
  prevBtn.addEventListener('click', () => { if (page>1) { page--; fetchPage(); } });
  nextBtn.addEventListener('click', () => { page++; fetchPage(); });

  // åˆå›ãƒ­ãƒ¼ãƒ‰
  fetchPage();
</script>
{% endblock %}
