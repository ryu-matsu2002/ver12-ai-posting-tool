{% extends "base_admin.html" %}
{% block title %}Title/Metaå†ç”Ÿæˆ | ç®¡ç†è€…{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">ğŸ§© Title & Meta ãƒãƒƒãƒå†ç”Ÿæˆ</h1>
  <p class="text-sm text-gray-600 mb-6">
    æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®<strong>å…¨è¨˜äº‹</strong>ã«ã¤ã„ã¦ã€<code>&lt;title&gt;</code>ï¼ˆ=è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¨
    ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆAIç”Ÿæˆãƒ»æ—¢å®š180æ–‡å­—ï¼‰ã‚’ä¸€æ‹¬æ•´å‚™ã—ã¾ã™ã€‚<br>
    å®Ÿè¡Œãƒœã‚¿ãƒ³ã¯<strong>1ã¤ã ã‘</strong>ã€‚ã‚µãƒ¼ãƒå´ãŒè‡ªå‹•ã§æœ€å¾Œã¾ã§ï¼ˆå¿…è¦ã«å¿œã˜ã¦åˆ†å‰²ã—ãªãŒã‚‰ï¼‰å‡¦ç†ã—ã¾ã™ã€‚
  </p>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç°¡ç•¥åŒ–ï¼‰ -->
  <div class="bg-white rounded-2xl shadow p-5 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="user_select" class="block text-sm font-medium mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</label>

        <!-- æ¤œç´¢å…¥åŠ›ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ã§å€™è£œã‚’é…å»¶å–å¾—ï¼‰ -->
        <input id="user_search" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢ï¼ˆå…¥åŠ›ã§å€™è£œã‚’å–å¾—ï¼‰"
               class="w-full border rounded-lg px-3 py-2 mb-2" autocomplete="off">

        <!-- åˆå›ã¯ç©ºã€‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/æ¤œç´¢ã§å€™è£œã‚’AJAXæ³¨å…¥ -->
        <select id="user_select" class="w-full border rounded-lg px-3 py-2" aria-describedby="user_help">
          <option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ --</option>
        </select>

        <p id="user_help" class="text-xs text-gray-500 mt-1">
          â€» åˆå›è¡¨ç¤ºæ™‚ã¯é«˜é€ŸåŒ–ã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ã¾ã›ã‚“ã€‚å…¥åŠ›/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å€™è£œã‚’å–å¾—ã—ã¾ã™ã€‚
        </p>
      </div>

      <div class="flex items-end">
        <button id="btnAutoAll"
                class="w-full md:w-auto px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
          ğŸ” ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨è¨˜äº‹ã«é©ç”¨ï¼ˆè‡ªå‹•ã§æœ€å¾Œã¾ã§ï¼‰
        </button>
      </div>
    </div>
    <span id="busy" class="hidden text-sm text-gray-600" aria-live="polite">å®Ÿè¡Œä¸­â€¦å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„</span>
  </div>

  <!-- é€²æ—è¡¨ç¤º -->
  <div id="progress" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-2xl shadow p-5">
      <h3 class="font-semibold mb-1">é€²æ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</h3>
      <div class="text-sm text-gray-600 mb-2">
        åˆ†æ¯: <span id="p_total" class="font-semibold">-</span>ã€€
        åˆ†å­: <span id="p_applied" class="font-semibold">-</span>ã€€
        ç‡: <span id="p_pct" class="font-semibold">-</span>%
      </div>
      <label class="inline-flex items-center gap-2 text-xs">
        <input id="p_published_only" type="checkbox" class="h-4 w-4" checked>
        å…¬é–‹è¨˜äº‹ã®ã¿ã‚’å¯¾è±¡
      </label>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 md:col-span-2">
      <h3 class="font-semibold mb-2">ã‚µã‚¤ãƒˆåˆ¥å†…è¨³ï¼ˆä¸Šä½50ï¼‰</h3>
      <div id="p_by_site" class="text-sm text-gray-700 space-y-1 max-h-52 overflow-auto" aria-live="polite"></div>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div id="result" class="mt-6 space-y-4"></div>
</div>

<script>
  const endpoint        = "{{ url_for('admin.admin_title_meta_backfill') }}";
  const progressEp      = "{{ url_for('admin.admin_title_meta_progress') }}";
  const usersSuggestEp  = "{{ url_for('admin.admin_tools_users_suggest') }}";

  const el = (sel) => document.querySelector(sel);
  const userSearch = el('#user_search');
  const userSelect = el('#user_select');
  const btnAutoAll = el('#btnAutoAll');
  const busy       = el('#busy');
  const resultBox  = el('#result');
  const pPublished = el('#p_published_only');
  const pTotal     = el('#p_total');
  const pApplied   = el('#p_applied');
  const pPct       = el('#p_pct');
  const pBySite    = el('#p_by_site');

  function setBusy(v) {
    btnAutoAll.disabled = v || !(userSelect.value && userSelect.value.trim());
    busy.classList.toggle('hidden', !v);
    document.body.toggleAttribute('aria-busy', v);
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã®æœ‰ç„¡ã§ãƒœã‚¿ãƒ³æ´»æ€§/éæ´»æ€§
  function reflectButtonState() {
    btnAutoAll.disabled = !(userSelect.value && userSelect.value.trim());
  }

  // ---------------- ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œï¼ˆé…å»¶å–å¾—ï¼‰ ----------------
  let usersCtrl = null;   // AbortController
  let usersOnce = false;  // åˆå›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã€ç©ºæ¤œç´¢ã§20ä»¶ã ã‘å–å¾—

  function setUserOptions(items) {
    const current = userSelect.value || '';
    const opts = ['<option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ --</option>']
      .concat((items || []).map(it => `<option value="${it.id}">${it.label}</option>`));
    userSelect.innerHTML = opts.join('');
    // æ—¢å­˜é¸æŠãŒãƒªã‚¹ãƒˆã«ã‚ã‚Œã°ç¶­æŒ
    if (current && Array.from(userSelect.options).some(o => o.value === current)) {
      userSelect.value = current;
    }
    reflectButtonState();
  }

  async function fetchUsers(q) {
    try {
      if (usersCtrl) usersCtrl.abort();
      usersCtrl = new AbortController();
      const params = new URLSearchParams();
      if (q && q.trim()) params.set('q', q.trim());
      const res = await fetch(`${usersSuggestEp}?${params.toString()}`, { signal: usersCtrl.signal });
      const data = await res.json().catch(() => ({items: []}));
      setUserOptions(data.items || []);
    } catch (e) {
      // ä¸­æ–­/å¤±æ•—æ™‚ã¯å€™è£œã‚’ã‚¯ãƒªã‚¢ã›ãšç„¡è¦–
    }
  }

  // å…¥åŠ›ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
  let userDebounce = null;
  userSearch.addEventListener('input', () => {
    clearTimeout(userDebounce);
    userDebounce = setTimeout(() => {
      const q = userSearch.value;
      fetchUsers(q);
    }, 200);
  });

  // ã‚»ãƒ¬ã‚¯ãƒˆã«åˆå›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã‚‰ç©ºæ¤œç´¢ã§ç›´è¿‘20ä»¶
  userSelect.addEventListener('focus', () => {
    if (usersOnce) return;
    usersOnce = true;
    fetchUsers('');
  });

  // é¸æŠãŒå¤‰ã‚ã£ãŸã‚‰é€²æ—æ›´æ–°ï¼†ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
  userSelect.addEventListener('change', () => {
    reflectButtonState();
    refreshProgress();
  });

  // ---------------- é€²æ—æç”» ----------------
  let progressTimer = null;

  function safePercent(num) {
    const n = Number(num);
    return Number.isFinite(n) ? n : 0;
  }

  async function refreshProgress() {
    const uid = (userSelect.value || '').trim();
    if (!uid) {
      pTotal.textContent='-'; pApplied.textContent='-'; pPct.textContent='-'; pBySite.innerHTML='';
      return;
    }
    const po = pPublished.checked ? '1' : '0';
    const url = `${progressEp}?user_id=${encodeURIComponent(uid)}&published_only=${po}`;
    try {
      const res = await fetch(url);
      // ä¾‹å¤–ç³»(4xx/5xx)ã¯JSONã§ãªã„å¯èƒ½æ€§â†’ã‚¬ãƒ¼ãƒ‰
      if (!res.ok) {
        pBySite.innerHTML = `<div class="text-red-600">é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼ï¼šHTTP ${res.status}</div>`;
        return;
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'progress error');

      pTotal.textContent   = data.total;
      pApplied.textContent = data.applied;

      const pctNum = safePercent(data.percentage);
      pPct.textContent     = safePercent(pctNum).toFixed(2);

      const list = (data.by_site || []).slice(0, 50).map(r => {
        const t = Number(r.total) || 0;
        const a = Number(r.applied) || 0;
        const pct = t ? Math.round((a / t) * 100) : 0;
        return `<div>#${r.site_id} â€¦ ${a}/${t} (${pct}%)</div>`;
      }).join('');
      pBySite.innerHTML = list || '<div class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    } catch (e) {
      // è»½ã„å¤±æ•—ã¯ç„¡è¦–ï¼ˆUIä¸Šã¯é™ã‹ã«ï¼‰
    }
  }

  pPublished.addEventListener('change', refreshProgress);

  // ãƒãƒ¼ãƒªãƒ³ã‚°ã¯1æœ¬ã«é™å®š
  if (!progressTimer) {
    progressTimer = setInterval(refreshProgress, 5000);
  }

  // ---------------- å®Ÿè¡Œçµæœæç”» ----------------
  function escapeHtml(s) {
    return String(s || '').replace(/[&<>\"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderSummaryAuto(res) {
    // ãƒ«ãƒ¼ãƒ—å®Œèµ°å¾Œã‚µãƒ¼ãƒãŒè¿”ã™ã‚µãƒãƒªãƒ¼ã«å¯¾å¿œï¼ˆroutes ã®å®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼‰
    const updatedTotal = Number(res.updated_total ?? res.updated ?? 0);
    const iterations   = Number(res.iterations ?? 1);
    const lastCursor   = (res.last_cursor ?? res.cursor ?? '');
    const lastChunk    = res.last_chunk || {};
    const lastUpdated  = Number(lastChunk.updated ?? 0);
    const doneFlag     = (lastChunk.done === true) || (!lastCursor || lastCursor === 0);

    return `
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="font-semibold mb-2">å®Ÿè¡Œçµæœï¼ˆè‡ªå‹•å®Œèµ°ï¼‰</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-3 rounded-lg bg-gray-50">åˆè¨ˆæ›´æ–°<br><span class="text-lg font-bold">${updatedTotal}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">åå¾©å›æ•°<br><span class="text-lg font-bold">${iterations}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">æœ€çµ‚ãƒãƒ£ãƒ³ã‚¯æ›´æ–°<br><span class="text-lg font-bold">${lastUpdated}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">çŠ¶æ…‹<br><span class="text-lg font-bold">${doneFlag ? 'å®Œäº†' : 'æœªå®Œ'}</span></div>
        </div>
        <div class="mt-3 text-sm">last_cursor: <code class="px-2 py-1 bg-gray-100 rounded">${escapeHtml(String(lastCursor ?? ''))}</code></div>
      </div>
    `;
  }

  // ---------------- å®Ÿè¡Œ ----------------
  btnAutoAll.addEventListener('click', async () => {
    const uid = (userSelect.value || '').trim();
    if (!uid) { alert('å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }

    setBusy(true);
    resultBox.innerHTML = '';
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: Number(uid) })
      });

      let data = {};
      try { data = await res.json(); } catch (_){ /* éJSONã§ã‚‚è½ã¨ã•ãªã„ */ }

      if (!res.ok || data.ok === false) {
        resultBox.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
            <div class="font-semibold mb-1">ã‚¨ãƒ©ãƒ¼</div>
            <pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(data || {status: res.status}, null, 2))}</pre>
          </div>`;
        return;
      }

      resultBox.innerHTML = renderSummaryAuto(data);
      await refreshProgress();
    } catch (e) {
      resultBox.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
          <div class="font-semibold mb-1">é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>
          <pre class="text-xs whitespace-pre-wrap">${escapeHtml(String(e))}</pre>
        </div>`;
    } finally {
      setBusy(false);
    }
  });

  // Enter ã‚­ãƒ¼ã§å®Ÿè¡Œï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ï¼‰
  userSelect.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' && !btnAutoAll.disabled) {
      btnAutoAll.click();
    }
  });

  // åˆæœŸï¼šé«˜é€ŸåŒ–ã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼é…åˆ—ã¯æç”»ã—ãªã„
</script>
{% endblock %}
