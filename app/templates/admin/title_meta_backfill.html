{% extends "base_admin.html" %}
{% block title %}Title/Metaå†ç”Ÿæˆ | ç®¡ç†è€…{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">ğŸ§© Title & Meta ãƒãƒƒãƒå†ç”Ÿæˆ</h1>
  <p class="text-sm text-gray-600 mb-6">
    æ—¢å­˜è¨˜äº‹ã«å¯¾ã—ã¦ <code>&lt;title&gt;</code>ï¼ˆ=è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¨ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆAIç”Ÿæˆãƒ»æ—¢å®š180æ–‡å­—ï¼‰ã‚’ä¸€æ‹¬ã§æ•´å‚™ã—ã¾ã™ã€‚<br>
    <strong>Dry-run</strong> ã¯DBã‚’æ›¸ãæ›ãˆãšå·®åˆ†ã‚µãƒ³ãƒ—ãƒ«ã‚’è¿”ã—ã¾ã™ã€‚<strong>Push to WP</strong> ã¯DBåæ˜ å¾Œã€å…¬é–‹æ¸ˆã¿( posted )ã®è¨˜äº‹ã«é™ã‚ŠWordPressã®æŠœç²‹(Excerpt)ã‚„å¯¾å¿œå¯èƒ½ãªSEOãƒ¡ã‚¿ã¸åŒæœŸã‚’è©¦ã¿ã¾ã™ã€‚
  </p>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="bg-white rounded-2xl shadow p-5 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- user_id -->
      <div>
        <label class="block text-sm font-medium mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆIDç›´å…¥åŠ› or ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼‰</label>
        <div class="flex gap-2">
          <input id="user_id" type="number" min="1" placeholder="ID"
                 class="w-32 border rounded-lg px-3 py-2" value="">
          <input id="user_query" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢"
                 class="flex-1 border rounded-lg px-3 py-2" list="user_list">
          <datalist id="user_list"></datalist>
        </div>
        <p class="text-xs text-gray-500 mt-1">å€™è£œã‚’é¸ã¶ã¨IDæ¬„ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <!-- site_id -->
      <div>
        <label class="block text-sm font-medium mb-1">ã‚µã‚¤ãƒˆï¼ˆIDç›´å…¥åŠ› or ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼‰</label>
        <div class="flex gap-2">
          <input id="site_id" type="number" min="1" placeholder="ID"
                 class="w-32 border rounded-lg px-3 py-2" value="">
          <input id="site_query" type="text" placeholder="ã‚µã‚¤ãƒˆå/URLã§æ¤œç´¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã§çµè¾¼ï¼‰"
                 class="flex-1 border rounded-lg px-3 py-2" list="site_list">
          <datalist id="site_list"></datalist>
        </div>
        <p class="text-xs text-gray-500 mt-1">ç©ºãªã‚‰å…¨ã‚µã‚¤ãƒˆå¯¾è±¡ï¼ˆuser_idã§ã•ã‚‰ã«çµã‚Šè¾¼ã¿å¯ï¼‰</p>
      </div>

      <!-- limit -->
      <div>
        <label class="block text-sm font-medium mb-1">1å›ã®ä¸Šé™ä»¶æ•°</label>
        <input id="limit" type="number" min="1" max="2000" class="w-full border rounded-lg px-3 py-2" value="200">
        <p class="text-xs text-gray-500 mt-1">å¤§ããã—ã™ãã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚200ã€œ500ç¨‹åº¦æ¨å¥¨ã€‚</p>
      </div>

      <!-- after_id -->
      <div>
        <label class="block text-sm font-medium mb-1">ç¶šãã‚«ãƒ¼ã‚½ãƒ«ï¼ˆafter_idï¼‰</label>
        <input id="after_id" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="å‰å›ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® cursor ã‚’è²¼ã‚Šä»˜ã‘" value="">
        <p class="text-xs text-gray-500 mt-1">å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ãŸã„å ´åˆã«æŒ‡å®šï¼ˆç©ºãªã‚‰å…ˆé ­ã‹ã‚‰ï¼‰ã€‚</p>
      </div>

      <!-- dryrun -->
      <div class="flex items-center space-x-2">
        <input id="dryrun" type="checkbox" class="h-4 w-4">
        <label for="dryrun" class="text-sm font-medium">Dry-runï¼ˆDBæ›¸è¾¼ãªã—ãƒ»å·®åˆ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</label>
      </div>

      <!-- push_to_wp -->
      <div class="flex items-center space-x-2">
        <input id="push_to_wp" type="checkbox" class="h-4 w-4">
        <label for="push_to_wp" class="text-sm font-medium">Push to WPï¼ˆDBåæ˜ å¾Œã€WPã«ã‚‚åŒæœŸï¼‰</label>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="flex flex-wrap items-center gap-3 pt-2">
      <button id="btnPreview" class="px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-black transition">
        ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆDry-runï¼‰
      </button>
      <button id="btnApply" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        âœ… æœ¬é©ç”¨ï¼ˆDBã®ã¿ï¼‰
      </button>
      <button id="btnApplyPush" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition">
        ğŸš€ æœ¬é©ç”¨ + WPåæ˜ 
      </button>
      <button id="btnNextCursor" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition hidden">
        â­ï¸ ã¤ã¥ãã‚’å®Ÿè¡Œï¼ˆæ¬¡ã‚«ãƒ¼ã‚½ãƒ«ï¼‰
      </button>

      <button id="btnAutoAll" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition">
        ğŸ” ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨è¨˜äº‹ã«é©ç”¨ï¼ˆè‡ªå‹•ã§æœ€å¾Œã¾ã§ï¼‰
      </button>

      <span id="busy" class="hidden text-sm text-gray-600">å®Ÿè¡Œä¸­â€¦å°‘ã€…ãŠå¾…ã¡ã‚’</span>
    </div>
  </div>

  <!-- é€²æ—è¡¨ç¤º -->
  <div id="progress" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white rounded-2xl shadow p-5">
      <h3 class="font-semibold mb-1">é€²æ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</h3>
      <div class="text-sm text-gray-600 mb-2">
        åˆ†æ¯: <span id="p_total" class="font-semibold">-</span>ã€€
        åˆ†å­: <span id="p_applied" class="font-semibold">-</span>ã€€
        ç‡: <span id="p_pct" class="font-semibold">-</span>%
      </div>
      <label class="inline-flex items-center gap-2 text-xs">
        <input id="p_published_only" type="checkbox" class="h-4 w-4" checked>
        å…¬é–‹è¨˜äº‹ã®ã¿ã‚’å¯¾è±¡
      </label>
    </div>
    <div class="bg-white rounded-2xl shadow p-5 md:col-span-2">
      <h3 class="font-semibold mb-2">ã‚µã‚¤ãƒˆåˆ¥å†…è¨³ï¼ˆä¸Šä½ï¼‰</h3>
      <div id="p_by_site" class="text-sm text-gray-700 space-y-1 max-h-52 overflow-auto"></div>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div id="result" class="mt-6 space-y-4"></div>
</div>

<script>
  const endpoint = "{{ url_for('admin.admin_title_meta_backfill') }}";
  const usersSuggestEp = "{{ url_for('admin.admin_tools_users_suggest') }}";
  const sitesSuggestEp = "{{ url_for('admin.admin_tools_sites_suggest') }}";
  const progressEp     = "{{ url_for('admin.admin_title_meta_progress') }}";

  const el = (sel) => document.querySelector(sel);
  const btnPreview    = el('#btnPreview');
  const btnApply      = el('#btnApply');
  const btnApplyPush  = el('#btnApplyPush');
  const btnNextCursor = el('#btnNextCursor');
  const btnAutoAll    = el('#btnAutoAll');
  const busy          = el('#busy');
  const resultBox     = el('#result');
  const userQuery     = el('#user_query');
  const userList      = el('#user_list');
  const siteQuery     = el('#site_query');
  const siteList      = el('#site_list');
  const pPublished    = el('#p_published_only');
  const pTotal        = el('#p_total');
  const pApplied      = el('#p_applied');
  const pPct          = el('#p_pct');
  const pBySite       = el('#p_by_site');

  function getParams({forceDryrun=null, forcePush=null, useCursor=false} = {}) {
    const site_id   = el('#site_id').value.trim();
    const user_id   = el('#user_id').value.trim();
    const limit     = el('#limit').value.trim() || "200";
    const dryrun    = (forceDryrun !== null) ? forceDryrun : el('#dryrun').checked;
    const push_to_wp= (forcePush   !== null) ? forcePush   : el('#push_to_wp').checked;
    const after_id  = useCursor ? (btnNextCursor.dataset.cursor || "") : (el('#after_id').value.trim());

    const params = new URLSearchParams();
    if (site_id)   params.set('site_id', site_id);
    if (user_id)   params.set('user_id', user_id);
    if (limit)     params.set('limit', limit);
    if (dryrun)    params.set('dryrun', '1');
    if (push_to_wp && !dryrun) params.set('push_to_wp', '1'); // dryrunä¸­ã¯ç„¡åŠ¹
    if (after_id)  params.set('after_id', after_id);
    return params;
  }

  function setBusy(v) {
    [btnPreview, btnApply, btnApplyPush, btnNextCursor].forEach(b => b.disabled = v);
    busy.classList.toggle('hidden', !v);
  }

  function renderSummaryCard(res) {
    const {
      total, scanned, updated, failed, skipped_manual,
      cursor, elapsed_ms, samples = [],
      wp_synced, wp_errors
    } = res;

    const wpLine = (typeof wp_synced !== 'undefined' || typeof wp_errors !== 'undefined')
      ? `<div class="text-sm">WPåŒæœŸ: <span class="font-medium">${wp_synced||0}</span> æˆåŠŸ / <span class="font-medium">${wp_errors||0}</span> ã‚¨ãƒ©ãƒ¼</div>`
      : '';

    const card = `
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="font-semibold mb-2">å®Ÿè¡Œçµæœ</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="p-3 rounded-lg bg-gray-50">total<br><span class="text-lg font-bold">${total||0}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">scanned<br><span class="text-lg font-bold">${scanned||0}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">updated (DB)<br><span class="text-lg font-bold">${updated||0}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">failed<br><span class="text-lg font-bold text-red-600">${failed||0}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">skipped_manual<br><span class="text-lg font-bold">${skipped_manual||0}</span></div>
          <div class="p-3 rounded-lg bg-gray-50">elapsed<br><span class="text-lg font-bold">${elapsed_ms||0} ms</span></div>
        </div>
        ${wpLine}
        <div class="mt-3 text-sm">æ¬¡ã‚«ãƒ¼ã‚½ãƒ«: <code class="px-2 py-1 bg-gray-100 rounded">${cursor ?? ''}</code></div>
      </div>
    `;
    return card;
  }

  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function renderSamplesTable(samples) {
    if (!samples || samples.length === 0) return `
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold mb-2">å·®åˆ†ã‚µãƒ³ãƒ—ãƒ«</h3>
        <p class="text-sm text-gray-600">ã‚µãƒ³ãƒ—ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆä»¶æ•°ãŒå°‘ãªã„ã€ã¾ãŸã¯æœ¬é©ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚</p>
      </div>
    `;

    const rows = samples.map(s => `
      <tr class="border-t">
        <td class="px-3 py-2 text-sm">#${s.id}</td>
        <td class="px-3 py-2 text-sm">${escapeHtml(s.title||'')}</td>
        <td class="px-3 py-2 text-sm">${escapeHtml(s.keyword||'')}</td>
        <td class="px-3 py-2 text-xs">
          <div class="font-mono whitespace-pre-wrap break-words">${escapeHtml(s.current||'')}</div>
          <div class="text-gray-500 mt-1">len=${s.current_len||0} / quality=${escapeHtml(s.current_quality||'')}</div>
        </td>
        <td class="px-3 py-2 text-xs">
          <div class="font-mono whitespace-pre-wrap break-words">${escapeHtml(s.suggest||'')}</div>
          <div class="text-gray-500 mt-1">len=${s.suggest_len||0} / quality=${escapeHtml(s.suggest_quality||'')}</div>
        </td>
      </tr>
    `).join('');

    return `
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="font-semibold mb-3">å·®åˆ†ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€å¤§20ä»¶ï¼‰</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left">
            <thead>
              <tr class="border-b">
                <th class="px-3 py-2 text-xs font-medium text-gray-500">ID</th>
                <th class="px-3 py-2 text-xs font-medium text-gray-500">Title</th>
                <th class="px-3 py-2 text-xs font-medium text-gray-500">Keyword</th>
                <th class="px-3 py-2 text-xs font-medium text-gray-500">Current Meta</th>
                <th class="px-3 py-2 text-xs font-medium text-gray-500">Suggested Meta</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  function setNextCursor(cursor) {
    if (cursor && Number(cursor) > 0) {
      btnNextCursor.dataset.cursor = String(cursor);
      btnNextCursor.classList.remove('hidden');
    } else {
      btnNextCursor.dataset.cursor = '';
      btnNextCursor.classList.add('hidden');
    }
  }

  // ---------- ã‚µã‚¸ã‚§ã‚¹ãƒˆ ----------
  let userSuggestTimer = null;
  userQuery.addEventListener('input', () => {
    clearTimeout(userSuggestTimer);
    userSuggestTimer = setTimeout(async () => {
      const q = userQuery.value.trim();
      if (!q) { userList.innerHTML = ''; return; }
      const res = await fetch(`${usersSuggestEp}?q=${encodeURIComponent(q)}`);
      const data = await res.json().catch(() => ({items: []}));
      userList.innerHTML = (data.items || []).map(it => `<option value="${it.label}" data-id="${it.id}">`).join('');
    }, 200);
  });
  userQuery.addEventListener('change', () => {
    const opt = Array.from(userList.options).find(o => o.value === userQuery.value);
    if (opt && opt.getAttribute('data-id')) {
      el('#user_id').value = opt.getAttribute('data-id');
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºã¾ã£ãŸã‚‰ã‚µã‚¤ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆã‚‚çµã‚Šè¾¼ã‚ã‚‹
      siteList.innerHTML = '';
      siteQuery.value = '';
      refreshProgress(); // æ±ºå®šã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é€²æ—å³æ›´æ–°
    }
  });

  let siteSuggestTimer = null;
  siteQuery.addEventListener('input', () => {
    clearTimeout(siteSuggestTimer);
    siteSuggestTimer = setTimeout(async () => {
      const q = siteQuery.value.trim();
      const uid = el('#user_id').value.trim();
      if (!q) { siteList.innerHTML = ''; return; }
      const url = `${sitesSuggestEp}?q=${encodeURIComponent(q)}${uid ? `&user_id=${uid}` : ''}`;
      const res = await fetch(url);
      const data = await res.json().catch(() => ({items: []}));
      siteList.innerHTML = (data.items || []).map(it => `<option value="${it.label}" data-id="${it.id}">`).join('');
    }, 200);
  });
  siteQuery.addEventListener('change', () => {
    const opt = Array.from(siteList.options).find(o => o.value === siteQuery.value);
    if (opt && opt.getAttribute('data-id')) {
      el('#site_id').value = opt.getAttribute('data-id');
    }
  });

  // ---------- é€²æ— ----------
  async function refreshProgress() {
    const uid = (el('#user_id').value || '').trim();
    if (!uid) { pTotal.textContent='-'; pApplied.textContent='-'; pPct.textContent='-'; pBySite.innerHTML=''; return; }
    const po = pPublished.checked ? '1' : '0';
    const url = `${progressEp}?user_id=${encodeURIComponent(uid)}&published_only=${po}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'progress error');
      pTotal.textContent = data.total;
      pApplied.textContent = data.applied;
      pPct.textContent = data.percentage.toFixed(2);
      pBySite.innerHTML = (data.by_site || []).map(r => {
        const pct = r.total ? Math.round((r.applied / r.total) * 100) : 0;
        return `<div>#${r.site_id} â€¦ ${r.applied}/${r.total} (${pct}%)</div>`;
      }).join('');
    } catch(e) {
      // è»½ãç„¡è¦–ï¼ˆUIãƒã‚¤ã‚ºã«ã—ãªã„ï¼‰
    }
  }
  pPublished.addEventListener('change', refreshProgress);
  setInterval(refreshProgress, 5000);


  async function runBatch(params) {
    setBusy(true);
    try {
      const url = `${endpoint}?${params.toString()}`;
      const res = await fetch(url, { method: 'GET' });
      const data = await res.json().catch(() => ({}));

      // å¤±æ•—æ™‚
      if (!res.ok || data.ok === false) {
        resultBox.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
            <div class="font-semibold mb-1">ã‚¨ãƒ©ãƒ¼</div>
            <pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
          </div>`;
        setNextCursor(null);
        return;
      }

      // æˆåŠŸæ™‚
      const summary = renderSummaryCard(data);
      const samples = params.get('dryrun') ? renderSamplesTable(data.samples || []) : '';
      resultBox.innerHTML = summary + samples;

      // æ¬¡ã‚«ãƒ¼ã‚½ãƒ«
      setNextCursor(data.cursor);

      // å…¥åŠ›æ¬„ã«ã‚‚åæ˜ ï¼ˆä»»æ„ï¼‰
      if (data.cursor) {
        el('#after_id').value = data.cursor;
      }
    } catch (e) {
      resultBox.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4">
          <div class="font-semibold mb-1">é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>
          <pre class="text-xs whitespace-pre-wrap">${escapeHtml(String(e))}</pre>
        </div>`;
      setNextCursor(null);
    } finally {
      setBusy(false);
    }
  }

  btnPreview.addEventListener('click', () => {
    const p = getParams({ forceDryrun: true, forcePush: false, useCursor: false });
    runBatch(p);
  });

  btnApply.addEventListener('click', () => {
    const p = getParams({ forceDryrun: false, forcePush: false, useCursor: false });
    runBatch(p);
  });

  btnApplyPush.addEventListener('click', () => {
    const p = getParams({ forceDryrun: false, forcePush: true, useCursor: false });
    runBatch(p);
  });

  btnNextCursor.addEventListener('click', () => {
    const isDry = el('#dryrun').checked; // ç›´å‰ã®ãƒ¢ãƒ¼ãƒ‰ã‚’è¸è¥²
    const willPush = el('#push_to_wp').checked && !isDry;
    const p = getParams({ forceDryrun: isDry, forcePush: willPush, useCursor: true });
    runBatch(p);
  });

  // ---------- è‡ªå‹•ã§æœ€å¾Œã¾ã§ï¼ˆcursor ãŒå°½ãã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ï¼‰ ----------
  btnAutoAll.addEventListener('click', async () => {
    const uid = (el('#user_id').value || '').trim();
    if (!uid) { alert('å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æœ¬é©ç”¨ï¼ˆDBã®ã¿ or WPåŒæœŸã¯ãƒã‚§ãƒƒã‚¯ã«å¾“ã†ï¼‰
    let isDry = false;
    const willPush = el('#push_to_wp').checked;
    let cursor = null;
    do {
      const p = getParams({ forceDryrun: isDry, forcePush: willPush, useCursor: !!cursor });
      if (cursor) p.set('after_id', cursor);
      await runBatch(p);
      // æ¬¡ã‚«ãƒ¼ã‚½ãƒ«ã‚’èª­ã‚€
      cursor = btnNextCursor.dataset.cursor || '';
      await new Promise(r => setTimeout(r, 250)); // å°ä¼‘æ­¢ã§è² è·å¹³æº–åŒ–
      await refreshProgress(); // é€æ¬¡é€²æ—æ›´æ–°
    } while (cursor && Number(cursor) > 0);
  });
</script>
{% endblock %}
