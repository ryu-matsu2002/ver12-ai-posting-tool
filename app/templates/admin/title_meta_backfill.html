{% extends "base_admin.html" %}
{% block title %}Title/Meta再生成 | 管理者{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-3">🧩 Title & Meta バッチ再生成</h1>
  <p class="text-sm text-gray-600 mb-6">
    各ユーザーの<strong>既存記事</strong>について、&lt;title&gt; とメタディスクリプション（AI 生成・既定180字）を
    一括整備します。行右端の<strong>「実行」</strong>を押すだけで、そのユーザーの全対象記事を最後まで自動処理します。
  </p>

  <!-- 操作バー（検索・更新） -->
  <div class="bg-white rounded-2xl shadow p-4 mb-4 flex flex-col md:flex-row gap-3 md:items-center">
    <div class="flex-1 flex gap-2">
      <input id="q" type="text" placeholder="ユーザー名で絞り込み（クライアント側フィルタ）"
             class="w-full border rounded-lg px-3 py-2" autocomplete="off">
      <button id="btnReload"
              class="px-3 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100">
        再読込
      </button>
    </div>
    <div class="text-xs text-gray-500">
      対象品質: <code>empty, too_short, too_long, duplicate</code>（変更は API 側パラメータで可）
    </div>
  </div>

  <!-- 一覧（1 ユーザー 1 行） -->
  <div class="bg-white rounded-2xl shadow">
    <div class="px-4 py-3 border-b text-sm text-gray-600 flex justify-between">
      <div>ユーザー一覧（非同期取得）</div>
      <div id="loadState" class="text-gray-500">読み込み待機中…</div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-4 py-2 w-56">ユーザー</th>
            <th class="text-left px-4 py-2 w-28">対象件数</th>
            <th class="text-left px-4 py-2">サイト内訳</th>
            <th class="text-left px-4 py-2 w-40">直近の結果</th>
            <th class="text-right px-4 py-2 w-36">操作</th>
          </tr>
        </thead>
        <tbody id="userRows">
          <!-- 非同期に挿入 -->
        </tbody>
      </table>
    </div>
  </div>

  <p class="text-xs text-gray-500 mt-3">
    初期表示は DB を叩かずに 1 秒以内で開きます。行データは AJAX で軽量取得しています。
  </p>
</div>

<script>
  // エンドポイント
  const listEp     = "{{ url_for('admin.admin_title_meta_users') }}";
  const runEp      = "{{ url_for('admin.admin_title_meta_backfill') }}";

  // DOM 参照
  const el = (s) => document.querySelector(s);
  const userRows = el('#userRows');
  const qInput   = el('#q');
  const loadState = el('#loadState');
  const btnReload = el('#btnReload');

  // 状態
  let rawUsers = [];   // API からの生配列
  let running  = new Set(); // 実行中 user_id

  // HTML ユーティリティ
  const esc = (s) => String(s ?? '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const fmtInt = (n) => Number(n||0).toLocaleString();

  function siteChip(s) {
    // s: {site_id, name, targets, posted, done}
    return `
      <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full border bg-gray-50 mr-2 mb-2">
        <span class="text-gray-700">${esc(s.name)}</span>
        <span class="text-gray-500">#${s.site_id}</span>
        <span class="text-gray-800 font-medium">${fmtInt(s.targets)}</span>
        <span class="text-xs text-gray-500">(posted:${fmtInt(s.posted)} / done:${fmtInt(s.done)})</span>
      </span>
    `;
  }

  function actionCell(user_id) {
    const busy = running.has(user_id);
    return `
      <button data-run="${user_id}"
              class="px-3 py-2 rounded-lg text-white ${busy?'bg-gray-400 cursor-not-allowed':'bg-purple-600 hover:bg-purple-700'}"
              ${busy?'disabled':''}>
        ${busy ? '実行中…' : '実行'}
      </button>
    `;
  }

  function rowHTML(u) {
    // u: {user_id, name, targets, sites:[...] }
    const sites = (u.sites||[]).map(siteChip).join('');
    return `
      <tr class="border-t">
        <td class="px-4 py-3">
          <div class="font-medium">${esc(u.name)}</div>
          <div class="text-xs text-gray-500">#${u.user_id}</div>
        </td>
        <td class="px-4 py-3">
          <div class="font-bold">${fmtInt(u.targets)}</div>
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-wrap">${sites || '<span class="text-gray-400">内訳なし</span>'}</div>
        </td>
        <td class="px-4 py-3">
          <div id="r-${u.user_id}" class="text-xs text-gray-600">-</div>
        </td>
        <td class="px-4 py-3 text-right">
          ${actionCell(u.user_id)}
        </td>
      </tr>
    `;
  }

  function renderList(filterText='') {
    const f = (filterText || '').trim().toLowerCase();
    const rows = rawUsers
      .filter(u => !f || String(u.name||'').toLowerCase().includes(f) || String(u.user_id).includes(f))
      .map(rowHTML)
      .join('');
    userRows.innerHTML = rows || `
      <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">該当ユーザーが見つかりません</td></tr>`;
    // 再アタッチ（動的生成のため）
    attachRowHandlers();
  }

  function attachRowHandlers() {
    userRows.querySelectorAll('button[data-run]').forEach(btn => {
      btn.addEventListener('click', () => runForUser(Number(btn.dataset.run)));
    });
  }

  async function loadList() {
    try {
      loadState.textContent = '読み込み中…';
      const res = await fetch(listEp, { cache: 'no-store' });
      const data = await res.json().catch(() => ({users:[]}));
      rawUsers = Array.isArray(data.users) ? data.users : [];
      renderList(qInput.value);
      loadState.textContent = `読み込み完了（${rawUsers.length}件）`;
    } catch(e) {
      loadState.textContent = '読み込みエラー';
      userRows.innerHTML = `
        <tr><td colspan="5" class="px-4 py-6 text-center text-red-600">一覧の取得に失敗しました</td></tr>`;
    }
  }

  async function runForUser(user_id) {
    if (running.has(user_id)) return;
    running.add(user_id);
    // ボタン再描画
    const cell = userRows.querySelector(`button[data-run="${user_id}"]`);
    if (cell) {
      cell.outerHTML = actionCell(user_id);
      attachRowHandlers();
    }
    const resBox = el(`#r-${user_id}`);
    if (resBox) resBox.textContent = '実行リクエスト送信中…';

    try {
      const res = await fetch(runEp, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || data.ok === false) {
        const msg = data.error ? `エラー: ${data.error}` : `HTTP ${res.status}`;
        if (resBox) resBox.textContent = msg;
      } else {
        // サマリーを軽く表示
        const total = Number(data.updated_total ?? data.updated ?? 0);
        const iters = Number(data.iterations ?? 1);
        const okWp  = (data.wp && data.wp.ok) ? ` / WP OK ${data.wp.ok}` : '';
        if (resBox) resBox.textContent = `完了: 更新 ${total}件 / 反復 ${iters}${okWp}`;
      }
    } catch(e) {
      if (resBox) resBox.textContent = '通信エラー';
    } finally {
      running.delete(user_id);
      // ボタン再描画
      const cell2 = userRows.querySelector(`button[data-run="${user_id}"]`);
      if (cell2) {
        cell2.outerHTML = actionCell(user_id);
        attachRowHandlers();
      }
    }
  }

  // 入力フィルタ（デバウンス）
  let deb = null;
  qInput.addEventListener('input', () => {
    clearTimeout(deb);
    deb = setTimeout(() => renderList(qInput.value), 150);
  });

  btnReload.addEventListener('click', loadList);

  // 初期ロード：サーバーはHTMLだけ返し DB は触らない → JS で軽量APIを叩く
  loadList();
</script>
{% endblock %}
