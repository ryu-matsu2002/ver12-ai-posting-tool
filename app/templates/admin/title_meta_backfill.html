{% extends "base_admin.html" %}
{% block title %}Title/Metaå†ç”Ÿæˆ | ç®¡ç†è€…{% endblock %}

{% block content %}
<div class="px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">ğŸ§© Title & Meta ãƒãƒƒãƒå†ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰</h1>

  <div class="bg-white rounded-2xl shadow p-4 mb-4">
    <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
      <div class="flex-1 w-full">
        <input id="q" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§çµã‚Šè¾¼ã¿â€¦" />
      </div>
      <div class="flex items-center gap-2">
        <button id="btnReload" class="px-3 py-2 rounded-lg border hover:bg-gray-50">å†èª­è¾¼</button>
      </div>
    </div>
    <div class="text-xs text-gray-500 mt-2">
      åˆ†æ¯ï¼<strong>WPåæ˜ å¯¾è±¡ï¼ˆpostedè¨˜äº‹ï¼‰</strong> ï¼ åˆ†å­ï¼<code>WPã¸ãƒ¡ã‚¿åæ˜ ã§ããŸä»¶æ•°</code> ï¼ æ‰‹å‹•ãƒ¡ã‚¿é™¤å¤–
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow overflow-hidden">
    <div class="border-b px-4 py-2 text-sm text-gray-600 flex items-center justify-between">
      <div>è¡¨ç¤ºã¯é…å»¶å–å¾—ï¼ˆåˆå›DBãªã—ã§é«˜é€Ÿè¡¨ç¤ºï¼‰</div>
      <div id="loading" class="hidden">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-4 py-2 w-64">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
            <th class="text-left px-4 py-2 w-36">çŠ¶æ…‹</th>
            <th class="text-left px-4 py-2 w-56">é€²æ—</th>
            <th class="text-left px-4 py-2">ã‚µã‚¤ãƒˆå†…è¨³</th>
            <th class="text-right px-4 py-2 w-28">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="border-t px-4 py-3 flex items-center justify-between text-sm">
      <div><span id="pagerInfo">0 / 0</span></div>
      <div class="space-x-2">
        <button id="prev" class="px-3 py-1 border rounded disabled:opacity-50" disabled>å‰ã¸</button>
        <button id="next" class="px-3 py-1 border rounded disabled:opacity-50" disabled>æ¬¡ã¸</button>
      </div>
    </div>
  </div>

  <!-- å®Ÿè¡Œçµæœã®ç°¡æ˜“ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="resultModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white rounded-xl shadow-xl w-[520px] max-w-[92vw] p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">WPåæ˜  å®Ÿè¡Œçµæœ</h2>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700">âœ•</button>
      </div>
      <div id="resultBody" class="text-sm space-y-2">
        <!-- å‹•çš„ã«åŸ‹ã‚è¾¼ã‚€ -->
      </div>
      <div class="text-right mt-4">
        <button id="okModal" class="px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
  const listEp = "{{ url_for('admin.admin_title_meta_rows') }}";
  const runEp  = "{{ url_for('admin.admin_title_meta_backfill') }}";

  const el = (s) => document.querySelector(s);
  const rowsEl = el('#rows');
  const qEl = el('#q');
  const loadingEl = el('#loading');
  const pagerInfo = el('#pagerInfo');
  const prevBtn = el('#prev');
  const nextBtn = el('#next');
  const reloadBtn = el('#btnReload');

  const modal = el('#resultModal');
  const closeModalBtn = el('#closeModal');
  const okModalBtn = el('#okModal');
  const resultBody = el('#resultBody');

  let page = 1, perPage = 20, total = 0, debounceTimer = null;

  const pill = (text, hint='') =>
    `<span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-700 mr-2 mb-1" title="${hint}">${text}</span>`;

  function statusBadge(applied, total, fallback=0){
    const ok = total>0 ? (applied>=total) : (fallback===0);
    const cls = ok ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-800';
    const label = ok ? 'æ•´å‚™æ¸ˆã¿' : 'æ•´å‚™ä¸­';
    return `<span class="inline-flex px-2 py-1 rounded ${cls}">${label}</span>`;
  }

  const roundPct = (num)=> Math.round(num * 100) / 100;

  const progressText = (a,t)=>{
    const p = (t>0) ? roundPct((a / t) * 100) : 0;
    return `${a} / ${t}ï¼ˆ${p}%ï¼‰`;
  };

  const miniBar = (a,t)=>{
    const pct = (t>0) ? Math.max(0, Math.min(100, (a/t)*100)) : 0;
    return `<span class="inline-block w-28 h-2 bg-gray-200 rounded-full overflow-hidden align-middle" aria-hidden="true">
              <span class="block h-2" style="width:${pct}%; background:#8b5cf6;"></span>
            </span>`;
  };

  const siteChips = (sites)=>{
    if(!Array.isArray(sites)||!sites.length) return '<span class="text-gray-400">ï¼ˆãªã—ï¼‰</span>';
    return sites.map(s=>{
      const txt = `${s.name} #${s.site_id} ${s.applied}/${s.total}ï¼ˆ${s.percentage}%ï¼‰`;
      return pill(txt, `site_id=${s.site_id}`);
    }).join('');
  };

  function rowHtml(item){
    // åˆå›æç”»ã¯å¾“æ¥ã®é›†è¨ˆï¼ˆmetaé©ç”¨ï¼‰ã§æããŒã€å®Ÿè¡Œå¾Œã¯WPå®Ÿç¸¾ã§ä¸Šæ›¸ãã™ã‚‹
    const total = Number(item.total_cnt||0);
    const applied = Number(item.applied_cnt||0);
    const fallback = Number(item.target_cnt || Math.max(total - applied,0));
    const canRun = total>0 && applied<total;

    return `
      <tr class="border-t" data-user-row="${item.user_id}">
        <td class="px-4 py-3 align-top">
          <div class="font-medium">#${item.user_id} ${item.username} <span class="text-gray-500 text-xs">&lt;${item.email}&gt;</span></div>
        </td>
        <td class="px-4 py-3 align-top">
          <span class="js-status">${statusBadge(applied,total,fallback)}</span>
          <div class="text-[11px] text-gray-500 mt-1 js-basis">è¡¨ç¤ºåŸºæº–: DBé©ç”¨</div>
        </td>
        <td class="px-4 py-3 align-top">
          <div class="flex items-center gap-2">
            <span class="js-progress-text">${progressText(applied,total)}</span>
            <span class="js-bar">${miniBar(applied,total)}</span>
          </div>
        </td>
        <td class="px-4 py-3 align-top">
          <div class="flex flex-wrap">${siteChips(item.sites)}</div>
        </td>
        <td class="px-4 py-3 align-top text-right">
          <button class="px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-50"
                  data-user-id="${item.user_id}" ${canRun?'':'disabled'}>å®Ÿè¡Œ</button>
        </td>
      </tr>`;
  }

  function getCsrfToken(){
    const m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.getAttribute('content') : '';
  }

  async function fetchPage(){
    loadingEl.classList.remove('hidden');
    try{
      const params = new URLSearchParams({ page:String(page), per_page:String(perPage), published_only:'1' });
      const q = (qEl.value||'').trim(); if(q) params.set('q', q);
      const res = await fetch(`${listEp}?${params.toString()}`);
      const data = await res.json();
      total = Number(data.total||0);
      rowsEl.innerHTML = (data.items||[]).map(rowHtml).join('') ||
        `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>`;
      const lastPage = Math.max(1, Math.ceil(total / perPage));
      pagerInfo.textContent = `${page} / ${lastPage}ï¼ˆå…¨${total}äººï¼‰`;
      prevBtn.disabled = page<=1;
      nextBtn.disabled = page>=lastPage;
    }catch(e){
      rowsEl.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-600">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>`;
    }finally{
      loadingEl.classList.add('hidden');
    }
  }

  // ---- å®Ÿè¡Œå¾Œï¼šå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œã‚’WPå®Ÿç¸¾ã§ä¸Šæ›¸ãè¡¨ç¤ºã™ã‚‹ ----
  function applyWpResultToRow(userId, wpSyncedOk, wpTargetTotal){
    const row = rowsEl.querySelector(`tr[data-user-row="${userId}"]`);
    if(!row) return;

    const a = Number(wpSyncedOk||0);
    const t = Number(wpTargetTotal||0);

    // é€²æ—ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒãƒ¼
    const progressTextEl = row.querySelector('.js-progress-text');
    const barEl = row.querySelector('.js-bar');
    if(progressTextEl) progressTextEl.textContent = progressText(a, t);
    if(barEl) barEl.innerHTML = miniBar(a, t);

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    const statusEl = row.querySelector('.js-status');
    if(statusEl) statusEl.innerHTML = statusBadge(a, t, Math.max(t - a, 0));

    // è¡¨ç¤ºåŸºæº–ã®æ³¨è¨˜
    const basisEl = row.querySelector('.js-basis');
    if(basisEl) basisEl.textContent = 'è¡¨ç¤ºåŸºæº–: WPåæ˜ å®Ÿç¸¾';
  }

  function showResultModal(summary){
    const ok = !!summary?.ok;
    const rows = [];
    rows.push(`<div class="font-medium ${ok?'text-green-700':'text-red-700'}">${ok?'å®Œäº†':'å¤±æ•—'}</div>`);
    if(summary){
      const a = Number(summary.wp_synced_ok||0);
      const t = Number(summary.wp_target_total||0);
      const unres = Number(summary.wp_unresolved||0);
      const fail = Number(summary.wp_failed||0);
      const pct = t>0 ? roundPct((a/t)*100) : 0;

      rows.push(`<div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ #${summary.user_id}</div>`);
      rows.push(`<div class="mt-2">WPåæ˜ : <strong>${a} / ${t}ï¼ˆ${pct}%ï¼‰</strong></div>`);
      rows.push(`<div class="text-gray-600">æœªè§£æ±ºï¼ˆwp_post_idæœªç‰¹å®šï¼‰: ${unres} / å¤±æ•—: ${fail}</div>`);
    }
    resultBody.innerHTML = rows.join('');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function hideResultModal(){
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  // â˜… ã‚¯ãƒªãƒƒã‚¯å§”è­²
  rowsEl.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-user-id]');
    if(!btn) return;
    const userId = Number(btn.getAttribute('data-user-id'));
    if(!userId || btn.disabled) return;

    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'å®Ÿè¡Œä¸­â€¦';
    try{
      const headers = {'Content-Type':'application/json'};
      const csrf = getCsrfToken(); if(csrf) headers['X-CSRFToken']=csrf;

      // æŠ¼ä¸‹ç›´å¾Œã«100%ã«ã—ãªã„ï¼šå®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…ã£ã¦ã‹ã‚‰UIæ›´æ–°
      const res = await fetch(runEp, { method:'POST', headers, body: JSON.stringify({ user_id: userId }) });
      const text = await res.text();
      if(!res.ok){
        alert(`å®Ÿè¡Œã«å¤±æ•—ï¼ˆ${res.status}ï¼‰\n${text.slice(0,300)}`);
      }else{
        let data={}; try{ data = text? JSON.parse(text):{} }catch{}
        if(data.ok===false){
          alert(`å®Ÿè¡Œã«å¤±æ•—\n${data.error||'unknown error'}`);
        }else{
          // â˜… å®Ÿè¡Œç›´å¾Œã®è¡¨ç¤ºã¯ã€ŒWPåæ˜ å®Ÿç¸¾ã€ã§ä¸Šæ›¸ãï¼ˆåˆ†å­/åˆ†æ¯ã‚’WPåŸºæº–ã«å·®ã—æ›¿ãˆï¼‰
          const a = Number(data.wp_synced_ok||0);
          const t = Number(data.wp_target_total||0);
          applyWpResultToRow(userId, a, t);
          // çµæœãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          showResultModal(data);
        }
      }
    }catch(e){
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message||e));
    }finally{
      btn.disabled = false; btn.textContent = original;
    }
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  closeModalBtn.addEventListener('click', hideResultModal);
  okModalBtn.addEventListener('click', hideResultModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) hideResultModal(); });

  // UIæ“ä½œ
  qEl.addEventListener('input', ()=>{
    clearTimeout(debounceTimer);
    debounceTimer=setTimeout(()=>{ page=1; fetchPage(); },250);
  });
  reloadBtn.addEventListener('click', ()=>fetchPage());
  prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; fetchPage(); } });
  nextBtn.addEventListener('click', ()=>{ page++; fetchPage(); });

  fetchPage();
</script>
{% endblock %}
