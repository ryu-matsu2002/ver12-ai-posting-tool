{% extends "base_admin.html" %}
{% block title %}サイト投稿状況 | 管理者{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">🌐 サイト投稿状況一覧</h1>

<div class="space-y-6">

  {% for user_name, user_data in sites_by_user.items() %}
  {% set user_sites = user_data['sites'] %}
  {% set genres = user_data['genres'] %}

  <details class="bg-blue-50 shadow rounded border border-blue-200" style="overflow: hidden;">
    <summary class="px-4 py-3 cursor-pointer bg-blue-100 text-lg font-semibold border-b border-blue-300">
      👤 {{ user_name }}（{{ user_sites|length }} サイト）
    </summary>

    <!-- 🔍 検索＆ジャンルフィルタ（ユーザー単位） -->
    <div class="flex flex-wrap items-center gap-4 px-4 pt-4">
      <input type="text" placeholder="サイト名またはURL" oninput="filterSites(this, '{{ user_name }}')"
             class="p-2 border rounded w-64" />
      <select onchange="filterSites(this, '{{ user_name }}')" class="p-2 border rounded">
        <option value="">すべてのジャンル</option>
        {% for genre in genres %}
        <option value="{{ genre }}">{{ genre }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- 📝 サイトテーブル -->
    <div class="overflow-x-auto mt-4" id="table-{{ user_name }}">
      <table class="min-w-full text-sm text-left site-table">
        <thead class="bg-blue-100 text-blue-800 font-semibold">
          <tr>
            <th class="py-2 px-4">サイト名</th>
            <th class="py-2 px-4">URL</th>
            <th class="py-2 px-4 text-green-700">投稿完了</th>
            <th class="py-2 px-4 text-blue-700">記事生成済み</th>
            <th class="py-2 px-4 text-gray-800">総記事数</th>
            <th class="py-2 px-4 text-purple-700">クリック数</th>
            <th class="py-2 px-4 text-pink-700">表示回数</th>
          </tr>
        </thead>
        <tbody>
          {% for s in user_sites %}
          <tr class="border-t hover:bg-white"
              data-site="{{ s.name }} {{ s.url }}"
              data-genre="{{ s.genre or '' }}">
            <td class="py-2 px-4 font-medium text-blue-900">
              <a href="{{ s.url }}" target="_blank" class="underline">{{ s.name }}</a>
            </td>
            <td class="py-2 px-4">
              {% if s.gsc_connected %}
                <span class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded mr-2">GSC</span>
              {% endif %}
              <a href="{{ s.url }}" target="_blank" class="text-blue-600 underline">{{ s.url }}</a>
            </td>
            <td class="py-2 px-4 text-green-700">{{ s.posted or 0 }}</td>
            <td class="py-2 px-4 text-blue-700">{{ s.done or 0 }}</td>
            <td class="py-2 px-4">{{ s.total or 0 }}</td>
            <td class="py-2 px-4 text-purple-700">{{ s.clicks or 0 }}</td>
            <td class="py-2 px-4 text-pink-700">{{ s.impressions or 0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </details>
  {% else %}
  <div class="text-gray-500">サイトが登録されていません。</div>
  {% endfor %}

</div>

<!-- ✅ 検索＆ジャンル絞り込み JS -->
<script>
function filterSites(input, user) {
  const table = document.getElementById(`table-${user}`);
  const keyword = input.value?.toLowerCase() || "";
  const isSelect = input.tagName === "SELECT";
  const rows = table.querySelectorAll("tbody tr");

  rows.forEach(row => {
    const siteText = row.dataset.site.toLowerCase();
    const genre = row.dataset.genre;
    const matchText = !keyword || (!isSelect && siteText.includes(keyword));
    const matchGenre = isSelect ? (!keyword || genre === keyword) : true;
    row.style.display = matchText && matchGenre ? "" : "none";
  });
}
</script>
{% endblock %}
