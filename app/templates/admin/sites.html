{% extends "base_admin.html" %}
{% block title %}ã‚µã‚¤ãƒˆæŠ•ç¨¿çŠ¶æ³ | ç®¡ç†è€…{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">ğŸŒ ç™»éŒ²ã‚µã‚¤ãƒˆ/è¨˜äº‹ç®¡ç†</h1>

<div class="space-y-6">

  {% for user_name, user_data in sites_by_user.items() %}
  {% set user_sites = user_data['sites'] %}
  {% set genres = user_data['genres'] %}
  {% set uid = user_data['user_id'] %}

  <details class="bg-blue-50 shadow rounded border border-blue-200" style="overflow: hidden;">
    <summary class="px-4 py-3 cursor-pointer bg-blue-100 text-lg font-semibold border-b border-blue-300">
      ğŸ‘¤ {{ user_name }}ï¼ˆ{{ user_sites|length }} ã‚µã‚¤ãƒˆï¼‰
    </summary>

    <!-- ğŸ” æ¤œç´¢ï¼†ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="flex flex-wrap items-center gap-4 px-4 pt-4">
      <input type="text" placeholder="ã‚µã‚¤ãƒˆåã¾ãŸã¯URL" class="p-2 border rounded w-64 site-search" />
      <select class="p-2 border rounded site-genre-filter">
        <option value="">ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ³ãƒ«</option>
        {% for genre in genres %}
        <option value="{{ genre }}">{{ genre }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ã‚µã‚¤ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="overflow-x-auto mt-4" id="table-{{ user_name }}">
      <table class="min-w-full text-sm text-left site-table">
        <thead class="bg-blue-100 text-blue-800 font-semibold">
          <tr>
            <th class="py-2 px-4">ã‚µã‚¤ãƒˆå</th>
            <th class="py-2 px-2 text-green-700">æŠ•ç¨¿å®Œäº†</th>
            <th class="py-2 px-2 text-blue-700">è¨˜äº‹ç”Ÿæˆæ¸ˆã¿</th>
            <th class="py-2 px-2">ç·è¨˜äº‹æ•°</th>
            <th class="py-2 px-2 text-purple-700">ã‚¯ãƒªãƒƒã‚¯æ•°</th>
            <th class="py-2 px-2 text-pink-700">è¡¨ç¤ºå›æ•°</th>
            <th class="py-2 px-4">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for s in user_sites %}
          <tr class="border-t hover:bg-white"
              data-site="{{ s['name'] }} {{ s['url'] }}"
              data-genre="{{ s['genre'] or '' }}">
            <td class="py-2 px-4 font-medium text-blue-900">
              <div class="flex items-center gap-2">
                {% if s['gsc_connected'] %}
                  <span class="inline-block bg-green-600 text-white text-xs font-bold px-2 py-1 rounded">GSC</span>
                {% endif %}
                <a href="{{ s['url'] }}" target="_blank" class="underline">{{ s['name'] }}</a>
              </div>
            </td>
            <td class="py-2 px-2 text-green-700 text-center">{{ s['posted'] or 0 }}</td>
            <td class="py-2 px-2 text-blue-700 text-center">{{ s['done'] or 0 }}</td>
            <td class="py-2 px-2 text-center">{{ s['total'] or 0 }}</td>
            <td class="py-2 px-2 text-purple-700 text-center">{{ s['clicks'] or 0 }}</td>
            <td class="py-2 px-2 text-pink-700 text-center">{{ s['impressions'] or 0 }}</td>
            <td class="py-2 px-4 space-x-1 whitespace-nowrap">
              <a href="{{ url_for('admin.site_articles', site_id=s['id']) }}"
                 class="inline-block bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-2 py-1 rounded">
                è¨˜äº‹ä¸€è¦§
              </a>
              <a href="{{ s['url'].rstrip('/') }}/wp-admin" target="_blank"
                 class="inline-block bg-purple-700 hover:bg-purple-800 text-white text-xs font-bold px-2 py-1 rounded">
                WPç®¡ç†
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </details>
  {% else %}
  <div class="text-gray-500">ã‚µã‚¤ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  {% endfor %}

</div>

<!-- âœ… JSï¼šæ¤œç´¢ï¼‹ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ -->
<script>
document.querySelectorAll("details").forEach(wrapper => {
  const input = wrapper.querySelector(".site-search");
  const select = wrapper.querySelector(".site-genre-filter");
  const table = wrapper.querySelector("table");

  function filter() {
    const keyword = input.value.toLowerCase();
    const selectedGenre = select.value;
    const rows = table.querySelectorAll("tbody tr");

    rows.forEach(row => {
      const siteText = row.dataset.site.toLowerCase();
      const genre = row.dataset.genre;
      const matchText = !keyword || siteText.includes(keyword);
      const matchGenre = !selectedGenre || genre === selectedGenre;
      row.style.display = matchText && matchGenre ? "" : "none";
    });
  }

  input.addEventListener("input", filter);
  select.addEventListener("change", filter);
});
</script>
{% endblock %}
