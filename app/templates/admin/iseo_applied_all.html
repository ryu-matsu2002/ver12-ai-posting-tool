{% extends "base_admin.html" %}
{% block title %}内部SEO｜適用済み記事一覧{% endblock %}
{% block content %}
<div class="container my-4">
  <h2 class="mb-3">内部SEO｜適用済み記事一覧</h2>

  <!-- Filters -->
  <form id="frm-filter" class="row g-2 mb-3">
    <!-- user_id は hidden で固定 -->
    <input type="hidden" name="user_id" value="{{ current_user_id }}">

    <div class="col-12 mb-2">
      <span class="badge bg-info text-dark">
        表示中ユーザー: {{ current_user_id if current_user_id else "未指定" }}
      </span>
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 small">Version</label>
      <input type="number" class="form-control form-control-sm" name="version" placeholder="任意">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 small">From</label>
      <input type="date" class="form-control form-control-sm" name="date_from">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 small">To</label>
      <input type="date" class="form-control form-control-sm" name="date_to">
    </div>
    <div class="col-auto">
      <label class="form-label mb-0 small">&nbsp;</label>
      <button class="btn btn-sm btn-primary w-100" type="submit">検索</button>
    </div>
  </form>

  <div id="msg" class="alert d-none" role="alert"></div>

  <!-- ▼ サイトごとの開閉パネルをここに動的に構築 -->
  <div id="site-accordion" class="accordion"></div>
</div>

<!-- 明細モーダル -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">リンク明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2" id="detail-meta"></div>
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="tbl-detail">
            <thead>
              <tr>
                <th style="width:25%">target_url</th>
                <th style="width:20%">anchor_text</th>
                <th style="width:15%">position</th>
                <th style="width:20%">applied_at</th>
                <th>status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  "use strict";

  // ★ Linter 対策：テンプレ式は「文字列」で埋め込み
  const API_LIST   = "{{ url_for('admin.admin_iseo_applied_all_data') }}";
  const API_DETAIL = "{{ url_for('admin.admin_iseo_applied_details') }}";

  const msg   = document.getElementById("msg");
  const frm   = document.getElementById("frm-filter");
  const accEl = document.getElementById("site-accordion");

  // サイト別の状態：cursor/loaded/tbody参照など
  const siteState = new Map(); // site_id -> {cursor, loaded, tbodyEl, metaEl}

  function csrfHeader() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? { "X-CSRFToken": meta.content } : {};
  }
  function showMsg(ok, text) {
    msg.classList.remove("d-none", "alert-success", "alert-danger");
    msg.classList.add(ok ? "alert-success" : "alert-danger");
    msg.textContent = text;
  }
  function clearMsg() {
    msg.classList.add("d-none");
    msg.textContent = "";
  }
  function formQuery(form) {
    return Object.fromEntries(new FormData(form).entries());
  }
  function esc(s){
    return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  function fmtDateTime(iso){
    if (!iso) return "-";
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  // 1行（記事×version）HTML
  function rowHtml(r){
    const u  = r.src_url || "#";
    const dt = r.last_applied_at ? new Date(r.last_applied_at).toLocaleString() : "-";
    const user = r.user_name || ("#" + r.user_id);
    const site = "#" + r.site_id + (r.site_name ? " " + r.site_name : "");
    const title = r.src_title || "(no title)";
    const count = (typeof r.link_count === "number") ? r.link_count : (r.link_count || "");
    const ver = (typeof r.link_version === "number") ? r.link_version : (r.link_version || "");
    return (
      '<tr data-site="' + r.site_id + '" data-post="' + r.post_id + '" data-version="' + r.link_version + '">' +
        "<td>" + dt + "</td>" +
        "<td>" + user + "</td>" +
        "<td>" + site + "</td>" +
        '<td><a href="' + u + '" target="_blank" rel="noopener">' + esc(title) + "</a></td>" +
        '<td class="text-end">' + count + "</td>" +
        '<td><span class="badge text-bg-secondary">V' + ver + "</span></td>" +
      "</tr>"
    );
  }

  // サイトパネル（アコーディオン）1個を組み立て
  function buildSitePanel(site){
    const sid = site.site_id;
    const sname = site.site_name || ("#" + sid);

    const itemId = "site-" + sid;
    const headerId = "h-" + sid;
    const bodyId = "b-" + sid;

    const wrapper = document.createElement("div");
    wrapper.className = "accordion-item mb-2";
    wrapper.innerHTML = `
      <h2 class="accordion-header" id="${headerId}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#${bodyId}" aria-expanded="false" aria-controls="${bodyId}">
          <span class="me-2 badge bg-secondary">#${sid}</span> <strong>${esc(sname)}</strong>
          <span class="ms-3 small text-muted" id="${itemId}-meta">読み込み待ち</span>
        </button>
      </h2>
      <div id="${bodyId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#site-accordion">
        <div class="accordion-body">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:140px">最終適用</th>
                  <th>User</th>
                  <th>Site</th>
                  <th>記事</th>
                  <th style="width:90px" class="text-end">リンク数</th>
                  <th style="width:80px">Version</th>
                </tr>
              </thead>
              <tbody id="${itemId}-tbody">
                <tr><td colspan="6" class="text-center text-muted py-3">読み込み中…</td></tr>
              </tbody>
            </table>
          </div>
          <!-- すべて自動で取り切るためページングUIは非表示 -->
        </div>
      </div>
    `;
    accEl.appendChild(wrapper);

    // 状態登録
    const st = {
      cursor: null,
      loaded: false,
      tbodyEl: wrapper.querySelector(`#${itemId}-tbody`),
      metaEl:  wrapper.querySelector(`#${itemId}-meta`),
    };
    siteState.set(sid, st);

    // 開いたときに遅延ロード
    wrapper.querySelector(`#${bodyId}`).addEventListener("show.bs.collapse", () => {
      if (!st.loaded) {
        loadSiteRows(sid, true);
      }
    });

    return wrapper;   // ←★ これで buildSitePanel をきちんと閉じる
  }

  // --- 1ページ取得（内部用） ---
  async function fetchOnePage(baseParams){
    const url = API_LIST + "?" + new URLSearchParams(baseParams).toString();
    const res = await fetch(url, { headers: { ...csrfHeader() } });
    let js = {};
    try { js = await res.json(); } catch(e){ js = {}; }
    if (!res.ok || !js.ok) throw new Error(js.error || res.statusText || "取得失敗");
    return js;
  }

  // サイトごとの記事×versionを取得して描画（全件取り切る・逐次追記）
  async function loadSiteRows(site_id, first){
    const st = siteState.get(site_id);
    if (!st) return;

    if (first === true) {
      st.cursor = null;
      // プレースホルダ再表示
      st.tbodyEl.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">読み込み中…</td></tr>';
    }

    const base = formQuery(frm);
    base.site_id = site_id;
    // 1リクエストのページサイズ（サーバ上限200まで）で高速連続フェッチ
    base.limit = 200;

    let total = 0;
    let lastAppliedISO = null;
    let cursor = st.cursor || null;

    // 初回はtbodyを空に
    st.tbodyEl.innerHTML = "";

    // 逐次取得ループ（キーセットページング）
    while (true) {
      const params = { ...base };
      if (cursor) params.cursor = cursor;
      let js;
      try {
        js = await fetchOnePage(params);
      } catch (err) {
        st.tbodyEl.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-3">${esc(String(err))}</td></tr>`;
        return;
      }
      const chunk = Array.isArray(js.rows) ? js.rows.filter(r => r.site_id === site_id) : [];
      if (chunk.length) {
        // 逐次追記
        const html = chunk.map(rowHtml).join("");
        const temp = document.createElement("tbody");
        temp.innerHTML = html;
        while (temp.firstChild) st.tbodyEl.appendChild(temp.firstChild);
        // クリックハンドラ付与（重複防止フラグ付き）
        st.tbodyEl.querySelectorAll("tr").forEach(tr => {
          if (!tr.dataset.bound) {
            tr.dataset.bound = "1";
            tr.addEventListener("click", () => openDetail(tr));
          }
        });
        total += chunk.length;
        if (!lastAppliedISO) lastAppliedISO = chunk[0]?.last_applied_at || null;
      }

      if (!js.has_more) {
        cursor = null;
        break;
      }
      cursor = js.next_cursor || null;
      // UI固まり防止
      await new Promise(r => requestAnimationFrame(r));
    }

    if (total === 0) {
      st.tbodyEl.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">データがありません</td></tr>';
    }

    // メタ表示更新
    if (st.metaEl) {
      st.metaEl.textContent = `最終適用: ${fmtDateTime(lastAppliedISO)} / 件数: ${total.toLocaleString()}`;
    }

    st.cursor = null; // 全件取り切り
    st.loaded = true;
  }

  // 初期ロード：サイト見出し一覧を構築（遅延ロード前提）
  async function loadSites(){
    clearMsg();

    // リセット
    accEl.innerHTML = "";
    siteState.clear();

    const base = formQuery(frm);
    // サイト一覧は軽量取得：まず1回呼んで sites をもらう
    const url = API_LIST + "?" + new URLSearchParams(base).toString();
    const res = await fetch(url, { headers: { ...csrfHeader() } });
    let js = {};
    try { js = await res.json(); } catch(e){ js = {}; }

    if (!res.ok || !js.ok) {
      showMsg(false, js.error || res.statusText || "一覧取得に失敗しました");
      return;
    }

    // 1) サーバが sites を返していればそれを使う
    let sites = Array.isArray(js.sites) ? js.sites : null;

    // 2) rows からユニークサイト抽出のフォールバック
    if (!sites || !sites.length) {
      const rows = Array.isArray(js.rows) ? js.rows : [];
      const map = new Map();
      for (const r of rows) {
        if (!map.has(r.site_id)) {
          map.set(r.site_id, {site_id: r.site_id, site_name: r.site_name || ("#" + r.site_id)});
        }
      }
      sites = Array.from(map.values());
    }

    if (!sites.length) {
      accEl.innerHTML = `<div class="text-muted">表示できるサイトがありません</div>`;
      return;
    }

    // サイトごとのアコーディオン生成（行は展開時に遅延ロード）
    sites.forEach(s => buildSitePanel(s));
  }

  async function openDetail(tr) {
    const site_id = tr.getAttribute("data-site");
    const post_id = tr.getAttribute("data-post");
    const version = tr.getAttribute("data-version");
    const qs = new URLSearchParams({ site_id: site_id, post_id: post_id, version: version }).toString();
    const url = API_DETAIL + "?" + qs;

    const res = await fetch(url, { headers: { ...csrfHeader() } });
    let js = {};
    try { js = await res.json(); } catch (e) { js = {}; }

    if (!res.ok || !js.ok) {
      showMsg(false, js.error || res.statusText || "明細取得に失敗しました");
      return;
    }

    const meta = document.getElementById("detail-meta");
    meta.textContent = "site_id=" + site_id + " / post_id=" + post_id + " / version=V" + version;

    const tbodyD = document.querySelector("#tbl-detail tbody");
    const items = Array.isArray(js.items) ? js.items : [];
    if (!items.length) {
      tbodyD.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">明細なし</td></tr>';
    } else {
      tbodyD.innerHTML = items.map(function (it) {
        const turl = it.target_url || "";
        const atxt = it.anchor_text || "";
        const pos  = it.position || "";
        const apAt = it.applied_at ? new Date(it.applied_at).toLocaleString() : "";
        const st   = it.status || "";
        return (
          "<tr>" +
            '<td><a href="' + esc(turl) + '" target="_blank" rel="noopener">' + esc(turl) + "</a></td>" +
            "<td>" + esc(atxt) + "</td>" +
            "<td><code>" + esc(pos) + "</code></td>" +
            "<td>" + apAt + "</td>" +
            "<td>" + esc(st) + "</td>" +
          "</tr>"
        );
      }).join("");
    }

    // Bootstrap 5 Modal
    var modalEl = document.getElementById("detailModal");
    var m = bootstrap.Modal.getOrCreateInstance(modalEl);
    m.show();
  }

  // 検索ボタン：サイト一覧を取り直し（各サイトは開いた時に遅延ロード）
  frm.addEventListener("submit", function (e) {
    e.preventDefault();
    loadSites();
  });

  // 初期ロード：サイト見出しのみ
  loadSites();
})();
</script>
{% endblock %}
