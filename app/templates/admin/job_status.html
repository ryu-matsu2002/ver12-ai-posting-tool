{% extends "base_admin.html" %}
{% block title %}å‡¦ç†ä¸­ã‚¸ãƒ§ãƒ–ä¸€è¦§{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">ğŸ”„ å‡¦ç†ä¸­ã‚¸ãƒ§ãƒ–ä¸€è¦§</h1>

{% if articles %}
  <table class="w-full table-auto bg-white rounded shadow">
    <thead>
      <tr class="bg-gray-100 text-gray-700">
        <th class="p-2 text-left">ID</th>
        <th class="p-2 text-left">ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th class="p-2 text-left">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
        <th class="p-2 text-left">é€²æ—</th>
        <th class="p-2 text-left">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
        <th class="p-2 text-left">ç”Ÿæˆé–‹å§‹</th>
      </tr>
    </thead>
    <tbody>
      {% for art in articles %}
        <tr class="border-b">
          <td class="p-2">{{ art.id }}</td>
          <td class="p-2">{{ art.title[:30] if art.title else "(æœªè¨­å®š)" }}</td>
          <td class="p-2">{{ art.keyword }}</td>
          <td class="p-2">{{ art.progress }}%</td>
          <td class="p-2">{{ art.user.email if art.user else "-" }}</td>
          <td class="p-2">{{ art.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-gray-600">ç¾åœ¨ã€å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<!-- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<h2 class="text-xl font-semibold mt-10 mb-3">ğŸ§¾ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ï¼ˆç›´è¿‘30ä»¶ï¼‰</h2>
<div id="log-box" class="bg-black text-white text-sm p-4 rounded h-64 overflow-y-scroll font-mono whitespace-pre-line">
  èª­ã¿è¾¼ã¿ä¸­...
</div>

<script>
function fetchLogs() {
  fetch("/admin/log-stream")
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("log-box");
      if (data.logs) {
        box.innerHTML = data.logs.map(line => {
          const safe = line.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          return `<div class="${line.color}">${safe}</div>`;
        }).join("");
        box.scrollTop = box.scrollHeight;
      } else {
        box.innerHTML = "<div class='text-red-400'>ãƒ­ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
      }
    });
}

// 3ç§’ã”ã¨ã«æ›´æ–°
setInterval(fetchLogs, 3000);
fetchLogs();
</script>
{% endblock %}
