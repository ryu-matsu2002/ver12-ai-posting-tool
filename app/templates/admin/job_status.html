{% extends "base_admin.html" %}
{% block title %}å‡¦ç†ä¸­ã‚¸ãƒ§ãƒ–ä¸€è¦§{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">ğŸ”„ å‡¦ç†ä¸­ã‚¸ãƒ§ãƒ–ä¸€è¦§</h1>

{% if articles %}
  <table class="w-full table-auto bg-white rounded shadow">
    <thead>
      <tr class="bg-gray-100 text-gray-700">
        <th class="p-2 text-left">ID</th>
        <th class="p-2 text-left">ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th class="p-2 text-left">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
        <th class="p-2 text-left">é€²æ—</th>
        <th class="p-2 text-left">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
        <th class="p-2 text-left">ç”Ÿæˆé–‹å§‹</th>
      </tr>
    </thead>
    <tbody>
      {% for art in articles %}
        <tr class="border-b">
          <td class="p-2">{{ art.id }}</td>
          <td class="p-2">{{ art.title[:30] if art.title else "(æœªè¨­å®š)" }}</td>
          <td class="p-2">{{ art.keyword }}</td>
          <td class="p-2">{{ art.progress }}%</td>
          <td class="p-2">{{ art.user.email if art.user else "-" }}</td>
          <td class="p-2">{{ art.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-gray-600">ç¾åœ¨ã€å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<!-- âœ… æ¤œç´¢ãƒãƒ¼ -->
<div class="mt-10 mb-4">
  <label class="block text-gray-700 mb-1 font-medium">ğŸ” ãƒ­ã‚°çµã‚Šè¾¼ã¿:</label>
  <input type="text" id="log-filter" placeholder="ä¾‹: 2025-06-16 / Article 1234 / æŠ•ç¨¿å…ˆã‚µã‚¤ãƒˆæœªè¨­å®š"
         class="w-full p-2 border border-gray-300 rounded" oninput="applyFilter()">
</div>

<!-- âœ… ãƒ­ã‚°è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
<h2 class="text-xl font-semibold mb-3">ğŸ§¾ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ï¼ˆç›´è¿‘30ä»¶ï¼‰</h2>
<div id="log-box" class="bg-black text-white text-sm p-4 rounded h-[36rem] overflow-y-scroll font-mono whitespace-pre-line">
  èª­ã¿è¾¼ã¿ä¸­...
</div>

<!-- âœ… è¦ç´„ -->
<h2 class="text-xl font-semibold mt-10 mb-2">âŒâš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ»è­¦å‘Šã¾ã¨ã‚</h2>
<ul id="summary-list" class="list-disc list-inside text-sm text-red-500 space-y-1">
  <li>èª­ã¿è¾¼ã¿ä¸­...</li>
</ul>

<!-- âœ… AIã«ã‚ˆã‚‹å¯¾å‡¦ã‚¬ã‚¤ãƒ‰ -->
<h2 class="text-xl font-semibold mt-10 mb-2">ğŸ§  è‡ªå‹•å¯¾å¿œã‚¬ã‚¤ãƒ‰ï¼ˆAIåˆ†é¡ï¼‰</h2>
<ul id="ai-guide" class="list-disc list-inside text-sm text-blue-700 space-y-1">
  <li>åˆ†æä¸­...</li>
</ul>

<script>
let summaryMap = {};
let logsRaw = [];
let checkedMap = {};

function fetchLogs() {
  fetch("/admin/log-stream")
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("log-box");
      const summary = document.getElementById("summary-list");
      const guide = document.getElementById("ai-guide");

      if (data.logs) {
        logsRaw = data.logs;
        summaryMap = {};

        // ãƒ­ã‚°è¡¨ç¤º
        const html = data.logs.map(line => {
          const safe = line.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          if (safe.includes("âŒ") || safe.includes("âš ï¸")) {
            const brief = safe.replace(/^.*(?:âŒ|âš ï¸)\s*/, "").slice(0, 100);
            summaryMap[brief] = (summaryMap[brief] || 0) + 1;
          }
          return `<div class="${line.color}">${safe}</div>`;
        });

        box.innerHTML = html.join("");
        box.scrollTop = box.scrollHeight;

        // è¦ç´„æç”»
        summary.innerHTML = "";
        Object.entries(summaryMap).forEach(([msg, count], index) => {
          const id = "error-" + index;
          const isChecked = checkedMap[id] ? "checked" : "";
          summary.innerHTML += `
            <li id="${id}">
              <label class="flex items-start gap-2">
                <input type="checkbox" onchange="checkedMap['${id}'] = this.checked" ${isChecked}>
                <span>${msg} Ã—${count}å›</span>
              </label>
              <button onclick="copyText(\`${msg}\`)" class="ml-2 text-xs bg-blue-600 text-white px-2 py-0.5 rounded">ğŸ“‹ Copy</button>
            </li>`;
        });

        if (Object.keys(summaryMap).length === 0) {
          summary.innerHTML = "<li>ç¾åœ¨ã€ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Šã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>";
        }

        // å¯¾å‡¦ã‚¬ã‚¤ãƒ‰
        const guideItems = [];
        for (const msg of Object.keys(summaryMap)) {
          if (msg.includes("rest_cannot_create") || msg.includes("æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹æ¨©é™")) {
            guideItems.push("ğŸ›  WordPressã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          } else if (msg.includes("æŠ•ç¨¿å…ˆã‚µã‚¤ãƒˆæœªè¨­å®š")) {
            guideItems.push("ğŸ“Œ è¨˜äº‹ã«é–¢é€£ä»˜ã‘ã‚‹ã‚µã‚¤ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          } else if (msg.includes("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒèµ·å‹•")) {
            // ç„¡è¦–
          } else {
            guideItems.push(`ğŸ” ãã®ä»–ï¼š${msg}`);
          }
        }
        guide.innerHTML = guideItems.length > 0 ? guideItems.map(i => `<li>${i}</li>`).join("") :
          "<li>å¯¾å¿œãŒå¿…è¦ãªã‚¨ãƒ©ãƒ¼ã¯ç¾åœ¨ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";

        applyFilter();
      }
    });
}

// ğŸ” ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†
function applyFilter() {
  const keyword = document.getElementById("log-filter").value.trim().toLowerCase();
  const box = document.getElementById("log-box");
  if (!logsRaw.length) return;

  const filtered = logsRaw.filter(line =>
    line.message.toLowerCase().includes(keyword)
  ).map(line => {
    const safe = line.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    return `<div class="${line.color}">${safe}</div>`;
  });

  box.innerHTML = filtered.length ? filtered.join("") :
    "<div class='text-gray-400'>è©²å½“ã™ã‚‹ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
}

// ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼é–¢æ•°
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
}

setInterval(fetchLogs, 3000);
fetchLogs();
</script>
{% endblock %}
