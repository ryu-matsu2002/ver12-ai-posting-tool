{% extends "base_admin.html" %}
{% block title %}å†…éƒ¨SEO è©³ç´°ãƒ­ã‚°{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex align-items-center mb-3">
    <h2 class="h5 mb-0">ğŸ“œ å†…éƒ¨SEO è©³ç´°ãƒ­ã‚°</h2>
    <a class="btn btn-sm btn-outline-secondary ms-auto" href="/admin/internal-seo/detail">å†…éƒ¨SEOç®¡ç†ã¸æˆ»ã‚‹</a>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆGSCé¢¨ï¼šå°å‹ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
  <form id="filterForm" class="row g-2 align-items-end mb-3" onsubmit="event.preventDefault(); resetAndLoad();">
    <div class="col-6 col-md-2">
      <label class="form-label mb-1 small">Site ID</label>
      <input type="number" class="form-control form-control-sm" id="fSiteId" value="{{ request.args.get('site_id','') }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label mb-1 small">Post ID</label>
      <input type="number" class="form-control form-control-sm" id="fPostId" value="{{ request.args.get('post_id','') }}">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label mb-1 small">Status</label>
      {% set st = request.args.get('status','') %}
      <select class="form-select form-select-sm" id="fStatus">
        <option value=""  {% if st=='' %}selected{% endif %}>ã™ã¹ã¦</option>
        <option value="applied" {% if st=='applied' %}selected{% endif %}>applied</option>
        <option value="pending" {% if st=='pending' %}selected{% endif %}>pending</option>
        <option value="skipped" {% if st=='skipped' %}selected{% endif %}>skipped</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label mb-1 small">ä»¶æ•°</label>
      {% set lim = request.args.get('limit', 50) | int %}
      <select class="form-select form-select-sm" id="fLimit">
        {% for n in [25,50,100] %}
          <option value="{{ n }}" {% if lim==n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-auto">
      <button class="btn btn-sm btn-primary">å†èª­ã¿è¾¼ã¿</button>
      <a class="btn btn-sm btn-outline-secondary" href="/admin/internal-seo/detail">ãƒªã‚»ãƒƒãƒˆ</a>
    </div>
  </form>

  <!-- RUNçµ±è¨ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <h6 class="mb-0">ğŸ“Š RUN çµ±è¨ˆ</h6>
        <span class="text-muted small ms-2">run_id ã‚’æŒ‡å®šã™ã‚‹ã¨è©³ç´°ã‚’å–å¾—</span>
      </div>
      <div class="row g-2 align-items-end">
        <div class="col-6 col-md-2">
          <label class="form-label mb-1 small">run_id</label>
          <input type="number" id="fRunId" class="form-control form-control-sm" value="{{ request.args.get('run_id','') }}">
        </div>
        <div class="col-12 col-md-auto">
          <button id="btnLoadRun" class="btn btn-sm btn-outline-primary">èª­ã¿è¾¼ã¿</button>
        </div>
      </div>
      <pre id="runStatsBox" class="small text-monospace mt-3 text-muted mb-0">æœªå–å¾—</pre>
    </div>
  </div>

  <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:72px">ID</th>
              <th style="width:72px">Site</th>
              <th style="width:90px">Post</th>
              <th>Post URL</th>
              <th style="width:90px">Target</th>
              <th>Target URL</th>
              <th>Anchor</th>
              <th style="width:80px">Pos</th>
              <th style="width:110px">Status</th>
              <th>Applied</th>
            </tr>
          </thead>
          <tbody id="actionsBody">
            <tr id="placeholderRow"><td colspan="10" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Diff ãƒšã‚¤ãƒ³ -->
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">Diff Beforeï¼ˆæŠœç²‹ï¼‰</div>
            <div class="card-body"><pre id="diffBefore" class="mb-0 small text-monospace text-wrap"></pre></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">Diff Afterï¼ˆæŠœç²‹ï¼‰</div>
            <div class="card-body"><pre id="diffAfter" class="mb-0 small text-monospace text-wrap"></pre></div>
          </div>
        </div>
      </div>

      <div class="d-flex mt-2">
        <button id="loadMoreBtn" class="btn btn-sm btn-outline-secondary ms-auto d-none" type="button">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function fmtLocal(iso) {
  if (!iso) return '-';
  try {
    const d = new Date(iso);
    const pad = (x)=> String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  } catch(e) { return iso; }
}
function esc(v) {
  if (v===null||v===undefined) return '';
  return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}
function statusBadge(st) {
  if (st === 'applied') return '<span class="badge bg-success">applied</span>';
  if (st === 'pending') return '<span class="badge bg-info text-dark">pending</span>';
  if (st === 'skipped') return '<span class="badge bg-secondary">skipped</span>';
  return `<span class="badge bg-light text-dark">${esc(st || '-')}</span>`;
}

let nextCursor = null;
let loading = false;
let reachedEnd = false;

function currentQuery(limitOverride) {
  const p = new URLSearchParams();
  const s = document.getElementById('fSiteId').value.trim();
  const pid = document.getElementById('fPostId').value.trim();
  const st = document.getElementById('fStatus').value;
  const rawLim = limitOverride ?? document.getElementById('fLimit').value;
  const lim = (rawLim && String(rawLim).trim()) ? rawLim : '50';
  if (s)   p.set('site_id', s);
  if (pid) p.set('post_id', pid);
  if (st)  p.set('status', st);
  if (lim) p.set('limit', lim);
  if (nextCursor) p.set('cursor', nextCursor);
  return p.toString();
}

async function loadActions(initial=false) {
  if (loading || reachedEnd) return;
  loading = true;

  const tbody = document.getElementById('actionsBody');
  const ph = document.getElementById('placeholderRow');
  if (ph) ph.remove();

  try {
    const res = await fetch(`/admin/internal-seo/actions?${currentQuery()}`, {headers:{'Accept':'application/json'}});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const rows = data.rows || [];
    const frag = document.createDocumentFragment();

    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.site_id}</td>
        <td>${r.post_id ?? '-'}</td>
        <td class="text-truncate" style="max-width:360px;"><a href="${esc(r.post_url)}" target="_blank">${esc(r.post_url)}</a></td>
        <td>${r.target_post_id ?? '-'}</td>
        <td class="text-truncate" style="max-width:360px;"><a href="${esc(r.target_url)}" target="_blank">${esc(r.target_url)}</a></td>
        <td>${esc(r.anchor_text)}</td>
        <td>${esc(r.position)}</td>
        <td>${statusBadge(r.status)}</td>
        <td>${fmtLocal(r.applied_at)}</td>`;
      tr.addEventListener('click', () => showDiff(r));
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);

    if (rows.length) showDiff(rows[0]);

    nextCursor = data.next_cursor || null;
    reachedEnd = !data.has_more;
    document.getElementById('loadMoreBtn').classList.toggle('d-none', reachedEnd);
  } catch (e) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="10" class="text-danger">èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</td>`;
    tbody.appendChild(tr);
    reachedEnd = true;
  } finally {
    loading = false;
  }
}

function showDiff(r) {
  document.getElementById('diffBefore').textContent = r.diff_before_excerpt || '';
  document.getElementById('diffAfter').textContent  = r.diff_after_excerpt || '';
}

function resetAndLoad() {
  nextCursor = null; reachedEnd = false;
  document.getElementById('actionsBody').innerHTML = '<tr id="placeholderRow"><td colspan="10" class="text-muted">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
  loadActions(true);
}

// RUN çµ±è¨ˆï¼ˆä»»æ„ï¼‰
async function loadRunStats() {
  const runId = document.getElementById('fRunId').value.trim();
  const box = document.getElementById('runStatsBox');
  if (!runId) { box.textContent = 'run_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
  box.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
  try {
    const res = await fetch(`/admin/internal-seo/run/${encodeURIComponent(runId)}/stats`, {headers:{'Accept':'application/json'}});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const s = (data && data.stats) || {};
    const segs = [];
    const add = (name, o)=> {
      if (!o) return;
      const kv = Object.entries(o).map(([k,v]) => `${esc(k)}: ${esc(typeof v==='object'? JSON.stringify(v): v)}`).join('\n');
      segs.push(`--- ${name} ---\n${kv}`);
    };
    add('Indexer', s.indexer);
    add('LinkGraph', s.link_graph);
    add('Planner', s.planner);
    add('Applier', s.applier);
    add('Params', s.params);
    box.textContent = segs.length ? segs.join('\n\n') : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
  } catch (e) {
    box.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
  }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnLoadRun').addEventListener('click', loadRunStats);
  resetAndLoad();
  document.getElementById('loadMoreBtn').addEventListener('click', ()=> loadActions(false));
});
</script>
{% endblock %}
