{# --------------------------------------------------------------------- #}
{#  _job_progress.html                                                   #}
{#  å„ã‚µã‚¤ãƒˆã®å¤–éƒ¨SEOã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã‚’è¡¨ç¤º                                   #}
{#  æœŸå¾…å¤‰æ•°: site_id, blogï¼ˆstrï¼‰, siteï¼ˆ=sï¼‰                           #}
{# --------------------------------------------------------------------- #}

{% set blog_label  = blog|capitalize %}
{% set card_id     = "site-card-" ~ site_id %}

{% if s.registered_blogs is defined %}
  {% set is_registered = blog in s.registered_blogs %}
{% else %}
  {% set is_registered = False %}
{% endif %}

{% set account = s.external_blog_accounts
    | selectattr('blog_type.value', 'equalto', blog)
    | list | first %}
{% set is_captcha_completed = account and account.is_captcha_completed %}

<div id="{{ card_id }}" class="border p-4 rounded shadow-sm bg-white">
  <div class="flex items-center justify-between mb-2">
    <div class="font-bold text-gray-800">{{ blog_label }} å¤–éƒ¨SEO</div>

    {% if is_registered %}
      <div class="text-green-600 font-bold">âœ… ç™»éŒ²æ¸ˆã¿</div>

    {% elif blog == "livedoor" %}
      {% if is_captcha_completed %}
        <button class="px-4 py-2 bg-gray-400 text-white rounded cursor-default" disabled>
          âœ… CAPTCHAçªç ´æ¸ˆ
        </button>
      {% else %}
        <button
          id="start-btn-{{ blog }}-{{ site_id }}"
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
          data-site-id="{{ site_id }}"
          data-blog="{{ blog }}"
          onclick="handleCaptchaClick(this)">
          ğŸ“· CAPTCHAçªç ´
        </button>
      {% endif %}

    {% else %}
      <button
        id="start-btn-{{ blog }}-{{ site_id }}"
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
        hx-post="{{ url_for('main.start_external_seo') }}"
        hx-vals='{"site_id":"{{ site_id }}","blog":"{{ blog }}"}'
        hx-target="#{{ card_id }}"
        hx-swap="outerHTML"
        onclick="setRunningStatus('{{ blog }}', '{{ site_id }}')">
        é–‹å§‹
      </button>
    {% endif %}
  </div>

  <div class="text-sm text-gray-600" id="status-text-{{ blog }}-{{ site_id }}">
    AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ{{ blog_label }}ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’è©¦ã¿ã¾ã™ã€‚
    å‡¦ç†ã«ã¯30ç§’å‰å¾Œã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
  </div>

  {# âœ… çŠ¶æ…‹é€²æ—è¡¨ç¤ºç”¨ã®è¿½åŠ  spanï¼ˆJSã§æ›¸ãæ›ãˆã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰ #}
  <div class="mt-1 text-sm">
    <span id="status-{{ site_id }}-{{ blog }}" class="text-blue-700 font-medium">
      {% if is_captcha_completed %}
        âœ… CAPTCHAçªç ´æ¸ˆ
      {% else %}
        â³ CAPTCHAæœªçªç ´
      {% endif %}
    </span>
  </div>
</div>

<script>
  function setRunningStatus(blog, siteId) {
    const btn = document.getElementById(`start-btn-${blog}-${siteId}`);
    const statusText = document.getElementById(`status-text-${blog}-${siteId}`);
    if (btn) {
      btn.outerHTML = `<div class="text-blue-600 font-bold">â³ å®Ÿè¡Œä¸­...</div>`;
    }
    if (statusText) {
      statusText.innerText = "AIãŒç™»éŒ²ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...";
    }
  }
</script>
