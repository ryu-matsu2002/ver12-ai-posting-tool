{# --------------------------------------------------------------------- #}
{#  _job_progress.html                                                   #}
{#  AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ï¼ˆã‚¸ãƒ§ãƒ–ãƒ¢ãƒ‡ãƒ«ãªã—ï¼‰                                #}
{#  æœŸå¾…å¤‰æ•°: site_id, blog, siteï¼ˆ=sï¼‰                                  #}
{# --------------------------------------------------------------------- #}

{% set blog_label  = blog|capitalize %}
{% set card_id     = "site-card-" ~ site_id %}
{% set is_registered = blog in site.registered_blogs %}

{# CAPTCHAçªç ´æ¸ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—ï¼ˆsite.external_blog_accountsã‹ã‚‰ blog ã‚¿ã‚¤ãƒ—ã‚’ä¸€è‡´ã§æ¤œç´¢ï¼‰ #}
{% set account = site.external_blog_accounts | selectattr('blog_type', 'equalto', blog) | list | first %}
{% set is_captcha_completed = account and account.is_captcha_completed %}

<div id="{{ card_id }}" class="border p-4 rounded shadow-sm bg-white">

  <div class="flex items-center justify-between mb-2">
    <div class="font-bold text-gray-800">{{ blog_label }} å¤–éƒ¨SEO</div>

    {% if is_registered %}
      <!-- âœ… æˆåŠŸè¡¨ç¤º -->
      <div class="text-green-600 font-bold">âœ… ç™»éŒ²æ¸ˆã¿</div>

    {% elif blog == "livedoor" %}
      {% if is_captcha_completed %}
        <!-- âœ… CAPTCHAçªç ´æ¸ˆè¡¨ç¤º -->
        <button class="px-4 py-2 bg-gray-400 text-white rounded cursor-default" disabled>
          âœ… CAPTCHAçªç ´æ¸ˆ
        </button>
      {% else %}
        <!-- âœ… CAPTCHAçªç ´ãƒœã‚¿ãƒ³ -->
        <button
          id="start-btn-{{ blog }}-{{ site_id }}"
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
          data-site-id="{{ site_id }}"
          data-blog="{{ blog }}"
          onclick="handleCaptchaClick(this)">
          ğŸ“· CAPTCHAçªç ´
        </button>
      {% endif %}

    {% else %}
      <!-- âœ… ä»–ãƒ–ãƒ­ã‚°: HTMXã§éåŒæœŸå®Ÿè¡Œ -->
      <button
        id="start-btn-{{ blog }}-{{ site_id }}"
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
        hx-post="{{ url_for('main.start_external_seo') }}"
        hx-vals='{"site_id":"{{ site_id }}","blog":"{{ blog }}"}'
        hx-target="#{{ card_id }}"
        hx-swap="outerHTML"
        onclick="setRunningStatus('{{ blog }}', '{{ site_id }}')">
        é–‹å§‹
      </button>
    {% endif %}
  </div>

  <div class="text-sm text-gray-600" id="status-text-{{ blog }}-{{ site_id }}">
    AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ{{ blog_label }}ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’è©¦ã¿ã¾ã™ã€‚
    å‡¦ç†ã«ã¯30ç§’å‰å¾Œã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
  </div>

</div>

<script>
  function setRunningStatus(blog, siteId) {
    const btn = document.getElementById(`start-btn-${blog}-${siteId}`);
    const statusText = document.getElementById(`status-text-${blog}-${siteId}`);

    if (btn) {
      btn.outerHTML = `<div class="text-blue-600 font-bold">â³ å®Ÿè¡Œä¸­...</div>`;
    }

    if (statusText) {
      statusText.innerText = "AIãŒç™»éŒ²ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...";
    }
  }
</script>
