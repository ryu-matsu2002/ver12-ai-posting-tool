{% extends "base.html" %}
{% block title %}GSCè¨˜äº‹ç”Ÿæˆ | Site Craft{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-8">ğŸ” GSCè¨˜äº‹ç”Ÿæˆ</h2>

<div class="grid md:grid-cols-2 gap-10 items-start">

  <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ + GSCç”Ÿæˆé–‹å§‹ -->
  <div>
    <form method="POST" action="{{ url_for('main.gsc_generate') }}">
      <input type="hidden" name="site_id" value="{{ selected_site.id if selected_site else '' }}">

      <!-- ğŸ”¸ å¯¾è±¡ã‚µã‚¤ãƒˆï¼ˆå›ºå®šè¡¨ç¤ºï¼‰ -->
      <div class="mb-4">
        <label class="block font-semibold mb-1 text-gray-800 dark:text-white">å¯¾è±¡ã‚µã‚¤ãƒˆ</label>
        <div class="p-2 bg-gray-100 rounded">
          {{ selected_site.name if selected_site else "ï¼ˆæœªé¸æŠï¼‰" }}
        </div>
      </div>

      <!-- ğŸ”¸ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
      <div class="mb-4">
        <label class="block font-semibold mb-1 text-gray-800 dark:text-white">ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <select id="prompt_select" name="prompt_id" class="w-full p-2 border rounded">
          <option value="">â€• ä½¿ã‚ãªã„ â€•</option>
          {% for p in saved_prompts %}
            <option value="{{ p.id }}"
                    data-title='{{ p.title_pt|default("")|tojson }}'
                    data-body='{{ p.body_pt|default("")|tojson }}'>
              {{ p.genre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- ğŸ”¸ è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒªã‚¢ï¼ˆãƒˆã‚°ãƒ«è¡¨ç¤ºï¼‰ -->
      <div class="mb-4">
        <button type="button" onclick="toggleDetailPrompt()" class="text-blue-600 hover:underline text-sm">
          ï¼‹ è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
        </button>
      </div>

      <div id="detail_prompt_area" class="hidden mb-6 space-y-4">
        <div>
          <label class="block font-semibold mb-1 text-gray-800 dark:text-white">ã‚¿ã‚¤ãƒˆãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
          <textarea id="title_prompt" name="title_prompt" rows="2" class="w-full p-2 border rounded">{{ title_prompt or '' }}</textarea>
        </div>
        <div>
          <label class="block font-semibold mb-1 text-gray-800 dark:text-white">æœ¬æ–‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
          <textarea id="body_prompt" name="body_prompt" rows="4" class="w-full p-2 border rounded">{{ body_prompt or '' }}</textarea>
        </div>
      </div>

      <button type="submit"
              class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
        ğŸ” GSCãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨˜äº‹ç”Ÿæˆã‚’é–‹å§‹
      </button>
    </form>
  </div>

  <!-- å³ã‚«ãƒ©ãƒ ï¼šç¾åœ¨ã®GSCã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div>
    <h3 class="text-xl font-semibold mb-4">ğŸ”– ç¾åœ¨ã®GSCã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§</h3>
    {% if gsc_keywords %}
      <ul class="bg-white dark:bg-gray-800 border rounded shadow divide-y max-h-[400px] overflow-y-auto">
        {% for kw in gsc_keywords %}
          <li class="p-3 flex justify-between items-center">
            <span>{{ kw.keyword }}</span>
            <span class="text-sm text-gray-500">
              {{ "ç”Ÿæˆæ¸ˆã¿" if kw.used else "æœªç”Ÿæˆ" }}
            </span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500">ã¾ã GSCç”±æ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>
</div>

<!-- ğŸ”§ è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒˆã‚°ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ + é¸æŠåæ˜ JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById("prompt_select");
  const titleField = document.getElementById("title_prompt");
  const bodyField = document.getElementById("body_prompt");

  if (select && titleField && bodyField) {
    select.addEventListener("change", function () {
      const selected = this.options[this.selectedIndex];
      const title = selected.getAttribute("data-title") || "";
      const body = selected.getAttribute("data-body") || "";

      try {
        titleField.value = JSON.parse(title);
        bodyField.value = JSON.parse(body);
      } catch {
        titleField.value = title;
        bodyField.value = body;
      }
    });
  }
});

function toggleDetailPrompt() {
  const area = document.getElementById("detail_prompt_area");
  area.classList.toggle("hidden");
}
</script>
{% endblock %}
