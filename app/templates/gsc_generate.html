{% extends "base.html" %}
{% block title %}GSCè¨˜äº‹ç”Ÿæˆ | Site Craft{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-8">ğŸ” GSCè¨˜äº‹ç”Ÿæˆ</h2>

<!-- âœ…âœ…âœ… è¿½åŠ ï¼šé€²æ—çŠ¶æ³è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ âœ…âœ…âœ… -->
<div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded shadow">
  <p class="text-sm">
    ğŸ—‚ï¸ <strong>GSCè¨˜äº‹æ•°ï¼š</strong>{{ gsc_done }} ä»¶ ï¼
    <strong>é€šå¸¸è¨˜äº‹æ•°ï¼š</strong>{{ manual_done }} ä»¶ ï¼
    <strong>åˆè¨ˆï¼š</strong>{{ total_done }} ä»¶ ï¼
    <strong>æ®‹ã‚Šï¼š</strong>{{ remaining }} ä»¶ï¼ˆä¸Šé™ï¼š1000 ä»¶ï¼‰
  </p>
</div>

<div class="grid md:grid-cols-2 gap-10 items-start">

  <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ + GSCç”Ÿæˆé–‹å§‹ -->
  <div>
    <form method="POST" action="{{ url_for('main.gsc_generate') }}">
      <input type="hidden" name="site_id" value="{{ selected_site.id if selected_site else '' }}">

      <!-- ğŸ”¸ å¯¾è±¡ã‚µã‚¤ãƒˆ -->
      <div class="mb-4">
        <label class="block font-semibold mb-1 text-gray-800 dark:text-white">å¯¾è±¡ã‚µã‚¤ãƒˆ</label>
        <div class="p-2 bg-gray-100 rounded">
          {{ selected_site.name if selected_site else "ï¼ˆæœªé¸æŠï¼‰" }}
        </div>
      </div>

      <!-- ğŸ”¸ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
      <div class="mb-4">
        <label class="block font-semibold mb-1 text-gray-800 dark:text-white">ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <select id="prompt_select" name="prompt_id" class="w-full p-2 border rounded">
          <option value="">â€• ä½¿ã‚ãªã„ â€•</option>
          {% for p in saved_prompts %}
            <option value="{{ p.id }}"
                    data-title='{{ p.title_pt|default("")|tojson }}'
                    data-body='{{ p.body_pt|default("")|tojson }}'>
              {{ p.genre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- ğŸ”¸ è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒˆã‚°ãƒ«ï¼‰ -->
      <div class="mb-4">
        <button type="button" onclick="toggleDetailPrompt()" class="text-blue-600 hover:underline text-sm">
          ï¼‹ è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
        </button>
      </div>

      <div id="detail_prompt_area" class="hidden mb-6 space-y-4">
        <div>
          <label class="block font-semibold mb-1 text-gray-800 dark:text-white">ã‚¿ã‚¤ãƒˆãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
          <textarea id="title_prompt" name="title_prompt" rows="2" class="w-full p-2 border rounded">{{ title_prompt or '' }}</textarea>
        </div>
        <div>
          <label class="block font-semibold mb-1 text-gray-800 dark:text-white">æœ¬æ–‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
          <textarea id="body_prompt" name="body_prompt" rows="4" class="w-full p-2 border rounded">{{ body_prompt or '' }}</textarea>
        </div>
      </div>

            <!-- âœ…âœ…âœ… ä¿®æ­£ï¼šç”Ÿæˆä¸­ã®å ´åˆã¯ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– + è­¦å‘Šè¡¨ç¤º -->
      {% set is_generating = selected_site.gsc_generation_started %}
      {% if is_generating %}
        <div class="p-4 mb-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded shadow">
          âš ï¸ ã“ã®ã‚µã‚¤ãƒˆã§ã¯ç¾åœ¨ã€GSCç”±æ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹è¨˜äº‹ç”ŸæˆãŒé€²è¡Œä¸­ã§ã™ã€‚å®Œäº†ã™ã‚‹ã¾ã§æ–°ãŸã«é–‹å§‹ã§ãã¾ã›ã‚“ã€‚
        </div>
        <button type="submit" class="bg-gray-400 text-white px-6 py-2 rounded cursor-not-allowed" disabled>
          â³ è¨˜äº‹ç”Ÿæˆä¸­ï¼ˆå®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ï¼‰
        </button>
      {% else %}
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
          ğŸ” GSCãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨˜äº‹ç”Ÿæˆã‚’é–‹å§‹
        </button>
      {% endif %}
    </form>
  </div>

  <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div>
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-xl font-semibold">ğŸ”– GSCã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§</h3>
      <form method="get" class="flex items-center space-x-2">
        <input type="hidden" name="site_id" value="{{ selected_site.id }}">
        <label for="status" class="text-sm text-gray-700">è¡¨ç¤ºï¼š</label>
        <select name="status" id="status" onchange="this.form.submit()" class="p-1 border rounded text-sm">
          <option value="">ã™ã¹ã¦</option>
          <option value="done" {{ 'selected' if request.args.get('status') == 'done' else '' }}>ç”Ÿæˆæ¸ˆã¿</option>
          <option value="unprocessed" {{ 'selected' if request.args.get('status') == 'unprocessed' else '' }}>æœªç”Ÿæˆ</option>
        </select>
      </form>
    </div>

    <!-- âœ…âœ…âœ… ä¿®æ­£ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°å†…è¨³è¡¨ç¤ºï¼ˆå…¨ä½“ãƒ»ç”Ÿæˆæ¸ˆã¿ãƒ»æœªç”Ÿæˆï¼‰ âœ…âœ…âœ… -->
    <p class="text-sm text-gray-500 mb-3">
      ğŸ§® ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ï¼š
      <span class="text-green-600 font-semibold">ç”Ÿæˆæ¸ˆã¿ {{ gsc_done_keywords }} ä»¶</span> ï¼
      <span class="text-red-600 font-semibold">æœªç”Ÿæˆ {{ gsc_pending_keywords }} ä»¶</span>
    </p>


    {% if gsc_keywords %}
      <ul class="bg-white dark:bg-gray-800 border rounded shadow divide-y max-h-[400px] overflow-y-auto">
        {% for kw in gsc_keywords %}
          <li class="p-3 flex justify-between items-center">
            <div>
              <span>{{ kw.keyword }}</span>
              {% if kw.source == "gsc" %}
                <span class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-800 rounded-full">GSC</span>
              {% endif %}
            </div>
            <span class="text-sm text-gray-500">
              {% if kw.status == 'done' %}
                âœ… ç”Ÿæˆæ¸ˆã¿
              {% else %}
                â³ æœªç”Ÿæˆ
              {% endif %}
            </span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500">ã¾ã GSCç”±æ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>
</div>

<!-- ğŸ”§ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById("prompt_select");
  const titleField = document.getElementById("title_prompt");
  const bodyField = document.getElementById("body_prompt");

  if (select && titleField && bodyField) {
    select.addEventListener("change", function () {
      const selected = this.options[this.selectedIndex];
      const title = selected.getAttribute("data-title") || "";
      const body = selected.getAttribute("data-body") || "";

      try {
        titleField.value = JSON.parse(title);
        bodyField.value = JSON.parse(body);
      } catch {
        titleField.value = title;
        bodyField.value = body;
      }
    });
  }
});

function toggleDetailPrompt() {
  const area = document.getElementById("detail_prompt_area");
  area.classList.toggle("hidden");
}
</script>
{% endblock %}
