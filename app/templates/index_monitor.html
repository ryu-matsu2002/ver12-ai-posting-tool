{% extends "base.html" %}
{% block title %}インデックス申請（UI補助）{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
  <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
    <span class="material-icons text-blue-400">fact_check</span>
    インデックス申請（UI補助）
  </h1>

  <p class="text-sm text-gray-300 mb-6">
    直近 <strong>28日間</strong> の掲載実績（<code>GSCDailyTotal</code>）をもとに、
    サイト別のインデックス状況を高速に可視化しています。<br>
    申請は <strong>Google Search Console</strong> のページで実行してください（本ツールはリンク補助のみ・規約遵守）。
  </p>

  <!-- ① サイト別サマリー -->
  <div class="mb-8">
    <h2 class="text-lg font-semibold mb-3">サイト別インデックス状況（28日）</h2>
    <div class="overflow-x-auto bg-gray-900 rounded-xl shadow-lg border border-gray-700">
      <table class="min-w-full divide-y divide-gray-700 text-sm">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-gray-300">サイトURL</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">記事数</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">掲載日数</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">インデックス率</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">GSC接続</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
          {% for s in summary %}
            {% set rate_color = 'text-green-400' if s.rate >= 80 else ('text-yellow-400' if s.rate >= 40 else 'text-red-400') %}
            <tr class="hover:bg-gray-800/60 transition">
              <td class="px-4 py-3">
                <a href="{{ s.site_url }}" target="_blank" class="text-blue-400 hover:underline break-all">{{ s.site_url }}</a>
              </td>
              <td class="px-4 py-3 text-right text-gray-200">{{ s.article_count }}</td>
              <td class="px-4 py-3 text-right text-gray-200">{{ s.indexed_days }}/28</td>
              <td class="px-4 py-3 text-right font-bold {{ rate_color }}">{{ s.rate }}%</td>
              <td class="px-4 py-3 text-right">
                {% if s.gsc_connected %}
                  <span class="text-green-400">接続済み</span>
                {% else %}
                  <a href="{{ url_for('main.gsc_connect') }}" class="text-red-400 hover:underline">未接続</a>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-center text-gray-400 py-6">サイトがありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ② 直近公開記事（最大50件） + GSCで開く -->
  <div>
    <h2 class="text-lg font-semibold mb-3">直近の公開記事（最大50件）</h2>
    <div class="overflow-x-auto bg-gray-900 rounded-xl shadow-lg border border-gray-700">
      <table class="min-w-full divide-y divide-gray-700 text-sm">
        <thead class="bg-gray-800">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-gray-300">タイトル</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-300">URL</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">投稿日</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-300">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
          {% for (aid, title, url, site_id, posted_at) in recent_articles %}
            {% set row = (summary | selectattr('site_id','equalto', site_id) | list | first) if summary else None %}
            {% set prop = row.property_uri if row else None %}
            {% set gsc_ok = row.gsc_connected if row else False %}

            {# resource_id はエンコードしない。URL だけ urlencode。 #}
            {% if prop %}
              {% set resource_id = prop %}
            {% else %}
              {# GSCConfig未登録時は URL プレフィックスを推定（末尾 / 必須） #}
              {% set site_url = row.site_url if row else '' %}
              {% set resource_id = site_url if site_url.endswith('/') else site_url ~ '/' %}
            {% endif %}

            {% set inspect_url = "https://search.google.com/search-console/inspect?resource_id=" ~ resource_id ~ "&url=" ~ (url | urlencode) %}

            <tr class="hover:bg-gray-800/60 transition">
              <td class="px-4 py-3 font-medium break-all">{{ title }}</td>
              <td class="px-4 py-3">
                <a href="{{ url }}" target="_blank" class="text-blue-400 hover:underline break-all">{{ url }}</a>
              </td>
              <td class="px-4 py-3 text-right text-gray-300">
                {{ posted_at.strftime('%Y-%m-%d %H:%M') if posted_at else '-' }}
              </td>
              <td class="px-4 py-3 text-right">
                {% if gsc_ok %}
                  <a href="{{ inspect_url }}" target="_blank" rel="noopener"
                     class="inline-flex items-center px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-500 text-white">
                    <span class="material-icons text-sm mr-1">open_in_new</span>GSCで開く
                  </a>
                {% else %}
                  <span class="text-gray-500 text-xs">GSC未接続</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-center text-gray-400 py-6">公開済み記事（URLあり）がまだありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="mt-3 text-xs text-gray-400">
      ※「GSCで開く」から <em>URL検査 → インデックス登録をリクエスト</em> を手動で押してください。自動申請は規約上できません。
    </p>
  </div>
</div>
{% endblock %}
