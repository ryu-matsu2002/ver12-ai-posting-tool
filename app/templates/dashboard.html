{% extends "base.html" %}
{% block title %}Dashboard | AI Posting Tool{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-8">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

<!-- âœ… ç™»éŒ²æ ã®è¡¨ç¤ºï¼šã‚µã‚¤ãƒˆç™»éŒ²ãƒšãƒ¼ã‚¸ã¨åŒæ§˜ã« -->
<div class="mb-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded shadow text-sm text-yellow-800">
  <h3 class="text-lg font-semibold mb-2 text-blue-900 flex items-center gap-2">
    ğŸ“¦ ç™»éŒ²æ ã®ä½¿ç”¨çŠ¶æ³
  </h3>
  {% for plan_name, plan in plans.items() %}
    <p>ğŸ§¾ <strong>åˆ©ç”¨ä¸­ã®ãƒ—ãƒ©ãƒ³:</strong>
      {% if plan_name == 'affiliate' %}
        ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆç”¨ãƒ—ãƒ©ãƒ³
      {% elif plan_name == 'business' %}
        äº‹æ¥­ç”¨ãƒ—ãƒ©ãƒ³
      {% else %}
        {{ plan_name }}
      {% endif %}
    </p>
    <p>
      â— ç™»éŒ²ã‚µã‚¤ãƒˆæ•°ï¼š{{ plan.used }}ã‚µã‚¤ãƒˆ<br>
      â— ã‚ã¨ {{ plan.remaining }} ã‚µã‚¤ãƒˆç™»éŒ²å¯èƒ½ã§ã™ã€‚
    </p>
    {% if plan.logs %}
      <details class="mt-2 mb-2">
        <summary class="cursor-pointer text-blue-700">ğŸ“œ ç™»éŒ²æ ã®è¿½åŠ å±¥æ­´ã‚’è¦‹ã‚‹</summary>
        <ul class="ml-4 list-disc mt-1 text-gray-700">
          {% for log in plan.logs %}
            <li>{{ log.created_at.strftime("%Y-%m-%d") }}ï¼š{{ log.count }}ä»¶ï¼ˆ{{ log.reason }}ï¼‰</li>
          {% endfor %}
        </ul>
      </details>
    {% endif %}
    <hr class="my-2 border-yellow-400">
  {% endfor %}
  <p class="mt-2 text-sm text-blue-700">
    ğŸ§¾ <a href="{{ url_for('main.purchase_history') }}" class="underline hover:text-blue-900">è³¼å…¥å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹</a>
  </p>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
<div class="grid md:grid-cols-4 gap-6 mb-10">
  <div class="bg-white dark:bg-gray-800 p-6 rounded shadow text-center">
    <p class="text-xl font-bold text-green-700 mb-2">æŠ•ç¨¿å®Œäº†</p>
    <p class="text-4xl font-extrabold text-green-700">{{ posted or 0 }}</p>
  </div>
  <div class="bg-white dark:bg-gray-800 p-6 rounded shadow text-center">
    <p class="text-xl font-bold text-blue-600 mb-2">æŠ•ç¨¿å¾…æ©Ÿä¸­</p>
    <p class="text-4xl font-extrabold text-blue-600">{{ done or 0 }}</p>
  </div>
  <div class="bg-white dark:bg-gray-800 p-6 rounded shadow text-center">
    <p class="text-xl font-bold text-gray-800 dark:text-white mb-2">ç·è¨˜äº‹æ•°</p>
    <p class="text-4xl font-extrabold">{{ total_articles or 0 }}</p>
  </div>
  <div class="bg-white dark:bg-red-100 p-6 rounded shadow text-center">
    <p class="text-xl font-bold text-red-600 mb-2">ã‚¨ãƒ©ãƒ¼</p>
    <p class="text-4xl font-extrabold text-red-600">{{ error or 0 }}</p>
  </div>
</div>

<!-- ã‚«ãƒ¼ãƒ‰ç¾¤ -->
<div class="grid lg:grid-cols-4 md:grid-cols-2 sm:grid-cols-2 gap-6 mb-6">
  <a href="{{ url_for('main.log_sites', username=current_user.username) }}"
     class="block bg-white dark:bg-gray-800 p-5 rounded-lg shadow hover:shadow-xl transition text-center">
    <div class="text-3xl mb-2">ğŸ—˜</div>
    <p class="font-semibold text-lg text-gray-900 dark:text-white">è¨˜äº‹ç”Ÿæˆ</p>
    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ã‚µã‚¤ãƒˆåˆ¥ã«è¨˜äº‹ä½œæˆãƒ»çŠ¶æ³ç¢ºèªãƒ»æŠ•ç¨¿ãŒå¯èƒ½</p>
  </a>
  <a href="{{ url_for('main.sites', username=current_user.username) }}"
     class="block bg-white dark:bg-gray-800 p-5 rounded-lg shadow hover:shadow-xl transition text-center">
    <div class="text-3xl mb-2">ğŸŒ</div>
    <p class="font-semibold text-lg text-gray-900 dark:text-white">æ–°è¦ã‚µã‚¤ãƒˆç™»éŒ²</p>
    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">WordPressã‚µã‚¤ãƒˆã‚’ç™»éŒ²ã—ã¦è‡ªå‹•æŠ•ç¨¿å…ˆã«è¨­å®š</p>
  </a>
  <a href="{{ url_for('main.prompts', username=current_user.username) }}"
     class="block bg-white dark:bg-gray-800 p-5 rounded-lg shadow hover:shadow-xl transition text-center">
    <div class="text-3xl mb-2">ğŸ“‹</div>
    <p class="font-semibold text-lg text-gray-900 dark:text-white">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç™»éŒ²</p>
    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">è¨˜äº‹ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†</p>
  </a>
  <a href="{{ url_for('main.keywords', username=current_user.username) }}"
     class="block bg-white dark:bg-gray-800 p-5 rounded-lg shadow hover:shadow-xl transition text-center">
    <div class="text-3xl mb-2">ğŸ·</div>
    <p class="font-semibold text-lg text-gray-900 dark:text-white">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</p>
    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²ãƒ»ç®¡ç†</p>
  </a>
</div>

<!-- ChatGPTã‚«ãƒ¼ãƒ‰ã¨ãƒ­ãƒœãƒƒãƒˆ -->
<div class="relative flex flex-wrap items-end gap-6">
  <a href="{{ url_for('main.chatgpt', username=current_user.username) }}"
     class="block bg-white dark:bg-gray-800 p-5 rounded-lg shadow hover:shadow-xl transition text-center w-[280px]">
    <div class="text-3xl mb-2">ğŸ¤–</div>
    <p class="font-semibold text-lg text-gray-900 dark:text-white">ChatGPT</p>
    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ChatGPTã®ãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™</p>
  </a>

  <!-- ãƒ­ãƒœãƒƒãƒˆç”»åƒã¨ãƒãƒ£ãƒƒãƒˆ -->
  <div class="relative">
    <img id="robotImage"
         src="{{ url_for('static', filename='images/robot.png') }}"
         alt="ãƒ­ãƒœãƒƒãƒˆ"
         class="w-32 h-auto cursor-pointer transition-transform duration-300"
         onclick="toggleChat(); robotTalk();" />

    <div id="speechBubble"
         class="absolute left-36 bottom-20 bg-yellow-100 text-black text-sm px-3 py-2 rounded shadow-lg border border-gray-300 hidden z-30">
    </div>

    <div id="chatWindow"
         class="absolute left-36 bottom-0 w-[500px] bg-white border border-gray-300 shadow-lg rounded-md hidden z-30">
      <div class="bg-blue-700 text-white px-4 py-2 rounded-t-md flex justify-between items-center">
        ğŸ¤– site craftï¼šï¼šãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
        <button onclick="toggleChat()" class="text-white">Ã—</button>
      </div>
      <div id="chatMessages" class="p-3 h-64 overflow-y-auto text-sm space-y-2 bg-gray-50"></div>
      <div class="p-2 border-t flex">
        <input id="chatInput" type="text"
               class="flex-1 border rounded px-2 py-1 text-sm"
               placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
        <button onclick="sendMessage()"
                class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
          é€ä¿¡
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script>
  const chatUsername = "{{ current_user.username }}";
  const messageLog = [];

  const phrases = [
    "ä»Šæ—¥ã‚‚ã„ã„è¨˜äº‹ã‚’æ›¸ã“ã†ï¼",
    "ã‚¯ãƒªãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ï¼",
    "SEOã‚‚ãƒãƒƒãƒãƒªå¯¾å¿œä¸­ï¼",
    "è‡ªå‹•åŒ–ã¯æœ€é«˜ã ã‚ˆã­ï¼",
    "ãƒ­ãƒœã‚‚ä¼‘ã¿ãŸã„ãªã..."
  ];

  function toggleChat() {
    const chat = document.getElementById("chatWindow");
    const messages = document.getElementById("chatMessages");
    chat.classList.toggle("hidden");

    if (!chat.dataset.initialized) {
      const greeting = document.createElement("div");
      greeting.textContent = `ğŸ¤– ã“ã‚“ã«ã¡ã¯ã€${chatUsername}ã•ã‚“ï¼ã”è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã©ã†ãã€‚`;
      greeting.className = "text-left text-blue-700";
      messages.appendChild(greeting);
      chat.dataset.initialized = true;
    }
  }

  function robotTalk() {
    const robot = document.getElementById('robotImage');
    const bubble = document.getElementById('speechBubble');
    if (!robot || !bubble) return;

    robot.classList.add('dance-animation');
    setTimeout(() => robot.classList.remove('dance-animation'), 800);

    const random = phrases[Math.floor(Math.random() * phrases.length)];
    bubble.textContent = random;
    bubble.classList.remove('hidden');
    setTimeout(() => bubble.classList.add('hidden'), 2500);
  }

  function sendMessage() {
    const input = document.getElementById("chatInput");
    const messages = document.getElementById("chatMessages");
    const userText = input.value.trim();
    if (!userText) return;

    const userMsg = document.createElement("div");
    userMsg.textContent = "ğŸ‘¤ " + userText;
    userMsg.className = "text-right text-gray-800";
    messages.appendChild(userMsg);
    messageLog.push({ role: "user", content: userText });

    const botMsg = document.createElement("div");
    botMsg.textContent = "ğŸ¤– è€ƒãˆä¸­...";
    botMsg.className = "text-left text-blue-700";
    messages.appendChild(botMsg);

    messages.scrollTop = messages.scrollHeight;
    input.value = "";

    fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: userText,
        history: messageLog,
        username: chatUsername
      })
    })
    .then(res => res.json())
    .then(data => {
      botMsg.textContent = "ğŸ¤– " + data.reply;
      messageLog.push({ role: "assistant", content: data.reply });
      messages.scrollTop = messages.scrollHeight;
    })
    .catch(err => {
      botMsg.textContent = "ğŸ¤– ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
    });
  }

  // ğŸ”§ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨
  function toggleUserDropdown() {
    const menu = document.getElementById('userDropdown');
    if (menu) menu.classList.toggle('hidden');
  }

  document.addEventListener('click', function (e) {
    const btn = document.getElementById('userDropdownBtn');
    const menu = document.getElementById('userDropdown');
    if (btn && menu && !btn.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.add('hidden');
    }
  });
</script>

<style>
  @keyframes robot-dance {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(3deg); }
    50% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
    100% { transform: rotate(0deg); }
  }
  .dance-animation {
    animation: robot-dance 0.8s ease-in-out;
  }
</style>
{% endblock %}
