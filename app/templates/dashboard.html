{% extends "base.html" %}
{% block title %}Dashboard | SITE CRAFT{% endblock %}

{% block content %}
<!-- 🔷 ヘッダーロゴ -->
<div class="flex flex-col items-center justify-center mt-10 mb-6">
  <div class="flex items-center space-x-6">
    <img src="{{ url_for('static', filename='images/tcc_logo.png') }}" alt="SITE CRAFT ロゴ" class="w-24 h-24" />
    <h1 class="text-[5rem] font-extrabold tracking-wide text-custom-brand leading-none">SITE CRAFT</h1>
  </div>
</div>

<!-- 📊 投稿数カード -->
<div class="grid md:grid-cols-4 gap-6 justify-center mt-8 mb-16 px-6">
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-green-700 mb-2">投稿完了</p>
    <p class="text-4xl font-extrabold text-green-700">{{ posted or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-blue-600 mb-2">投稿待機中</p>
    <p class="text-4xl font-extrabold text-blue-600">{{ done or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-gray-900 mb-2">総記事数</p>
    <p class="text-4xl font-extrabold text-gray-900">{{ total_articles or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-red-600 mb-2">エラー</p>
    <p class="text-4xl font-extrabold text-red-600">
      {{ error or 0 }}
      {% if error %}
        <a href="{{ url_for('main.view_errors', username=current_user.username) }}" class="text-blue-500 underline">エラー詳細</a>
      {% endif %}
    </p>
  </div>
</div>

<!-- 🤖 ロボット + 👑 ランキング -->
<div class="flex flex-col lg:flex-row justify-center items-start gap-8 px-6 mb-20">
  <!-- 🤖 ロボット -->
  <div class="relative w-full lg:w-[30%] flex-shrink-0 ml-[-20px] mt-10">
    <img id="robotImage"
         src="{{ url_for('static', filename='images/robot.png') }}"
         alt="ロボット"
         class="w-56 h-auto cursor-pointer transition-transform duration-300"
         onclick="toggleChat(); robotTalk();" />
    <div id="speechBubble"
         class="absolute left-36 bottom-20 bg-yellow-100 text-black text-sm px-3 py-2 rounded shadow-lg border border-gray-300 hidden z-30">
    </div>

    <!-- チャットウィンドウ -->
    <div id="chatWindow"
         class="absolute left-[12rem] bottom-[-80px] w-[300px] h-[500px] bg-white border border-gray-300 shadow-lg rounded-md hidden z-30 flex flex-col">
      <div class="bg-blue-700 text-white px-4 py-2 rounded-t-md flex justify-between items-center">
        🤖 site craft：チャットルーム
        <button onclick="toggleChat()" class="text-white">×</button>
      </div>
      <div id="chatMessages" class="p-3 overflow-y-auto text-sm space-y-2 bg-gray-50 flex-1"></div>
      <div class="p-2 border-t flex">
        <input id="chatInput" type="text" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="メッセージを入力..." />
        <button onclick="sendMessage()" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">送信</button>
      </div>
    </div>
  </div>

  <!-- 👑 ランキング（3タブ） -->
  <div class="w-full lg:w-[70%] pl-40">
    <h2 class="text-2xl font-bold mb-3">👑 ランキング</h2>

    <!-- タブ -->
    <div class="flex items-center gap-2 mb-2">
      <!-- 既定はサイト登録数 -->
      <button id="tab-site"   class="rank-tab is-active" data-type="site">サイト登録数</button>
      <button id="tab-impr"   class="rank-tab" data-type="impressions">表示回数（直近28日）</button>
      <button id="tab-clicks" class="rank-tab" data-type="clicks">クリック数（直近28日）</button>
    </div>

    <!-- テーブル（高さは従来と同じ） -->
    <div id="ranking-container" class="overflow-y-auto max-h-[500px] border border-gray-200 rounded">
      <table id="ranking-table" class="w-full bg-white shadow text-sm table-fixed">  <!-- table-fixed で列幅安定 -->
        <colgroup id="rank-colgroup">
          <!-- JSでタブに応じて差し替え -->
        </colgroup>
        <thead class="bg-gray-100 text-gray-700 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ===== 初期化 =====
  window.addEventListener("DOMContentLoaded", () => {
    // 既定タブ：サイト登録数
    setActiveTab(document.getElementById("tab-site"));
    renderHeadAndCols("site");
    loadRanking("site");

    // クリックで切替（ページ全体は再読込しない）
    document.querySelectorAll(".rank-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.type;
        setActiveTab(btn);
        renderHeadAndCols(type);   // 見出し・列幅だけ更新
        loadRanking(type);         // 本体データだけAjax更新
      });
    });
  });

  function setActiveTab(btn){
    document.querySelectorAll(".rank-tab").forEach(b => b.classList.remove("is-active"));
    btn.classList.add("is-active");
  }

  // ===== 見出し＆colgroup（列幅）をタブ毎に差し替え =====
  function renderHeadAndCols(type){
    const thead = document.getElementById("ranking-thead");
    const colg  = document.getElementById("rank-colgroup");

    if (type === "site") {
      // 列幅：順位(64px) / 名前(自動) / 値(120px) → 余りは名前へ寄せる
      colg.innerHTML = `
        <col style="width:64px">
        <col>
        <col style="width:120px">
      `;
      thead.innerHTML = `
        <tr>
          <th class="p-2 text-left">順位</th>
          <th class="p-2 text-left">名前</th>
          <th class="p-2 text-right">サイト数</th>
        </tr>
      `;
    } else {
      // 列幅：順位(64px) / サイト名(50%) / 名前(30%) / 値(20%≒120px~固定寄り)
      colg.innerHTML = `
        <col style="width:64px">
        <col style="width:50%">
        <col style="width:30%">
        <col style="width:20%">
      `;
      thead.innerHTML = `
        <tr>
          <th class="p-2 text-left">順位</th>
          <th class="p-2 text-left">サイト名</th>
          <th class="p-2 text-left">名前</th>
          <th class="p-2 text-right">値</th>
        </tr>
      `;
    }
  }

  // ===== ランキング読み込み（/api/rankings を利用） =====
  function loadRanking(type) {
    const tbody = document.getElementById("ranking-body");
    tbody.innerHTML = "";

    fetch(`/api/rankings?type=${encodeURIComponent(type)}`)
      .then(res => {
        if (!res.ok) throw new Error(`APIエラー: ${res.status}`);
        return res.json();
      })
      .then(rows => {
        rows.slice(0, 50).forEach((row, idx) => {
          const icon = idx === 0 ? "🥇" : idx === 1 ? "🥈" : idx === 2 ? "🥉" : `#${idx + 1}`;
          const tr = document.createElement("tr");
          tr.className = "border-b";

          if (type === "site") {
            // ユーザー単位（サイト登録数） — 名前表示＆サイト数の値
            const fullName = `${row.last_name || ""} ${row.first_name || ""}`.trim();
            tr.innerHTML = `
              <td class="p-2 font-semibold">${icon}</td>
              <td class="p-2 truncate">${escapeHtml(fullName || "—")}</td>
              <td class="p-2 text-right font-semibold">${row.site_count ?? 0}</td>
            `;
          } else {
            // サイト単位（表示回数／クリック数） — “名前” 表示に統一
            const siteName = row.site_name || row.site_url || `site#${row.site_id}`;
            const nameText = row.username || ""; // ユーザー名→表記は“名前”
            const href = row.site_url ? row.site_url : "#";
            tr.innerHTML = `
              <td class="p-2 font-semibold">${icon}</td>
              <td class="p-2 truncate">
                <a href="${href}" target="_blank" class="text-blue-600 underline">${escapeHtml(siteName)}</a>
              </td>
              <td class="p-2 truncate">${escapeHtml(nameText)}</td>
              <td class="p-2 text-right font-semibold">${row.value ?? 0}</td>
            `;
          }
          tbody.appendChild(tr);
        });
      })
      .catch(err => {
        console.error("❌ ランキング読み込み失敗:", err);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="p-3 text-red-600">ランキングの取得に失敗しました。</td>`;
        tbody.appendChild(tr);
      });
  }

  // XSS対策の簡易エスケープ
  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ====== チャット（既存） ======
  const chatUsername = "{{ current_user.username }}";
  const messageLog = [];
  const phrases = ["今日もがんばろう！", "SEO最適化中！", "記事作成順調！", "GSC記事生成を実装！"];

  function toggleChat() {
    const chat = document.getElementById("chatWindow");
    const messages = document.getElementById("chatMessages");
    chat.classList.toggle("hidden");
    if (!chat.dataset.initialized) {
      const greeting = document.createElement("div");
      greeting.textContent = `🤖 こんにちは、${chatUsername}さん！ご質問があればお気軽にどうぞ。`;
      greeting.className = "text-left text-blue-700";
      messages.appendChild(greeting);
      chat.dataset.initialized = true;
    }
  }

  function robotTalk() {
    const robot = document.getElementById('robotImage');
    const bubble = document.getElementById('speechBubble');
    if (!robot || !bubble) return;
    robot.classList.add('dance-animation');
    setTimeout(() => robot.classList.remove('dance-animation'), 800);
    const random = phrases[Math.floor(Math.random() * phrases.length)];
    bubble.textContent = random;
    bubble.classList.remove('hidden');
    setTimeout(() => bubble.classList.add('hidden'), 2500);
  }

  function sendMessage() {
    const input = document.getElementById("chatInput");
    const messages = document.getElementById("chatMessages");
    const userText = input.value.trim();
    if (!userText) return;
    const userMsg = document.createElement("div");
    userMsg.textContent = "👤 " + userText;
    userMsg.className = "text-right text-gray-800";
    messages.appendChild(userMsg);
    messageLog.push({ role: "user", content: userText });
    const botMsg = document.createElement("div");
    botMsg.textContent = "🤖 考え中...";
    botMsg.className = "text-left text-blue-700";
    messages.appendChild(botMsg);
    messages.scrollTop = messages.scrollHeight;
    input.value = "";
    fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userText, history: messageLog, username: chatUsername })
    })
      .then(res => res.json())
      .then(data => {
        botMsg.textContent = "🤖 " + data.reply;
        messageLog.push({ role: "assistant", content: data.reply });
        messages.scrollTop = messages.scrollHeight;
      })
      .catch(() => {
        botMsg.textContent = "🤖 エラーが発生しました。";
      });
  }
</script>

<style>
  @keyframes robot-dance {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(3deg); }
    50% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
    100% { transform: rotate(0deg); }
  }
  .dance-animation {
    animation: robot-dance 0.8s ease-in-out;
  }
  .text-custom-brand {
    color: #23185E;
  }

  /* タブ風ボタン（純CSS） */
  .rank-tab{
    display:inline-flex;
    align-items:center;
    gap:.25rem;
    padding:.375rem .75rem;        /* py-1.5 px-3 */
    border-radius:.375rem;         /* rounded-md */
    border:1px solid #D1D5DB;      /* border-gray-300 */
    background:#fff;               /* bg-white */
    color:#1F2937;                 /* text-gray-800 */
    font-size:.875rem;             /* text-sm */
    line-height:1.25rem;
    cursor:pointer;
    transition:background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .rank-tab:hover{ background:#F9FAFB; }
  .rank-tab.is-active{
    background:#2563EB;            /* bg-blue-600 */
    color:#fff;                     /* text-white */
    border-color:#2563EB;          /* border-blue-600 */
  }
  .rank-tab:focus{
    outline:2px solid #93C5FD;     /* focus-visible */
    outline-offset:2px;
  }
</style>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>console.log("✅ Dashboard scripts loaded");</script>
{% endblock %}
