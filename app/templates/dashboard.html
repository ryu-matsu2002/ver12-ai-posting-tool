{% extends "base.html" %}
{% block title %}Dashboard | SITE CRAFT{% endblock %}

{% block content %}
<!-- ğŸ”· ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ -->
<div class="flex flex-col items-center justify-center mt-10 mb-6">
  <div class="flex items-center space-x-6">
    <img src="{{ url_for('static', filename='images/tcc_logo.png') }}" alt="SITE CRAFT ãƒ­ã‚´" class="w-24 h-24" />
    <h1 class="text-[5rem] font-extrabold tracking-wide text-custom-brand leading-none">SITE CRAFT</h1>
  </div>
</div>

<!-- ğŸ“Š æŠ•ç¨¿æ•°ã‚«ãƒ¼ãƒ‰ -->
<div class="grid md:grid-cols-4 gap-6 justify-center mt-8 mb-16 px-6">
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-green-700 mb-2">æŠ•ç¨¿å®Œäº†</p>
    <p class="text-4xl font-extrabold text-green-700">{{ posted or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-blue-600 mb-2">æŠ•ç¨¿å¾…æ©Ÿä¸­</p>
    <p class="text-4xl font-extrabold text-blue-600">{{ done or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-gray-900 mb-2">ç·è¨˜äº‹æ•°</p>
    <p class="text-4xl font-extrabold text-gray-900">{{ total_articles or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-red-600 mb-2">ã‚¨ãƒ©ãƒ¼</p>
    <p class="text-4xl font-extrabold text-red-600">
      {{ error or 0 }}
      {% if error %}
        <a href="{{ url_for('main.view_errors', username=current_user.username) }}" class="text-blue-500 underline">ã‚¨ãƒ©ãƒ¼è©³ç´°</a>
      {% endif %}
    </p>
  </div>
</div>

<!-- ğŸ¤– ãƒ­ãƒœãƒƒãƒˆ + ğŸ‘‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div class="flex flex-col lg:flex-row justify-center items-start gap-8 px-6 mb-20">
  <!-- ğŸ¤– ãƒ­ãƒœãƒƒãƒˆ -->
  <div class="relative w-full lg:w-[30%] flex-shrink-0 ml-[-20px] mt-10">
    <img id="robotImage"
         src="{{ url_for('static', filename='images/robot.png') }}"
         alt="ãƒ­ãƒœãƒƒãƒˆ"
         class="w-56 h-auto cursor-pointer transition-transform duration-300"
         onclick="toggleChat(); robotTalk();" />
    <div id="speechBubble"
         class="absolute left-36 bottom-20 bg-yellow-100 text-black text-sm px-3 py-2 rounded shadow-lg border border-gray-300 hidden z-30">
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="chatWindow"
         class="absolute left-[12rem] bottom-[-80px] w-[300px] h-[500px] bg-white border border-gray-300 shadow-lg rounded-md hidden z-30 flex flex-col">
      <div class="bg-blue-700 text-white px-4 py-2 rounded-t-md flex justify-between items-center">
        ğŸ¤– site craftï¼šãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
        <button onclick="toggleChat()" class="text-white">Ã—</button>
      </div>
      <div id="chatMessages" class="p-3 overflow-y-auto text-sm space-y-2 bg-gray-50 flex-1"></div>
      <div class="p-2 border-t flex">
        <input id="chatInput" type="text" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
        <button onclick="sendMessage()" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- ğŸ‘‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆ3ã‚¿ãƒ–ï¼‰ -->
  <div class="w-full lg:w-[70%] pl-40">
    <h2 class="text-2xl font-bold mb-3">ğŸ‘‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>

    <!-- ã‚¿ãƒ– -->
    <div class="flex items-center gap-2 mb-2">
      <!-- æ—¢å®šã¯ã‚µã‚¤ãƒˆç™»éŒ²æ•° -->
      <button id="tab-site"   class="rank-tab is-active" data-type="site">ã‚µã‚¤ãƒˆç™»éŒ²æ•°</button>
      <button id="tab-impr"   class="rank-tab" data-type="impressions">è¡¨ç¤ºå›æ•°ï¼ˆç›´è¿‘28æ—¥ï¼‰</button>
      <button id="tab-clicks" class="rank-tab" data-type="clicks">ã‚¯ãƒªãƒƒã‚¯æ•°ï¼ˆç›´è¿‘28æ—¥ï¼‰</button>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div id="ranking-container" class="overflow-y-auto max-h-[500px] border border-gray-200 rounded">
      <table id="ranking-table" class="w-full bg-white shadow text-sm table-fixed">
        <colgroup id="rank-colgroup"></colgroup>
        <thead class="bg-gray-100 text-gray-700 sticky top-0 z-10" id="ranking-thead"></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ===== åˆæœŸåŒ– =====
  window.addEventListener("DOMContentLoaded", function () {
    // æ—¢å®šã‚¿ãƒ–ï¼šã‚µã‚¤ãƒˆç™»éŒ²æ•°
    setActiveTab(document.getElementById("tab-site"));
    renderHeadAndCols("site");
    loadRanking("site");

    // ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿ï¼ˆãƒšãƒ¼ã‚¸å…¨ä½“ã¯å†èª­è¾¼ã—ãªã„ï¼‰
    var tabs = document.querySelectorAll(".rank-tab");
    tabs.forEach(function(btn){
      btn.addEventListener("click", function(){
        var type = btn.getAttribute("data-type");
        setActiveTab(btn);
        renderHeadAndCols(type);   // è¦‹å‡ºã—ãƒ»åˆ—å¹…ã ã‘æ›´æ–°
        loadRanking(type);         // ãƒ‡ãƒ¼ã‚¿ã ã‘Ajaxæ›´æ–°
      });
    });

    // ã‚¿ãƒ–ã®å¯è¦–çŠ¶æ…‹ã«å¿œã˜ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–“éš”ã‚’èª¿æ•´
    document.addEventListener("visibilitychange", schedulePresenceRefresh);
  });

  function setActiveTab(btn){
    document.querySelectorAll(".rank-tab").forEach(function(b){ b.classList.remove("is-active"); });
    btn.classList.add("is-active");
  }

  // ===== è¦‹å‡ºã—ï¼†colgroupï¼ˆåˆ—å¹…ï¼‰ã‚’ã‚¿ãƒ–æ¯ã«å·®ã—æ›¿ãˆ =====
  function renderHeadAndCols(type){
    var thead = document.getElementById("ranking-thead");
    var colg  = document.getElementById("rank-colgroup");

    if (type === "site") {
      // åˆ—å¹…ï¼šé †ä½ / åå‰ / ã‚µã‚¤ãƒˆæ•° / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
      colg.innerHTML =
        '<col style="width:64px">' +
        '<col style="width:50%">' +
        '<col style="width:20%">' +
        '<col style="width:30%">';
      thead.innerHTML =
        '<tr>' +
          '<th class="p-2 text-left sep-col">é †ä½</th>' +
          '<th class="p-2 text-left">åå‰</th>' +
          '<th class="p-2 text-right">ã‚µã‚¤ãƒˆæ•°</th>' +
          '<th class="p-2 text-left">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</th>' +
        '</tr>';
    } else {
      // åˆ—å¹…ï¼šé †ä½(64px) / ã‚µã‚¤ãƒˆå(50%) / åå‰(30%) / å€¤(20%)
      var valueLabel = (type === "impressions") ? "è¡¨ç¤ºå›æ•°" : "ã‚¯ãƒªãƒƒã‚¯æ•°";
      colg.innerHTML =
        '<col style="width:64px">' +
        '<col style="width:50%">' +
        '<col style="width:30%">' +
        '<col style="width:20%">';
      thead.innerHTML =
        '<tr>' +
          '<th class="p-2 text-left sep-col">é †ä½</th>' +
          '<th class="p-2 text-left">ã‚µã‚¤ãƒˆå</th>' +
          '<th class="p-2 text-left">åå‰</th>' +
          '<th class="p-2 text-right">' + valueLabel + '</th>' +
        '</tr>';
    }
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ï¼ˆ/api/rankings ã‚’åˆ©ç”¨ï¼‰ =====
  function loadRanking(type) {
    var tbody = document.getElementById("ranking-body");
    tbody.innerHTML = "";

    fetch("/api/rankings?type=" + encodeURIComponent(type))
      .then(function(res){
        if (!res.ok) throw new Error("APIã‚¨ãƒ©ãƒ¼: " + res.status);
        return res.json();
      })
      .then(function(rows){
        rows = rows.slice(0, 50);

        rows.forEach(function(row, idx){
          var icon = (idx === 0) ? "ğŸ¥‡" : (idx === 1) ? "ğŸ¥ˆ" : (idx === 2) ? "ğŸ¥‰" : "#" + (idx + 1);
          var tr = document.createElement("tr");
          tr.className = "border-b";

          if (type === "site") {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ï¼ˆã‚µã‚¤ãƒˆç™»éŒ²æ•°ï¼‰ â€” åå‰è¡¨ç¤ºï¼†ã‚µã‚¤ãƒˆæ•°ï¼‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ—ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
            var fullName = buildName(row);
            tr.innerHTML =
              '<td class="p-2 font-semibold sep-col">' + icon + '</td>' +
              '<td class="p-2 truncate second-col-pad">' + escapeHtml(fullName || "â€”") + '</td>' +
              '<td class="p-2 text-right font-semibold">' + (row.site_count != null ? row.site_count : 0) + '</td>' +
              '<td class="p-2" data-presence data-user-id="' + (row.user_id ?? "") + '">â€”</td>';
          } else {
            // ã‚µã‚¤ãƒˆå˜ä½ï¼ˆè¡¨ç¤ºå›æ•°ï¼ã‚¯ãƒªãƒƒã‚¯æ•°ï¼‰ â€” â€œåå‰â€ è¡¨ç¤ºï¼ˆå§“+å â†’ user_name â†’ usernameï¼‰
            var siteName = row.site_name || row.site_url || ("site#" + row.site_id);
            var nameText = buildName(row);
            var href = row.site_url ? row.site_url : "#";
            tr.innerHTML =
              '<td class="p-2 font-semibold sep-col">' + icon + '</td>' +
              '<td class="p-2 truncate second-col-pad">' +
                '<a href="' + href + '" target="_blank" class="text-blue-600 underline">' + escapeHtml(siteName) + '</a>' +
              '</td>' +
              '<td class="p-2 truncate">' + escapeHtml(nameText) + '</td>' +
              '<td class="p-2 text-right font-semibold">' + (row.value != null ? row.value : 0) + '</td>';
          }
          tbody.appendChild(tr);
        });

        // presence ã‚’ä¸€æ‹¬å–å¾—ã—ã¦åæ˜ ï¼ˆã‚µã‚¤ãƒˆã‚¿ãƒ–ã®ã¿ï¼‰
        if (type === "site") {
          var ids = rows.map(function(r){ return r.user_id; }).filter(Boolean);
          if (ids.length) {
            fetch("/presence/status?user_ids=" + encodeURIComponent(Array.from(new Set(ids)).join(",")))
              .then(function(res){ return res.json(); })
              .then(function(data){ renderPresence(data); })
              .catch(function(err){ console.warn("presence fetch failed:", err); });
              // âœ… åˆå›ãƒ¬ãƒ¼ã‚¹å¯¾ç­–ï¼š2ç§’å¾Œã«ã‚‚ã†ä¸€åº¦ã ã‘å–ã‚Šç›´ã—ã¦åæ˜ 
            setTimeout(function(){
              fetch("/presence/status?user_ids=" + encodeURIComponent(Array.from(new Set(ids)).join(",")))
                .then(function(res){ return res.json(); })
                .then(function(data){ renderPresence(data); })
                .catch(function(){});
            }, 2000);
          }
          schedulePresenceRefresh(); // å®šæœŸæ›´æ–°ï¼ˆç”»é¢å¯è¦–æ™‚ã¯çŸ­ã‚ï¼‰
        } else {
          // ä»–ã‚¿ãƒ–ã§ã¯å®šæœŸæ›´æ–°ã‚’åœæ­¢
          clearInterval(presenceTimer);
        }
      })
      .catch(function(err){
        console.error("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿å¤±æ•—:", err);
        var tr = document.createElement("tr");
        // ç¾åœ¨ã™ã¹ã¦ã®ã‚¿ãƒ–ã§åˆ—æ•°ã¯4
        tr.innerHTML = '<td colspan="4" class="p-3 text-red-600">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td>';
        tbody.appendChild(tr);
      });
  }

  // â€œåå‰â€ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šlast_name+first_name â†’ user_name â†’ username
  function buildName(row){
    var lf = [row.last_name, row.first_name].filter(Boolean).join(" ").trim();
    if (lf) return lf;
    if (row.user_name) return row.user_name;
    if (row.username) return row.username;
    return "";
  }

  // XSSå¯¾ç­–ã®ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]); });
  }

  // ---- Presenceæç”»ï¼ˆ/presence/status ã®çµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã¸åæ˜ ï¼‰
  function renderPresence(data){
    var onlineSet = new Set((data.online_ids || []).map(Number));
    var lastMap = data.last_seen_at || {};
    document.querySelectorAll('[data-presence][data-user-id]').forEach(function(td){
      var uid = td.getAttribute('data-user-id');
      if (!uid) return;
      if (onlineSet.has(Number(uid))) {
        td.innerHTML = '<span class="inline-flex items-center gap-1">' +
          '<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>' +
          '<span class="text-green-700">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­</span>' +
        '</span>';
      } else {
        var iso = lastMap[uid];
        td.innerHTML = '<span class="text-gray-500">' + timeagoJp(iso) + '</span>';
      }
    });
  }

  // ISOæ–‡å­—åˆ— â†’ æ—¥æœ¬èªç›¸å¯¾æ™‚åˆ»
  function timeagoJp(iso){
    if (!iso) return "æœªã‚ªãƒ³ãƒ©ã‚¤ãƒ³";
    var t = new Date(iso);
    var sec = Math.max(1, Math.floor((Date.now() - t.getTime()) / 1000));
    if (sec < 90) return "1åˆ†ä»¥å†…";
    var min = Math.floor(sec/60);
    if (min < 60) return min + "åˆ†å‰";
    var hr = Math.floor(min/60);
    if (hr < 24) return hr + "æ™‚é–“å‰";
    var day = Math.floor(hr/24);
    if (day < 7) return day + "æ—¥å‰";
    var wk = Math.floor(day/7);
    if (wk < 5) return wk + "é€±é–“å‰";
    var mon = Math.floor(day/30);
    if (mon < 12) return mon + "ã‹æœˆå‰";
    var yr = Math.floor(day/365);
    return yr + "å¹´å‰";
  }

  // 45â€“90ç§’ã”ã¨ã®è»½é‡æ›´æ–°ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æœ¬ä½“ã¯å†å–å¾—ã—ãªã„ï¼‰
  var presenceTimer;
  function schedulePresenceRefresh(){
    clearInterval(presenceTimer);
    var interval = document.hidden ? 90000 : 45000;
    presenceTimer = setInterval(function(){
      var tds = document.querySelectorAll('[data-presence][data-user-id]');
      if (!tds.length) return;
      var ids = Array.from(new Set(Array.from(tds).map(function(td){ return td.getAttribute('data-user-id'); }).filter(Boolean)));
      if (!ids.length) return;
      fetch("/presence/status?user_ids=" + encodeURIComponent(ids.join(",")))
        .then(function(res){ return res.json(); })
        .then(function(data){ renderPresence(data); })
        .catch(function(){});
    }, interval);
  }

  // ====== ãƒãƒ£ãƒƒãƒˆï¼ˆæ—¢å­˜ï¼‰ ======
  var chatUsername = "{{ current_user.username }}";
  var messageLog = [];
  var phrases = ["ä»Šæ—¥ã‚‚ãŒã‚“ã°ã‚ã†ï¼", "SEOæœ€é©åŒ–ä¸­ï¼", "è¨˜äº‹ä½œæˆé †èª¿ï¼", "GSCè¨˜äº‹ç”Ÿæˆã‚’å®Ÿè£…ï¼"];

  function toggleChat() {
    var chat = document.getElementById("chatWindow");
    var messages = document.getElementById("chatMessages");
    chat.classList.toggle("hidden");
    if (!chat.dataset.initialized) {
      var greeting = document.createElement("div");
      greeting.textContent = "ğŸ¤– ã“ã‚“ã«ã¡ã¯ã€" + chatUsername + "ã•ã‚“ï¼ã”è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã©ã†ãã€‚";
      greeting.className = "text-left text-blue-700";
      messages.appendChild(greeting);
      chat.dataset.initialized = true;
    }
  }

  function robotTalk() {
    var robot = document.getElementById('robotImage');
    var bubble = document.getElementById('speechBubble');
    if (!robot || !bubble) return;
    robot.classList.add('dance-animation');
    setTimeout(function(){ robot.classList.remove('dance-animation'); }, 800);
    var random = phrases[Math.floor(Math.random() * phrases.length)];
    bubble.textContent = random;
    bubble.classList.remove('hidden');
    setTimeout(function(){ bubble.classList.add('hidden'); }, 2500);
  }

  function sendMessage() {
    var input = document.getElementById("chatInput");
    var messages = document.getElementById("chatMessages");
    var userText = (input.value || "").trim();
    if (!userText) return;
    var userMsg = document.createElement("div");
    userMsg.textContent = "ğŸ‘¤ " + userText;
    userMsg.className = "text-right text-gray-800";
    messages.appendChild(userMsg);
    messageLog.push({ role: "user", content: userText });
    var botMsg = document.createElement("div");
    botMsg.textContent = "ğŸ¤– è€ƒãˆä¸­...";
    botMsg.className = "text-left text-blue-700";
    messages.appendChild(botMsg);
    messages.scrollTop = messages.scrollHeight;
    input.value = "";
    fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userText, history: messageLog, username: chatUsername })
    })
      .then(function(res){ return res.json(); })
      .then(function(data){
        botMsg.textContent = "ğŸ¤– " + (data.reply || "");
        messageLog.push({ role: "assistant", content: data.reply || "" });
        messages.scrollTop = messages.scrollHeight;
      })
      .catch(function(){
        botMsg.textContent = "ğŸ¤– ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      });
  }
</script>

<style>
  @keyframes robot-dance {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(3deg); }
    50% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
    100% { transform: rotate(0deg); }
  }
  .dance-animation { animation: robot-dance 0.8s ease-in-out; }
  .text-custom-brand { color: #23185E; }

  /* ã‚¿ãƒ–é¢¨ãƒœã‚¿ãƒ³ï¼ˆç´”CSSï¼‰ */
  .rank-tab{
    display:inline-flex;
    align-items:center;
    gap:.25rem;
    padding:.375rem .75rem;
    border-radius:.375rem;
    border:1px solid #D1D5DB;
    background:#fff;
    color:#1F2937;
    font-size:.875rem;
    line-height:1.25rem;
    cursor:pointer;
    transition:background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .rank-tab:hover{ background:#F9FAFB; }
  .rank-tab.is-active{
    background:#2563EB;
    color:#fff;
    border-color:#2563EB;
  }
  .rank-tab:focus{
    outline:2px solid #93C5FD;
    outline-offset:2px;
  }

  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã®è¦–èªæ€§å‘ä¸Šï¼šRankåˆ—ã‚’åŒºåˆ‡ã‚‹ãƒ»2åˆ—ç›®ã«ä½™ç™½ã§â€œé›¢ã™â€ */
  #ranking-table th:first-child,
  #ranking-table td:first-child{
    border-right:1px solid #E5E7EB; /* gray-200 */
    white-space:nowrap;
  }
  #ranking-table th,
  #ranking-table td{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  /* 2åˆ—ç›®ï¼ˆåå‰/ã‚µã‚¤ãƒˆåï¼‰ã«å°‘ã—å·¦ä½™ç™½ã‚’è¿½åŠ ã—ã¦ Rank ã‹ã‚‰é›¢ã™ */
  #ranking-table th:nth-child(2),
  #ranking-table td:nth-child(2){
    padding-left:1rem; /* 16px */
  }
  /* table-fixed æ™‚ã®è¦‹æ „ãˆã‚’å®‰å®šåŒ– */
  #ranking-table { table-layout: fixed; }
</style>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>console.log("âœ… Dashboard scripts loaded");</script>
{% endblock %}
