{% extends "base.html" %}
{% block title %}Dashboard | SITE CRAFT{% endblock %}

{% block content %}

<!-- ğŸ”· ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ­ã‚´ -->
<div class="flex flex-col items-center justify-center mt-10 mb-6">
  <div class="flex items-center space-x-6">
    <img src="{{ url_for('static', filename='images/tcc_logo.png') }}" alt="SITE CRAFT ãƒ­ã‚´" class="w-24 h-24" />
    <h1 class="text-[5rem] font-extrabold tracking-wide text-custom-brand leading-none">SITE CRAFT</h1>
  </div>
</div>

<!-- ğŸ“Š æŠ•ç¨¿æ•°ã‚«ãƒ¼ãƒ‰ -->
<div class="grid md:grid-cols-4 gap-6 justify-center mt-8 mb-16 px-6">
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-green-700 mb-2">æŠ•ç¨¿å®Œäº†</p>
    <p class="text-4xl font-extrabold text-green-700">{{ posted or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-blue-600 mb-2">æŠ•ç¨¿å¾…æ©Ÿä¸­</p>
    <p class="text-4xl font-extrabold text-blue-600">{{ done or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-gray-900 mb-2">ç·è¨˜äº‹æ•°</p>
    <p class="text-4xl font-extrabold text-gray-900">{{ total_articles or 0 }}</p>
  </div>
  <div class="bg-white shadow rounded p-6 text-center">
    <p class="text-xl font-bold text-red-600 mb-2">ã‚¨ãƒ©ãƒ¼</p>
    <p class="text-4xl font-extrabold text-red-600">{{ error or 0 }}</p>
  </div>
</div>

<!-- ğŸ¤– ãƒ­ãƒœãƒƒãƒˆ + ğŸ… ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div class="flex flex-col lg:flex-row justify-center items-start gap-8 px-6 mb-20">
  <!-- ğŸ¤– ãƒ­ãƒœãƒƒãƒˆ -->
  <div class="relative w-full lg:w-[30%] flex-shrink-0 ml-[-20px]">
    <img id="robotImage"
         src="{{ url_for('static', filename='images/robot.png') }}"
         alt="ãƒ­ãƒœãƒƒãƒˆ"
         class="w-56 h-auto cursor-pointer transition-transform duration-300"
         onclick="toggleChat(); robotTalk();" />
    <div id="speechBubble"
         class="absolute left-36 bottom-20 bg-yellow-100 text-black text-sm px-3 py-2 rounded shadow-lg border border-gray-300 hidden z-30">
    </div>
    <div id="chatWindow"
         class="absolute left-[12rem] bottom-0 w-[400px] bg-white border border-gray-300 shadow-lg rounded-md hidden z-30">
      <div class="bg-blue-700 text-white px-4 py-2 rounded-t-md flex justify-between items-center">
        ğŸ¤– site craftï¼šãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
        <button onclick="toggleChat()" class="text-white">Ã—</button>
      </div>
      <div id="chatMessages" class="p-3 h-60 overflow-y-auto text-sm space-y-2 bg-gray-50"></div>
      <div class="p-2 border-t flex">
        <input id="chatInput" type="text" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
        <button onclick="sendMessage()" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- ğŸ… ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div class="w-full lg:w-[50%] pl-32">
  <h2 class="text-2xl font-bold mb-4">ğŸ‘‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>

  <!-- ã‚¿ãƒ– -->
  <div class="mb-4 flex space-x-4">
    <button onclick="loadRanking('site')" class="ranking-tab px-4 py-2 rounded bg-blue-100 text-blue-800 font-semibold">ã‚µã‚¤ãƒˆæ•°</button>
    <button onclick="loadRanking('impressions')" class="ranking-tab px-4 py-2 rounded bg-gray-100 text-gray-800">è¡¨ç¤ºå›æ•°</button>
    <button onclick="loadRanking('clicks')" class="ranking-tab px-4 py-2 rounded bg-gray-100 text-gray-800">ã‚¯ãƒªãƒƒã‚¯æ•°</button>
  </div>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ -->
  <div id="ranking-container" class="overflow-y-auto max-h-[500px] border border-gray-200 rounded">
    <table class="w-full bg-white shadow text-sm">
      <thead class="bg-gray-100 text-gray-700 sticky top-0 z-10" id="ranking-thead"></thead>
      <tbody id="ranking-body"></tbody>
    </table>
  </div>
</div>

<script>
  const labelMap = {
    "site": "ç™»éŒ²ã‚µã‚¤ãƒˆæ•°",
    "impressions": "è¡¨ç¤ºå›æ•°",
    "clicks": "ã‚¯ãƒªãƒƒã‚¯æ•°"
  };

  window.addEventListener("DOMContentLoaded", () => {
    loadRanking("site");
  });

  function loadRanking(type) {
    const tbody = document.getElementById("ranking-body");
    const thead = document.getElementById("ranking-thead");

    // ğŸ¯ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™ï¼šåˆæœŸåŒ–ï¼†fadeã‚¯ãƒ©ã‚¹è¿½åŠ 
    tbody.classList.remove("fade-enter-active");
    void tbody.offsetWidth; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
    tbody.classList.add("fade-enter");

    fetch(`/api/rankings?type=${type}`)
      .then(res => res.json())
      .then(data => {
        tbody.innerHTML = "";
        thead.innerHTML = "";

        if (type === "site") {
          thead.innerHTML = `
            <tr>
              <th class="p-2 text-left w-[50px]">é †ä½</th>
              <th class="p-2 text-left w-[80px]">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
              <th class="p-2 text-center w-[60px]">${labelMap[type]}</th>
            </tr>`;

          data.forEach((row, index) => {
            const icon = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "#" + (index + 1);
            const tr = document.createElement("tr");
            tr.className = "border-b";
            tr.innerHTML = `
              <td class="p-2 font-semibold">${icon}</td>
              <td class="p-2 truncate w-[80px]">${row.last_name} ${row.first_name}</td>
              <td class="p-2 text-center w-[60px]">${row.site_count}</td>`;
            tbody.appendChild(tr);
          });

        } else {
          thead.innerHTML = `
            <tr>
              <th class="p-2 text-left w-[50px]">é †ä½</th>
              <th class="p-2 text-left w-[100px]">ã‚µã‚¤ãƒˆå</th>
              <th class="p-2 text-left w-[80px]">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
              <th class="p-2 text-center w-[60px]">${labelMap[type]}</th>
            </tr>`;

          data.forEach((row, index) => {
            const icon = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "#" + (index + 1);
            const tr = document.createElement("tr");
            tr.className = "border-b";
            tr.innerHTML = `
              <td class="p-2 font-semibold">${icon}</td>
              <td class="p-2 truncate w-[100px]">${row.site_name}</td>
              <td class="p-2 truncate w-[80px]">${row.user_name}</td>
              <td class="p-2 text-center w-[60px]">${row.value}</td>`;
            tbody.appendChild(tr);
          });
        }

        // âœ… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼š0.3ç§’ã§fade-in
        setTimeout(() => {
          tbody.classList.remove("fade-enter");
          tbody.classList.add("fade-enter-active");
        }, 10);

        document.querySelectorAll(".ranking-tab").forEach(btn => {
          btn.classList.remove("bg-blue-100", "text-blue-800");
          btn.classList.add("bg-gray-100", "text-gray-800");
        });
        const activeBtn = document.querySelector(`.ranking-tab[onclick="loadRanking('${type}')"]`);
        if (activeBtn) {
          activeBtn.classList.remove("bg-gray-100", "text-gray-800");
          activeBtn.classList.add("bg-blue-100", "text-blue-800");
        }
      })
      .catch(err => {
        console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      });
  }
</script>

<style>
  @keyframes robot-dance {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(3deg); }
    50% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
    100% { transform: rotate(0deg); }
  }
  .dance-animation {
    animation: robot-dance 0.8s ease-in-out;
  }
  .text-custom-brand {
    color: #23185E;
  }

  /* ğŸ¨ ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ‡æ›¿ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  #ranking-body.fade-enter {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #ranking-body.fade-enter-active {
    opacity: 1;
  }
</style>

{% endblock %}
