{# app/templates/external_accounts.html #}
{% extends "base.html" %}
{% block title %}å¤–éƒ¨ãƒ–ãƒ­ã‚°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§{% endblock %}

{% block content %}
{% block content %}
<style>
  /* ==== å¤–éƒ¨SEOãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ†ãƒ¼ãƒï¼ˆã“ã®ãƒšãƒ¼ã‚¸å†…ã ã‘ã«é©ç”¨ï¼‰ ==== */
  :root{
    --seo-bg:#3A1F5C; --pane:#44286D; --pane-2:#4D2F7D; --edge:rgba(255,255,255,.14);
    --txt:#fff; --txt-dim:#E7E1FA; --row:#54307EAA; --row-alt:#593587AA; --row-hover:#68449C;
  }
  /* ãƒšãƒ¼ã‚¸èƒŒæ™¯ã‚’ãƒ‘ãƒ¼ãƒ—ãƒ«ã«ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ã®ç™½ã‚’ä¸Šæ›¸ãï¼‰ */
  html, body, main, #main, #content, .content, .page-wrapper, .page-content{
    background:var(--seo-bg) !important; color:var(--txt);
  }

  /* ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå¾Œè¿°ã® .extacc ã§å…¨ä½“ã‚’åŒ…ã‚€ï¼‰ */
  .extacc h2{ color:var(--txt); font-size:2.1rem; font-weight:800; letter-spacing:.02em;
              margin:0 0 12px; text-shadow:0 2px 10px rgba(0,0,0,.25); }

  /* çµã‚Šè¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚«ãƒ¼ãƒ‰é¢¨ã« */
  .extacc form{
    background:var(--pane-2); border:1px solid var(--edge); border-radius:12px;
    padding:10px 12px; color:var(--txt);
  }
  .extacc label{ color:var(--txt-dim); }
  .extacc select{ background:rgba(255,255,255,.10); color:var(--txt); border:1px solid var(--edge);
                  border-radius:10px; padding:6px 10px; }
  .extacc button[type="submit"]{ background:#2563EB; color:#fff; border:1px solid #1D4ED8;
                                 padding:.45rem .8rem; border-radius:.6rem; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¤–éƒ¨SEOãƒšãƒ¼ã‚¸é¢¨ã« */
  .extacc table{ width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--edge);
                 background:var(--pane); border-radius:12px; overflow:hidden; }
  .extacc thead{ background:var(--pane-2) !important; color:var(--txt); }
  .extacc th{ font-weight:700; padding:10px 12px; border-bottom:1px solid var(--edge); text-align:left; }
  .extacc td{ padding:10px 12px; color:var(--txt); }
  .extacc tbody tr{ background:var(--row); border-bottom:1px solid var(--edge); }
  .extacc tbody tr:nth-child(odd){ background:var(--row-alt); }
  .extacc tbody tr:hover{ background:var(--row-hover); }

  /* ãƒªãƒ³ã‚¯è‰²ï¼ˆè¨˜äº‹ä¸€è¦§ãƒ»ã‚½ãƒ¼ãƒˆï¼‰ */
  .extacc a{ color:#C9B7FF; }
  .extacc a:hover{ color:#fff; text-decoration:underline; }

  /* Pillï¼ˆLD / note / Ameï¼‰â€” æ–‡å­—è‰²ã‚’ç™½ã«å›ºå®šã—ã¤ã¤ãƒ†ãƒ¼ãƒã«é¦´æŸ“ã¾ã›ã‚‹ */
  .extacc .text-white{ color:#fff !important; }
  .extacc .bg-orange-600{ background:#A888F8 !important; }  /* livedoor */
  .extacc .bg-blue-600{   background:#7F7396 !important; }  /* note    */
  .extacc .bg-green-600{  background:#2ED3B7 !important; color:#06261E !important; } /* Ame */
  /* â€œè¨˜äº‹ä¸€è¦§â€ãƒªãƒ³ã‚¯ã®é’ã‚‚ãƒ†ãƒ¼ãƒè‰²ã«å¯„ã›ã‚‹ */
  .extacc .text-blue-600{ color:#C9B7FF !important; }
  .extacc .text-blue-600:hover{ color:#fff !important; }
</style>

<div class="extacc">
<h2 class="text-2xl font-bold mb-6 flex items-center">
  ğŸš€ å¤–éƒ¨ç„¡æ–™ãƒ–ãƒ­ã‚°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§
</h2>

{# â”€â”€ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ â”€â”€ #}
<form method="get" class="mb-6 flex items-center space-x-4">
  <label for="site_id" class="text-sm font-medium">ã‚µã‚¤ãƒˆã§çµã‚Šè¾¼ã¿ï¼š</label>
  <select name="site_id" id="site_id" class="border rounded px-2 py-1 text-sm">
    <option value="">-- å…¨ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º --</option>
    {% for s in all_sites %}
      <option value="{{ s.id }}" {% if site_id and site_id == s.id %}selected{% endif %}>
        {{ s.name }}
      </option>
    {% endfor %}
  </select>
  {% if selected_blog_type %}<input type="hidden" name="blog_type" value="{{ selected_blog_type }}">{% endif %}
  {% if selected_sort %}<input type="hidden" name="sort" value="{{ selected_sort }}">{% endif %}
  {% if search_query %}<input type="hidden" name="q" value="{{ search_query }}">{% endif %}
  <button type="submit"
          class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">
    çµã‚Šè¾¼ã‚€
  </button>
</form>

{# â”€â”€ ã‚½ãƒ¼ãƒˆãƒˆã‚°ãƒ«è¨ˆç®— â”€â”€ #}
{% set current_sort = selected_sort or request.args.get('sort') %}
{% set posted_toggle    = 'posted_asc'    if current_sort == 'posted_desc'    else 'posted_desc' %}
{% set generated_toggle = 'generated_asc' if current_sort == 'generated_desc' else 'generated_desc' %}
{% set total_toggle     = 'total_asc'     if current_sort == 'total_desc'     else 'total_desc' %}

{% set has_accounts = false %}

{% for site in all_sites %}
  {% set site_accounts = accts | selectattr("site_id", "equalto", site.id) | list %}
  {% if site_accounts %}
    {% set has_accounts = true %}

    <h3 class="text-lg font-bold mt-8 mb-2">{{ site.name }}</h3>
    <table class="w-full text-sm border mb-4 table-fixed">
      {# â˜… 6åˆ—ã‚’å‡ç­‰ï¼ˆ16.66%ï¼‰ã«å›ºå®š #}
      <colgroup>
        <col style="width:16.66%">
        <col style="width:16.66%">
        <col style="width:16.66%">
        <col style="width:16.66%">
        <col style="width:16.66%">
        <col style="width:16.66%">
      </colgroup>
      <thead class="bg-gray-100">
        <tr>
          <th class="px-3 py-2">ãƒ–ãƒ­ã‚°</th>
          <th class="px-3 py-2">ãƒ¡ãƒ¼ãƒ«</th>

          <th class="px-3 py-2 text-right">
            <a class="hover:underline"
               href="{{ url_for('main.external_accounts',
                                site_id=site_id,
                                blog_type=selected_blog_type,
                                q=search_query,
                                sort=posted_toggle) }}">
              æŠ•ç¨¿å®Œäº†
              {% if current_sort and current_sort.startswith('posted_') %}
                {% if current_sort.endswith('desc') %}â¬‡{% else %}â¬†{% endif %}
              {% else %}â†•{% endif %}
            </a>
          </th>
          <th class="px-3 py-2 text-right">
            <a class="hover:underline"
               href="{{ url_for('main.external_accounts',
                                site_id=site_id,
                                blog_type=selected_blog_type,
                                q=search_query,
                                sort=generated_toggle) }}">
              è¨˜äº‹ç”Ÿæˆæ¸ˆã¿
              {% if current_sort and current_sort.startswith('generated_') %}
                {% if current_sort.endswith('desc') %}â¬‡{% else %}â¬†{% endif %}
              {% else %}â†•{% endif %}
            </a>
          </th>
          <th class="px-3 py-2 text-right">
            <a class="hover:underline"
               href="{{ url_for('main.external_accounts',
                                site_id=site_id,
                                blog_type=selected_blog_type,
                                q=search_query,
                                sort=total_toggle) }}">
              ç·è¨˜äº‹æ•°
              {% if current_sort and current_sort.startswith('total_') %}
                {% if current_sort.endswith('desc') %}â¬‡{% else %}â¬†{% endif %}
              {% else %}â†•{% endif %}
            </a>
          </th>

          <th class="px-3 py-2">è¨˜äº‹ä¸€è¦§</th>
        </tr>
      </thead>
      <tbody>
        {% for a in site_accounts %}
          {% set posted    = a.posted_cnt or 0 %}
          {% set generated = a.generated_cnt or 0 %}
          {% set total     = a.total_cnt or (posted + generated) %}

          <tr class="border-b">
            <td class="px-3 py-2">
              <span class="px-2 py-1 rounded text-white text-xs
                    {% if a.blog_type.value == 'note' %} bg-blue-600
                    {% elif a.blog_type.value == 'ameba' %} bg-green-600
                    {% elif a.blog_type.value == 'livedoor' %} bg-orange-600
                    {% else %} bg-gray-600 {% endif %}">
                {{ a.blog_type.value }}
              </span>
            </td>

            <td class="px-3 py-2 font-mono truncate">
              {{ a.email }}
            </td>

            <td class="px-3 py-2 text-right">{{ posted }}</td>
            <td class="px-3 py-2 text-right">{{ generated }}</td>
            <td class="px-3 py-2 text-right">{{ total }}</td>

            <td class="px-3 py-2">
              <a href="{{ url_for('main.external_account_articles', acct_id=a.id) }}"
                 class="text-blue-600 hover:underline">è¨˜äº‹ä¸€è¦§</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endfor %}

{% if not has_accounts %}
  <p class="text-gray-500">ã¾ã å¤–éƒ¨ãƒ–ãƒ­ã‚°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}
</div>
{% endblock %}
