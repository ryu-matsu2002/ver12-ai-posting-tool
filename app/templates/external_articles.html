{# app/templates/external_articles.html #}
{% extends "base.html" %}
{% block title %}å¤–éƒ¨SEO | è¨˜äº‹ä¸€è¦§{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 flex items-center">
  ğŸ“ {{ site.name }} â€”
  <span class="ml-2 px-2 py-0.5 rounded text-white text-xs {% if acct.blog_type.value == 'livedoor' %}bg-orange-600{% elif acct.blog_type.value == 'note' %}bg-blue-600{% else %}bg-gray-600{% endif %}">
    {{ acct.blog_type.value }}
  </span>
  ã®è¨˜äº‹ä¸€è¦§
</h2>

<p class="mb-4">
  <a href="{{ url_for('main.external_accounts', site_id=site.id) }}" class="text-blue-600 hover:underline">â† ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a>
</p>

<table class="w-full text-sm border">
  <thead class="bg-gray-100">
    <tr>
      <th class="px-3 py-2 text-left">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
      <th class="px-3 py-2 text-left">ç¾åœ¨ã®çŠ¶æ…‹</th>
      <th class="px-3 py-2 text-left">æŠ•ç¨¿äºˆå®šæ—¥</th>
      <th class="px-3 py-2 text-left">Q&amp;Aè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</th>
      <th class="px-3 py-2 text-left">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
      <th class="px-3 py-2 text-right">æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {% for sched, kw, art in rows %}
      {# è¡¨ç¤ºURLã®æ±ºå®šï¼ˆã¾ãšURLã‚’ç¢ºå®šã•ã›ã‚‹ï¼‰ #}
      {% set view_url = sched.posted_url or (art and art.posted_url) or None %}

      {# çŠ¶æ…‹ã®æ±ºå®šï¼ˆé †ç•ªãŒé‡è¦ï¼šURLãŒã‚ã‚Œã°æœ€å„ªå…ˆã§ã€ŒæŠ•ç¨¿å®Œäº†ã€ï¼‰ #}
      {% set state = 'è¨˜äº‹ç”Ÿæˆä¸­' %}
      {% if view_url %}
        {% set state = 'æŠ•ç¨¿å®Œäº†' %}
      {% elif sched.status == 'posted' %}
        {% set state = 'æŠ•ç¨¿å®Œäº†' %}
      {% elif sched.status == 'error' or (art and art.status == 'error') %}
        {% set state = 'ã‚¨ãƒ©ãƒ¼' %}
      {% elif art %}
        {% if art.status in ['done'] %}
          {% set state = 'è¨˜äº‹ç”Ÿæˆæ¸ˆã¿' %}
        {% else %}
          {% set state = 'è¨˜äº‹ç”Ÿæˆä¸­' %}
        {% endif %}
      {% endif %}

      {% set badge_classes =
         'bg-green-100 text-green-700' if state == 'æŠ•ç¨¿å®Œäº†' else
         'bg-blue-100 text-blue-700'  if state == 'è¨˜äº‹ç”Ÿæˆæ¸ˆã¿' else
         'bg-amber-100 text-amber-700' if state == 'è¨˜äº‹ç”Ÿæˆä¸­' else
         'bg-red-100 text-red-700' %}

      <tr class="border-b">
        <td class="px-3 py-2">{{ kw.keyword }}</td>
        <td class="px-3 py-2">
          <span class="px-2 py-1 rounded text-xs font-semibold {{ badge_classes }}">{{ state }}</span>
        </td>
        <td class="px-3 py-2">
          {% if sched.scheduled_date %}{{ to_jst(sched.scheduled_date).strftime("%Y-%m-%d %H:%M") }}{% endif %}
        </td>
        <td class="px-3 py-2">{{ art.title if art else "" }}</td>
        <td class="px-3 py-2">
          {% if art %}
            <a href="{{ url_for('main.external_article_preview', article_id=art.id) }}"
               class="text-blue-600 hover:underline" target="_blank">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
          {% else %}
            <span class="text-gray-400">â€”</span>
          {% endif %}
        </td>
        <td class="px-3 py-2 text-right whitespace-nowrap">
          <a href="{{ url_for('main.external_article_edit', article_id=art.id) if art else '#' }}"
             class="px-2 py-1 bg-amber-500/90 hover:bg-amber-500 text-white rounded text-xs {% if not art %}pointer-events-none opacity-50{% endif %}">ç·¨é›†</a>

          <form action="{{ url_for('main.external_article_delete', article_id=art.id) if art else '#' }}"
                method="post" class="inline"
                onsubmit="return confirm('ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
            <button type="submit"
                    class="px-2 py-1 bg-rose-600 hover:bg-rose-700 text-white rounded text-xs {% if not art %}pointer-events-none opacity-50{% endif %}">
              å‰Šé™¤
            </button>
          </form>

          {% if state == 'æŠ•ç¨¿å®Œäº†' %}
            {% if view_url %}
              {# â˜… æŠ•ç¨¿å®Œäº† â†’ è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’é’è‰²ã«å¤‰æ›´ #}
              <a href="{{ view_url }}" target="_blank"
                 class="ml-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                è¨˜äº‹è¡¨ç¤º
              </a>
            {% elif art %}
              <a href="{{ url_for('main.external_article_preview', article_id=art.id) }}" target="_blank"
                 class="ml-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                è¨˜äº‹è¡¨ç¤º
              </a>
            {% endif %}
          {% else %}
            <form action="{{ url_for('main.external_schedule_post_now', schedule_id=sched.id) }}"
                  method="post" class="inline">
              <button type="submit"
                      class="ml-1 px-2 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-xs">
                å³æ™‚æŠ•ç¨¿
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
