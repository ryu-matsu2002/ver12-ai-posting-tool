{# app/templates/external_articles.html #}
{% extends "base.html" %}
{% block title %}外部SEO | 記事一覧{% endblock %}

{% block content %}
<style>
  :root{
    --seo-bg:#3A1F5C; --pane:#44286D; --pane-2:#4D2F7D; --edge:rgba(255,255,255,.14);
    --txt:#fff; --txt-dim:#E7E1FA; --row:#54307EAA; --row-alt:#593587AA; --row-hover:#68449C;
  }

  /* 背景と文字色を外部SEOページと統一 */
  html, body, main, #main, #content, .content, .page-wrapper, .page-content{
    background:var(--seo-bg) !important; color:var(--txt) !important;
  }
  h2, h3, p, th, td, a, span{ color:var(--txt) !important; }
  a{ color:#C9B7FF !important; } a:hover{ color:#fff !important; text-decoration:underline; }

  /* テーブル */
  table{
    width:100%;
    border-collapse:separate; border-spacing:0;
    background:var(--pane); border:1px solid var(--edge);
    border-radius:12px; overflow:hidden; table-layout:fixed;
  }
  thead{ background:var(--pane-2) !important; }
  th{
    font-weight:700; padding:10px 12px; border-bottom:1px solid var(--edge);
    text-align:left; white-space:nowrap;
  }
  td{ padding:10px 12px; vertical-align:middle; }
  tbody tr{ background:var(--row); border-bottom:1px solid var(--edge); }
  tbody tr:nth-child(odd){ background:var(--row-alt); }
  tbody tr:hover{ background:var(--row-hover); }

  /* 列幅（右端の見切れ防止。操作は左寄せ・wrap可） */
  .col-key{ width:26%; }
  .col-state{ width:10%; }
  .col-date{ width:12%; }
  .col-title{ width:30%; }
  .col-actions{ width:22%; }  /* 右端に余白が残りやすいバランス */

  /* タイトル列：長文は省略表示 */
  .title-ellipsis{
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }

  /* 状態バッジ */
  .state-badge{ font-weight:600; }
  .state-posted{ background:#16A34A; color:#fff; }  /* 投稿完了 */
  .state-done{   background:#2563EB; color:#fff; }  /* 記事生成済み */
  .state-gen{    background:#D97706; color:#fff; }  /* 記事生成中 */
  .state-error{  background:#DC2626; color:#fff; }  /* エラー */

  /* ボタン（白文字で統一） */
  .btn{ display:inline-flex; align-items:center; padding:.25rem .5rem; border-radius:.375rem;
        font-size:.75rem; line-height:1; color:#fff !important; }
  .btn-amber{ background:#D97706; }   .btn-amber:hover{ background:#F59E0B; }
  .btn-rose{  background:#DC2626; }   .btn-rose:hover{  background:#EF4444; }
  .btn-blue{  background:#2563EB; }   .btn-blue:hover{  background:#3B82F6; }
  .btn-emer{  background:#059669; }   .btn-emer:hover{  background:#10B981; }
  .btn-disabled{ opacity:.5; pointer-events:none; }

  /* 操作ボタン行：折り返しOK、左寄せ（右端見切れ防止） */
  .actions{ display:flex; flex-wrap:wrap; gap:.35rem; justify-content:flex-start; }
</style>

<h2 class="text-2xl font-bold mb-6 flex items-center">
  📝 {{ site.name }} —
  <span class="ml-2 px-2 py-0.5 rounded text-white text-xs {% if acct.blog_type.value == 'livedoor' %}bg-orange-600{% elif acct.blog_type.value == 'note' %}bg-blue-600{% else %}bg-gray-600{% endif %}">
    {{ acct.blog_type.value }}
  </span>
  の記事一覧
</h2>

<p class="mb-4">
  <a href="{{ url_for('main.external_accounts', site_id=site.id) }}">← アカウント一覧に戻る</a>
</p>

<table class="w-full text-sm">
  <colgroup>
    <col class="col-key">
    <col class="col-state">
    <col class="col-date">
    <col class="col-title">
    <col class="col-actions">
  </colgroup>
  <thead>
    <tr>
      <th class="px-3 py-2">検索キーワード</th>
      <th class="px-3 py-2">現在の状態</th>
      <th class="px-3 py-2">投稿予定日</th>
      <th class="px-3 py-2">Q&amp;A記事タイトル</th>
      <th class="px-3 py-2">操作</th>
    </tr>
  </thead>
  <tbody>
    {% for sched, kw, art in rows %}
      {# 表示URL #}
      {% set view_url = sched.posted_url or (art and art.posted_url) or None %}

      {# 状態 #}
      {% set state = '記事生成中' %}
      {% if view_url %}
        {% set state = '投稿完了' %}
      {% elif sched.status == 'posted' %}
        {% set state = '投稿完了' %}
      {% elif sched.status == 'error' or (art and art.status == 'error') %}
        {% set state = 'エラー' %}
      {% elif art %}
        {% if art.status in ['done'] %}
          {% set state = '記事生成済み' %}
        {% else %}
          {% set state = '記事生成中' %}
        {% endif %}
      {% endif %}

      {% set badge_class =
         'state-posted' if state == '投稿完了' else
         'state-done'   if state == '記事生成済み' else
         'state-gen'    if state == '記事生成中' else
         'state-error' %}

      <tr>
        <td class="px-3 py-2">{{ kw.keyword }}</td>
        <td class="px-3 py-2">
          <span class="px-2 py-1 rounded text-xs state-badge {{ badge_class }}">{{ state }}</span>
        </td>
        <td class="px-3 py-2">
          {% if sched.scheduled_date %}{{ to_jst(sched.scheduled_date).strftime("%Y-%m-%d %H:%M") }}{% endif %}
        </td>
        <td class="px-3 py-2 title-ellipsis" title="{{ art.title if art else '' }}">
          {{ art.title if art else "" }}
        </td>
        <td class="px-3 py-2">
          <div class="actions">
            {# プレビュー（ボタン） #}
            {% if art %}
              <a class="btn btn-blue"
                 href="{{ url_for('main.external_article_preview', article_id=art.id) }}" target="_blank">
                プレビュー
              </a>
            {% else %}
              <span class="btn btn-blue btn-disabled">プレビュー</span>
            {% endif %}

            {# 投稿完了時の「記事表示」 #}
            {% if state == '投稿完了' %}
              {% if view_url %}
                <a class="btn btn-blue" href="{{ view_url }}" target="_blank">記事表示</a>
              {% elif art %}
                <a class="btn btn-blue" href="{{ url_for('main.external_article_preview', article_id=art.id) }}" target="_blank">記事表示</a>
              {% endif %}
            {% else %}
              <form action="{{ url_for('main.external_schedule_post_now', schedule_id=sched.id) }}" method="post">
                <button type="submit" class="btn btn-emer">即時投稿</button>
              </form>
            {% endif %}

            {# 編集/削除 #}
            <a href="{{ url_for('main.external_article_edit', article_id=art.id) if art else '#' }}"
               class="btn btn-amber {% if not art %}btn-disabled{% endif %}">
              編集
            </a>

            <form action="{{ url_for('main.external_article_delete', article_id=art.id) if art else '#' }}"
                  method="post"
                  onsubmit="return confirm('この記事を削除しますか？');">
              <button type="submit" class="btn btn-rose {% if not art %}btn-disabled{% endif %}">
                削除
              </button>
            </form>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
