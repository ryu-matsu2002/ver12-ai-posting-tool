{% extends "base.html" %}
{% block title %}投稿ログ - サイト一覧 | AI Posting Tool{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-6">記事生成 - 投稿ログ - サイト一覧</h2>

<!-- 🔍 サイト検索＋ステータスフィルター -->
<form method="get" class="mb-6 flex flex-wrap gap-4 items-center" id="search-form">
  <div class="flex items-center gap-2">
    <label for="query" class="font-medium">サイト検索:</label>
    <input type="text" id="query" name="query" placeholder="サイト名またはURL"
           value="{{ search_query or '' }}" class="p-2 border rounded w-64">
  </div>
  <div class="flex items-center gap-2">
    <label for="status" class="font-medium">表示するステータス:</label>
    <select id="status" name="plan_type" onchange="this.form.submit()" class="p-2 border rounded">
      <option value="all" {% if selected_status == 'all' %}selected{% endif %}>すべてのステータス</option>
      <option value="affiliate" {% if selected_status == 'affiliate' %}selected{% endif %}>アフィリエイト用</option>
      <option value="business" {% if selected_status == 'business' %}selected{% endif %}>事業用</option>
    </select>
  </div>
  <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded" id="search-button">検索</button>
</form>

{% if sites %}
<div class="overflow-x-auto">
  <table class="min-w-full text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 whitespace-nowrap">
    <thead>
      <tr class="bg-gray-100 dark:bg-gray-700 text-left text-black font-bold text-sm">
        <th class="px-3 py-2">サイト名</th>
        <th class="px-3 py-2">URL</th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=total&order={{ 'asc' if sort_key == 'total' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&plan_type={{ selected_status }}"
             class="flex justify-center items-center gap-1">
            総記事数
            {% if sort_key == 'total' %}
              <span class="text-lg font-bold text-blue-700">{{ '↓' if sort_order == 'desc' else '↑' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">⇅</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=done&order={{ 'asc' if sort_key == 'done' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&plan_type={{ selected_status }}"
             class="flex justify-center items-center gap-1">
            記事生成済み
            {% if sort_key == 'done' %}
              <span class="text-lg font-bold text-green-600">{{ '↓' if sort_order == 'desc' else '↑' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">⇅</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=posted&order={{ 'asc' if sort_key == 'posted' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&plan_type={{ selected_status }}"
             class="flex justify-center items-center gap-1">
            投稿完了
            {% if sort_key == 'posted' %}
              <span class="text-lg font-bold text-indigo-600">{{ '↓' if sort_order == 'desc' else '↑' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">⇅</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">詳細</th>
      </tr>
    </thead>
    <tbody>
      {% for site in sites %}
      <tr class="{% if loop.index0 % 2 == 0 %}bg-white{% else %}bg-blue-50{% endif %} border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-900">
        <td class="px-3 py-2 font-medium text-blue-700 dark:text-blue-300">
          [{{ site.name }}]
        </td>
        <td class="px-3 py-2 break-all text-blue-700 underline">
          <a href="{{ site.url }}" target="_blank">{{ site.url }}</a>
          {% if site.gsc_connected %}
            <span class="ml-2 inline-block bg-green-600 text-white text-xs font-semibold px-2 py-0.5 rounded">
              GSC接続済み ✅
            </span>
          {% endif %}
        </td>
        <td class="px-3 py-2 text-center text-black">{{ site.total or 0 }}</td>
        <td class="px-3 py-2 text-center text-green-600 font-bold">{{ site.done or 0 }}</td>
        <td class="px-3 py-2 text-center text-blue-600 font-bold">{{ site.posted or 0 }}</td>
        <td class="px-3 py-2 text-center space-x-1">
          {% if site.gsc_connected %}
            <a href="{{ url_for('main.gsc_generate', username=current_user.username) }}?site_id={{ site.id }}"
               class="inline-block py-1 px-3 bg-lime-600 hover:bg-lime-700 text-white rounded text-sm">
              GSC生成
            </a>
          {% endif %}
          <a href="{{ url_for('main.generate', username=current_user.username) }}?site_id={{ site.id }}"
             class="inline-block py-1 px-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">
            記事生成
          </a>
          <a href="{{ url_for('main.log', username=current_user.username, site_id=site.id) }}"
             class="inline-block py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">
            記事一覧
          </a>
          <a href="{{ site.url.rstrip('/') }}/admin"
             target="_blank"
             class="inline-block py-1 px-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">
            WP管理
          </a>
          <a href="{{ url_for('main.edit_site', username=current_user.username, sid=site.id) }}"
             class="inline-block py-1 px-3 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
            修正
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
  <div class="text-gray-500 text-center py-12">
    サイトがまだ登録されていません。
  </div>
{% endif %}

<!-- ✅ 検索送信時インジケーター -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("search-form");
  const button = document.getElementById("search-button");
  form.addEventListener("submit", function () {
    button.disabled = true;
    button.textContent = "検索中... ⏳";
  });
});
</script>

{% endblock %}
