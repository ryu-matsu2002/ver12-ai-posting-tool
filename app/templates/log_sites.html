{% extends "base.html" %}
{% block title %}æŠ•ç¨¿ãƒ­ã‚° - ã‚µã‚¤ãƒˆä¸€è¦§ | AI Posting Tool{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-6">è¨˜äº‹ç”Ÿæˆ - æŠ•ç¨¿ãƒ­ã‚° - ã‚µã‚¤ãƒˆä¸€è¦§</h2>

<!-- âœ… ã‚µã‚¤ãƒˆæ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="get" class="mb-4 flex items-center gap-2">
  <label for="query" class="font-medium">ã‚µã‚¤ãƒˆæ¤œç´¢:</label>
  <input type="text" id="query" name="query" value="{{ search_query or '' }}"
         placeholder="ã‚µã‚¤ãƒˆåã¾ãŸã¯URL"
         class="p-2 border rounded w-64">
  <button type="submit" class="px-3 py-2 bg-blue-500 text-white rounded">æ¤œç´¢</button>
</form>

<!-- âœ… ã‚¸ãƒ£ãƒ³ãƒ«çµã‚Šè¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="get" class="mb-6 flex items-center gap-2">
  <label for="genre_id" class="font-medium">ã‚¸ãƒ£ãƒ³ãƒ«ã§çµã‚Šè¾¼ã¿:</label>
  <select id="genre_id" name="genre_id" class="p-2 border rounded">
    {% for gid, gname in genre_choices %}
      <option value="{{ gid }}" {% if selected_genre_id == gid %}selected{% endif %}>{{ gname }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="px-3 py-2 bg-blue-500 text-white rounded">çµã‚Šè¾¼ã‚€</button>
</form>

<!-- âœ… ä¸¦ã³é †ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ -->
<form method="get" class="mb-6 flex items-center gap-2" id="sort-form">
  <label for="sort-select" class="font-medium">ä¸¦ã³é †:</label>
  <select id="sort-select" class="p-2 border rounded">
    <option value="created-asc" {% if sort_key == 'created' and sort_order == 'asc' %}selected{% endif %}>ç™»éŒ²ãŒå¤ã„é †</option>
    <option value="created-desc" {% if sort_key == 'created' and sort_order == 'desc' %}selected{% endif %}>ç™»éŒ²ãŒæ–°ã—ã„é †</option>
  </select>

  <!-- ğŸ” å®Ÿéš›ã«é€ä¿¡ã™ã‚‹å€¤ã¯ hidden input ã«è¨­å®š -->
  <input type="hidden" name="sort" value="created">
  <input type="hidden" name="order" id="order-input" value="{{ sort_order }}">
  <input type="hidden" name="query" value="{{ search_query }}">
  <input type="hidden" name="genre_id" value="{{ selected_genre_id }}">
  <button type="submit" class="px-3 py-2 bg-blue-500 text-white rounded">ä¸¦ã³æ›¿ãˆ</button>
</form>

<script>
  const select = document.getElementById('sort-select');
  const orderInput = document.getElementById('order-input');

  select.addEventListener('change', function () {
    const selectedValue = select.value;  // "created-asc" or "created-desc"
    const parts = selectedValue.split('-');
    orderInput.value = parts[1];  // "asc" or "desc"
  });
</script>



{% if sites %}
<div class="overflow-x-auto">
  <table class="min-w-full text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 whitespace-nowrap">
    <thead>
      <tr class="bg-gray-100 dark:bg-gray-700 text-left text-black font-bold text-sm">
        <th class="px-3 py-2">ã‚µã‚¤ãƒˆå</th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=posted&order={{ 'asc' if sort_key == 'posted' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&genre_id={{ selected_genre_id }}"
             class="flex justify-center items-center gap-1">
            æŠ•ç¨¿å®Œäº†
            {% if sort_key == 'posted' %}
              <span class="text-lg font-bold text-indigo-600">{{ 'â†“' if sort_order == 'desc' else 'â†‘' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">â‡…</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=done&order={{ 'asc' if sort_key == 'done' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&genre_id={{ selected_genre_id }}"
             class="flex justify-center items-center gap-1">
            è¨˜äº‹ç”Ÿæˆæ¸ˆã¿
            {% if sort_key == 'done' %}
              <span class="text-lg font-bold text-green-600">{{ 'â†“' if sort_order == 'desc' else 'â†‘' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">â‡…</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=total&order={{ 'asc' if sort_key == 'total' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&genre_id={{ selected_genre_id }}"
             class="flex justify-center items-center gap-1">
            ç·è¨˜äº‹æ•°
            {% if sort_key == 'total' %}
              <span class="text-lg font-bold text-blue-700">{{ 'â†“' if sort_order == 'desc' else 'â†‘' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">â‡…</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=clicks&order={{ 'asc' if sort_key == 'clicks' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&genre_id={{ selected_genre_id }}"
             class="flex justify-center items-center gap-1">
            ã‚¯ãƒªãƒƒã‚¯æ•°
            {% if sort_key == 'clicks' %}
              <span class="text-lg font-bold text-rose-600">{{ 'â†“' if sort_order == 'desc' else 'â†‘' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">â‡…</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">
          <a href="?sort=impressions&order={{ 'asc' if sort_key == 'impressions' and sort_order == 'desc' else 'desc' }}&query={{ search_query }}&genre_id={{ selected_genre_id }}"
             class="flex justify-center items-center gap-1">
            è¡¨ç¤ºå›æ•°
            {% if sort_key == 'impressions' %}
              <span class="text-lg font-bold text-purple-600">{{ 'â†“' if sort_order == 'desc' else 'â†‘' }}</span>
            {% else %}
              <span class="text-gray-400 text-sm">â‡…</span>
            {% endif %}
          </a>
        </th>
        <th class="px-3 py-2 text-center">è©³ç´°</th>
      </tr>
    </thead>
    <tbody>
      {% for site in sites %}
      <tr class="{% if loop.index0 % 2 == 0 %}bg-white{% else %}bg-blue-50{% endif %} border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-900">
        <td class="px-3 py-2 font-medium text-blue-700 dark:text-blue-300">
          <div class="flex items-center gap-2">
            {% if site.gsc_connected %}
              <span class="inline-block bg-green-600 text-white text-xs font-semibold px-2 py-0.5 rounded">GSC</span>
            {% endif %}
            <a href="{{ site.url }}" target="_blank" class="underline">{{ site.name }}</a>
          </div>
        </td>
        <td class="px-3 py-2 text-center text-indigo-600 font-bold">{{ site.posted or 0 }}</td>
        <td class="px-3 py-2 text-center text-green-600 font-bold">{{ site.done or 0 }}</td>
        <td class="px-3 py-2 text-center text-black">{{ site.total or 0 }}</td>
        <td class="px-3 py-2 text-center text-rose-600 font-bold">{{ site.clicks or 0 }}</td>
        <td class="px-3 py-2 text-center text-purple-600 font-bold">{{ site.impressions or 0 }}</td>
        <td class="px-3 py-2 text-center space-x-1">
          {% if site.gsc_connected %}
          <a href="{{ url_for('main.gsc_generate') }}?site_id={{ site.id }}"
             class="inline-block py-1 px-3 bg-lime-600 hover:bg-lime-700 text-white rounded text-sm">GSCç”Ÿæˆ</a>
          {% endif %}
          <a href="{{ url_for('main.generate', username=current_user.username) }}?site_id={{ site.id }}"
             class="inline-block py-1 px-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">è¨˜äº‹ç”Ÿæˆ</a>
          <a href="{{ url_for('main.log', username=current_user.username, site_id=site.id) }}"
             class="inline-block py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">è¨˜äº‹ä¸€è¦§</a>
          <a href="{{ site.url.rstrip('/') }}/admin" target="_blank"
             class="inline-block py-1 px-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">WPç®¡ç†</a>
          <a href="{{ url_for('main.edit_site', username=current_user.username, sid=site.id) }}"
             class="inline-block py-1 px-3 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">ä¿®æ­£</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
  <div class="text-gray-500 text-center py-12">ã‚µã‚¤ãƒˆãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
{% endif %}
{% endblock %}
