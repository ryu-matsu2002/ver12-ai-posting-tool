{% extends "base.html" %}
{% block title %}サイト登録 | TCC autowize{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-8">WordPress サイト管理</h2>

<div class="grid md:grid-cols-2 gap-10">

  <!-- ─────── 左：新規サイト登録フォーム ─────── -->
  <div>
    <h3 class="text-2xl font-semibold mb-6">新規サイト登録</h3>

    {% if remaining_quota > 0 %}
      <div class="mb-4 text-green-700 font-semibold">
        ✅ あと {{ remaining_quota }} サイト登録可能です。
      </div>
    {% else %}
      <div class="mb-4 bg-yellow-100 text-yellow-800 p-3 rounded shadow">
        ⚠️ サイト登録上限に達しています。
        <a href="#purchase" class="underline text-blue-600">プランを購入</a>して登録枠を追加してください。
      </div>
    {% endif %}

    <form method="post" class="space-y-5 p-6 bg-white dark:bg-gray-800 rounded shadow-lg">
      {{ form.hidden_tag() }}

      <div>
        {{ form.name.label(class="block mb-1 text-lg font-medium") }}
        {{ form.name(class="w-full p-3 text-base rounded border dark:bg-gray-700 dark:border-gray-600", disabled=(remaining_quota <= 0)) }}
      </div>

      <div>
        {{ form.url.label(class="block mb-1 text-lg font-medium") }}
        {{ form.url(class="w-full p-3 text-base rounded border dark:bg-gray-700 dark:border-gray-600", disabled=(remaining_quota <= 0)) }}
        <small class="text-gray-500 dark:text-gray-400">例: https://example.com</small>
      </div>

      <div>
        {{ form.username.label(class="block mb-1 text-lg font-medium") }}
        {{ form.username(class="w-full p-3 text-base rounded border dark:bg-gray-700 dark:border-gray-600", disabled=(remaining_quota <= 0)) }}
      </div>

      <div>
        {{ form.app_pass.label(class="block mb-1 text-lg font-medium") }}
        {{ form.app_pass(class="w-full p-3 text-base rounded border dark:bg-gray-700 dark:border-gray-600", disabled=(remaining_quota <= 0)) }}
        <small class="text-gray-500 dark:text-gray-400">WP の「アプリケーションパスワード」を入力</small>
      </div>

      {% if remaining_quota > 0 %}
        {{ form.submit(class="py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white text-lg rounded shadow") }}
      {% else %}
        <button class="py-3 px-6 bg-gray-400 text-white text-lg rounded cursor-not-allowed" disabled>登録不可</button>
      {% endif %}
    </form>
  </div>

  <!-- ─────── 右：プラン・支払いフォーム ─────── -->
  <div id="purchase">
    <h3 class="text-2xl font-semibold mb-6">登録枠の追加購入</h3>

    <!-- プランステータス -->
    <div class="mb-6 p-4 bg-gray-100 dark:bg-gray-700 rounded shadow text-sm">
      <p>🧾 現在のプラン: <strong>{{ plan_type|capitalize }}</strong></p>
      <p>✅ 使用済み: <strong>{{ used_quota }}</strong> / 上限: <strong>{{ total_quota }}</strong></p>
    </div>

    <!-- プラン選択 -->
    <div class="p-4 bg-blue-50 border border-blue-300 rounded shadow mb-4 text-sm">
      💡 プラン選択:<br>
      ・アフィリエイト用（¥3,000）<br>
      ・事業用（月額 ¥20,000）
    </div>

    <form action="{{ url_for('main.purchase') }}" method="post" id="payment-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-semibold text-sm">プラン種別</label>
        <select name="plan_type" class="p-2 w-full border rounded">
          <option value="affiliate">アフィリエイト用（¥3,000）</option>
          <option value="business">事業用（月額 ¥20,000）</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold text-sm">サイト数</label>
        <select name="site_count" class="p-2 w-full border rounded">
          {% for i in range(1, 6) %}
          <option value="{{ i }}">{{ i }} サイト</option>
          {% endfor %}
        </select>
      </div>

      <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded text-base font-bold shadow">
        プランを購入する
      </button>
    </form>

    <!-- Stripe 埋め込み用（checkout.session.url にリダイレクトせず iframe的に統合したい場合はStripe Elements等の対応が必要） -->
    <!-- Stripe Elementsでの完全埋め込みを希望の場合、JSによるStripe.js統合が別途必要 -->
  </div>

</div>
{% endblock %}
