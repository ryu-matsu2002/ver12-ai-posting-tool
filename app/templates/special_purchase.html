{% extends "base.html" %}
{% block title %}特別プラン購入 | TCC autowize{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-10">
  <h2 class="text-3xl font-bold mb-6">🎯 特別ユーザー限定プラン</h2>

  {% if request.args.get("success") %}
    <div class="mb-6 p-4 bg-green-100 text-green-800 rounded">
      ✅ 支払いが完了しました！マイページに戻ってサイトを登録してください。
    </div>
    <a href="{{ url_for('main.dashboard', username=current_user.username) }}"
       class="inline-block mb-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      🏠 マイページに戻る
    </a>
  {% elif request.args.get("canceled") %}
    <div class="mb-6 p-4 bg-red-100 text-red-800 rounded">
      ❌ 支払いがキャンセルされました。もう一度お試しください。
    </div>
    <a href="{{ url_for('main.special_purchase', username=current_user.username) }}"
       class="inline-block mb-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
      🔁 支払いページに戻る
    </a>
  {% endif %}

  <!-- ✅ 決済カード入力ボックス -->
  <div class="bg-white shadow p-6 rounded-xl border border-gray-200">
    <h3 class="text-xl font-semibold mb-4">アフィリエイト用サイト登録（特別価格）</h3>
    <p class="mb-4 text-gray-700">
      このページは特別な許可を受けたユーザーのみがアクセス可能です。1,000円でサイトを1件登録できます。
    </p>

    <form id="payment-form">
      <div id="card-element" class="mb-4 p-4 border rounded bg-gray-50 shadow-sm"></div>
      <button id="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        💳 1,000円でサイト登録枠を購入する
      </button>
      <div id="payment-message" class="mt-4 text-center text-green-700 font-semibold hidden">
        ✅ 支払いが完了しました！
      </div>
    </form>
  </div>
</div>

<!-- ✅ Stripe JS & 決済処理 -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_public_key }}");
  const elements = stripe.elements();
  const cardElement = elements.create("card");
  cardElement.mount("#card-element");

  const form = document.getElementById("payment-form");
  const messageEl = document.getElementById("payment-message");

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const { error, paymentIntent } = await stripe.confirmCardPayment("{{ client_secret }}", {
      payment_method: {
        card: cardElement,
      }
    });

    if (error) {
      alert("❌ 支払いに失敗しました: " + error.message);
    } else {
      messageEl.classList.remove("hidden");
      setTimeout(() => {
        window.location.href = "{{ url_for('main.special_purchase', username=username) }}?success=true";
      }, 2000);
    }
  });
</script>
{% endblock %}
