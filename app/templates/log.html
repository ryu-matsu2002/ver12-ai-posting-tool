{% extends "base.html" %}
{% block title %}è¨˜äº‹ä¸€è¦§ | AI Posting Tool{% endblock %}

{% block content %}
<!-- ğŸ”™ ã‚µã‚¤ãƒˆä¸€è¦§ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯ï¼ˆä¸Šéƒ¨ï¼‰ -->
<div class="mb-4">
  <a href="{{ url_for('main.log_sites', username=current_user.username) }}" class="text-lg text-blue-700 hover:underline font-semibold">
    â† ã‚µã‚¤ãƒˆä¸€è¦§ã«æˆ»ã‚‹
  </a>
</div>

<h2 class="text-2xl font-semibold mb-4">è¨˜äº‹ä¸€è¦§</h2>

<!-- âœ… ç¾åœ¨ã®æŠ•ç¨¿å…ˆã‚µã‚¤ãƒˆ -->
<div class="mb-4 text-base font-semibold">
  ç¾åœ¨ã®æŠ•ç¨¿å…ˆã‚µã‚¤ãƒˆï¼š
  {% if site %}
    <a href="{{ site.url }}" target="_blank" class="text-blue-700 font-bold hover:underline inline-flex items-center gap-1">
      {{ site.name }}
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7v7m0-7L10 14m-4 0h4v4" />
      </svg>
    </a>
  {% else %}
    <span class="text-gray-500">æœªé¸æŠ</span>
  {% endif %}
</div>

<!-- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ -->
<form method="get" class="mb-6 flex items-center flex-wrap gap-3">
  <label for="statusFilter" class="font-medium shrink-0">è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
  <select
    id="statusFilter"
    name="status"
    onchange="this.form.submit()"
    class="p-2 rounded border dark:bg-gray-700 dark:border-gray-600 min-w-[200px]"
  >
    <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
    <option value="posted" {% if status == "posted" %}selected{% endif %}>âœ… æŠ•ç¨¿å®Œäº†</option>
    <option value="done" {% if status == "done" %}selected{% endif %}>ğŸ“ è¨˜äº‹ç”Ÿæˆæ¸ˆã¿</option>
    <option value="pending" {% if status == "pending" %}selected{% endif %}>â³ è¨˜äº‹ç”Ÿæˆä¸­</option>
    <option value="error" {% if status == "error" %}selected{% endif %}>âŒ ã‚¨ãƒ©ãƒ¼</option>
  </select>
</form>

<!-- âœ… ä¸€æ‹¬æ“ä½œãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="post" action="{{ url_for('main.bulk_delete_articles', username=current_user.username) }}">
  <div class="mb-4 flex items-center gap-2">
    <select name="action" class="p-2 rounded border">
      <option value="">ä¸€æ‹¬æ“ä½œ</option>
      <option value="delete">å‰Šé™¤</option>
    </select>
    <button type="submit"
            onclick="return confirm('é¸æŠã•ã‚ŒãŸè¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');"
            class="py-1 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded">
      é©ç”¨
    </button>
  </div>

  <!-- âœ… è¡¨ -->
  <table class="w-full bg-white dark:bg-gray-800 text-sm table-fixed">
    <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-semibold">
      <tr class="whitespace-nowrap">
        <th class="px-2 py-2 text-left w-[40px]"><input type="checkbox" onclick="toggleAll(this)"></th>
        <th class="px-2 py-2 text-left w-[15%]">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
        <th class="px-2 py-2 text-left w-[12%]">ã‚µã‚¤ãƒˆå</th>
        <th class="px-2 py-2 text-left w-[10%]">ç¾åœ¨ã®çŠ¶æ…‹</th>
        <th class="px-2 py-2 text-left w-[6%]">é€²è¡ŒçŠ¶æ³</th>
        <th class="px-2 py-2 text-left w-[10%]">æŠ•ç¨¿äºˆå®šæ—¥</th>
        <th class="px-2 py-2 text-left w-[20%]">Qï¼†Aè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th class="px-2 py-2 text-left w-[7%]">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
        <th class="px-2 py-2 text-left w-[10%]">ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒ</th>
        <th class="px-2 py-2 text-left w-[15%]">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for a in articles %}
      <tr class="{% if loop.index0 % 2 == 0 %}bg-white{% else %}bg-blue-50{% endif %}">
        <td class="px-2 py-2"><input type="checkbox" name="selected_ids" value="{{ a.id }}"></td>
        <td class="px-2 py-2">{{ a.keyword }}</td>
        <td class="px-2 py-2">{% if a.site %}{{ a.site.name }}{% else %}â€”{% endif %}</td>
        <td class="px-2 py-2">
          {% if a.status == "posted" %}<span class="text-green-600 font-bold">æŠ•ç¨¿å®Œäº†</span>
          {% elif a.status == "done" %}<span class="text-red-600 font-bold">è¨˜äº‹ç”Ÿæˆæ¸ˆã¿</span>
          {% elif a.status == "pending" %}<span class="text-black font-bold">è¨˜äº‹ç”Ÿæˆä¸­</span>
          {% elif a.status == "error" %}<span class="text-red-600 font-bold">ã‚¨ãƒ©ãƒ¼</span>
          {% else %}{{ a.status }}{% endif %}
        </td>
        <td class="px-2 py-2">{{ a.progress }}%</td>
        <td class="px-2 py-2 whitespace-nowrap">
          {% if a.scheduled_at %}
            {{ a.scheduled_at.astimezone(jst).strftime("%Y-%m-%d %H:%M") }}
          {% else %}â€”{% endif %}
        </td>
        <td class="px-2 py-2 break-words text-sm leading-snug" title="{{ a.title }}">{{ a.title }}</td>
        <td class="px-2 py-2">
          {% if a.status in ["done", "posted"] %}
            <a href="{{ url_for('main.preview', username=current_user.username, article_id=a.id) }}"
               class="text-blue-600 hover:underline text-sm">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
          {% else %}â€”{% endif %}
        </td>
        <td class="px-2 py-2 text-center">
          {% if a.image_url %}
            <img src="{{ a.image_url }}" class="h-12 w-16 object-cover rounded mx-auto">
          {% else %}â€”{% endif %}
        </td>
        <td class="px-2 py-2 space-x-2">
          {% if a.status == "error" %}
            <form action="{{ url_for('main.retry_article', username=current_user.username, id=a.id) }}" method="post" class="inline">
              <button type="submit" class="py-1 px-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs">å†ç”Ÿæˆ</button>
            </form>
          {% endif %}
          <a href="{{ url_for('main.edit_article', username=current_user.username, id=a.id) }}"
             class="text-green-600 hover:underline text-sm">ç·¨é›†</a>
          <form action="{{ url_for('main.delete_article', username=current_user.username, id=a.id) }}" method="post"
                class="inline" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
            <button type="submit" class="text-red-600 hover:underline text-sm">å‰Šé™¤</button>
          </form>
          {% if a.status == "done" and a.site_id %}
            <form action="{{ url_for('main.post_article', username=current_user.username, id=a.id) }}" method="post" class="inline">
              <button type="submit" class="py-1 px-3 bg-green-600 hover:bg-green-700 text-white rounded text-xs">
                å³æ™‚æŠ•ç¨¿
              </button>
            </form>
          {% endif %}
          {% if a.status == "posted" and a.posted_url %}
            <a href="{{ a.posted_url }}" target="_blank"
               class="py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs"
               title="å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º">è¨˜äº‹è¡¨ç¤º</a>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="10" class="px-4 py-6 text-center text-gray-500">
          è©²å½“ã™ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<script>
function toggleAll(master) {
  const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
  checkboxes.forEach(cb => cb.checked = master.checked);
}
</script>
{% endblock %}
