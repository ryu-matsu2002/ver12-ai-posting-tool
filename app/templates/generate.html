{% extends "base.html" %}
{% block title %}記事生成{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-10">
  <!-- 左：フォーム -->
  <div class="w-full lg:w-2/3">
    <h2 class="text-2xl font-semibold mb-6">記事生成</h2>

    <form method="post" id="genForm" class="space-y-6" onsubmit="return validateKeywordCount()">
      {{ form.hidden_tag() }}

      <!-- サイト選択 -->
      <div>
        {{ form.site_select.label(class="block mb-1 font-medium") }}
        {{ form.site_select(class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600", onchange="onSiteChange()") }}
      </div>

      <!-- プロンプト選択 -->
      <div>
        {{ form.genre_select.label(class="block mb-1 font-medium") }}
        {{ form.genre_select(id="selectPrompt", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
      </div>

      <!-- トグルボタン -->
      <div>
        <button type="button" onclick="togglePromptFields()" class="text-blue-600 border border-blue-600 rounded px-3 py-1 text-sm hover:bg-blue-50 transition" id="toggleBtn">
          <span id="toggleIcon">＋</span> <span id="toggleText">詳細プロンプトを表示</span>
        </button>
      </div>

      <!-- 詳細プロンプト欄 -->
      <div id="promptFields" class="space-y-4 mt-2 transition-all duration-300 overflow-hidden max-h-0">
        <div>
          {{ form.title_prompt.label(class="block mb-1 font-medium") }}
          {{ form.title_prompt(rows=3, id="titlePT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
        <div>
          {{ form.body_prompt.label(class="block mb-1 font-medium") }}
          {{ form.body_prompt(rows=5, id="bodyPT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
      </div>

      <!-- 選択キーワード -->
      <div>
        <label class="block mb-1 font-medium">選択中のキーワード（最大40件）</label>
        <div id="selectedList" class="flex flex-wrap gap-2 mb-2"></div>
      </div>

      <!-- POST対象欄（非表示） -->
      <div>
        {{ form.keywords.label(class="block mb-1 font-medium") }}
        {{ form.keywords(rows=8, id="keywordsField", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        <small class="text-gray-500 dark:text-gray-400">1 行 1 キーワード（最大 40 行）</small>
      </div>

      {{ form.submit(class="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded") }}
    </form>
  </div>

  <!-- 右：キーワード一覧 -->
  <div class="w-full lg:w-1/3">
    <h3 class="text-xl font-bold mb-4">登録キーワード</h3>
    <div id="keywordList" class="flex flex-wrap gap-2 max-h-[600px] overflow-y-auto p-3 border rounded bg-gray-50 dark:bg-gray-800"></div>

    <div class="flex flex-wrap gap-2 mt-4">
      <button type="button" onclick="selectAllKeywords()" class="bg-gray-500 hover:bg-gray-600 text-white text-sm px-3 py-1 rounded">全て選択（最大40件）</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  let selectedKeywords = [];
  let isOpen = false;

  function togglePromptFields() {
    const field = document.getElementById('promptFields');
    const icon = document.getElementById('toggleIcon');
    const text = document.getElementById('toggleText');
    isOpen = !isOpen;
    field.classList.toggle("max-h-0", !isOpen);
    field.classList.toggle("max-h-[1000px]", isOpen);
    icon.textContent = isOpen ? "－" : "＋";
    text.textContent = isOpen ? "詳細プロンプトを非表示" : "詳細プロンプトを表示";
  }

  async function onSiteChange() {
    const siteId = parseInt(document.querySelector('[name="site_select"]').value);
    if (!siteId) return;

    const list = document.getElementById("keywordList");
    list.innerHTML = "";
    selectedKeywords = [];
    updateSelectedList();

    try {
      const res = await fetch(`/api/keywords/all/${siteId}`);
      const data = await res.json();
      data.forEach(k => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "keyword-btn px-3 py-1 rounded border text-sm hover:bg-blue-100 dark:border-gray-600 dark:text-white";
        btn.textContent = k.keyword;
        btn.dataset.keyword = k.keyword;
        btn.onclick = () => toggleKeyword(btn);
        list.appendChild(btn);
      });
    } catch (err) {
      console.error("キーワード取得失敗", err);
    }
  }

  function toggleKeyword(button) {
    const kw = button.dataset.keyword;
    const i = selectedKeywords.indexOf(kw);
    if (i !== -1) {
      selectedKeywords.splice(i, 1);
      button.classList.remove('bg-blue-600', 'text-white');
    } else {
      if (selectedKeywords.length >= 40) {
        alert("最大40キーワードまで選択可能です");
        return;
      }
      selectedKeywords.push(kw);
      button.classList.add('bg-blue-600', 'text-white');
    }
    updateSelectedList();
  }

  function selectAllKeywords() {
    const buttons = document.querySelectorAll(".keyword-btn");
    for (const btn of buttons) {
      const kw = btn.dataset.keyword;
      if (!selectedKeywords.includes(kw)) {
        if (selectedKeywords.length >= 40) break;
        selectedKeywords.push(kw);
        btn.classList.add('bg-blue-600', 'text-white');
      }
    }
    updateSelectedList();
  }

  function updateSelectedList() {
    const display = document.getElementById("selectedList");
    const textarea = document.getElementById("keywordsField");
    display.innerHTML = "";
    selectedKeywords.forEach(kw => {
      const tag = document.createElement("span");
      tag.textContent = kw;
      tag.className = "bg-gray-300 text-sm px-2 py-1 rounded";
      display.appendChild(tag);
    });
    textarea.value = selectedKeywords.join("\n");
  }

  function validateKeywordCount() {
    const lines = document.getElementById("keywordsField").value.trim().split(/\r?\n/).filter(l => l);
    if (lines.length > 40) {
      alert("キーワードは最大40件までです。現在: " + lines.length);
      return false;
    }
    return true;
  }

  async function onPromptChange() {
    const pid = document.getElementById('selectPrompt').value;
    if (!pid || pid === "0") return;
    try {
      const res = await fetch(`/api/prompt/${pid}`);
      const j = await res.json();
      document.getElementById('titlePT').value = j.title_pt;
      document.getElementById('bodyPT').value = j.body_pt;
    } catch (err) {
      console.error('プロンプト取得エラー', err);
    }
  }

  document.getElementById('selectPrompt').addEventListener('change', onPromptChange);
</script>
{% endblock %}
