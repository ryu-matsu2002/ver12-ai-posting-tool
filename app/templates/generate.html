{% extends "base.html" %}
{% block title %}記事生成{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-10">
  <!-- 左：フォーム -->
  <div class="w-full lg:w-2/3">
    <h2 class="text-2xl font-semibold mb-6">記事生成</h2>

    <form method="post" id="genForm" class="space-y-6" onsubmit="return validateKeywordCount()">
      {{ form.hidden_tag() }}

      <!-- サイト選択 -->
      <div>
        {{ form.site_select.label(class="block mb-1 font-medium") }}
        {{ form.site_select(class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
      </div>

      <!-- 保存済みプロンプト選択 -->
      <div>
        {{ form.genre_select.label(class="block mb-1 font-medium") }}
        {{ form.genre_select(id="selectPrompt", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
      </div>

      <!-- トグルボタン（ボタン風デザイン） -->
      <div>
        <button type="button" onclick="togglePromptFields()"
          class="text-blue-600 border border-blue-600 rounded px-3 py-1 text-sm hover:bg-blue-50 transition"
          id="toggleBtn">
          <span id="toggleIcon">＋</span> <span id="toggleText">詳細プロンプトを表示</span>
        </button>
      </div>

      <!-- プロンプト欄 -->
      <div id="promptFields" class="space-y-4 mt-2 transition-all duration-300 overflow-hidden max-h-0">
        <div>
          {{ form.title_prompt.label(class="block mb-1 font-medium") }}
          {{ form.title_prompt(rows=3, id="titlePT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
        <div>
          {{ form.body_prompt.label(class="block mb-1 font-medium") }}
          {{ form.body_prompt(rows=5, id="bodyPT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
      </div>

      <!-- キーワード -->
      <div>
        {{ form.keywords.label(class="block mb-1 font-medium") }}
        {{ form.keywords(rows=8, id="keywordsField", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        <small class="text-gray-500 dark:text-gray-400">1 行 1 キーワード（最大 40 行）</small>
      </div>

      <!-- 生成開始ボタン -->
      {{ form.submit(class="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded") }}
    </form>
  </div>

  <!-- 右：登録済みキーワード選択 -->
  <div class="w-full lg:w-1/3">
    <h3 class="text-xl font-bold mb-4">登録済みキーワード</h3>
    <form id="keywordSelector" class="space-y-2 max-h-[600px] overflow-y-auto border p-4 rounded bg-gray-50">
      {% for kw in keyword_choices %}
        <div class="flex items-center gap-2">
          <input type="checkbox" id="kw_{{ kw.id }}" value="{{ kw.keyword }}" class="keyword-checkbox">
          <label for="kw_{{ kw.id }}" class="text-sm text-gray-800">{{ kw.keyword }}</label>
        </div>
      {% else %}
        <p class="text-gray-500">登録されたキーワードがありません。</p>
      {% endfor %}
      <button type="button" onclick="applySelectedKeywords()"
        class="mt-4 bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-1 rounded">
        選択したキーワードを反映する
      </button>
    </form>
  </div>
</div>

<!-- JS: プロンプト選択反映 -->
<script>
  async function onPromptChange() {
    const pid = document.getElementById('selectPrompt').value;
    if (!pid || pid === "0") return;
    try {
      const res = await fetch(`/api/prompt/${pid}`);
      if (!res.ok) throw new Error(res.statusText);
      const j = await res.json();
      document.getElementById('titlePT').value = j.title_pt;
      document.getElementById('bodyPT').value  = j.body_pt;
    } catch (err) {
      console.error('プロンプト取得エラー', err);
    }
  }
  document.getElementById('selectPrompt').addEventListener('change', onPromptChange);
</script>

<!-- JS: 詳細プロンプトトグル -->
<script>
  let isOpen = false;
  function togglePromptFields() {
    const field = document.getElementById('promptFields');
    const icon = document.getElementById('toggleIcon');
    const text = document.getElementById('toggleText');
    isOpen = !isOpen;
    field.classList.toggle("max-h-0", !isOpen);
    field.classList.toggle("max-h-[1000px]", isOpen);
    icon.textContent = isOpen ? "－" : "＋";
    text.textContent = isOpen ? "詳細プロンプトを非表示" : "詳細プロンプトを表示";
  }
</script>

<!-- JS: キーワード選択反映 -->
<script>
  function applySelectedKeywords() {
    const checkboxes = document.querySelectorAll(".keyword-checkbox:checked");
    const selected = Array.from(checkboxes).map(cb => cb.value);
    if (selected.length > 40) {
      alert("最大40キーワードまで選択可能です。現在: " + selected.length + "件");
      return;
    }
    document.getElementById("keywordsField").value = selected.join("\n");
  }

  function validateKeywordCount() {
    const value = document.getElementById("keywordsField").value;
    const lines = value.split(/\r?\n/).filter(line => line.trim() !== "");
    if (lines.length > 40) {
      alert("キーワードは最大40件までです。現在: " + lines.length + "件");
      return false;
    }
    return true;
  }
</script>
{% endblock %}
