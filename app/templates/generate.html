{% extends "base.html" %}
{% block title %}記事生成{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-10">

  <!-- 左：フォーム -->
  <div class="w-full lg:w-2/3">
    <h2 class="text-2xl font-semibold mb-6">記事生成</h2>

    <form method="post" id="genForm" class="space-y-6" onsubmit="return validateKeywordCount()">
      {{ form.hidden_tag() }}

      <!-- サイト選択 -->
      <div>
        {{ form.site_select.label(class="block mb-1 font-medium") }}
        {{ form.site_select(class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600", onchange="onSiteChange()") }}
      </div>

      <!-- プロンプト選択 -->
      <div>
        {{ form.genre_select.label(class="block mb-1 font-medium") }}
        {{ form.genre_select(id="selectPrompt", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
      </div>

      <!-- トグル -->
      <div>
        <button type="button" onclick="togglePromptFields()" class="text-blue-600 border border-blue-600 rounded px-3 py-1 text-sm hover:bg-blue-50" id="toggleBtn">
          <span id="toggleIcon">＋</span> <span id="toggleText">詳細プロンプトを表示</span>
        </button>
      </div>

      <!-- 詳細プロンプト -->
      <div id="promptFields" class="space-y-4 mt-2 transition-all duration-300 overflow-hidden max-h-0">
        <div>
          {{ form.title_prompt.label(class="block mb-1 font-medium") }}
          {{ form.title_prompt(rows=3, id="titlePT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
        <div>
          {{ form.body_prompt.label(class="block mb-1 font-medium") }}
          {{ form.body_prompt(rows=5, id="bodyPT", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        </div>
      </div>

      <!-- 選択キーワードPOST欄 -->
      <div>
        {{ form.keywords.label(class="block mb-1 font-medium") }}
        {{ form.keywords(rows=8, id="keywordsField", class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600") }}
        <small class="text-gray-500 dark:text-gray-400">1 行 1 キーワード（最大 40 行）</small>
      </div>

      {{ form.submit(class="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded") }}
    </form>
  </div>

  <!-- 右：キーワード一覧 -->
  <div class="w-full lg:w-1/3">
    <h3 class="text-xl font-bold mb-4">登録キーワード</h3>

    <!-- ステータス絞り込み + 全選択 -->
    <div class="flex justify-between items-center mb-2">
      <label class="text-sm">表示ステータス:
        <select id="statusFilter" class="p-1 border rounded text-sm" onchange="filterByStatus()">
          <option value="">すべて</option>
          <option value="used">生成済み</option>
          <option value="unused">未生成</option>
        </select>
      </label>
      <button type="button" onclick="selectAllKeywords()" class="bg-gray-500 hover:bg-gray-600 text-white text-sm px-3 py-1 rounded">全て選択</button>
    </div>

    <!-- キーワードテーブル -->
    <div class="border rounded bg-white dark:bg-gray-800 p-2 max-h-[600px] overflow-y-auto">
      <table class="w-full text-sm" id="keywordTable">
        <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
          <tr>
            <th class="p-2 text-left">キーワード</th>
            <th class="p-2 text-center">ステータス</th>
            <th class="p-2 text-center">操作</th>
          </tr>
        </thead>
        <tbody id="keywordList"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
let selectedKeywords = [];

function togglePromptFields() {
  const field = document.getElementById('promptFields');
  const icon = document.getElementById('toggleIcon');
  const text = document.getElementById('toggleText');
  const isOpen = field.classList.contains("max-h-0");
  field.classList.toggle("max-h-0", !isOpen);
  field.classList.toggle("max-h-[1000px]", isOpen);
  icon.textContent = isOpen ? "－" : "＋";
  text.textContent = isOpen ? "詳細プロンプトを非表示" : "詳細プロンプトを表示";
}

async function onSiteChange() {
  const siteId = parseInt(document.querySelector('[name="site_select"]').value);
  if (!siteId) return;
  selectedKeywords = [];
  updateKeywordsTextarea();

  const list = document.getElementById("keywordList");
  list.innerHTML = "";

  try {
    const res = await fetch(`/api/keywords/all/${siteId}`);
    const data = await res.json();

    data.forEach(k => {
      const row = document.createElement("tr");
      row.dataset.status = k.used ? "used" : "unused";

      const td1 = document.createElement("td");
      td1.className = "p-2";
      td1.textContent = k.keyword;

      const td2 = document.createElement("td");
      td2.className = "p-2 text-center";
      td2.textContent = k.used ? "生成済み" : "未生成";

      const td3 = document.createElement("td");
      td3.className = "p-2 text-center";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.dataset.keyword = k.keyword;
      btn.textContent = "追加";
      btn.className = "px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600";
      btn.onclick = () => toggleKeyword(btn);
      td3.appendChild(btn);

      row.appendChild(td1);
      row.appendChild(td2);
      row.appendChild(td3);
      list.appendChild(row);
    });
  } catch (err) {
    console.error("キーワード取得失敗", err);
  }
}

function toggleKeyword(btn) {
  const kw = btn.dataset.keyword;
  const idx = selectedKeywords.indexOf(kw);
  if (idx !== -1) {
    selectedKeywords.splice(idx, 1);
    btn.textContent = "追加";
    btn.classList.remove("bg-red-600");
    btn.classList.add("bg-blue-500");
  } else {
    if (selectedKeywords.length >= 40) {
      alert("最大40キーワードまでです");
      return;
    }
    selectedKeywords.push(kw);
    btn.textContent = "解除";
    btn.classList.remove("bg-blue-500");
    btn.classList.add("bg-red-600");
  }
  updateKeywordsTextarea();
}

function updateKeywordsTextarea() {
  const textarea = document.getElementById("keywordsField");
  textarea.value = selectedKeywords.join("\n");
}

function selectAllKeywords() {
  const buttons = document.querySelectorAll("#keywordList button");
  for (const btn of buttons) {
    const kw = btn.dataset.keyword;
    if (!selectedKeywords.includes(kw)) {
      if (selectedKeywords.length >= 40) break;
      selectedKeywords.push(kw);
      btn.textContent = "解除";
      btn.classList.remove("bg-blue-500");
      btn.classList.add("bg-red-600");
    }
  }
  updateKeywordsTextarea();
}

function validateKeywordCount() {
  const lines = document.getElementById("keywordsField").value.trim().split(/\r?\n/).filter(l => l);
  if (lines.length > 40) {
    alert("キーワードは最大40件までです。現在: " + lines.length);
    return false;
  }
  return true;
}

function filterByStatus() {
  const value = document.getElementById("statusFilter").value;
  const rows = document.querySelectorAll("#keywordList tr");
  rows.forEach(row => {
    row.style.display = (value === "" || row.dataset.status === value) ? "" : "none";
  });
}

async function onPromptChange() {
  const pid = document.getElementById('selectPrompt').value;
  if (!pid || pid === "0") return;
  try {
    const res = await fetch(`/api/prompt/${pid}`);
    const j = await res.json();
    document.getElementById('titlePT').value = j.title_pt;
    document.getElementById('bodyPT').value = j.body_pt;
  } catch (err) {
    console.error('プロンプト取得エラー', err);
  }
}
document.getElementById('selectPrompt').addEventListener('change', onPromptChange);

document.addEventListener("DOMContentLoaded", () => {
  const current = document.querySelector('[name="site_select"]').value;
  if (current && parseInt(current) > 0) {
    onSiteChange();
  }
});
</script>
{% endblock %}
