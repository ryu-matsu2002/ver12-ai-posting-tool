{% extends "base.html" %}
{% block title %}è¨˜äº‹ç”Ÿæˆ{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-10">
  <!-- å·¦ï¼šãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="w-full lg:w-1/2">
    <h2 class="text-2xl font-semibold mb-6">è¨˜äº‹ç”Ÿæˆ</h2>

    <form method="post"
          action="{{ url_for('main.generate', username=current_user.username) }}"
          id="genForm"
          class="space-y-6"
          onsubmit="return validateKeywordCount()">
      {{ form.hidden_tag() }}

      <!-- ã‚µã‚¤ãƒˆé¸æŠ -->
      <div>
        {{ form.site_select.label(class="block mb-1 font-medium") }}
        {{ form.site_select(class="w-full p-2 rounded border", onchange="onSiteChange()") }}
      </div>

      <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆPOSTç”¨ï¼‰ -->
      <div>
        {{ form.keywords.label(class="block mb-1 font-medium") }}
        {{ form.keywords(rows=10, id="keywordsField", class="w-full p-2 rounded border") }}
        <small class="text-gray-500">1 è¡Œ 1 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å¤§ 40 è¡Œï¼‰</small>
      </div>

      <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé¸æŠ -->
      <div>
        {{ form.genre_select.label(class="block mb-1 font-medium") }}
        {{ form.genre_select(id="selectPrompt", class="w-full p-2 rounded border") }}
      </div>

      <!-- è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ‡ã‚Šæ›¿ãˆ -->
      <div>
        <button type="button" onclick="togglePromptFields()" class="text-blue-600 border border-blue-600 rounded px-3 py-1 text-sm hover:bg-blue-50 transition" id="toggleBtn">
          <span id="toggleIcon">ï¼‹</span> <span id="toggleText">è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º</span>
        </button>
      </div>

      <!-- è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
      <div id="promptFields" class="space-y-4 mt-2 transition-all duration-300 overflow-hidden max-h-0">
        <div>
          {{ form.title_prompt.label(class="block mb-1 font-medium") }}
          {{ form.title_prompt(rows=3, id="titlePT", class="w-full p-2 rounded border") }}
        </div>
        <div>
          {{ form.body_prompt.label(class="block mb-1 font-medium") }}
          {{ form.body_prompt(rows=5, id="bodyPT", class="w-full p-2 rounded border") }}
        </div>
      </div>

      <!-- é€ä¿¡ -->
      {{ form.submit(class="py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded") }}
    </form>
  </div>

  <!-- å³ï¼šç™»éŒ²æ¸ˆã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º -->
  <div class="w-full lg:w-1/2">
    <h3 class="text-xl font-bold mb-2">ç™»éŒ²ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h3>
    {% if site_name %}
    <div class="mb-2 font-bold text-black">{{ site_name }}</div>
    {% endif %}

    {% if total_count is defined and used_count is defined and unused_count is defined %}
    <div class="mb-3 text-sm text-gray-700">
      ğŸ”¢ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ï¼š
      <span class="font-bold text-black">å…¨ä½“ {{ total_count }} ä»¶</span> ï¼
      <span class="text-green-600 font-semibold">ç”Ÿæˆæ¸ˆã¿ {{ used_count }} ä»¶</span> ï¼
      <span class="text-red-600 font-semibold">æœªç”Ÿæˆ {{ unused_count }} ä»¶</span>
    </div>
    {% endif %}

    <form method="get" class="flex items-center justify-between mb-2">
      <div>
        <label class="mr-2 font-medium">è¡¨ç¤ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
        <select name="status" class="p-1 border rounded" onchange="this.form.submit()">
          <option value="" {% if not status_filter %}selected{% endif %}>ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
          <option value="unused" {% if status_filter == 'unused' %}selected{% endif %}>æœªç”Ÿæˆ</option>
          <option value="used" {% if status_filter == 'used' %}selected{% endif %}>ç”Ÿæˆæ¸ˆã¿</option>
        </select>
        <input type="hidden" name="site_id" value="{{ selected_site.id if selected_site else '' }}">
      </div>
      <button type="button" onclick="selectAllKeywords()" class="bg-gray-500 text-white text-sm px-3 py-1 rounded">å…¨ã¦é¸æŠï¼ˆæœ€å¤§40ä»¶ï¼‰</button>
    </form>

    <div class="overflow-y-auto max-h-[500px] border rounded">
      <table class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr class="text-left">
            <th class="p-2"><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
            <th class="p-2">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
            <th class="p-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th class="p-2">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for kw in keyword_choices %}
          <tr class="border-t hover:bg-gray-50">
            <td class="p-2"><input type="checkbox" class="kw-checkbox" data-kw="{{ kw.keyword }}" onchange="toggleKeywordCheckbox(this)"></td>
            <td class="p-2">{{ kw.keyword }}</td>
            <td class="p-2">
              {% if kw.used %}
              <span class="text-green-600 font-bold">ç”Ÿæˆæ¸ˆã¿</span>
              {% else %}
              <span class="text-gray-700">æœªç”Ÿæˆ</span>
              {% endif %}
            </td>
            <td class="p-2">
              <button type="button" class="text-sm px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded" onclick="addKeyword('{{ kw.keyword }}')">è¿½åŠ </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let selectedKeywords = new Set();

function togglePromptFields() {
  const field = document.getElementById('promptFields');
  const icon = document.getElementById('toggleIcon');
  const text = document.getElementById('toggleText');
  const open = field.classList.toggle("max-h-0");
  field.classList.toggle("max-h-[1000px]", open);
  icon.textContent = open ? "ï¼‹" : "ï¼";
  text.textContent = open ? "è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º" : "è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤º";
}

function toggleKeywordCheckbox(checkbox) {
  const kw = checkbox.dataset.kw;
  if (checkbox.checked) {
    if (selectedKeywords.size >= 40) {
      alert("æœ€å¤§40ä»¶ã¾ã§é¸æŠå¯èƒ½ã§ã™");
      checkbox.checked = false;
      return;
    }
    selectedKeywords.add(kw);
  } else {
    selectedKeywords.delete(kw);
  }
  updateKeywordField();
}

function toggleAllCheckboxes(master) {
  const checkboxes = document.querySelectorAll('.kw-checkbox');
  for (const box of checkboxes) {
    box.checked = master.checked;
    const kw = box.dataset.kw;
    if (box.checked) {
      if (selectedKeywords.size < 40) selectedKeywords.add(kw);
    } else {
      selectedKeywords.delete(kw);
    }
  }
  updateKeywordField();
}

function addKeyword(kw) {
  if (selectedKeywords.size >= 40) {
    alert("æœ€å¤§40ä»¶ã¾ã§é¸æŠå¯èƒ½ã§ã™");
    return;
  }
  selectedKeywords.add(kw);
  updateKeywordField();
}

function selectAllKeywords() {
  const checkboxes = document.querySelectorAll('.kw-checkbox');
  for (const box of checkboxes) {
    const kw = box.dataset.kw;
    if (!box.checked && selectedKeywords.size < 40) {
      selectedKeywords.add(kw);
      box.checked = true;
    }
  }
  updateKeywordField();
}

function updateKeywordField() {
  document.getElementById("keywordsField").value = Array.from(selectedKeywords).join("\n");
}

function validateKeywordCount() {
  const lines = document.getElementById("keywordsField").value.trim().split(/\r?\n/).filter(l => l);
  if (lines.length > 40) {
    alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯æœ€å¤§40ä»¶ã¾ã§ã§ã™ã€‚ç¾åœ¨: " + lines.length);
    return false;
  }
  return true;
}

async function onSiteChange() {
  const selected = document.querySelector('[name="site_select"]').value;
  if (selected) {
    const url = new URL(window.location.href);
    url.searchParams.set("site_id", selected);
    url.searchParams.delete("status");
    window.location.href = url.toString();
  }
}

document.getElementById('selectPrompt').addEventListener('change', async function () {
  const pid = this.value;
  if (pid === "0") return;
  try {
    const res = await fetch(`/api/prompt/${pid}`);
    const j = await res.json();
    document.getElementById('titlePT').value = j.title_pt;
    document.getElementById('bodyPT').value = j.body_pt;
  } catch (err) {
    console.error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼', err);
  }
});
</script>
{% endblock %}
