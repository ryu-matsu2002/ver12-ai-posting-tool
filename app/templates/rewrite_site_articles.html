{# templates/rewrite_site_articles.html（ユーザー用 サイト別リライト記事一覧） #}
{% extends "base.html" %}
{% block title %}サイト別 リライト済み記事一覧{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  {# パンくず（見た目は管理画面と同じ構成） #}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.user_rewrite_dashboard') }}">リライト機能：サイト一覧</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">サイト別記事一覧</li>
    </ol>
  </nav>

  {# status_filter → 管理テンプレと同じ名前で扱えるように変数を合わせる #}
  {% set status = status_filter %}

  {# 見出し + 戻るボタン（構造・クラスは管理テンプレと同じ） #}
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <h3 class="mb-0">
      {{ site.site_name or site.name or "サイト" }}
      <small class="text-muted ms-2" style="font-size:.9rem;">(ID: {{ site.id }})</small>

      {# サイト全体のステータスバッジ（成功だけ / 失敗だけの場合に表示） #}
      {% set total = (stats.success or 0) + (stats.error or stats.failed or 0) %}
      {% if total > 0 and (stats.error or stats.failed or 0) == 0 %}
        <span class="badge bg-success ms-2">success</span>
      {% elif total > 0 and (stats.success or 0) == 0 %}
        <span class="badge bg-danger ms-2">error</span>
      {% endif %}
    </h3>

    <a class="btn btn-outline-secondary btn-sm"
       href="javascript:history.back();">
      戻る
    </a>
  </div>

  {# サイトURLリンク #}
  {% if site.site_url %}
    <div class="mb-3">
      <a href="{{ site.site_url }}" target="_blank" rel="noopener" class="link-secondary">
        {{ site.site_url }}
      </a>
    </div>
  {% endif %}

  {# 統計カード（待機/実行中/成功/失敗） — 管理テンプレと同じ構造 #}
  <div class="row g-2 text-center mb-2">
    <div class="col-6 col-md-3">
      <div class="card h-100 position-relative">
        <div class="card-body p-2">
          <div class="fw-bold">待機中</div>
          <div class="fs-5 text-secondary">
            {{ (stats.queued or stats.waiting or 0) }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 position-relative">
        <div class="card-body p-2">
          <div class="fw-bold">実行中</div>
          <div class="fs-5 text-warning">
            {{ (stats.running or 0) }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 position-relative">
        <div class="card-body p-2">
          <div class="fw-bold">成功</div>
          <div class="fs-5 text-success">
            {{ (stats.success or 0) }}
          </div>
        </div>
        {# 成功カード → フィルタリンク #}
        <a class="stretched-link"
           href="{{ url_for('main.user_rewrite_site_articles',
                            site_id=site.id,
                            status='success') }}"></a>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card h-100 position-relative">
        <div class="card-body p-2">
          <div class="fw-bold">失敗</div>
          <div class="fs-5 text-danger">
            {{ (stats.display_error
                if (stats.display_error is defined and stats.display_error is not none)
                else (stats.error or stats.failed or 0)) }}
          </div>
        </div>
        {# 失敗カード → フィルタリンク（ユーザー側は status='error' を使う実装） #}
        <a class="stretched-link"
           href="{{ url_for('main.user_rewrite_site_articles',
                            site_id=site.id,
                            status='error') }}"></a>
      </div>
    </div>
  </div>

  {# 対象記事数カード（管理テンプレの下部カード相当） #}
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4 col-lg-3">
      <div class="card">
        <div class="card-body p-2 text-center">
          <div class="small text-muted">対象記事数</div>
          <div class="fw-bold">
            {{ stats.target_articles or 0 }}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# 成功 / 失敗フィルタトグル — 管理テンプレと同じ見た目 #}
  <div class="mb-3">
    <div class="btn-group">
      <a class="btn btn-sm {% if status=='success' or not status %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{{ url_for('main.user_rewrite_site_articles',
                          site_id=site.id,
                          status='success') }}">
        成功のみ
      </a>
      <a class="btn btn-sm {% if status in ['failed','error'] %}btn-danger{% else %}btn-outline-danger{% endif %}"
         href="{{ url_for('main.user_rewrite_site_articles',
                          site_id=site.id,
                          status='error') }}">
        失敗のみ
      </a>
    </div>
    {% if updated_at %}
      <small class="text-muted ms-2">更新: {{ updated_at.strftime("%Y-%m-%d %H:%M") }}</small>
    {% endif %}
  </div>

  {# 記事テーブル — 管理テンプレの構造を踏襲しつつ、ユーザー用データ構造(logs)に対応 #}
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>
        リライト済み記事一覧
        {% if status in ['failed','error'] %}
          <small class="text-danger">(失敗)</small>
        {% elif status == 'success' %}
          <small class="text-success">(成功)</small>
        {% endif %}
      </span>
      <small class="text-muted">
        {% if updated_at %}更新: {{ updated_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
      </small>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center" style="width:90px;">ID</th>
            <th>タイトル</th>
            <th class="text-center" style="width:120px;">ステータス</th>
            <th class="text-center" style="width:180px;">最終更新</th>
            <th style="min-width:120px;">WPリンク</th>
            <th class="text-center" style="width:140px;">修正方針</th>
          </tr>
        </thead>
        <tbody>
          {% if logs and logs|length %}
            {% for row in logs %}
              {% set st = row.rewrite_status or row.status or '-' %}
              {% set cls = "secondary" %}
              {% if st == "success" %}
                {% set cls = "success" %}
              {% elif st in ["error","failed"] %}
                {% set cls = "danger" %}
              {% elif st == "running" %}
                {% set cls = "warning" %}
              {% elif st in ["waiting","queued"] %}
                {% set cls = "secondary" %}
              {% endif %}

              <tr>
                <td class="text-center fw-bold">
                  {{ row.article_id or row.id }}
                </td>
                <td>
                  {{ row.article_title or '（タイトル未設定）' }}
                  {% if row.article_id %}
                    <span class="text-muted ms-2">(#{{ row.article_id }})</span>
                  {% endif %}
                  {% if row.article_url %}
                    <div>
                      <a href="{{ row.article_url }}" target="_blank" rel="noopener">
                        {{ row.article_url }}
                      </a>
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  <span class="badge bg-{{ cls }}">{{ st }}</span>
                </td>
                <td class="text-center text-muted">
                  {% if row.executed_at %}
                    {{ row.executed_at|tojson|safe|replace('"','')|replace('T',' ') }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if row.posted_url %}
                    <a href="{{ row.posted_url }}" target="_blank" rel="noopener">open</a>
                  {% elif row.wp_url %}
                    <a href="{{ row.wp_url }}" target="_blank" rel="noopener">open</a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if row.id %}
                    <a class="btn btn-outline-primary btn-sm"
                       href="{{ url_for('main.user_rewrite_log_detail', log_id=row.id) }}"
                       target="_blank" rel="noopener">
                      修正方針
                    </a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                データがありません
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {# ページネーション（構造は管理テンプレと同等） #}
    {% if pagination %}
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          {{ pagination.total or 0 }} 件中 {{ pagination.first or 0 }}–{{ pagination.last or 0 }} を表示
        </div>
        <div class="btn-group">
          <a class="btn btn-outline-secondary btn-sm {% if not pagination.prev_url %}disabled{% endif %}"
             href="{{ pagination.prev_url or '#' }}">前へ</a>
          <a class="btn btn-outline-secondary btn-sm {% if not pagination.next_url %}disabled{% endif %}"
             href="{{ pagination.next_url or '#' }}">次へ</a>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
