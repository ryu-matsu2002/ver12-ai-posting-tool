{% extends "base.html" %}
{% block title %}GSCåˆ†æ - {{ site.name }}{% endblock %}

{% block content %}
<div class="p-6">
  <h1 class="text-2xl font-bold mb-4">ğŸ” GSCåˆ†æï¼š{{ site.name }}</h1>

  {% if error %}
    <div class="bg-red-100 text-red-700 p-4 rounded mb-6">{{ error }}</div>
  {% endif %}

  <!-- âœ… æœŸé–“é¸æŠã‚¿ãƒ– -->
  <div class="flex flex-wrap gap-2 mb-6">
    {% set options = [("1d", "24æ™‚é–“"), ("7d", "7æ—¥é–“"), ("28d", "28æ—¥é–“"),
                      ("3m", "3ã‹æœˆ"), ("6m", "6ã‹æœˆ"), ("12m", "12ã‹æœˆ"), ("16m", "16ã‹æœˆ")] %}
    {% for code, label in options %}
      <a href="{{ url_for('main.gsc_analysis', site_id=site.id, range=code) }}"
         class="px-4 py-2 rounded border
         {{ 'bg-blue-600 text-white' if selected_range == code else 'bg-white hover:bg-gray-100 text-gray-700' }}">
        {{ label }}
      </a>
    {% endfor %}

    <!-- âœ… ã‚«ã‚¹ã‚¿ãƒ  -->
    <form method="get" action="{{ url_for('main.gsc_analysis', site_id=site.id) }}" class="flex items-center gap-2">
      <input type="hidden" name="range" value="custom">
      <input type="date" name="start" value="{{ start_date }}" class="border rounded p-1 text-sm">
      <span class="text-gray-500">ï½</span>
      <input type="date" name="end" value="{{ end_date }}" class="border rounded p-1 text-sm">
      <button type="submit" class="bg-gray-700 text-white text-sm px-3 py-1 rounded">é©ç”¨</button>
    </form>
  </div>

  <!-- âœ… ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
  <div class="bg-white rounded shadow p-6 mb-8">
    <canvas id="gscChart" height="100"></canvas>
  </div>

  <!-- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º -->
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border border-gray-300">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
          <th class="p-2 border">æ—¥ä»˜</th>
          <th class="p-2 border">æ¤œç´¢ã‚¯ã‚¨ãƒª</th>
          <th class="p-2 border">ã‚¯ãƒªãƒƒã‚¯æ•°</th>
          <th class="p-2 border">è¡¨ç¤ºå›æ•°</th>
          <th class="p-2 border">CTR</th>
          <th class="p-2 border">æ²è¼‰é †ä½</th>
        </tr>
      </thead>
      <tbody>
        {% for m in metrics %}
        <tr class="text-center">
          <td class="p-2 border">{{ m.date }}</td>
          <td class="p-2 border">{{ m.query }}</td>
          <td class="p-2 border">{{ m.clicks }}</td>
          <td class="p-2 border">{{ m.impressions }}</td>
          <td class="p-2 border">{{ "%.1f"|format(m.ctr * 100) }}%</td>
          <td class="p-2 border">{{ "%.2f"|format(m.position) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- âœ… Chart.js -->
<script>
  const metricsData = JSON.parse('{{ metrics | tojson | safe }}');
  const impressions = {};
  const clicks = {};

  for (const m of metricsData) {
    const d = m.date;
    impressions[d] = (impressions[d] || 0) + m.impressions;
    clicks[d] = (clicks[d] || 0) + m.clicks;
  }

  const labels = Object.keys(impressions).sort();
  const data = {
    labels: labels,
    datasets: [
      {
        label: 'è¡¨ç¤ºå›æ•°',
        data: labels.map(d => impressions[d]),
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.3,
        fill: false
      },
      {
        label: 'ã‚¯ãƒªãƒƒã‚¯æ•°',
        data: labels.map(d => clicks[d]),
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.3,
        fill: false
      }
    ]
  };

  new Chart(document.getElementById('gscChart'), {
    type: 'line',
    data: data,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: {
          display: true,
          text: 'ã‚¯ãƒªãƒƒã‚¯æ•° / è¡¨ç¤ºå›æ•°ï¼ˆæ—¥åˆ¥ï¼‰'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
</script>
{% endblock %}
